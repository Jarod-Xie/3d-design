var jt;(function(i){i[i.Disjoint=0]="Disjoint",i[i.Contains=1]="Contains",i[i.Intersects=2]="Intersects"})(jt||(jt={}));var $e;(function(i){i[i.Back=0]="Back",i[i.Front=1]="Front",i[i.Intersecting=2]="Intersecting"})($e||($e={}));var N=function(){function i(){}return i.clamp=function(a,t,e){return Math.max(t,Math.min(e,a))},i.equals=function(a,t){return Math.abs(a-t)<=i.zeroTolerance},i.isPowerOf2=function(a){return(a&a-1)===0},i.radianToDegree=function(a){return a*i.radToDegreeFactor},i.degreeToRadian=function(a){return a*i.degreeToRadFactor},i}();N.zeroTolerance=1e-6;N.radToDegreeFactor=180/Math.PI;N.degreeToRadFactor=Math.PI/180;var w=function(){i.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z},i.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z},i.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z},i.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z},i.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},i.cross=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.x,u=e.y,h=e.z;r.x=o*h-c*u,r.y=c*l-n*h,r.z=n*u-o*l},i.distance=function(t,e){var r=e.x-t.x,n=e.y-t.y,o=e.z-t.z;return Math.sqrt(r*r+n*n+o*o)},i.distanceSquared=function(t,e){var r=e.x-t.x,n=e.y-t.y,o=e.z-t.z;return r*r+n*n+o*o},i.equals=function(t,e){return N.equals(t.x,e.x)&&N.equals(t.y,e.y)&&N.equals(t.z,e.z)},i.lerp=function(t,e,r,n){var o=t.x,c=t.y,l=t.z;n.x=o+(e.x-o)*r,n.y=c+(e.y-c)*r,n.z=l+(e.z-l)*r},i.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z)},i.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z)},i.negate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z},i.normalize=function(t,e){var r=t.x,n=t.y,o=t.z,c=Math.sqrt(r*r+n*n+o*o);c>0&&(c=1/c,e.x=r*c,e.y=n*c,e.z=o*c)},i.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e},i.transformNormal=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.elements;r.x=n*l[0]+o*l[4]+c*l[8],r.y=n*l[1]+o*l[5]+c*l[9],r.z=n*l[2]+o*l[6]+c*l[10]},i.transformToVec3=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.elements;r.x=n*l[0]+o*l[4]+c*l[8]+l[12],r.y=n*l[1]+o*l[5]+c*l[9]+l[13],r.z=n*l[2]+o*l[6]+c*l[10]+l[14]},i.transformToVec4=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.elements;r.x=n*l[0]+o*l[4]+c*l[8]+l[12],r.y=n*l[1]+o*l[5]+c*l[9]+l[13],r.z=n*l[2]+o*l[6]+c*l[10]+l[14],r.w=n*l[3]+o*l[7]+c*l[11]+l[15]},i.transformCoordinate=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.elements,u=n*l[3]+o*l[7]+c*l[11]+l[15];u=1/u,r.x=(n*l[0]+o*l[4]+c*l[8]+l[12])*u,r.y=(n*l[1]+o*l[5]+c*l[9]+l[13])*u,r.z=(n*l[2]+o*l[6]+c*l[10]+l[14])*u},i.transformByQuat=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=e.x,u=e.y,h=e.z,f=e.w,d=f*n+u*c-h*o,_=f*o+h*n-l*c,p=f*c+l*o-u*n,v=-l*n-u*o-h*c;r.x=d*f-v*l-_*h+p*u,r.y=_*f-v*u-p*l+d*h,r.z=p*f-v*h-d*u+_*l};function i(a,t,e){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),this.x=void 0,this.y=void 0,this.z=void 0,this.x=a,this.y=t,this.z=e}var s=i.prototype;return s.setValue=function(t,e,r){return this.x=t,this.y=e,this.z=r,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},s.length=function(){var t=this.x,e=this.y,r=this.z;return Math.sqrt(t*t+e*e+r*r)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z;return t*t+e*e+r*r},s.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},s.normalize=function(){return i.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z},s.clone=function(){return new i(this.x,this.y,this.z)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t},s.transformNormal=function(t){return i.transformNormal(this,t,this),this},s.transformToVec3=function(t){return i.transformToVec3(this,t,this),this},s.transformCoordinate=function(t){return i.transformCoordinate(this,t,this),this},s.transformByQuat=function(t){return i.transformByQuat(this,t,this),this},i}();w._zero=new w(0,0,0);w._one=new w(1,1,1);new w;var ur=function(){i.fromCenterAndExtent=function(t,e,r){w.subtract(t,e,r.min),w.add(t,e,r.max)},i.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,n=e.max;r.x=r.y=r.z=Number.MAX_VALUE,n.x=n.y=n.z=-Number.MAX_VALUE;for(var o=0,c=t.length;o<c;++o){var l=t[o];w.min(r,l,r),w.max(n,l,n)}},i.fromSphere=function(t,e){var r=t.center,n=t.radius,o=e.min,c=e.max;o.x=r.x-n,o.y=r.y-n,o.z=r.z-n,c.x=r.x+n,c.y=r.y+n,c.z=r.z+n},i.transform=function(t,e,r){var n=i._tempVec30,o=i._tempVec31;t.getCenter(n),t.getExtent(o),w.transformCoordinate(n,e,n);var c=o.x,l=o.y,u=o.z,h=e.elements;o.x=Math.abs(c*h[0])+Math.abs(l*h[4])+Math.abs(u*h[8]),o.y=Math.abs(c*h[1])+Math.abs(l*h[5])+Math.abs(u*h[9]),o.z=Math.abs(c*h[2])+Math.abs(l*h[6])+Math.abs(u*h[10]),w.subtract(n,o,r.min),w.add(n,o,r.max)},i.merge=function(t,e,r){return w.min(t.min,e.min,r.min),w.max(t.max,e.max,r.max),r};function i(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.min=new w,this.max=new w,a&&a.cloneTo(this.min),t&&t.cloneTo(this.max)}var s=i.prototype;return s.clone=function(){return new i(this.min,this.max)},s.cloneTo=function(t){return this.min.cloneTo(t.min),this.max.cloneTo(t.max),t},s.getCenter=function(t){return w.add(this.min,this.max,t),w.scale(t,.5,t),t},s.getExtent=function(t){return w.subtract(this.max,this.min,t),w.scale(t,.5,t),t},s.getCorners=function(t){t===void 0&&(t=[]);var e=this.min,r=this.max,n=e.x,o=e.y,c=e.z,l=r.x,u=r.y,h=r.z,f=t.length;if(f<8)for(var d=0,_=8-f;d<_;++d)t[f+d]=new w;return t[0].setValue(n,u,h),t[1].setValue(l,u,h),t[2].setValue(l,o,h),t[3].setValue(n,o,h),t[4].setValue(n,u,c),t[5].setValue(l,u,c),t[6].setValue(l,o,c),t[7].setValue(n,o,c),t},s.transform=function(t){return i.transform(this,t,this),this},i}();ur._tempVec30=new w;ur._tempVec31=new w;var Sr=function(){function i(){}return i.distancePlaneAndPoint=function(a,t){return w.dot(a.normal,t)+a.distance},i.intersectsPlaneAndPoint=function(a,t){var e=i.distancePlaneAndPoint(a,t);return e>0?$e.Front:e<0?$e.Back:$e.Intersecting},i.intersectsPlaneAndBox=function(a,t){var e=t.min,r=t.max,n=a.normal,o=i._tempVec30,c=i._tempVec31;return n.x>=0?(o.x=r.x,c.x=e.x):(o.x=e.x,c.x=r.x),n.y>=0?(o.y=r.y,c.y=e.y):(o.y=e.y,c.y=r.y),n.z>=0?(o.z=r.z,c.z=e.z):(o.z=e.z,c.z=r.z),i.distancePlaneAndPoint(a,o)<0?$e.Back:i.distancePlaneAndPoint(a,c)>0?$e.Front:$e.Intersecting},i.intersectsPlaneAndSphere=function(a,t){var e=t.center,r=t.radius,n=i.distancePlaneAndPoint(a,e);return n>r?$e.Front:n<-r?$e.Back:$e.Intersecting},i.intersectsRayAndPlane=function(a,t){var e=t.normal,r=N.zeroTolerance,n=w.dot(e,a.direction);if(Math.abs(n)<r)return-1;var o=w.dot(e,a.origin),c=(-t.distance-o)/n;if(c<0){if(c<-r)return-1;c=0}return c},i.intersectsRayAndBox=function(a,t){var e=N.zeroTolerance,r=a.origin,n=a.direction,o=t.min,c=t.max,l=n.x,u=n.y,h=n.z,f=r.x,d=r.y,_=r.z,p=0,v=Number.MAX_VALUE;if(Math.abs(l)<e){if(f<o.x||f>c.x)return-1}else{var g=1/l,m=(o.x-f)*g,y=(c.x-f)*g;if(m>y){var A=m;m=y,y=A}if(p=Math.max(m,p),v=Math.min(y,v),p>v)return-1}if(Math.abs(u)<e){if(d<o.y||d>c.y)return-1}else{var S=1/u,C=(o.y-d)*S,P=(c.y-d)*S;if(C>P){var R=C;C=P,P=R}if(p=Math.max(C,p),v=Math.min(P,v),p>v)return-1}if(Math.abs(h)<e){if(_<o.z||_>c.z)return-1}else{var T=1/h,E=(o.z-_)*T,D=(c.z-_)*T;if(E>D){var B=E;E=D,D=B}if(p=Math.max(E,p),v=Math.min(D,v),p>v)return-1}return p},i.intersectsRayAndSphere=function(a,t){var e=a.origin,r=a.direction,n=t.center,o=t.radius,c=i._tempVec30;w.subtract(e,n,c);var l=w.dot(c,r),u=w.dot(c,c)-o*o;if(l>0&&u>0)return-1;var h=l*l-u;if(h<0)return-1;var f=-l-Math.sqrt(h);return f<0&&(f=0),f},i.intersectsBoxAndBox=function(a,t){return a.min.x>t.max.x||t.min.x>a.max.x||a.min.y>t.max.y||t.min.y>a.max.y?!1:!(a.min.z>t.max.z||t.min.z>a.max.z)},i.intersectsSphereAndSphere=function(a,t){var e=a.radius+t.radius;return w.distanceSquared(a.center,t.center)<e*e},i.intersectsSphereAndBox=function(a,t){var e=a.center,r=t.max,n=t.min,o=i._tempVec30;o.setValue(Math.max(n.x,Math.min(e.x,r.x)),Math.max(n.y,Math.min(e.y,r.y)),Math.max(n.z,Math.min(e.z,r.z)));var c=w.distanceSquared(e,o);return c<=a.radius*a.radius},i.intersectsFrustumAndBox=function(a,t){for(var e=t.min,r=t.max,n=i._tempVec30,o=0;o<6;++o){var c=a.getPlane(o),l=c.normal;if(n.x=l.x>=0?e.x:r.x,n.y=l.y>=0?e.y:r.y,n.z=l.z>=0?e.z:r.z,w.dot(c.normal,n)>-c.distance)return!1}return!0},i.frustumContainsBox=function(a,t){for(var e=t.min,r=t.max,n=i._tempVec30,o=i._tempVec31,c=jt.Contains,l=0;l<6;++l){var u=a.getPlane(l),h=u.normal;if(h.x>=0?(n.x=r.x,o.x=e.x):(n.x=e.x,o.x=r.x),h.y>=0?(n.y=r.y,o.y=e.y):(n.y=e.y,o.y=r.y),h.z>=0?(n.z=r.z,o.z=e.z):(n.z=e.z,o.z=r.z),i.intersectsPlaneAndPoint(u,o)===$e.Front)return jt.Disjoint;i.intersectsPlaneAndPoint(u,n)===$e.Front&&(c=jt.Intersects)}return c},i.frustumContainsSphere=function(a,t){for(var e=jt.Contains,r=0;r<6;++r){var n=a.getPlane(r),o=i.intersectsPlaneAndSphere(n,t);if(o===$e.Front)return jt.Disjoint;if(o===$e.Intersecting){e=jt.Intersects;break}}return e},i}();Sr._tempVec30=new w;Sr._tempVec31=new w;var Ir=function(){i.normalize=function(t,e){var r=t.normal,n=1/r.length(),o=e.normal;o.x=r.x*n,o.y=r.y*n,o.z=r.z*n,e.distance=t.distance*n},i.fromPoints=function(t,e,r,n){var o=t.x,c=t.y,l=t.z,u=e.x-o,h=e.y-c,f=e.z-l,d=r.x-o,_=r.y-c,p=r.z-l,v=h*p-f*_,g=f*d-u*p,m=u*_-h*d,y=1/Math.sqrt(v*v+g*g+m*m),A=v*y,S=g*y,C=m*y,P=n.normal;P.x=A,P.y=S,P.z=C,n.distance=-(A*o+S*c+C*l)};function i(a,t){a===void 0&&(a=null),t===void 0&&(t=0),this.normal=new w,this.distance=0,a&&a.cloneTo(this.normal),this.distance=t}var s=i.prototype;return s.normalize=function(){return i.normalize(this,this),this},s.clone=function(){var t=new i;return this.cloneTo(t),t},s.cloneTo=function(t){return this.normal.cloneTo(t.normal),t.distance=this.distance,t},i}(),jc=function(){function i(a){a===void 0&&(a=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new Ir,this.far=new Ir,this.left=new Ir,this.right=new Ir,this.top=new Ir,this.bottom=new Ir,a&&this.calculateFromMatrix(a)}var s=i.prototype;return s.clone=function(){var t=new i;return this.cloneTo(t),t},s.cloneTo=function(t){return this.near.cloneTo(t.near),this.far.cloneTo(t.far),this.left.cloneTo(t.left),this.right.cloneTo(t.right),this.top.cloneTo(t.top),this.bottom.cloneTo(t.bottom),t},s.getPlane=function(t){switch(t){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},s.calculateFromMatrix=function(t){var e=t.elements,r=e[0],n=e[1],o=e[2],c=e[3],l=e[4],u=e[5],h=e[6],f=e[7],d=e[8],_=e[9],p=e[10],v=e[11],g=e[12],m=e[13],y=e[14],A=e[15],S=this.near.normal;S.x=-c-o,S.y=-f-h,S.z=-v-p,this.near.distance=-A-y,this.near.normalize();var C=this.far.normal;C.x=o-c,C.y=h-f,C.z=p-v,this.far.distance=y-A,this.far.normalize();var P=this.left.normal;P.x=-c-r,P.y=-f-l,P.z=-v-d,this.left.distance=-A-g,this.left.normalize();var R=this.right.normal;R.x=r-c,R.y=l-f,R.z=d-v,this.right.distance=g-A,this.right.normalize();var T=this.top.normal;T.x=n-c,T.y=u-f,T.z=_-v,this.top.distance=m-A,this.top.normalize();var E=this.bottom.normal;E.x=-c-n,E.y=-f-u,E.z=-v-_,this.bottom.distance=-A-m,this.bottom.normalize()},s.intersectsBox=function(t){return Sr.intersectsFrustumAndBox(this,t)},s.intersectsSphere=function(t){return Sr.frustumContainsSphere(this,t)!==jt.Disjoint},i}(),Vr=function(){i.add=function(t,e,r){var n=t.elements,o=e.elements,c=r.elements;c[0]=n[0]+o[0],c[1]=n[1]+o[1],c[2]=n[2]+o[2],c[3]=n[3]+o[3],c[4]=n[4]+o[4],c[5]=n[5]+o[5],c[6]=n[6]+o[6],c[7]=n[7]+o[7],c[8]=n[8]+o[8]},i.subtract=function(t,e,r){var n=t.elements,o=e.elements,c=r.elements;c[0]=n[0]-o[0],c[1]=n[1]-o[1],c[2]=n[2]-o[2],c[3]=n[3]-o[3],c[4]=n[4]-o[4],c[5]=n[5]-o[5],c[6]=n[6]-o[6],c[7]=n[7]-o[7],c[8]=n[8]-o[8]},i.multiply=function(t,e,r){var n=t.elements,o=e.elements,c=r.elements,l=n[0],u=n[1],h=n[2],f=n[3],d=n[4],_=n[5],p=n[6],v=n[7],g=n[8],m=o[0],y=o[1],A=o[2],S=o[3],C=o[4],P=o[5],R=o[6],T=o[7],E=o[8];c[0]=l*m+f*y+p*A,c[1]=u*m+d*y+v*A,c[2]=h*m+_*y+g*A,c[3]=l*S+f*C+p*P,c[4]=u*S+d*C+v*P,c[5]=h*S+_*C+g*P,c[6]=l*R+f*T+p*E,c[7]=u*R+d*T+v*E,c[8]=h*R+_*T+g*E},i.equals=function(t,e){var r=t.elements,n=e.elements;return N.equals(r[0],n[0])&&N.equals(r[1],n[1])&&N.equals(r[2],n[2])&&N.equals(r[3],n[3])&&N.equals(r[4],n[4])&&N.equals(r[5],n[5])&&N.equals(r[6],n[6])&&N.equals(r[7],n[7])&&N.equals(r[8],n[8])},i.lerp=function(t,e,r,n){var o=t.elements,c=e.elements,l=n.elements,u=1-r;l[0]=o[0]*u+c[0]*r,l[1]=o[1]*u+c[1]*r,l[2]=o[2]*u+c[2]*r,l[3]=o[3]*u+c[3]*r,l[4]=o[4]*u+c[4]*r,l[5]=o[5]*u+c[5]*r,l[6]=o[6]*u+c[6]*r,l[7]=o[7]*u+c[7]*r,l[8]=o[8]*u+c[8]*r},i.rotationQuaternion=function(t,e){var r=e.elements,n=t.x,o=t.y,c=t.z,l=t.w,u=n+n,h=o+o,f=c+c,d=n*u,_=o*u,p=o*h,v=c*u,g=c*h,m=c*f,y=l*u,A=l*h,S=l*f;r[0]=1-p-m,r[3]=_-S,r[6]=v+A,r[1]=_+S,r[4]=1-d-m,r[7]=g-y,r[2]=v-A,r[5]=g+y,r[8]=1-d-p},i.scaling=function(t,e){var r=e.elements;r[0]=t.x,r[1]=0,r[2]=0,r[3]=0,r[4]=t.y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},i.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t.x,r[7]=t.y,r[8]=1},i.invert=function(t,e){var r=t.elements,n=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],f=r[5],d=r[6],_=r[7],p=r[8],v=p*h-f*_,g=-p*u+f*d,m=_*u-h*d,y=o*v+c*g+l*m;!y||(y=1/y,n[0]=v*y,n[1]=(-p*c+l*_)*y,n[2]=(f*c-l*h)*y,n[3]=g*y,n[4]=(p*o-l*d)*y,n[5]=(-f*o+l*u)*y,n[6]=m*y,n[7]=(-_*o+c*d)*y,n[8]=(h*o-c*u)*y)},i.normalMatrix=function(t,e){var r=t.elements,n=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],f=r[5],d=r[6],_=r[7],p=r[8],v=r[9],g=r[10],m=r[11],y=r[12],A=r[13],S=r[14],C=r[15],P=o*f-c*h,R=o*d-l*h,T=o*_-u*h,E=c*d-l*f,D=c*_-u*f,B=l*_-u*d,O=p*A-v*y,G=p*S-g*y,L=p*C-m*y,W=v*S-g*A,K=v*C-m*A,Y=g*C-m*S,U=P*Y-R*K+T*W+E*L-D*G+B*O;if(!U)return null;U=1/U,n[0]=(f*Y-d*K+_*W)*U,n[1]=(d*L-h*Y-_*G)*U,n[2]=(h*K-f*L+_*O)*U,n[3]=(l*K-c*Y-u*W)*U,n[4]=(o*Y-l*L+u*G)*U,n[5]=(c*L-o*K-u*O)*U,n[6]=(A*B-S*D+C*E)*U,n[7]=(S*T-y*B-C*R)*U,n[8]=(y*D-A*T+C*P)*U},i.rotate=function(t,e,r){var n=t.elements,o=r.elements,c=Math.sin(e),l=Math.cos(e),u=n[0],h=n[1],f=n[2],d=n[3],_=n[4],p=n[5],v=n[6],g=n[7],m=n[8];o[0]=l*u+c*d,o[1]=l*h+c*_,o[2]=l*f+c*p,o[3]=l*d-c*u,o[4]=l*_-c*h,o[5]=l*p-c*f,o[6]=v,o[7]=g,o[8]=m},i.scale=function(t,e,r){var n=e.x,o=e.y,c=t.elements,l=r.elements;l[0]=n*c[0],l[1]=n*c[1],l[2]=n*c[2],l[3]=o*c[3],l[4]=o*c[4],l[5]=o*c[5],l[6]=c[6],l[7]=c[7],l[8]=c[8]},i.translate=function(t,e,r){var n=e.x,o=e.y,c=t.elements,l=r.elements,u=c[0],h=c[1],f=c[2],d=c[3],_=c[4],p=c[5],v=c[6],g=c[7],m=c[8];l[0]=u,l[1]=h,l[2]=f,l[3]=d,l[4]=_,l[5]=p,l[6]=n*u+o*d+v,l[7]=n*h+o*_+g,l[8]=n*f+o*p+m},i.transpose=function(t,e){var r=t.elements,n=e.elements;if(e===t){var o=r[1],c=r[2],l=r[5];n[1]=r[3],n[2]=r[6],n[3]=o,n[5]=r[7],n[6]=c,n[7]=l}else n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8]};function i(a,t,e,r,n,o,c,l,u){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),n===void 0&&(n=1),o===void 0&&(o=0),c===void 0&&(c=0),l===void 0&&(l=0),u===void 0&&(u=1),this.elements=new Float32Array(9);var h=this.elements;h[0]=a,h[1]=t,h[2]=e,h[3]=r,h[4]=n,h[5]=o,h[6]=c,h[7]=l,h[8]=u}var s=i.prototype;return s.setValue=function(t,e,r,n,o,c,l,u,h){var f=this.elements;return f[0]=t,f[1]=e,f[2]=r,f[3]=n,f[4]=o,f[5]=c,f[6]=l,f[7]=u,f[8]=h,this},s.setValueByArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,n=0;n<12;n++)r[n]=t[n+e];return this},s.setValueByMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},s.clone=function(){var t=this.elements,e=new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},s.cloneTo=function(t){var e=this.elements,r=t.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],t},s.add=function(t){return i.add(this,t,this),this},s.subtract=function(t){return i.subtract(this,t,this),this},s.multiply=function(t){return i.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],n=t[2],o=t[3],c=t[4],l=t[5],u=t[6],h=t[7],f=t[8],d=f*c-l*h,_=-f*o+l*u,p=h*o-c*u;return e*d+r*_+n*p},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},s.invert=function(){return i.invert(this,this),this},s.rotate=function(t){return i.rotate(this,t,this),this},s.scale=function(t){return i.scale(this,t,this),this},s.translate=function(t){return i.translate(this,t,this),this},s.transpose=function(){return i.transpose(this,this),this},i}(),Se=function(){i.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w},i.multiply=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w,u=e.x,h=e.y,f=e.z,d=e.w;r.x=n*d+l*u+o*f-c*h,r.y=o*d+l*h+c*u-n*f,r.z=c*d+l*f+n*h-o*u,r.w=l*d-n*u-o*h-c*f},i.conjugate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w},i.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},i.equals=function(t,e){return N.equals(t.x,e.x)&&N.equals(t.y,e.y)&&N.equals(t.z,e.z)&&N.equals(t.w,e.w)},i.rotationAxisAngle=function(t,e,r){var n=i._tempVector3;w.normalize(t,n),e*=.5;var o=Math.sin(e);r.x=n.x*o,r.y=n.y*o,r.z=n.z*o,r.w=Math.cos(e)},i.rotationEuler=function(t,e,r,n){i.rotationYawPitchRoll(e,t,r,n)},i.rotationYawPitchRoll=function(t,e,r,n){var o=r*.5,c=e*.5,l=t*.5,u=Math.sin(o),h=Math.cos(o),f=Math.sin(c),d=Math.cos(c),_=Math.sin(l),p=Math.cos(l),v=p*d,g=_*f;n.x=p*f*h+_*d*u,n.y=_*d*h-p*f*u,n.z=v*u-g*h,n.w=v*h+g*u},i.rotationMatrix3x3=function(t,e){var r=t.elements,n=r[0],o=r[1],c=r[2],l=r[3],u=r[4],h=r[5],f=r[6],d=r[7],_=r[8],p=n+u+_,v,g;p>0?(v=Math.sqrt(p+1),e.w=v*.5,v=.5/v,e.x=(h-d)*v,e.y=(f-c)*v,e.z=(o-l)*v):n>=u&&n>=_?(v=Math.sqrt(1+n-u-_),g=.5/v,e.x=.5*v,e.y=(o+l)*g,e.z=(c+f)*g,e.w=(h-d)*g):u>_?(v=Math.sqrt(1+u-n-_),g=.5/v,e.x=(l+o)*g,e.y=.5*v,e.z=(d+h)*g,e.w=(f-c)*g):(v=Math.sqrt(1+_-n-u),g=.5/v,e.x=(c+f)*g,e.y=(h+d)*g,e.z=.5*v,e.w=(o-l)*g)},i.invert=function(t,e){var r=t.x,n=t.y,o=t.z,c=t.w,l=r*r+n*n+o*o+c*c;if(l>N.zeroTolerance){var u=1/l;e.x=-r*u,e.y=-n*u,e.z=-o*u,e.w=c*u}},i.lerp=function(t,e,r,n){var o=1-r;i.dot(t,e)>=0?(n.x=t.x*o+e.x*r,n.y=t.y*o+e.y*r,n.z=t.z*o+e.z*r,n.w=t.w*o+e.w*r):(n.x=t.x*o-e.x*r,n.y=t.y*o-e.y*r,n.z=t.z*o-e.z*r,n.w=t.w*o-e.w*r),n.normalize()},i.slerp=function(t,e,r,n){var o=t.x,c=t.y,l=t.z,u=t.w,h=e.x,f=e.y,d=e.z,_=e.w,p,v,g=o*h+c*f+l*d+u*_;if(g<0&&(g=-g,h=-h,f=-f,d=-d,_=-_),1-g>N.zeroTolerance){var m=Math.acos(g),y=Math.sin(m);p=Math.sin((1-r)*m)/y,v=Math.sin(r*m)/y}else p=1-r,v=r;n.x=p*o+v*h,n.y=p*c+v*f,n.z=p*l+v*d,n.w=p*u+v*_},i.normalize=function(t,e){var r=t.x,n=t.y,o=t.z,c=t.w,l=Math.sqrt(r*r+n*n+o*o+c*c);l>N.zeroTolerance&&(l=1/l,e.x=r*l,e.y=n*l,e.z=o*l,e.w=c*l)},i.rotationX=function(t,e){t*=.5;var r=Math.sin(t),n=Math.cos(t);e.x=r,e.y=0,e.z=0,e.w=n},i.rotationY=function(t,e){t*=.5;var r=Math.sin(t),n=Math.cos(t);e.x=0,e.y=r,e.z=0,e.w=n},i.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),n=Math.cos(t);e.x=0,e.y=0,e.z=r,e.w=n},i.rotateX=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=n*h+l*u,r.y=o*h+c*u,r.z=c*h-o*u,r.w=l*h-n*u},i.rotateY=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=n*h-c*u,r.y=o*h+l*u,r.z=c*h+n*u,r.w=l*h-o*u},i.rotateZ=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r.x=n*h+o*u,r.y=o*h-n*u,r.z=c*h+l*u,r.w=l*h-c*u},i.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e,r.w=t.w*e};function i(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=a,this.y=t,this.z=e,this.w=r}var s=i.prototype;return s.setValue=function(t,e,r,n){return this.x=t,this.y=e,this.z=r,this.w=n,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},s.conjugate=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},s.getAxisAngle=function(t){var e=this.x,r=this.y,n=this.z,o=e*e+r*r+n*n;if(o<N.zeroTolerance)return t.x=1,t.y=0,t.z=0,0;var c=1/o;return t.x=this.x*c,t.y=this.y*c,t.z=this.z*c,Math.acos(this.w)*2},s.identity=function(){return this.x=0,this.y=0,this.z=0,this.w=1,this},s.length=function(){var t=this.x,e=this.y,r=this.z,n=this.w;return Math.sqrt(t*t+e*e+r*r+n*n)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z,n=this.w;return t*t+e*e+r*r+n*n},s.normalize=function(){return i.normalize(this,this),this},s.toEuler=function(t){this.toYawPitchRoll(t);var e=t.x;return t.x=t.y,t.y=e,t},s.toYawPitchRoll=function(t){var e=this.x,r=this.y,n=this.z,o=this.w,c=e*e,l=r*r,u=n*n,h=e*r,f=n*o,d=n*e,_=r*o,p=r*n,v=e*o;return t.y=Math.asin(2*(v-p)),Math.cos(t.y)>N.zeroTolerance?(t.z=Math.atan2(2*(h+f),1-2*(u+c)),t.x=Math.atan2(2*(d+_),1-2*(l+c))):(t.z=Math.atan2(-2*(h-f),1-2*(l+u)),t.x=0),t},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w},s.clone=function(){return new i(this.x,this.y,this.z,this.w)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,t},s.rotateX=function(t){return i.rotateX(this,t,this),this},s.rotateY=function(t){return i.rotateY(this,t,this),this},s.rotateZ=function(t){return i.rotateZ(this,t,this),this},s.rotationAxisAngle=function(t,e){return i.rotationAxisAngle(t,e,this),this},s.multiply=function(t){return i.multiply(this,t,this),this},s.invert=function(){return i.invert(this,this),this},s.dot=function(t){return i.dot(this,t)},s.lerp=function(t,e){return i.lerp(this,t,e,this),this},s.rotateAxisAngle=function(t,e){return i._tempQuat1.rotationAxisAngle(t,e),this.multiply(i._tempQuat1),this},i}();Se._tempVector3=new w;Se._tempQuat1=new Se;var ie=function(){i.multiply=function(t,e,r){var n=t.elements,o=e.elements,c=r.elements,l=n[0],u=n[1],h=n[2],f=n[3],d=n[4],_=n[5],p=n[6],v=n[7],g=n[8],m=n[9],y=n[10],A=n[11],S=n[12],C=n[13],P=n[14],R=n[15],T=o[0],E=o[1],D=o[2],B=o[3],O=o[4],G=o[5],L=o[6],W=o[7],K=o[8],Y=o[9],U=o[10],j=o[11],oe=o[12],te=o[13],fe=o[14],me=o[15];c[0]=l*T+d*E+g*D+S*B,c[1]=u*T+_*E+m*D+C*B,c[2]=h*T+p*E+y*D+P*B,c[3]=f*T+v*E+A*D+R*B,c[4]=l*O+d*G+g*L+S*W,c[5]=u*O+_*G+m*L+C*W,c[6]=h*O+p*G+y*L+P*W,c[7]=f*O+v*G+A*L+R*W,c[8]=l*K+d*Y+g*U+S*j,c[9]=u*K+_*Y+m*U+C*j,c[10]=h*K+p*Y+y*U+P*j,c[11]=f*K+v*Y+A*U+R*j,c[12]=l*oe+d*te+g*fe+S*me,c[13]=u*oe+_*te+m*fe+C*me,c[14]=h*oe+p*te+y*fe+P*me,c[15]=f*oe+v*te+A*fe+R*me},i.equals=function(t,e){var r=t.elements,n=e.elements;return N.equals(r[0],n[0])&&N.equals(r[1],n[1])&&N.equals(r[2],n[2])&&N.equals(r[3],n[3])&&N.equals(r[4],n[4])&&N.equals(r[5],n[5])&&N.equals(r[6],n[6])&&N.equals(r[7],n[7])&&N.equals(r[8],n[8])&&N.equals(r[9],n[9])&&N.equals(r[10],n[10])&&N.equals(r[11],n[11])&&N.equals(r[12],n[12])&&N.equals(r[13],n[13])&&N.equals(r[14],n[14])&&N.equals(r[15],n[15])},i.lerp=function(t,e,r,n){var o=t.elements,c=e.elements,l=n.elements,u=1-r;l[0]=o[0]*u+c[0]*r,l[1]=o[1]*u+c[1]*r,l[2]=o[2]*u+c[2]*r,l[3]=o[3]*u+c[3]*r,l[4]=o[4]*u+c[4]*r,l[5]=o[5]*u+c[5]*r,l[6]=o[6]*u+c[6]*r,l[7]=o[7]*u+c[7]*r,l[8]=o[8]*u+c[8]*r,l[9]=o[9]*u+c[9]*r,l[10]=o[10]*u+c[10]*r,l[11]=o[11]*u+c[11]*r,l[12]=o[12]*u+c[12]*r,l[13]=o[13]*u+c[13]*r,l[14]=o[14]*u+c[14]*r,l[15]=o[15]*u+c[15]*r},i.rotationQuaternion=function(t,e){var r=e.elements,n=t.x,o=t.y,c=t.z,l=t.w,u=n+n,h=o+o,f=c+c,d=n*u,_=o*u,p=o*h,v=c*u,g=c*h,m=c*f,y=l*u,A=l*h,S=l*f;r[0]=1-p-m,r[1]=_+S,r[2]=v-A,r[3]=0,r[4]=_-S,r[5]=1-d-m,r[6]=g+y,r[7]=0,r[8]=v+A,r[9]=g-y,r[10]=1-d-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},i.rotationAxisAngle=function(t,e,r){var n=r.elements,o=t.x,c=t.y,l=t.z,u=Math.sqrt(o*o+c*c+l*l),h,f,d;Math.abs(u)<N.zeroTolerance||(u=1/u,o*=u,c*=u,l*=u,h=Math.sin(e),f=Math.cos(e),d=1-f,n[0]=o*o*d+f,n[1]=c*o*d+l*h,n[2]=l*o*d-c*h,n[3]=0,n[4]=o*c*d-l*h,n[5]=c*c*d+f,n[6]=l*c*d+o*h,n[7]=0,n[8]=o*l*d+c*h,n[9]=c*l*d-o*h,n[10]=l*l*d+f,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1)},i.rotationTranslation=function(t,e,r){i.rotationQuaternion(t,r);var n=r.elements;n[12]=e.x,n[13]=e.y,n[14]=e.z},i.affineTransformation=function(t,e,r,n){var o=n.elements,c=e.x,l=e.y,u=e.z,h=e.w,f=c+c,d=l+l,_=u+u,p=c*f,v=c*d,g=c*_,m=l*d,y=l*_,A=u*_,S=h*f,C=h*d,P=h*_,R=t.x,T=t.y,E=t.z;o[0]=(1-(m+A))*R,o[1]=(v+P)*R,o[2]=(g-C)*R,o[3]=0,o[4]=(v-P)*T,o[5]=(1-(p+A))*T,o[6]=(y+S)*T,o[7]=0,o[8]=(g+C)*E,o[9]=(y-S)*E,o[10]=(1-(p+m))*E,o[11]=0,o[12]=r.x,o[13]=r.y,o[14]=r.z,o[15]=1},i.scaling=function(t,e){var r=e.elements;r[0]=t.x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t.y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t.z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},i.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1},i.invert=function(t,e){var r=t.elements,n=e.elements,o=r[0],c=r[1],l=r[2],u=r[3],h=r[4],f=r[5],d=r[6],_=r[7],p=r[8],v=r[9],g=r[10],m=r[11],y=r[12],A=r[13],S=r[14],C=r[15],P=o*f-c*h,R=o*d-l*h,T=o*_-u*h,E=c*d-l*f,D=c*_-u*f,B=l*_-u*d,O=p*A-v*y,G=p*S-g*y,L=p*C-m*y,W=v*S-g*A,K=v*C-m*A,Y=g*C-m*S,U=P*Y-R*K+T*W+E*L-D*G+B*O;if(!U)return null;U=1/U,n[0]=(f*Y-d*K+_*W)*U,n[1]=(l*K-c*Y-u*W)*U,n[2]=(A*B-S*D+C*E)*U,n[3]=(g*D-v*B-m*E)*U,n[4]=(d*L-h*Y-_*G)*U,n[5]=(o*Y-l*L+u*G)*U,n[6]=(S*T-y*B-C*R)*U,n[7]=(p*B-g*T+m*R)*U,n[8]=(h*K-f*L+_*O)*U,n[9]=(c*L-o*K-u*O)*U,n[10]=(y*D-A*T+C*P)*U,n[11]=(v*T-p*D-m*P)*U,n[12]=(f*G-h*W-d*O)*U,n[13]=(o*W-c*G+l*O)*U,n[14]=(A*R-y*E-S*P)*U,n[15]=(p*E-v*R+g*P)*U},i.lookAt=function(t,e,r,n){var o=n.elements,c=i._tempVec30,l=i._tempVec31,u=i._tempVec32;w.subtract(t,e,u),u.normalize(),w.cross(r,u,c),c.normalize(),w.cross(u,c,l),o[0]=c.x,o[1]=l.x,o[2]=u.x,o[3]=0,o[4]=c.y,o[5]=l.y,o[6]=u.y,o[7]=0,o[8]=c.z,o[9]=l.z,o[10]=u.z,o[11]=0,o[12]=-w.dot(c,t),o[13]=-w.dot(l,t),o[14]=-w.dot(u,t),o[15]=1},i.ortho=function(t,e,r,n,o,c,l){var u=l.elements,h=1/(t-e),f=1/(r-n),d=1/(o-c);u[0]=-2*h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*f,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*d,u[11]=0,u[12]=(t+e)*h,u[13]=(n+r)*f,u[14]=(c+o)*d,u[15]=1},i.perspective=function(t,e,r,n,o){var c=o.elements,l=1/Math.tan(t/2),u=1/(r-n);c[0]=l/e,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=l,c[6]=0,c[7]=0,c[8]=0,c[9]=0,c[10]=(n+r)*u,c[11]=-1,c[12]=0,c[13]=0,c[14]=2*n*r*u,c[15]=0},i.rotateAxisAngle=function(t,e,r,n){var o=e.x,c=e.y,l=e.z,u=Math.sqrt(o*o+c*c+l*l);if(!(Math.abs(u)<N.zeroTolerance)){var h=t.elements,f=n.elements,d,_,p;u=1/u,o*=u,c*=u,l*=u,d=Math.sin(r),_=Math.cos(r),p=1-_;var v=h[0],g=h[1],m=h[2],y=h[3],A=h[4],S=h[5],C=h[6],P=h[7],R=h[8],T=h[9],E=h[10],D=h[11],B=o*o*p+_,O=c*o*p+l*d,G=l*o*p-c*d,L=o*c*p-l*d,W=c*c*p+_,K=l*c*p+o*d,Y=o*l*p+c*d,U=c*l*p-o*d,j=l*l*p+_;f[0]=v*B+A*O+R*G,f[1]=g*B+S*O+T*G,f[2]=m*B+C*O+E*G,f[3]=y*B+P*O+D*G,f[4]=v*L+A*W+R*K,f[5]=g*L+S*W+T*K,f[6]=m*L+C*W+E*K,f[7]=y*L+P*W+D*K,f[8]=v*Y+A*U+R*j,f[9]=g*Y+S*U+T*j,f[10]=m*Y+C*U+E*j,f[11]=y*Y+P*U+D*j,t!==n&&(f[12]=h[12],f[13]=h[13],f[14]=h[14],f[15]=h[15])}},i.scale=function(t,e,r){var n=t.elements,o=r.elements,c=e.x,l=e.y,u=e.z;o[0]=n[0]*c,o[1]=n[1]*c,o[2]=n[2]*c,o[3]=n[3]*c,o[4]=n[4]*l,o[5]=n[5]*l,o[6]=n[6]*l,o[7]=n[7]*l,o[8]=n[8]*u,o[9]=n[9]*u,o[10]=n[10]*u,o[11]=n[11]*u,o[12]=n[12],o[13]=n[13],o[14]=n[14],o[15]=n[15]},i.translate=function(t,e,r){var n=t.elements,o=r.elements,c=e.x,l=e.y,u=e.z;if(t===r)o[12]=n[0]*c+n[4]*l+n[8]*u+n[12],o[13]=n[1]*c+n[5]*l+n[9]*u+n[13],o[14]=n[2]*c+n[6]*l+n[10]*u+n[14],o[15]=n[3]*c+n[7]*l+n[11]*u+n[15];else{var h=n[0],f=n[1],d=n[2],_=n[3],p=n[4],v=n[5],g=n[6],m=n[7],y=n[8],A=n[9],S=n[10],C=n[11];o[0]=h,o[1]=f,o[2]=d,o[3]=_,o[4]=p,o[5]=v,o[6]=g,o[7]=m,o[8]=y,o[9]=A,o[10]=S,o[11]=C,o[12]=h*c+p*l+y*u+n[12],o[13]=f*c+v*l+A*u+n[13],o[14]=d*c+g*l+S*u+n[14],o[15]=_*c+m*l+C*u+n[15]}},i.transpose=function(t,e){var r=t.elements,n=e.elements;if(e===t){var o=r[1],c=r[2],l=r[3],u=r[6],h=r[7],f=r[11];n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=o,n[6]=r[9],n[7]=r[13],n[8]=c,n[9]=u,n[11]=r[14],n[12]=l,n[13]=h,n[14]=f}else n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15]};function i(a,t,e,r,n,o,c,l,u,h,f,d,_,p,v,g){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),n===void 0&&(n=0),o===void 0&&(o=1),c===void 0&&(c=0),l===void 0&&(l=0),u===void 0&&(u=0),h===void 0&&(h=0),f===void 0&&(f=1),d===void 0&&(d=0),_===void 0&&(_=0),p===void 0&&(p=0),v===void 0&&(v=0),g===void 0&&(g=1),this.elements=new Float32Array(16);var m=this.elements;m[0]=a,m[1]=t,m[2]=e,m[3]=r,m[4]=n,m[5]=o,m[6]=c,m[7]=l,m[8]=u,m[9]=h,m[10]=f,m[11]=d,m[12]=_,m[13]=p,m[14]=v,m[15]=g}var s=i.prototype;return s.setValue=function(t,e,r,n,o,c,l,u,h,f,d,_,p,v,g,m){var y=this.elements;return y[0]=t,y[1]=e,y[2]=r,y[3]=n,y[4]=o,y[5]=c,y[6]=l,y[7]=u,y[8]=h,y[9]=f,y[10]=d,y[11]=_,y[12]=p,y[13]=v,y[14]=g,y[15]=m,this},s.setValueByArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,n=0;n<16;n++)r[n]=t[n+e];return this},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},s.clone=function(){var t=this.elements,e=new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},s.cloneTo=function(t){var e=this.elements,r=t.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],t},s.multiply=function(t){return i.multiply(this,t,this),this},s.determinant=function(){var t=this.elements,e=t[0],r=t[1],n=t[2],o=t[3],c=t[4],l=t[5],u=t[6],h=t[7],f=t[8],d=t[9],_=t[10],p=t[11],v=t[12],g=t[13],m=t[14],y=t[15],A=e*l-r*c,S=e*u-n*c,C=e*h-o*c,P=r*u-n*l,R=r*h-o*l,T=n*h-o*u,E=f*g-d*v,D=f*m-_*v,B=f*y-p*v,O=d*m-_*g,G=d*y-p*g,L=_*y-p*m;return A*L-S*G+C*O+P*B-R*D+T*E},s.decompose=function(t,e,r){var n=i._tempMat30,o=this.elements,c=n.elements,l=o[0],u=o[1],h=o[2],f=o[3],d=o[4],_=o[5],p=o[6],v=o[7],g=o[8],m=o[9],y=o[10],A=o[11];t.x=o[12],t.y=o[13],t.z=o[14];var S=Math.sign(l*u*h*f)<0?-1:1,C=Math.sign(d*_*p*v)<0?-1:1,P=Math.sign(g*m*y*A)<0?-1:1,R=S*Math.sqrt(l*l+u*u+h*h),T=C*Math.sqrt(d*d+_*_+p*p),E=P*Math.sqrt(g*g+m*m+y*y);if(r.x=R,r.y=T,r.z=E,Math.abs(R)<N.zeroTolerance||Math.abs(T)<N.zeroTolerance||Math.abs(E)<N.zeroTolerance)return e.identity(),!1;var D=1/R,B=1/T,O=1/E;return c[0]=l*D,c[1]=u*D,c[2]=h*D,c[3]=d*B,c[4]=_*B,c[5]=p*B,c[6]=g*O,c[7]=m*O,c[8]=y*O,Se.rotationMatrix3x3(n,e),!0},s.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>N.zeroTolerance){var n=Math.sqrt(r+1)*2;t.w=.25*n,t.x=(e[6]-e[9])/n,t.y=(e[8]-e[2])/n,t.z=(e[1]-e[4])/n}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t.w=(e[6]-e[9])/o,t.x=.25*o,t.y=(e[1]+e[4])/o,t.z=(e[8]+e[2])/o}else if(e[5]>e[10]){var c=Math.sqrt(1+e[5]-e[0]-e[10])*2;t.w=(e[8]-e[2])/c,t.x=(e[1]+e[4])/c,t.y=.25*c,t.z=(e[6]+e[9])/c}else{var l=Math.sqrt(1+e[10]-e[0]-e[5])*2;t.w=(e[1]-e[4])/l,t.x=(e[8]+e[2])/l,t.y=(e[6]+e[9])/l,t.z=.25*l}return t},s.getScaling=function(t){var e=this.elements,r=e[0],n=e[1],o=e[2],c=e[4],l=e[5],u=e[6],h=e[8],f=e[9],d=e[10];return t.x=Math.sqrt(r*r+n*n+o*o),t.y=Math.sqrt(c*c+l*l+u*u),t.z=Math.sqrt(h*h+f*f+d*d),t},s.getTranslation=function(t){var e=this.elements;return t.x=e[12],t.y=e[13],t.z=e[14],t},s.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},s.invert=function(){return i.invert(this,this),this},s.rotateAxisAngle=function(t,e){return i.rotateAxisAngle(this,t,e,this),this},s.scale=function(t){return i.scale(this,t,this),this},s.translate=function(t){return i.translate(this,t,this),this},s.transpose=function(){return i.transpose(this,this),this},i}();ie._tempVec30=new w;ie._tempVec31=new w;ie._tempVec32=new w;ie._tempMat30=new Vr;ie._identity=new ie(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var Kc=function(){function i(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.origin=new w,this.direction=new w,a&&a.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var s=i.prototype;return s.intersectPlane=function(t){return Sr.intersectsRayAndPlane(this,t)},s.intersectSphere=function(t){return Sr.intersectsRayAndSphere(this,t)},s.intersectBox=function(t){return Sr.intersectsRayAndBox(this,t)},s.getPoint=function(t,e){return w.scale(this.direction,t,e),e.add(this.origin)},i}(),H=function(){i.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y},i.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y},i.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y},i.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y},i.dot=function(t,e){return t.x*e.x+t.y*e.y},i.distance=function(t,e){var r=e.x-t.x,n=e.y-t.y;return Math.sqrt(r*r+n*n)},i.distanceSquared=function(t,e){var r=e.x-t.x,n=e.y-t.y;return r*r+n*n},i.equals=function(t,e){return N.equals(t.x,e.x)&&N.equals(t.y,e.y)},i.lerp=function(t,e,r,n){var o=t.x,c=t.y;n.x=o+(e.x-o)*r,n.y=c+(e.y-c)*r},i.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y)},i.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y)},i.negate=function(t,e){e.x=-t.x,e.y=-t.y},i.normalize=function(t,e){var r=t.x,n=t.y,o=Math.sqrt(r*r+n*n);o>N.zeroTolerance&&(o=1/o,e.x=r*o,e.y=n*o)},i.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e};function i(a,t){a===void 0&&(a=0),t===void 0&&(t=0),this.x=void 0,this.y=void 0,this.x=a,this.y=t}var s=i.prototype;return s.setValue=function(t,e){return this.x=t,this.y=e,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this},s.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},s.lengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},s.negate=function(){return this.x=-this.x,this.y=-this.y,this},s.normalize=function(){return i.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y},s.clone=function(){return new i(this.x,this.y)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t},i}();H._zero=new H(0,0);H._one=new H(1,1);var ze=function(){i.add=function(t,e,r){r.x=t.x+e.x,r.y=t.y+e.y,r.z=t.z+e.z,r.w=t.w+e.w},i.subtract=function(t,e,r){r.x=t.x-e.x,r.y=t.y-e.y,r.z=t.z-e.z,r.w=t.w-e.w},i.multiply=function(t,e,r){r.x=t.x*e.x,r.y=t.y*e.y,r.z=t.z*e.z,r.w=t.w*e.w},i.divide=function(t,e,r){r.x=t.x/e.x,r.y=t.y/e.y,r.z=t.z/e.z,r.w=t.w/e.w},i.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},i.distance=function(t,e){var r=e.x-t.x,n=e.y-t.y,o=e.z-t.z,c=e.w-t.w;return Math.sqrt(r*r+n*n+o*o+c*c)},i.distanceSquared=function(t,e){var r=e.x-t.x,n=e.y-t.y,o=e.z-t.z,c=e.w-t.w;return r*r+n*n+o*o+c*c},i.equals=function(t,e){return N.equals(t.x,e.x)&&N.equals(t.y,e.y)&&N.equals(t.z,e.z)&&N.equals(t.w,e.w)},i.lerp=function(t,e,r,n){var o=t.x,c=t.y,l=t.z,u=t.w;n.x=o+(e.x-o)*r,n.y=c+(e.y-c)*r,n.z=l+(e.z-l)*r,n.w=u+(e.w-u)*r},i.max=function(t,e,r){r.x=Math.max(t.x,e.x),r.y=Math.max(t.y,e.y),r.z=Math.max(t.z,e.z),r.w=Math.max(t.w,e.w)},i.min=function(t,e,r){r.x=Math.min(t.x,e.x),r.y=Math.min(t.y,e.y),r.z=Math.min(t.z,e.z),r.w=Math.min(t.w,e.w)},i.negate=function(t,e){e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w},i.normalize=function(t,e){var r=t.x,n=t.y,o=t.z,c=t.w,l=Math.sqrt(r*r+n*n+o*o+c*c);l>N.zeroTolerance&&(l=1/l,e.x=r*l,e.y=n*l,e.z=o*l,e.w=c*l)},i.scale=function(t,e,r){r.x=t.x*e,r.y=t.y*e,r.z=t.z*e,r.w=t.w*e},i.transform=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w,u=e.elements;r.x=n*u[0]+o*u[4]+c*u[8]+l*u[12],r.y=n*u[1]+o*u[5]+c*u[9]+l*u[13],r.z=n*u[2]+o*u[6]+c*u[10]+l*u[14],r.w=n*u[3]+o*u[7]+c*u[11]+l*u[15]},i.transformByQuat=function(t,e,r){var n=t.x,o=t.y,c=t.z,l=t.w,u=e.x,h=e.y,f=e.z,d=e.w,_=d*n+h*c-f*o,p=d*o+f*n-u*c,v=d*c+u*o-h*n,g=-u*n-h*o-f*c;r.x=_*d-g*u-p*f+v*h,r.y=p*d-g*h-v*u+_*f,r.z=v*d-g*f-_*h+p*u,r.w=l};function i(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.z=void 0,this.w=void 0,this.x=a,this.y=t,this.z=e,this.w=r}var s=i.prototype;return s.setValue=function(t,e,r,n){return this.x=t,this.y=e,this.z=r,this.w=n,this},s.setValueByArray=function(t,e){return e===void 0&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},s.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},s.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},s.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},s.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},s.length=function(){var t=this.x,e=this.y,r=this.z,n=this.w;return Math.sqrt(t*t+e*e+r*r+n*n)},s.lengthSquared=function(){var t=this.x,e=this.y,r=this.z,n=this.w;return t*t+e*e+r*r+n*n},s.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},s.normalize=function(){return i.normalize(this,this),this},s.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},s.toArray=function(t,e){e===void 0&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w},s.clone=function(){var t=new i(this.x,this.y,this.z,this.w);return t},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w,t},i}();ze._zero=new ze(0,0,0,0);ze._one=new ze(1,1,1,1);var ne=function(){i.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},i.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},i.equals=function(t,e){return N.equals(t.r,e.r)&&N.equals(t.g,e.g)&&N.equals(t.b,e.b)&&N.equals(t.a,e.a)},i.add=function(t,e,r){return r.r=t.r+e.r,r.g=t.g+e.g,r.b=t.b+e.b,r.a=t.a+e.a,r},i.scale=function(t,e,r){return r.r=t.r*e,r.g=t.g*e,r.b=t.b*e,r.a=t.a*e,r};function i(a,t,e,r){a===void 0&&(a=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=a,this.g=t,this.b=e,this.a=r}var s=i.prototype;return s.setValue=function(t,e,r,n){return this.r=t,this.g=e,this.b=r,this.a=n,this},s.add=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},s.scale=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},s.clone=function(){var t=new i(this.r,this.g,this.b,this.a);return t},s.cloneTo=function(t){return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t},s.toLinear=function(t){return t.r=i.gammaToLinearSpace(this.r),t.g=i.gammaToLinearSpace(this.g),t.b=i.gammaToLinearSpace(this.b),t},s.toGamma=function(t){return t.r=i.linearToGammaSpace(this.r),t.g=i.linearToGammaSpace(this.g),t.b=i.linearToGammaSpace(this.b),t},i}(),vn=function(){function i(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=a,this.y=t,this.width=e,this.height=r}var s=i.prototype;return s.setValue=function(t,e,r,n){return this.x=t,this.y=e,this.width=r,this.height=n,this},s.clone=function(){return new i(this.x,this.y,this.width,this.height)},s.cloneTo=function(t){return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t},i}(),qc=function(){function i(){this.coefficients=new Float32Array(27)}var s=i.prototype;return s.addLight=function(t,e,r){e.scale(r);var n=this.coefficients,o=t.x,c=t.y,l=t.z,u=e.r,h=e.g,f=e.b,d=.282095,_=-.488603*c,p=.488603*l,v=-.488603*o,g=1.092548*(o*c),m=-1.092548*(c*l),y=.315392*(3*l*l-1),A=-1.092548*(o*l),S=.546274*(o*o-c*c);n[0]+=u*d,n[1]+=h*d,n[2]+=f*d,n[3]+=u*_,n[4]+=h*_,n[5]+=f*_,n[6]+=u*p,n[7]+=h*p,n[8]+=f*p,n[9]+=u*v,n[10]+=h*v,n[11]+=f*v,n[12]+=u*g,n[13]+=h*g,n[14]+=f*g,n[15]+=u*m,n[16]+=h*m,n[17]+=f*m,n[18]+=u*y,n[19]+=h*y,n[20]+=f*y,n[21]+=u*A,n[22]+=h*A,n[23]+=f*A,n[24]+=u*S,n[25]+=h*S,n[26]+=f*S},s.evaluate=function(t,e){var r=this.coefficients,n=t.x,o=t.y,c=t.z,l=.886227,u=-1.023327*o,h=1.023327*c,f=-1.023327*n,d=.858086*o*n,_=-.858086*o*c,p=.247708*(3*c*c-1),v=-.858086*c*n,g=.429042*(n*n-o*o),m=r[0]*l,y=r[1]*l,A=r[2]*l;return m+=r[3]*u+r[6]*h+r[9]*f,y+=r[4]*u+r[7]*h+r[10]*f,A+=r[5]*u+r[8]*h+r[11]*f,m+=r[12]*d+r[15]*_+r[18]*p+r[21]*v+r[24]*g,y+=r[13]*d+r[16]*_+r[19]*p+r[22]*v+r[25]*g,A+=r[14]*d+r[17]*_+r[20]*p+r[23]*v+r[26]*g,e.setValue(m,y,A,1),e},s.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},s.setValueByArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},s.toArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},s.clone=function(){var t=new i;return this.cloneTo(t),t},s.cloneTo=function(t){return this.toArray(t.coefficients),t},i}();function kn(i,s){var a=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);s&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),a.push.apply(a,t)}return a}function Gn(i){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?kn(Object(a),!0).forEach(function(t){Yc(i,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):kn(Object(a)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(a,t))})}return i}function Hn(i,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Z(i,s,a){return s&&Hn(i.prototype,s),a&&Hn(i,a),i}function Yc(i,s,a){return s in i?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,i}function _i(){return _i=Object.assign||function(i){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(i[t]=a[t])}return i},_i.apply(this,arguments)}function ee(i,s){i.prototype=Object.create(s.prototype),i.prototype.constructor=i,vi(i,s)}function pn(i){return pn=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},pn(i)}function vi(i,s){return vi=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},vi(i,s)}function Qc(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ki(i,s,a){return Qc()?ki=Reflect.construct:ki=function(e,r,n){var o=[null];o.push.apply(o,r);var c=Function.bind.apply(e,o),l=new c;return n&&vi(l,n.prototype),l},ki.apply(null,arguments)}function $c(i){return Function.toString.call(i).indexOf("[native code]")!==-1}function gn(i){var s=typeof Map=="function"?new Map:void 0;return gn=function(t){if(t===null||!$c(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof s!="undefined"){if(s.has(t))return s.get(t);s.set(t,e)}function e(){return ki(t,arguments,pn(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),vi(e,t)},gn(i)}function F(i){if(i===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return i}function Zc(i,s){if(!!i){if(typeof i=="string")return Wn(i,s);var a=Object.prototype.toString.call(i).slice(8,-1);if(a==="Object"&&i.constructor&&(a=i.constructor.name),a==="Map"||a==="Set")return Array.from(i);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Wn(i,s)}}function Wn(i,s){(s==null||s>i.length)&&(s=i.length);for(var a=0,t=new Array(s);a<s;a++)t[a]=i[a];return t}function Jc(i,s){var a=typeof Symbol!="undefined"&&i[Symbol.iterator]||i["@@iterator"];if(a)return(a=a.call(i)).next.bind(a);if(Array.isArray(i)||(a=Zc(i))||s&&i&&typeof i.length=="number"){a&&(i=a);var t=0;return function(){return t>=i.length?{done:!0}:{done:!1,value:i[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function V(i,s,a,t){!a||Object.defineProperty(i,s,{enumerable:a.enumerable,configurable:a.configurable,writable:a.writable,value:a.initializer?a.initializer.call(t):void 0})}function k(i,s,a,t,e){var r={};return Object.keys(t).forEach(function(n){r[n]=t[n]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(n,o){return o(i,s,n)||n},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(i,s,r),r=null),r}function el(i,s){var a=i.indexOf(s);if(a<0)return!1;var t=i.length-1;if(a!==t){var e=i[t];i[a]=e}return i.length--,!0}function pi(i){return Object.keys(i).map(function(s){return i[s]})}var Gr;(function(i){i[i.Success=0]="Success",i[i.Pending=1]="Pending",i[i.Failed=2]="Failed"})(Gr||(Gr={}));var st=function(i){ee(a,i),a.all=function(e){return new a(function(r,n,o){if(!Array.isArray(e))return r([e]);var c=0,l=e.length,u=new Array(l);e.forEach(function(h,f){Promise.resolve(h).then(function(d){u[f]=d,c+=1,o(c/l),c==l&&r(u)}).catch(function(d){return n(d)})})})};var s=a.prototype;s.onProgress=function(e){return this._listeners.add(e),this},s.cancel=function(){return this._status!==Gr.Pending?this:(this._reject("Promise Canceled"),this)};function a(t){var e,r,n=function(c){if(!(c<=e._progress)){e._progress=c;for(var l=Jc(e._listeners),u;!(u=l()).done;){var h=u.value;h(c)}}};return e=i.call(this,function(o,c){r=function(u){Promise.resolve().then(function(){e._status=Gr.Failed,c(u)})},t(function(l){Promise.resolve().then(function(){n(1),e._status=Gr.Success,o(l)})},r,function(l){Promise.resolve().then(function(){n(l)})})})||this,e._status=void 0,e._progress=void 0,e._reject=void 0,e._listeners=void 0,e._reject=r,e._listeners=new Set,e._progress=0,e._status=Gr.Pending,e}return Z(a,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),a}(gn(Promise)),Ji=function(){i._addLoader=function(t,e,r){this._loaders[t]=e;for(var n=0,o=r.length;n<o;n++)this._extTypeMapping[r[n]]=t},i._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1)]};function i(a){this.engine=a,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}var s=i.prototype;return s.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(n){return e._loadSingleItem(n)});return st.all(r)},s.cancelNotLoaded=function(t){var e=this;if(!t)pi(this._loadingPromises).forEach(function(n){n.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])===null||r===void 0||r.cancel()}else t.forEach(function(n){var o;(o=e._loadingPromises[n])===null||o===void 0||o.cancel()})},s.gc=function(){this._gc(!1)},s.getAssetPath=function(t){return this._assetPool[t]},s._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},s._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},s._addRefObject=function(t,e){this._refObjectPool[t]=e},s._deleteRefObject=function(t){delete this._refObjectPool[t]},s._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},s._assignDefaultOptions=function(t){var e,r,n,o,c;if(t.type=(e=t.type)!=null?e:i._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;return t.retryCount=(r=t.retryCount)!=null?r:this.retryCount,t.timeout=(n=t.timeout)!=null?n:this.timeout,t.retryInterval=(o=t.retryInterval)!=null?o:this.retryInterval,t.url=(c=t.url)!=null?c:t.urls.join(","),t},s._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),n=r.url;if(this._assetUrlPool[n])return new st(function(l){l(e._assetUrlPool[n])});if(this._loadingPromises[n])return this._loadingPromises[r.url];var o=i._loaders[r.type],c=o.load(r,this);return this._loadingPromises[n]=c,c.then(function(l){o.useCache&&e._addAsset(n,l),delete e._loadingPromises[n]}).catch(function(l){Promise.reject(l),delete e._loadingPromises[n]}),c},s._gc=function(t){for(var e=pi(this._refObjectPool),r=0,n=e.length;r<n;r++)(!e[r].isGCIgnored||t)&&e[r].destroy()},i}();Ji._loaders={};Ji._extTypeMapping={};function Jt(i,s,a){return a===void 0&&(a=!0),function(t){var e=new t(a);Ji._addLoader(i,e,s)}}var Xn=function(){function i(a,t,e,r){t===void 0&&(t=null),e===void 0&&(e={}),r===void 0&&(r=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=new Date().getTime(),this._target=t,this.data=e,this._currentTarget=null,this._bubbles=r,this._propagationStopped=!1,this._type=a}var s=i.prototype;return s.stopPropagation=function(){this._propagationStopped=!0},Z(i,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(t){this._target=t}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(t){this._currentTarget=t}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),i}(),Yt;(function(i){i[i.Ignore=0]="Ignore",i[i.Assignment=1]="Assignment",i[i.Shallow=2]="Shallow",i[i.Deep=3]="Deep"})(Yt||(Yt={}));function J(i,s){wt.registerCloneMode(i,s,Yt.Ignore)}function Bt(i,s){wt.registerCloneMode(i,s,Yt.Assignment)}function tl(i,s){wt.registerCloneMode(i,s,Yt.Shallow)}function Ee(i,s){wt.registerCloneMode(i,s,Yt.Deep)}var wt=function(){function i(){}return i.registerCloneMode=function(a,t,e){var r=i._subCloneModeMap.get(a.constructor);r||(r=Object.create(null),i._subCloneModeMap.set(a.constructor,r)),r[t]=e},i.getCloneMode=function(a){var t=i._cloneModeMap.get(a);if(!t){t=Object.create(null),i._cloneModeMap.set(a,t);for(var e=i._objectType,r=i._subCloneModeMap;a!==e;){var n=r.get(a);n&&_i(t,n),a=Object.getPrototypeOf(a)}}return t},i.deepCloneObject=function(a,t){var e=a.constructor;switch(e){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:t.set(a);break;case Array:for(var r=0,n=a.length;r<n;r++)i._deepCloneObjectItem(a,t,r);break;default:var o=a;if(o.clone&&o.cloneTo)o.cloneTo(t);else for(var c=Object.keys(a),l=0,u=c.length;l<u;l++)i._deepCloneObjectItem(a,t,c[l])}},i._deepCloneObjectItem=function(a,t,e){var r=a[e];if(r instanceof Object){var n=r.constructor;switch(n){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var o=r,c=t[e];c==null?t[e]=o.slice():c.set(o);break;case Array:var l=r,u=t[e];u==null?t[e]=new Array(l.length):u.length=l.length,i.deepCloneObject(l,u);break;default:if(r.clone&&r.cloneTo){var h=r,f=t[e];f?h.cloneTo(f):t[e]=h.clone()}else{var d=t[e];d==null&&(t[e]=d=new r.constructor),i.deepCloneObject(r,d);break}}}else t[e]=r},i}();wt._subCloneModeMap=new Map;wt._cloneModeMap=new Map;wt._objectType=Object.getPrototypeOf(Object);var cn,jn,rc=(cn=function(){function i(){V(this,"_evts",jn,this),this._evtCount=0}var s=i.prototype;return s.hasEvent=function(t){return this._evts[t]!=null},s.eventNames=function(){return this._evtCount===0?[]:Object.keys(this._evts)},s.listenerCount=function(t){var e=this._evts[t];return e?e.fn?1:e.length:0},s.dispatch=function(t,e){if(!this._evts[t])return!1;var r=this._evts[t];if(r.fn)r.once&&this.removeEventListener(t,r.fn),r.fn(e);else for(var n=r.length,o=0;o<n;o++)r[o].once&&this.removeEventListener(t,r[o].fn),r[o].fn(e);return!0},s.on=function(t,e){return this.addEventListener(t,e)},s.once=function(t,e){return this.addEventListener(t,e,!0)},s.addEventListener=function(t,e,r){var n={fn:e,once:r},o=this._evts;return o[t]?o[t].fn?o[t]=[o[t],n]:o[t].push(n):(o[t]=n,this._evtCount++),this},s.off=function(t,e){if(!this._evts[t])return this;if(!e)return this._clearEvent(t),this;var r=this._evts[t];if(r.fn&&r.fn===e)this._clearEvent(t);else{var n=r.indexOf(e);if(n>-1){var o=r[r.length-1];r[n]=o,r.length--,r.length===1&&(this._evts[t]=r[0])}}return this},s.removeEventListener=function(t,e){return this.off(t,e)},s.removeAllEventListeners=function(t){t?this._evts[t]&&this._clearEvent(t):(this._evts=Object.create(null),this._evtCount=0)},s.trigger=function(t){this.dispatch(t.type,t.data)},s._clearEvent=function(t){--this._evtCount===0?this._evts=Object.create(null):delete this._evts[t]},i}(),jn=k(cn.prototype,"_evts",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),cn),rr=function(s){},rl=console.log.bind(console),il=console.info.bind(console),nl=console.warn.bind(console),al=console.error.bind(console),pt={debug:rr,info:rr,warn:rr,error:rr,isEnabled:!1,enable:function(){this.debug=rl,this.info=il,this.warn=nl,this.error=al,this.isEnabled=!0},disable:function(){this.debug=rr,this.info=rr,this.warn=rr,this.error=rr,this.isEnabled=!1}},ol=function(){function i(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var a=this._clock.now();this._startTime=a,this._lastTickTime=a}var s=i.prototype;return s.reset=function(){this._lastTickTime=this._clock.now()},s.tick=function(){var t=this.nowTime;this._deltaTime=(t-this._lastTickTime)*this._timeScale,this._lastTickTime=t},Z(i,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){this._timeScale=t}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),i}(),Ii,Kn,qn,Yn,Qn,dr=(Ii=(Qn=Yn=function(){function i(a){V(this,"instanceId",Kn,this),V(this,"_engine",qn,this),this._destroyed=!1,this._engine=a}var s=i.prototype;return s.destroy=function(){var t;this._destroyed||((t=this._engine.resourceManager)===null||t===void 0||t._deleteAsset(this),this._destroyed=!0)},Z(i,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),i}(),Yn._instanceIdCounter=0,Qn),Kn=k(Ii.prototype,"instanceId",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++dr._instanceIdCounter}}),qn=k(Ii.prototype,"_engine",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ii),Be;(function(i){i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT=5124]="INT",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.FLOAT_ARRAY=35677]="FLOAT_ARRAY",i[i.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",i[i.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",i[i.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",i[i.INT_ARRAY=100003]="INT_ARRAY",i[i.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",i[i.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",i[i.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",i[i.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",i[i.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",i[i.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",i[i.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",i[i.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT"})(Be||(Be={}));var Q;(function(i){i.shaderVertexID="shaderVertexID",i.standardDerivatives="OES_standard_derivatives",i.shaderTextureLod="EXT_shader_texture_lod",i.elementIndexUint="OES_element_index_uint",i.depthTexture="WEBGL_depth_texture",i.drawBuffers="WEBGL_draw_buffers",i.vertexArrayObject="OES_vertex_array_object",i.instancedArrays="ANGLE_instanced_arrays",i.multipleSample="multipleSampleOnlySupportedInWebGL2",i.textureFloat="OES_texture_float",i.textureFloatLinear="OES_texture_float_linear",i.textureHalfFloat="OES_texture_half_float",i.textureHalfFloatLinear="OES_texture_half_float_linear",i.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",i.colorBufferFloat="EXT_color_buffer_float",i.colorBufferHalfFloat="EXT_color_buffer_half_float",i.textureFilterAnisotropic="EXT_texture_filter_anisotropic",i.blendMinMax="EXT_blend_minmax",i.astc="WEBGL_compressed_texture_astc",i.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",i.etc="WEBGL_compressed_texture_etc",i.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",i.etc1="WEBGL_compressed_texture_etc1",i.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",i.pvrtc="WEBGL_compressed_texture_pvrtc",i.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",i.s3tc="WEBGL_compressed_texture_s3tc",i.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc"})(Q||(Q={}));var Wt=function(){function i(a){a===void 0&&(a=0),this._elements=void 0,this.length=0,this._elements=new Array(a)}var s=i.prototype;return s.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},s.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},s.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},s.deleteByIndex=function(t){var e=this._elements,r=null,n=this.length-1;return t!==n&&(r=e[n],e[t]=r),this.length--,r},s.garbageCollection=function(){this._elements.length=this.length},i}(),ct=function(){function i(){this._mask=[],this._length=0}i.unionCollection=function(t,e,r){var n=r._mask,o,c,l,u;t._length<e._length?(o=t._length,c=e._length,l=t._mask,u=e._mask):(o=e._length,c=t._length,l=e._mask,u=t._mask);var h=0;for(n.length<c&&(n.length=c);h<o;h++)n[h]=l[h]|u[h];for(;h<c;h++)n[h]=u[h];r._length=c};var s=i.prototype;return s.enable=function(t){var e=t._index,r=e+1,n=this._mask,o=this._length;if(o<r){for(n.length<r&&(n.length=r);o<e;o++)n[o]=0;n[e]=t._value,this._length=r}else n[e]|=t._value},s.disable=function(t){var e=t._index,r=this._mask,n=this._length-1;if(!(e>n)){var o=r[e]&~t._value;e==n&&o===0?this._length--:r[e]=o}},s.unionCollection=function(t){var e=t._mask,r=t._length,n=this._mask,o=this._length;if(o<r){n.length<r&&(n.length=r);for(var c=0;c<o;c++)n[c]|=e[c];for(;c<r;c++)n[c]=e[c];this._length=r}else for(var l=0;l<r;l++)n[l]|=e[l]},s.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,n=this._length-1,o=Math.min(t._length-1,n);o>=0;o--){var c=r[o]&~e[o];o==n&&c===0?(n--,this._length--):r[o]=c}},s.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,n=this._length-1;n>=0;n--){var o=r[n]&e[n];o==0&&n==this._length-1?this._length--:r[n]=o}},s.isEnable=function(t){var e=t._index;return e>=this._length?!1:(this._mask[e]&t._value)!==0},s.clear=function(){this._length=0},i}(),Cn=function(){function i(){this._onStartScripts=new Wt,this._onUpdateScripts=new Wt,this._onLateUpdateScripts=new Wt,this._destroyComponents=[],this._onUpdateAnimations=new Wt,this._renderers=new Wt,this._onUpdateRenderers=new Wt,this._componentsContainerPool=[],this._colliders=new Wt}var s=i.prototype;return s.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},s.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},s.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},s.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},s.addCollider=function(t){t._index=this._colliders.length,this._colliders.add(t)},s.removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1},s.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},s.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},s.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},s.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},s.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},s.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},s.addDestroyComponent=function(t){this._destroyComponents.push(t)},s.callScriptOnStart=function(){var t=this._onStartScripts;if(t.length>0){for(var e=t._elements,r=0;r<t.length;r++){var n=e[r];n._started=!0,n._onStartIndex=-1,n.onStart()}t.length=0}},s.callScriptOnUpdate=function(t){for(var e=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var n=e[r];n._started&&n.onUpdate(t)}},s.callScriptOnLateUpdate=function(t){for(var e=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var n=e[r];n._started&&n.onLateUpdate(t)}},s.callAnimationUpdate=function(t){for(var e=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)e[r].update(t)},s.callRendererOnUpdate=function(t){for(var e=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)e[r].update(t)},s.callRender=function(t){for(var e=t._camera,r=this._renderers._elements,n=this._renderers.length-1;n>=0;--n){var o=r[n];if(!!(e.cullingMask&o._entity.layer)&&!(e.enableFrustumCulling&&(o.isCulled=!e._frustum.intersectsBox(o.bounds),o.isCulled))){var c=e.entity.transform,l=c.worldPosition,u=o.bounds.getCenter(i._tempVector0);if(e.isOrthographic){var h=c.getWorldForward(i._tempVector1);w.subtract(u,l,u),o._distanceForSort=w.dot(u,h)}else o._distanceForSort=w.distanceSquared(u,l);o._updateShaderData(t),o._render(e),ct.unionCollection(e._globalShaderMacro,o.shaderData._macroCollection,o._globalShaderMacro)}}},s.callComponentDestroy=function(){var t=this._destroyComponents,e=t.length;if(e>0){for(var r=e-1;r>=0;--r)t[r].onDestroy();t.length=0}},s.callCameraOnBeginRender=function(t){for(var e=t.entity._components,r=e.length-1;r>=0;--r){var n=e[r];n.onBeginRender&&n.onBeginRender(t)}},s.callCameraOnEndRender=function(t){for(var e=t.entity._components,r=e.length-1;r>=0;--r){var n=e[r];n.onEndRender&&n.onEndRender(t)}},s.callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},s.callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},s.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},s.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},i}();Cn._tempVector0=new w;Cn._tempVector1=new w;var sl=function(){function i(){}return i.cloneComponent=function(a,t){for(var e=wt.getCloneMode(a.constructor),r=Object.keys(a),n=0,o=r.length;n<o;n++){var c=r[n],l=e[c];switch(l){case void 0:case Yt.Assignment:t[c]=a[c];break;case Yt.Shallow:var u=a[c];if(u instanceof Object){var h=t[c];h==null&&(h=t[c]=u.constructor()),_i(h,u)}else t[c]=u;break;case Yt.Deep:var f=a[c];if(f instanceof Object){var d=t[c];d==null&&(d=t[c]=f.constructor()),wt.deepCloneObject(f,d)}else t[c]=f;break}}a._cloneTo&&a._cloneTo(t)},i}(),gi=function(){i.register=function(a,t){this._addDependency(a,t,this._dependenciesMap),this._addDependency(t,a,this._invDependenciesMap)},i._addCheck=function(a,t){var e=i._dependenciesMap.get(t);if(e){for(var r=0,n=e.length;r<n;r++)if(!a.getComponent(e[r]))throw"you should add "+e[r]+" before adding "+t}},i._removeCheck=function(a,t){var e=i._invDependenciesMap.get(t);if(e){for(var r=0,n=e.length;r<n;r++)if(a.getComponent(e[r]))throw"you should remove "+e[r]+" before adding "+t}},i._addDependency=function(a,t,e){var r=e.get(a);r||(r=[],e.set(a,r)),r.indexOf(t)===-1&&r.push(t)};function i(){}return i}();gi._dependenciesMap=new Map;gi._invDependenciesMap=new Map;function cl(){for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];return function(t){s.forEach(function(e){return gi.register(t,e)})}}var ht;(function(i){i[i.Layer0=1]="Layer0",i[i.Layer1=2]="Layer1",i[i.Layer2=4]="Layer2",i[i.Layer3=8]="Layer3",i[i.Layer4=16]="Layer4",i[i.Layer5=32]="Layer5",i[i.Layer6=64]="Layer6",i[i.Layer7=128]="Layer7",i[i.Layer8=256]="Layer8",i[i.Layer9=512]="Layer9",i[i.Layer10=1024]="Layer10",i[i.Layer11=2048]="Layer11",i[i.Layer12=4096]="Layer12",i[i.Layer13=8192]="Layer13",i[i.Layer14=16384]="Layer14",i[i.Layer15=32768]="Layer15",i[i.Layer16=65536]="Layer16",i[i.Layer17=131072]="Layer17",i[i.Layer18=262144]="Layer18",i[i.Layer19=524288]="Layer19",i[i.Layer20=1048576]="Layer20",i[i.Layer21=2097152]="Layer21",i[i.Layer22=4194304]="Layer22",i[i.Layer23=8388608]="Layer23",i[i.Layer24=16777216]="Layer24",i[i.Layer25=33554432]="Layer25",i[i.Layer26=67108864]="Layer26",i[i.Layer27=134217728]="Layer27",i[i.Layer28=268435456]="Layer28",i[i.Layer29=536870912]="Layer29",i[i.Layer30=1073741824]="Layer30",i[i.Layer31=2147483648]="Layer31",i[i.Everything=4294967295]="Everything",i[i.Nothing=0]="Nothing"})(ht||(ht={}));var Lr,$n,Zn,Jn,ea,Mt=(Lr=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t.engine)||this,V(e,"_entity",$n,F(e)),V(e,"_destroyed",Zn,F(e)),V(e,"_enabled",Jn,F(e)),V(e,"_awoken",ea,F(e)),e._entity=t,e}var a=s.prototype;return a.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&(this._enabled&&this._onDisable(),this._onInActive()),this._destroyed=!0,this._onDestroy())},a._onAwake=function(){},a._onEnable=function(){},a._onDisable=function(){},a._onDestroy=function(){},a._onActive=function(){},a._onInActive=function(){},a._setActive=function(e){e?(this._awoken||(this._awoken=!0,this._onAwake()),this._entity._isActiveInHierarchy&&(this._onActive(),this._enabled&&this._onEnable())):(this._enabled&&this._onDisable(),this._onInActive())},Z(s,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),s}(dr),$n=k(Lr.prototype,"_entity",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zn=k(Lr.prototype,"_destroyed",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jn=k(Lr.prototype,"_enabled",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ea=k(Lr.prototype,"_awoken",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lr),ll=function(){function i(a){a===void 0&&(a=[]),this._flags=a,this.flag=!0,this._flags.push(this)}var s=i.prototype;return s.destroy=function(){var t=this._flags;el(t,this),this._flags=null},i}(),bi=function(){function i(){this._updateFlags=[]}var s=i.prototype;return s.register=function(){return new ll(this._updateFlags)},s.distribute=function(){for(var t=this._updateFlags,e=t.length-1;e>=0;e--)t[e].flag=!0},i}(),Qe,ta,ra,ia,na,aa,oa,sa,ca,la,ua,ha,fa,da,Rt,_a,Ot=(Qe=(_a=Rt=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,V(t,"_position",ta,F(t)),V(t,"_rotation",ra,F(t)),V(t,"_rotationQuaternion",ia,F(t)),V(t,"_scale",na,F(t)),V(t,"_worldPosition",aa,F(t)),V(t,"_worldRotation",oa,F(t)),V(t,"_worldRotationQuaternion",sa,F(t)),V(t,"_lossyWorldScale",ca,F(t)),V(t,"_localMatrix",la,F(t)),V(t,"_worldMatrix",ua,F(t)),V(t,"_updateFlagManager",ha,F(t)),V(t,"_isParentDirty",fa,F(t)),V(t,"_parentTransformCache",da,F(t)),t._dirtyFlag=le.WmWpWeWqWs,t}var a=s.prototype;return a.setPosition=function(e,r,n){this._position.setValue(e,r,n),this.position=this._position},a.setRotation=function(e,r,n){this._rotation.setValue(e,r,n),this.rotation=this._rotation},a.setRotationQuaternion=function(e,r,n,o){this._rotationQuaternion.setValue(e,r,n,o),this.rotationQuaternion=this._rotationQuaternion},a.setScale=function(e,r,n){this._scale.setValue(e,r,n),this.scale=this._scale},a.setWorldPosition=function(e,r,n){this._worldPosition.setValue(e,r,n),this.worldPosition=this._worldPosition},a.setWorldRotation=function(e,r,n){this._worldRotation.setValue(e,r,n),this.worldRotation=this._worldRotation},a.setWorldRotationQuaternion=function(e,r,n,o){this._worldRotationQuaternion.setValue(e,r,n,o),this.worldRotationQuaternion=this._worldRotationQuaternion},a.getWorldForward=function(e){var r=this.worldMatrix.elements;return e.setValue(-r[8],-r[9],-r[10]),e.normalize()},a.getWorldRight=function(e){var r=this.worldMatrix.elements;return e.setValue(r[0],r[1],r[2]),e.normalize()},a.getWorldUp=function(e){var r=this.worldMatrix.elements;return e.setValue(r[4],r[5],r[6]),e.normalize()},a.translate=function(e,r,n,o){if(typeof e=="number"){var c=s._tempVec3;c.setValue(e,r,n),this._translate(c,o)}else this._translate(e,r)},a.rotate=function(e,r,n,o){typeof e=="number"?this._rotateXYZ(e,r,n,o):this._rotateXYZ(e.x,e.y,e.z,r)},a.rotateByAxis=function(e,r,n){n===void 0&&(n=!0);var o=r*N.degreeToRadFactor;Se.rotationAxisAngle(e,o,s._tempQuat0),this._rotateByQuat(s._tempQuat0,n)},a.lookAt=function(e,r){var n,o=this.worldPosition,c=N.zeroTolerance;if(!(Math.abs(o.x-e.x)<c&&Math.abs(o.y-e.y)<c&&Math.abs(o.z-e.z)<c)){var l=s._tempMat43,u=this._worldRotationQuaternion;r=(n=r)!=null?n:s._tempVec3.setValue(0,1,0),ie.lookAt(o,e,r,l),l.getRotation(u).invert(),this.worldRotationQuaternion=u}},a.registerWorldChangeFlag=function(){return this._updateFlagManager.register()},a._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},a._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},a._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(le.WmWp)){this._worldAssociatedChange(le.WmWp);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionFlag()}}},a._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(le.WmWeWq)){this._worldAssociatedChange(le.WmWeWq);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(le.WmWpWeWq)){this._worldAssociatedChange(le.WmWpWeWq);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(le.WmWs)){this._worldAssociatedChange(le.WmWs);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(le.WmWpWs)){this._worldAssociatedChange(le.WmWpWs);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(le.WmWpWeWqWs)){this._worldAssociatedChange(le.WmWpWeWqWs);for(var e=this._entity._children,r=0,n=e.length;r<n;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateAllWorldFlag()}}},a._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var n=r.transform;if(n){e=n;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},a._getScaleMatrix=function(){var e=s._tempQuat0,r=s._tempMat30,n=s._tempMat31,o=s._tempMat32;return n.setValueByMatrix(this.worldMatrix),Se.invert(this.worldRotationQuaternion,e),Vr.rotationQuaternion(e,r),Vr.multiply(r,n,o),o},a._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.distribute()},a._rotateByQuat=function(e,r){r?(Se.multiply(this.rotationQuaternion,e,this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion):(Se.multiply(this.worldRotationQuaternion,e,this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion)},a._translate=function(e,r){r===void 0&&(r=!0),r?this.position=this._position.add(e):this.worldPosition=this._worldPosition.add(e)},a._rotateXYZ=function(e,r,n,o){o===void 0&&(o=!0);var c=N.degreeToRadFactor,l=s._tempQuat0;Se.rotationEuler(e*c,r*c,n*c,l),this._rotateByQuat(l,o)},Z(s,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._setDirtyFlagTrue(le.LocalMatrix),this._updateWorldPositionFlag()}},{key:"worldPosition",get:function(){return this._isContainDirtyFlag(le.WorldPosition)&&(this._getParentTransform()?this.worldMatrix.getTranslation(this._worldPosition):this._position.cloneTo(this._worldPosition),this._setDirtyFlagFalse(le.WorldPosition)),this._worldPosition},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition);var r=this._getParentTransform();r?(ie.invert(r.worldMatrix,s._tempMat41),w.transformCoordinate(e,s._tempMat41,this._position)):e.cloneTo(this._position),this.position=this._position,this._setDirtyFlagFalse(le.WorldPosition)}},{key:"rotation",get:function(){return this._isContainDirtyFlag(le.LocalEuler)&&(this._rotationQuaternion.toEuler(this._rotation),this._rotation.scale(N.radToDegreeFactor),this._setDirtyFlagFalse(le.LocalEuler)),this._rotation},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation),this._setDirtyFlagTrue(le.LocalMatrix|le.LocalQuat),this._setDirtyFlagFalse(le.LocalEuler),this._updateWorldRotationFlag()}},{key:"worldRotation",get:function(){return this._isContainDirtyFlag(le.WorldEuler)&&(this.worldRotationQuaternion.toEuler(this._worldRotation),this._worldRotation.scale(N.radToDegreeFactor),this._setDirtyFlagFalse(le.WorldEuler)),this._worldRotation},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation),Se.rotationEuler(N.degreeToRadian(e.x),N.degreeToRadian(e.y),N.degreeToRadian(e.z),this._worldRotationQuaternion),this.worldRotationQuaternion=this._worldRotationQuaternion,this._setDirtyFlagFalse(le.WorldEuler)}},{key:"rotationQuaternion",get:function(){return this._isContainDirtyFlag(le.LocalQuat)&&(Se.rotationEuler(N.degreeToRadian(this._rotation.x),N.degreeToRadian(this._rotation.y),N.degreeToRadian(this._rotation.z),this._rotationQuaternion),this._setDirtyFlagFalse(le.LocalQuat)),this._rotationQuaternion},set:function(e){this._rotationQuaternion!==e&&e.cloneTo(this._rotationQuaternion),this._setDirtyFlagTrue(le.LocalMatrix|le.LocalEuler),this._setDirtyFlagFalse(le.LocalQuat),this._updateWorldRotationFlag()}},{key:"worldRotationQuaternion",get:function(){if(this._isContainDirtyFlag(le.WorldQuat)){var e=this._getParentTransform();e!=null?Se.multiply(e.worldRotationQuaternion,this.rotationQuaternion,this._worldRotationQuaternion):this.rotationQuaternion.cloneTo(this._worldRotationQuaternion),this._setDirtyFlagFalse(le.WorldQuat)}return this._worldRotationQuaternion},set:function(e){this._worldRotationQuaternion!==e&&e.cloneTo(this._worldRotationQuaternion);var r=this._getParentTransform();r?(Se.invert(r.worldRotationQuaternion,s._tempQuat0),Se.multiply(e,s._tempQuat0,this._rotationQuaternion)):e.cloneTo(this._rotationQuaternion),this.rotationQuaternion=this._rotationQuaternion,this._setDirtyFlagFalse(le.WorldQuat)}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale),this._setDirtyFlagTrue(le.LocalMatrix),this._updateWorldScaleFlag()}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(le.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.setValue(r[0],r[4],r[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(le.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(le.LocalMatrix)&&(ie.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(le.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(le.LocalEuler),this._setDirtyFlagFalse(le.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(le.WorldMatrix)){var e=this._getParentTransform();e?ie.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(le.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var r=this._getParentTransform();r?(ie.invert(r.worldMatrix,s._tempMat42),ie.multiply(e,s._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(le.WorldMatrix)}}]),s}(Mt),Rt._tempQuat0=new Se,Rt._tempVec3=new w,Rt._tempMat30=new Vr,Rt._tempMat31=new Vr,Rt._tempMat32=new Vr,Rt._tempMat40=new ie,Rt._tempMat41=new ie,Rt._tempMat42=new ie,Rt._tempMat43=new ie,_a),ta=k(Qe.prototype,"_position",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),ra=k(Qe.prototype,"_rotation",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),ia=k(Qe.prototype,"_rotationQuaternion",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Se}}),na=k(Qe.prototype,"_scale",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1)}}),aa=k(Qe.prototype,"_worldPosition",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),oa=k(Qe.prototype,"_worldRotation",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),sa=k(Qe.prototype,"_worldRotationQuaternion",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Se}}),ca=k(Qe.prototype,"_lossyWorldScale",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1)}}),la=k(Qe.prototype,"_localMatrix",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),ua=k(Qe.prototype,"_worldMatrix",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),ha=k(Qe.prototype,"_updateFlagManager",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bi}}),fa=k(Qe.prototype,"_isParentDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),da=k(Qe.prototype,"_parentTransformCache",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qe),le;(function(i){i[i.LocalEuler=1]="LocalEuler",i[i.LocalQuat=2]="LocalQuat",i[i.WorldPosition=4]="WorldPosition",i[i.WorldEuler=8]="WorldEuler",i[i.WorldQuat=16]="WorldQuat",i[i.WorldScale=32]="WorldScale",i[i.LocalMatrix=64]="LocalMatrix",i[i.WorldMatrix=128]="WorldMatrix",i[i.WmWp=132]="WmWp",i[i.WmWeWq=152]="WmWeWq",i[i.WmWpWeWq=156]="WmWpWeWq",i[i.WmWs=160]="WmWs",i[i.WmWpWs=164]="WmWpWs",i[i.WmWpWeWqWs=188]="WmWpWeWqWs"})(le||(le={}));var Kt=function(i){ee(s,i),s._findChildByName=function(e,r){for(var n=e._children,o=n.length-1;o>=0;o--){var c=n[o];if(c.name===r)return c}return null},s._traverseSetOwnerScene=function(e,r){e._scene=r;for(var n=e._children,o=e.childCount-1;o>=0;o--)this._traverseSetOwnerScene(n[o],r)};function s(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.layer=ht.Layer0,r.transform=void 0,r._isActiveInHierarchy=!1,r._components=[],r._scripts=new Wt,r._children=[],r._scene=void 0,r._isRoot=!1,r._isActive=!0,r._parent=null,r._activeChangedComponents=void 0,r._invModelMatrix=new ie,r._inverseWorldMatFlag=void 0,r.name=e,r.transform=r.addComponent(Ot),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var a=s.prototype;return a.addComponent=function(e){gi._addCheck(this,e);var r=new e(this);return this._components.push(r),this._isActiveInHierarchy&&r._setActive(!0),r},a.getComponent=function(e){for(var r=this._components.length-1;r>=0;r--){var n=this._components[r];if(n instanceof e)return n}},a.getComponents=function(e,r){r.length=0;for(var n=this._components.length-1;n>=0;n--){var o=this._components[n];o instanceof e&&r.push(o)}return r},a.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},a.addChild=function(e){e.parent=this},a.removeChild=function(e){e.parent=null},a.getChild=function(e){return this._children[e]},a.findByName=function(e){var r=this._children,n=s._findChildByName(this,e);if(n)return n;for(var o=r.length-1;o>=0;o--){var c=r[o],l=c.findByName(e);if(l)return l}return null},a.findByPath=function(e){for(var r=e.split("/"),n=this,o=0,c=r.length;o<c;++o){var l=r[o];if(l&&(n=s._findChildByName(n,l),!n))return null}return n},a.createChild=function(e){var r=new s(this.engine,e);return r.layer=this.layer,r.parent=this,r},a.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var n=e[r];n._parent=null,n._isActiveInHierarchy&&n._processInActive(),s._traverseSetOwnerScene(n,null)}e.length=0},a.clone=function(){var e=new s(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var r=this._children,n=0,o=this._children.length;n<o;n++){var c=r[n];e.addChild(c.clone())}for(var l=this._components,u=0,h=l.length;u<h;u++){var f=l[u];if(!(f instanceof Ot)){var d=e.addComponent(f.constructor);sl.cloneComponent(f,d)}}return e},a.destroy=function(){if(!this._destroyed){i.prototype.destroy.call(this);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var n=this._children,o=n.length-1;o>=0;o--)n[o].destroy();if(this._children.length=0,this._parent!=null){var c=this._parent._children;c.splice(c.indexOf(this),1)}this._parent=null}},a._removeComponent=function(e){gi._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},a._addScript=function(e){e._entityCacheIndex=this._scripts.length,this._scripts.add(e)},a._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityCacheIndex);r&&(r._entityCacheIndex=e._entityCacheIndex),e._entityCacheIndex=-1},a._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children;r.splice(r.indexOf(this),1),this._parent=null}return e},a._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},a._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},a._getComponentsInChildren=function(e,r){for(var n=this._components.length-1;n>=0;n--){var o=this._components[n];o instanceof e&&r.push(o)}for(var c=this._children.length-1;c>=0;c--)this._children[c]._getComponentsInChildren(e,r)},a._setActiveComponents=function(e){for(var r=this._activeChangedComponents,n=0,o=r.length;n<o;++n)r[n]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(r),this._activeChangedComponents=null},a._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var r=this._components,n=r.length-1;n>=0;n--)e.push(r[n]);for(var o=this._children,c=o.length-1;c>=0;c--){var l=o[c];l.isActive&&l._setActiveInHierarchy(e)}},a._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var r=this._components,n=r.length-1;n>=0;n--)e.push(r[n]);for(var o=this._children,c=o.length-1;c>=0;c--){var l=o[c];l.isActive&&l._setInActiveInHierarchy(e)}},a._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},a.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(ie.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},Z(s,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent;(r!=null&&r._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var r=this._removeFromParent(),n=this._parent=e;if(n){n._children.push(this);var o=n._scene;this._scene!==o&&s._traverseSetOwnerScene(this,o),n._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),r&&s._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"position",get:function(){return this.transform.position},set:function(e){this.transform.position=e}},{key:"worldPosition",get:function(){return this.transform.worldPosition},set:function(e){this.transform.worldPosition=e}},{key:"rotation",get:function(){return this.transform.rotationQuaternion},set:function(e){this.transform.rotationQuaternion=e}},{key:"scale",get:function(){return this.transform.scale},set:function(e){this.transform.scale=e}}]),s}(dr),ic=function(){function i(){this._features=[],this._objects=[]}var s=i.prototype;return s.registerFeature=function(t){for(var e=this._features,r=0,n=e.length;r<n;r++)if(e[r]===t)return;e.push(t);for(var o=this._objects,c=0,l=o.length;c<l;c++)o[c].features.push(new t)},s.addObject=function(t){t.features=[];for(var e=0,r=this._features.length;e<r;e++){var n;t.features.push(new this._features[e]((n=t.engine)!=null?n:t))}this._objects.push(t)},s.callFeatureMethod=function(t,e,r){for(var n=t.features,o=n.length,c=0;c<o;c++){var l=n[c];l[e]&&l[e].apply(l,r)}},s.findFeature=function(t,e){for(var r=t.features,n=r.length,o=0;o<n;o++){var c=r[o];if(c.constructor===e)return c}},i}(),hr;(function(i){i[i.DepthColor=0]="DepthColor",i[i.Depth=1]="Depth",i[i.None=2]="None"})(hr||(hr={}));var ul=function(){this.entity=null,this.distance=0,this.point=new w,this.normal=new w},Wi;(function(i){i[i.Average=0]="Average",i[i.Minimum=1]="Minimum",i[i.Multiply=2]="Multiply",i[i.Maximum=3]="Maximum"})(Wi||(Wi={}));var Pr;(function(i){i[i.X=0]="X",i[i.Y=1]="Y",i[i.Z=2]="Z"})(Pr||(Pr={}));var Lt=function(){function i(){var a=this;this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(t,e){},this._onContactExit=function(t,e){},this._onContactStay=function(t,e){},this._onTriggerEnter=function(t,e){for(var r=a._physicalObjectsMap[t],n=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerEnter(n);o=n.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerEnter(r)},this._onTriggerExit=function(t,e){for(var r=a._physicalObjectsMap[t],n=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerExit(n);o=n.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerExit(r)},this._onTriggerStay=function(t,e){for(var r=a._physicalObjectsMap[t],n=a._physicalObjectsMap[e],o=r.collider.entity._scripts,c=0,l=o.length;c<l;c++)o.get(c).onTriggerStay(n);o=n.collider.entity._scripts;for(var u=0,h=o.length;u<h;u++)o.get(u).onTriggerStay(r)},this._nativePhysicsManager=i._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay)}var s=i.prototype;return s.raycast=function(t,e,r,n){var o=this,c,l=Number.MAX_VALUE;typeof e=="number"?l=e:e!=null&&(c=e);var u=ht.Everything;if(typeof r=="number"?u=r:r!=null&&(c=r),n&&(c=n),c!=null){var h=this._nativePhysicsManager.raycast(t,l,function(f,d,_,p){c.entity=o._physicalObjectsMap[f]._collider.entity,c.distance=d,p.cloneTo(c.normal),_.cloneTo(c.point)});return h?c.entity.layer&u?!0:(c.entity=null,c.distance=0,c.point.setValue(0,0,0),c.normal.setValue(0,0,0),!1):!1}else return this._nativePhysicsManager.raycast(t,l)},s._update=function(t){this._nativePhysicsManager.update(t)},s._addColliderShape=function(t){this._physicalObjectsMap[t.id]=t,this._nativePhysicsManager.addColliderShape(t._nativeShape)},s._removeColliderShape=function(t){delete this._physicalObjectsMap[t.id],this._nativePhysicsManager.removeColliderShape(t._nativeShape)},s._addCollider=function(t){this._nativePhysicsManager.addCollider(t._nativeCollider)},s._removeCollider=function(t){this._nativePhysicsManager.removeCollider(t._nativeCollider)},i}();Lt._nativePhysics=void 0;var hl=function(){function i(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=Wi.Average,this._frictionCombine=Wi.Average,this._nativeMaterial=void 0,this._nativeMaterial=Lt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}return Z(i,[{key:"bounciness",get:function(){return this._bounciness},set:function(a){this._bounciness=a,this._nativeMaterial.setBounciness(a)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(a){this._dynamicFriction=a,this._nativeMaterial.setDynamicFriction(a)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(a){this._staticFriction=a,this._nativeMaterial.setStaticFriction(a)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(a){this._bounceCombine=a,this._nativeMaterial.setBounceCombine(a)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(a){this._frictionCombine=a,this._nativeMaterial.setFrictionCombine(a)}}]),i}(),wi=function(){function i(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._position=new w,this._material=void 0,this._isTrigger=!1,this._isSceneQuery=!0,this._material=new hl,this._id=i._idGenerator++}var s=i.prototype;return s.setPosition=function(t,e,r){this._position.setValue(t,e,r),this._nativeShape.setPosition(this._position)},Z(i,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"material",get:function(){return this._material},set:function(t){this._material=t,this._nativeShape.setMaterial(t._nativeMaterial)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&t.cloneTo(this._position),this._nativeShape.setPosition(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._nativeShape.setIsTrigger(t)}}]),i}();wi._idGenerator=0;var fl=function(i){ee(s,i);function s(){var t;return t=i.call(this)||this,t._size=new w(1,1,1),t._nativeShape=Lt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}var a=s.prototype;return a.setSize=function(e,r,n){this._size.x=e,this._size.y=r,this._size.z=n,this._nativeShape.setSize(this._size)},Z(s,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&e.cloneTo(this._size),this._nativeShape.setSize(e)}}]),s}(wi),dl=function(i){ee(s,i);function s(){var a;return a=i.call(this)||this,a._radius=1,a._nativeShape=Lt._nativePhysics.createSphereColliderShape(a._id,a._radius,a._material._nativeMaterial),a}return Z(s,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}}]),s}(wi),_l=function(i){ee(s,i);function s(){var t;return t=i.call(this)||this,t._rotation=new w,t._nativeShape=Lt._nativePhysics.createPlaneColliderShape(t._id,t._material._nativeMaterial),t}var a=s.prototype;return a.setRotation=function(e,r,n){this._rotation.setValue(e,r,n),this._nativeShape.setRotation(this._rotation)},Z(s,[{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation!=e&&e.cloneTo(this._rotation),this._nativeShape.setRotation(e)}}]),s}(wi),vl=function(i){ee(s,i);function s(){var a;return a=i.call(this)||this,a._radius=1,a._height=2,a._upAxis=Pr.Y,a._nativeShape=Lt._nativePhysics.createCapsuleColliderShape(a._id,a._radius,a._height,a._material._nativeMaterial),a._nativeShape.setUpAxis(Pr.Y),a}return Z(s,[{key:"radius",get:function(){return this._radius},set:function(t){this._nativeShape.setRadius(t)}},{key:"height",get:function(){return this._height},set:function(t){this._nativeShape.setHeight(t)}},{key:"upAxis",get:function(){return this._upAxis},set:function(t){this._upAxis=t,this._nativeShape.setUpAxis(t)}}]),s}(wi),ln,va,nc=(ln=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,V(e,"_index",va,F(e)),e._nativeCollider=void 0,e._updateFlag=void 0,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var a=s.prototype;return a.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),this._nativeCollider.addShape(e._nativeShape),e._collider=this)},a.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this._nativeCollider.removeShape(e._nativeShape),this.engine.physicsManager._removeColliderShape(e),e._collider=null)},a.clearShapes=function(){for(var e=this._shapes,r=0,n=e.length;r<n;r++)this._nativeCollider.removeShape(e[r]._nativeShape),this.engine.physicsManager._removeColliderShape(e[r]);e.length=0},a._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion),this._updateFlag.flag=!1;for(var r=e.lossyWorldScale,n=0,o=this.shapes.length;n<o;n++)this.shapes[n]._nativeShape.setWorldScale(r)}},a._onLateUpdate=function(){},a._onEnable=function(){this.engine.physicsManager._addCollider(this),this.engine._componentsManager.addCollider(this)},a._onDisable=function(){this.engine.physicsManager._removeCollider(this),this.engine._componentsManager.removeCollider(this)},a._onDestroy=function(){this.clearShapes()},Z(s,[{key:"shapes",get:function(){return this._shapes}}]),s}(Mt),va=k(ln.prototype,"_index",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ln),pl=function(i){ee(s,i);function s(a){var t;t=i.call(this,a)||this;var e=t.entity.transform;return t._nativeCollider=Lt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return s}(nc),ac=function(i){ee(s,i);function s(t){var e;e=i.call(this,t)||this,e.linearVelocity=void 0,e.angularVelocity=void 0,e.linearDamping=void 0,e.angularDamping=void 0,e.mass=void 0,e.isKinematic=void 0;var r=e.entity.transform;return e._nativeCollider=Lt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e}var a=s.prototype;return a.applyForce=function(e){this._nativeCollider.addForce(e)},a.applyTorque=function(e){this._nativeCollider.addTorque(e)},a._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,n=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,n),e.worldPosition=r,e.worldRotationQuaternion=n,this._updateFlag.flag=!1},s}(nc),zt;(function(i){i[i.Down=0]="Down",i[i.Move=1]="Move",i[i.Up=2]="Up",i[i.Leave=3]="Leave"})(zt||(zt={}));var gl=function(s){this.id=void 0,this.phase=zt.Leave,this.position=new H,this._uniqueID=void 0,this._needUpdate=!0,this.id=s},en=function(){function i(a){var t=this;this._pointers=[],this._multiPointerEnabled=!0,this._enablePhysics=!1,this._engine=void 0,this._canvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._keyEventList=[],this._keyEventCount=0,this._needOverallPointers=!1,this._currentPosition=new H,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this._engine=a,this._canvas=a.canvas;var e=this._canvas._webCanvas;e.style.touchAction="none",e.onpointerdown=e.onpointerup=e.onpointerout=e.onpointermove=function(r){t._nativeEvents.push(r)},this._pointerPool=new Array(11),this._enablePhysics=!!a.physicsManager}var s=i.prototype;return s._update=function(){if(this._needOverallPointers&&this._overallPointers(),this._nativeEvents.length>0&&this._handlePointerEvent(this._nativeEvents),this._enablePhysics){var t=this._pointerRayCast(),e=this._keyEventCount;if(e>0){for(var r=this._keyEventList,n=0;n<e;n++)switch(r[n]){case sr.Down:this._firePointerDown(t);break;case sr.Up:this._firePointerUpAndClick(t);break}this._firePointerExitAndEnter(t),r[e-1]===sr.Leave&&(this._currentPressedEntity=null),this._keyEventCount=0}else this._firePointerDrag(),this._firePointerExitAndEnter(t)}},s._destroy=function(){var t=this._canvas._webCanvas;t.onpointerdown=t.onpointerup=t.onpointerout=t.onpointermove=null,this._nativeEvents.length=0,this._pointerPool.length=0,this._pointers.length=0,this._currentPosition=null,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._engine=null,this._canvas=null},s._overallPointers=function(){for(var t=this._pointers,e=0,r=t.length,n=0;n<r;n++)t[n].phase===zt.Leave?e++:e>0&&(t[n-e]=t[n]);t.length=r-e,this._needOverallPointers=!1},s._getIndexByPointerID=function(t){for(var e=this._pointers,r=e.length-1;r>=0;r--)if(e[r]._uniqueID===t)return r;return-1},s._addPointer=function(t,e,r,n){var o=this._pointers,c=o.length;if(c===0||this._multiPointerEnabled){for(var l=this._pointerPool,u=0;u<c&&!(o[u].id>u);u++);var h=l[u];h||(h=l[u]=new gl(u)),h._uniqueID=t,h._needUpdate=!0,h.position.setValue(e,r),h.phase=n,o.splice(u,0,h)}},s._removePointer=function(t){this._pointers[t].phase=zt.Leave},s._updatePointer=function(t,e,r,n){var o=this._pointers[t];o.position.setValue(e,r),o._needUpdate=!0,o.phase=n},s._handlePointerEvent=function(t){for(var e=this._pointers,r=this._keyEventList,n=e.length,o=t.length,c=0;c<o;c++){var l=t[c],u=this._getIndexByPointerID(l.pointerId);switch(l.type){case"pointerdown":u===-1?(this._addPointer(l.pointerId,l.offsetX,l.offsetY,zt.Down),n++):this._updatePointer(u,l.offsetX,l.offsetY,zt.Down),n===1&&(r[this._keyEventCount++]=sr.Down);break;case"pointerup":u>=0&&(this._updatePointer(u,l.offsetX,l.offsetY,zt.Up),n===1&&(r[this._keyEventCount++]=sr.Up));break;case"pointermove":u===-1?(this._addPointer(l.pointerId,l.offsetX,l.offsetY,zt.Move),n++):this._updatePointer(u,l.offsetX,l.offsetY,zt.Move);break;case"pointerout":u>=0&&(this._removePointer(u),--n===0&&(r[this._keyEventCount++]=sr.Leave),this._needOverallPointers=!0);break}}var h=e.length;if(h>0){var f=this._canvas,d=this._currentPosition,_=f.width/f._webCanvas.clientWidth,p=f.height/f._webCanvas.clientHeight;if(n===0){var v=t[o-1];d.setValue(v.offsetX*_,v.offsetY*p)}else{d.setValue(0,0);for(var g=0;g<h;g++){var m=e[g],y=m.position;m._needUpdate&&(y.setValue(y.x*_,y.y*p),m._needUpdate=!1),d.add(y)}d.scale(1/h)}}t.length=0},s._pointerRayCast=function(){if(this._pointers.length>0)for(var t=i._tempPoint,e=i._tempRay,r=i._tempHitResult,n=this._engine.sceneManager.activeScene._activeCameras,o=this._currentPosition.x/this._canvas.width,c=this._currentPosition.y/this._canvas.height,l=n.length-1;l>=0;l--){var u=n[l];if(!(!u.enabled||u.renderTarget)){var h=u.viewport,f=h.x,d=h.y,_=h.z,p=h.w;if(o>=f&&c>=d&&o-f<=_&&c-d<=p){if(t.setValue((o-f)/_,(c-d)/p),this._engine.physicsManager.raycast(u.viewportPointToRay(t,e),r))return r.entity;if(u.clearFlags===hr.DepthColor)return null}}}return null},s._firePointerDrag=function(){if(this._currentPressedEntity)for(var t=this._currentPressedEntity._scripts,e=t.length-1;e>=0;e--)t.get(e).onPointerDrag()},s._firePointerExitAndEnter=function(t){if(this._currentEnteredEntity!==t){if(this._currentEnteredEntity)for(var e=this._currentEnteredEntity._scripts,r=e.length-1;r>=0;r--)e.get(r).onPointerExit();if(t)for(var n=t._scripts,o=n.length-1;o>=0;o--)n.get(o).onPointerEnter();this._currentEnteredEntity=t}},s._firePointerDown=function(t){if(t)for(var e=t._scripts,r=e.length-1;r>=0;r--)e.get(r).onPointerDown();this._currentPressedEntity=t},s._firePointerUpAndClick=function(t){var e=this._currentPressedEntity;if(e){for(var r=e===t,n=e._scripts,o=n.length-1;o>=0;o--){var c=n.get(o);r&&c.onPointerClick(),c.onPointerUp()}this._currentPressedEntity=null}},i}();en._tempRay=new Kc;en._tempPoint=new H;en._tempHitResult=new ul;var sr;(function(i){i[i.Down=0]="Down",i[i.Up=1]="Up",i[i.Leave=2]="Leave"})(sr||(sr={}));var ml=function(){function i(a){this._pointerManager=void 0,this._pointerManager=new en(a,a.canvas._webCanvas)}var s=i.prototype;return s._update=function(){this._pointerManager._update()},s._destroy=function(){this._pointerManager._destroy()},Z(i,[{key:"pointers",get:function(){return this._pointerManager._pointers}},{key:"multiPointerEnabled",get:function(){return this._pointerManager._multiPointerEnabled},set:function(t){this._pointerManager._multiPointerEnabled=t}}]),i}(),We;(function(i){i[i.Opaque=1e3]="Opaque",i[i.AlphaTest=2e3]="AlphaTest",i[i.Transparent=3e3]="Transparent"})(We||(We={}));var Qr=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,t.resourceManager._addRefObject(e.instanceId,F(e)),e}var a=s.prototype;return a.destroy=function(e){if(e===void 0&&(e=!1),this._destroyed)return!0;if(!e&&this._refCount!==0)return!1;var r=this._engine.resourceManager;r&&(i.prototype.destroy.call(this),r._deleteRefObject(this.instanceId));var n=this._getRefCount();return n>0&&this._addRefCount(-n),this._engine=null,this._onDestroy(),!0},a._getRefCount=function(){return this._refCount},a._addRefCount=function(e){this._refCount+=e},a._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},Z(s,[{key:"refCount",get:function(){return this._refCount}}]),s}(dr),xt;(function(i){i[i.Scene=0]="Scene",i[i.Camera=1]="Camera",i[i.Renderer=2]="Renderer",i[i.Material=3]="Material"})(xt||(xt={}));var At=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}var a=s.prototype;return a.generateMipmaps=function(){!this._mipmap||this._platformTexture.generateMipmaps()},a._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},a._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},a._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},Z(s,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(e=r),e<1&&(e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),s}(Qr),yl=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
#define whiteCompliment(a) ( 1.0 - saturate( a ) )
vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}`,xl=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef O3_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef O3_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef O3_USE_JOINT_TEXTURE
uniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 u_jointMatrix[O3_JOINTS_NUM];
#endif
#endif
#ifdef O3_HAS_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef O3_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,bl=`#define GLSLIFY 1
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;`,wl=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
varying vec4 v_color;
#endif
`,Al=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
varying mat3 v_TBN;
#else
varying vec3 v_normal;
#endif
#endif
`,Sl=`#define GLSLIFY 1
varying vec2 v_uv;`,Pl=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
varying vec3 v_pos;
#endif
`,Ml=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
uniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;
#endif
#ifdef O3_SHADOW_MAP_COUNT
uniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];
#endif
`,Tl=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
varying vec3 v_fogDepth;uniform vec3 u_fogColor;
#ifdef O3_FOG_EXP2
uniform float u_fogDensity;
#else
uniform float u_fogNear;uniform float u_fogFar;
#endif
#endif
`,Cl=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,Rl=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,El=`#define GLSLIFY 1
#ifndef O3_GENERATE_SHADOW_MAP
gl_Position=u_MVPMat*position;
#endif
`,zl=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,Bl=`#define GLSLIFY 1
#ifdef O3_HAS_NORMAL
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
vec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);
#else
v_normal=normalize(mat3(u_normalMat)*normal);
#endif
#endif
`,Dl=`#define GLSLIFY 1
#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)
normal=vec4(skinMatrix*vec4(normal,0.0)).xyz;
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE )
tangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;
#endif
#endif
#endif
`,Ol=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifndef OASIS_BLENDSHAPE_TEXTURE
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#ifdef OASIS_BLENDSHAPE_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef OASIS_BLENDSHAPE_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
#endif
uniform float u_blendShapeWeights[4];
#endif
`,Fl=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
#else
position.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];
#ifndef OMIT_NORMAL
#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )
normal.xyz+=NORMAL_BS0*u_blendShapeWeights[0];normal.xyz+=NORMAL_BS1*u_blendShapeWeights[1];normal.xyz+=NORMAL_BS2*u_blendShapeWeights[2];normal.xyz+=NORMAL_BS3*u_blendShapeWeights[3];
#endif
#if defined( O3_HAS_TANGENT ) && defined( O3_NORMAL_TEXTURE ) && defined(OASIS_BLENDSHAPE_TANGENT)
tangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];
#endif
#endif
#endif
#endif
`,Il=`#define GLSLIFY 1
#ifdef O3_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef O3_NEED_TILINGOFFSET
v_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;
#endif
`,Ll=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,Ul=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
gl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;
#endif
#ifdef O3_SHADOW_MAP_COUNT
for(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}
#endif
`,Nl=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
v_fogDepth=(u_MVMat*position).xyz;
#endif
`,Vl=`#define GLSLIFY 1
#ifdef O3_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];
#endif
#ifdef O3_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];
#endif
#ifdef O3_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;
#ifdef O3_USE_SH
uniform vec3 u_env_sh[9];
#endif
#ifdef O3_USE_SPECULAR_ENV
uniform samplerCube u_env_specularSampler;
#endif
`,kl=`#define GLSLIFY 1
uniform vec4 u_emissiveColor;uniform vec4 u_diffuseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;
#ifdef O3_EMISSIVE_TEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef O3_DIFFUSE_TEXTURE
uniform sampler2D u_diffuseTexture;
#endif
#ifdef O3_SPECULAR_TEXTURE
uniform sampler2D u_specularTexture;
#endif
#ifdef O3_NORMAL_TEXTURE
uniform sampler2D u_normalTexture;
#endif
`,Gl=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
float fogDepth=length(v_fogDepth);
#ifdef O3_FOG_EXP2
float fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));
#else
float fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);
#endif
gl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);
#endif
`,Hl=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_diffuseColor;vec4 specular=u_specularColor;
#ifdef O3_EMISSIVE_TEXTURE
vec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef O3_DIFFUSE_TEXTURE
vec4 diffuseTextureColor=texture2D(u_diffuseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef O3_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(u_specularTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;`,Wl=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec3 V=normalize(u_cameraPos-v_pos);
#endif
`,Xl=`#define GLSLIFY 1
vec3 N=getNormal();vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef ALPHA_CUTOFF
if(diffuse.a<u_alphaCutoff){discard;}
#endif
`,jl=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,Kl=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,ql=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,Yl=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,Ql=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,$l=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,Zl=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,Jl=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,eu=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,tu=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,ru=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,iu=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,nu=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,au=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,ou=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,su=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,cu=`#define GLSLIFY 1
uniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_specularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;uniform float u_normalIntensity;uniform float u_occlusionStrength;
#ifdef HAS_BASECOLORMAP
uniform sampler2D u_baseColorSampler;
#endif
#ifdef O3_NORMAL_TEXTURE
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_EMISSIVEMAP
uniform sampler2D u_emissiveSampler;
#endif
#ifdef HAS_METALROUGHNESSMAP
uniform sampler2D u_metallicRoughnessSampler;
#endif
#ifdef HAS_SPECULARGLOSSINESSMAP
uniform sampler2D u_specularGlossinessSampler;
#endif
#ifdef HAS_OCCLUSIONMAP
uniform sampler2D u_occlusionSampler;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;};struct PhysicalMaterial{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;};`,lu=`#define GLSLIFY 1
#include <normal_get>
float pow2(float x){return x*x;}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}PhysicalMaterial getPhysicalMaterial(vec4 diffuseColor,float metal,float roughness,vec3 specularColor,float glossiness,float alphaCutoff){PhysicalMaterial material;
#ifdef HAS_BASECOLORMAP
vec4 baseColor=texture2D(u_baseColorSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=gammaToLinear(baseColor);
#endif
diffuseColor*=baseColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuseColor*=v_color;
#endif
#ifdef ALPHA_CUTOFF
if(diffuseColor.a<alphaCutoff){discard;}
#endif
#ifdef HAS_METALROUGHNESSMAP
vec4 metalRoughMapColor=texture2D(u_metallicRoughnessSampler,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef HAS_SPECULARGLOSSINESSMAP
vec4 specularGlossinessColor=texture2D(u_specularGlossinessSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=diffuseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),diffuseColor.rgb,metal);material.roughness=clamp(roughness,0.04,1.0);
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=diffuseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=clamp(1.0-glossiness,0.04,1.0);
#endif
material.opacity=diffuseColor.a;return material;}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,uu=`#define GLSLIFY 1
vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,GeometricContext geometry,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+geometry.viewDir);float dotNL=saturate(dot(geometry.normal,incidentDirection));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));float dotNH=saturate(dot(geometry.normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}`,hu=`#define GLSLIFY 1
void addDirectRadiance(vec3 incidentDirection,vec3 color,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color;irradiance*=PI;reflectedLight.directSpecular+=irradiance*BRDF_Specular_GGX(incidentDirection,geometry,material.specularColor,material.roughness);reflectedLight.directDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef O3_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(GeometricContext geometry,PhysicalMaterial material,inout ReflectedLight reflectedLight){
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}
#endif
}`,fu=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(GeometricContext geometry,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef O3_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=reflect(-geometry.viewDir,geometry.normal);float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef O3_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef OASIS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef OASIS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,du=`#define GLSLIFY 1
GeometricContext geometry=GeometricContext(v_pos,getNormal(),normalize(u_cameraPos-v_pos));PhysicalMaterial material=getPhysicalMaterial(u_baseColor,u_metal,u_roughness,u_specularColor,u_glossiness,u_alphaCutoff);ReflectedLight reflectedLight=ReflectedLight(vec3(0),vec3(0),vec3(0),vec3(0));float dotNV=saturate(dot(geometry.normal,geometry.viewDir));addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef O3_USE_SH
vec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);
#ifdef OASIS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=u_envMapLight.diffuseIntensity;
#else
vec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=radiance*envBRDFApprox(material.specularColor,material.roughness,dotNV);
#ifdef HAS_OCCLUSIONMAP
float ambientOcclusion=(texture2D(u_occlusionSampler,v_uv).r-1.0)*u_occlusionStrength+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef O3_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,dotNV);
#endif
#endif
vec3 emissiveRadiance=u_emissiveColor;
#ifdef HAS_EMISSIVEMAP
vec4 emissiveColor=texture2D(u_emissiveSampler,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);
#ifndef OASIS_COLORSPACE_GAMMA
targetColor=linearToGamma(targetColor);
#endif
gl_FragColor=targetColor;`,_u={pbr_frag_define:cu,pbr_helper:lu,brdf:uu,direct_irradiance_frag_define:hu,ibl_frag_define:fu,pbr_frag:du},vu=`#define GLSLIFY 1
vec3 getNormal(){
#ifdef O3_NORMAL_TEXTURE
#ifndef O3_HAS_TANGENT
#ifdef HAS_DERIVATIVES
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 tex_dx=dFdx(vec3(v_uv,0.0));vec3 tex_dy=dFdy(vec3(v_uv,0.0));vec3 t=(tex_dy.t*pos_dx-tex_dx.t*pos_dy)/(tex_dx.s*tex_dy.t-tex_dy.s*tex_dx.t);
#ifdef O3_HAS_NORMAL
vec3 ng=normalize(v_normal);
#else
vec3 ng=normalize(cross(pos_dx,pos_dy));
#endif
t=normalize(t-ng*dot(ng,t));vec3 b=normalize(cross(ng,t));mat3 tbn=mat3(t,b,ng);
#else
#ifdef O3_HAS_NORMAL
vec3 ng=normalize(v_normal);
#else
vec3 ng=vec3(0.0,0.0,1.0);
#endif
mat3 tbn=mat3(vec3(0.0),vec3(0.0),ng);
#endif
#else
mat3 tbn=v_TBN;
#endif
vec3 n=texture2D(u_normalTexture,v_uv).rgb;n=normalize(tbn*((2.0*n-1.0)*vec3(u_normalIntensity,u_normalIntensity,1.0)));
#else
#ifdef O3_HAS_NORMAL
vec3 n=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 n=normalize(cross(pos_dx,pos_dy));
#else
vec3 n=vec3(0.0,0.0,1.0);
#endif
#endif
n*=float(gl_FrontFacing)*2.0-1.0;return n;}`,pu=Gn(Gn({common:yl,common_vert:xl,common_frag:bl,color_share:wl,normal_share:Al,uv_share:Sl,worldpos_share:Pl,shadow_share:Ml,fog_share:Tl,begin_normal_vert:Cl,begin_position_vert:Rl,position_vert:El,color_vert:zl,normal_vert:Bl,skinning_vert:Dl,blendShape_input:Ol,blendShape_vert:Fl,uv_vert:Il,worldpos_vert:Ll,shadow_vert:Ul,fog_vert:Nl,light_frag_define:Vl,mobile_material_frag:kl,fog_frag:Gl,begin_mobile_frag:Hl,begin_viewdir_frag:Wl,mobile_blinnphong_frag:Xl,noise_common:jl,noise_cellular_2D:Kl,noise_cellular_2x2:ql,noise_cellular_2x2x2:Yl,noise_cellular_3D:Ql,noise_cellular:$l,noise_perlin_2D:Zl,noise_perlin_3D:Jl,noise_perlin_4D:eu,noise_perlin:tu,noise_psrd_2D:ru,noise_simplex_2D:iu,noise_simplex_3D_grad:nu,noise_simplex_3D:au,noise_simplex_4D:ou,noise_simplex:su},_u),{},{normal_get:vu}),Ur=function(){function i(){}return i.parseCustomMacros=function(a){return a.map(function(t){return"#define "+t+`
`}).join("")},i.parseIncludes=function(a){var t=/^[ \t]*#include +<([\w\d.]+)>/gm;function e(r,n){var o=pu[n];return o===void 0?(pt.error('Shader slice "'+r.trim()+'" not founded.'),""):i.parseIncludes(o)}return a.replace(t,e)},i.parseExtension=function(a){return a.map(function(t){return"#extension "+t+` : enable
`}).join("")},i.convertTo300=function(a,t){if(a=a.replace(/\battribute\b/g,"in"),a=a.replace(/\bvarying\b/g,t?"in":"out"),a=a.replace(/\btexture(2D|Cube)\b/g,"texture"),a=a.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t){var e=/\bgl_FragData\[.+?\]/g.test(a);if(e){a=a.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=a.match(/\bgl_FragData\[.+?\]/g);a=this._replaceMRTShader(a,r)}else a=a.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),a=a.replace(/\bgl_FragColor\b/g,"glFragColor")}return a},i._replaceMRTShader=function(a,t){for(var e="",r=new Set,n=0;n<t.length;n++){var o=t[n].match(/\bgl_FragData\[(.+?)\]/);r.add(o[1])}return r.forEach(function(c){e+="layout(location="+c+") out vec4 fragOutColor"+c+`;
`}),e+="void main(",a=a.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),a=a.replace(/void\s+?main\s*\(/g,e),a},i}(),gu=function(s,a,t){this.name=void 0,this._index=void 0,this._value=void 0,this.name=s,this._index=a,this._value=t},Mr;(function(i){i[i.Linear=0]="Linear",i[i.Gamma=1]="Gamma"})(Mr||(Mr={}));var mu=function(){function i(a){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=a._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=a.settings.colorSpace}var s=i.prototype;return s.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},s.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},s.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===Mr.Linear?this._gl.uniform2f(t.location,ne.gammaToLinearSpace(e.r),ne.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},s.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===Mr.Linear?this._gl.uniform3f(t.location,ne.gammaToLinearSpace(e.r),ne.gammaToLinearSpace(e.g),ne.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},s.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===Mr.Linear?this._gl.uniform4f(t.location,ne.gammaToLinearSpace(e.r),ne.gammaToLinearSpace(e.g),ne.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},s.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},s.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},s.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},s.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},s.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},s.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},s.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},s.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},s.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},s.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},s.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture)},s.uploadTextureArray=function(t,e){for(var r=this._rhi,n=t.textureIndex,o=0;o<e.length;o++){var c=e[o];r.activeTexture(n[o]),r.bindTexture(c._platformTexture)}},i}(),ti=function(){this.constUniforms=[],this.textureUniforms=[]},oc=function(){i._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,n;return e.map(function(o,c){if(n="0:"+(c+1),n.length>=r)return n.substring(0,r)+o;for(var l=0;l<r-n.length;l++)n+=" ";return n+o}).join(`
`)};function i(a,t,e){this.id=void 0,this.sceneUniformBlock=new ti,this.cameraUniformBlock=new ti,this.rendererUniformBlock=new ti,this.materialUniformBlock=new ti,this.otherUniformBlock=new ti,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=a,this._gl=a._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=i._counter++}var s=i.prototype;return s.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},s.uploadUniforms=function(t,e){for(var r=e._properties,n=t.constUniforms,o=0,c=n.length;o<c;o++){var l=n[o],u=r[l.propertyId];u!=null&&l.applyFunc(l,u)}},s.uploadTextures=function(t,e){var r=e._properties,n=t.textureUniforms;if(n)for(var o=0,c=n.length;o<c;o++){var l=n[o],u=r[l.propertyId];u?l.applyFunc(l,u):l.applyFunc(l,l.textureDefault)}},s.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var n=t[e];n.applyFunc(n,n.textureDefault)}},s.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},s.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBind!==this?(this._gl.useProgram(this._glProgram),t._currentBind=this,!0):!1},s.destroy=function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._glProgram&&t.deleteProgram(this._glProgram)},s._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var n=t[r],o=z._getShaderPropertyGroup(n.name);o!==void 0&&(t.splice(t.indexOf(n),1),this._groupingUniform(n,o,e))}},s._groupingUniform=function(t,e,r){switch(e){case xt.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case xt.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case xt.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case xt.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},s._createProgram=function(t,e){var r=this._gl,n=this._createShader(r.VERTEX_SHADER,t);if(!n)return null;var o=this._createShader(r.FRAGMENT_SHADER,e);if(!o)return null;var c=r.createProgram();return r.attachShader(c,n),r.attachShader(c,o),r.linkProgram(c),r.validateProgram(c),r.isContextLost()?(r.deleteShader(n),r.deleteShader(o),null):(this._vertexShader=n,this._fragmentShader=o,c)},s._createShader=function(t,e){var r=this._gl,n=r.createShader(t);return n?(r.shaderSource(n,e),r.compileShader(n),r.isContextLost()?(r.deleteShader(n),null):n):null},s._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,n=this._getUniformInfos(),o=this._getAttributeInfos();n.forEach(function(c){var l=c.name,u=c.size,h=c.type,f=new mu(t._engine),d=!1,_=!1;l.indexOf("[0]")>0&&(l=l.substr(0,l.length-3),d=!0);var p=z._getShaderPropertyGroup(l),v=e.getUniformLocation(r,l);switch(f.name=l,f.propertyId=z.getPropertyByName(l)._uniqueId,f.location=v,h){case e.FLOAT:d?f.applyFunc=f.upload1fv:(f.applyFunc=f.upload1f,f.cacheValue=0);break;case e.FLOAT_VEC2:d?f.applyFunc=f.upload2fv:(f.applyFunc=f.upload2f,f.cacheValue=new H(0,0));break;case e.FLOAT_VEC3:d?f.applyFunc=f.upload3fv:(f.applyFunc=f.upload3f,f.cacheValue=new w(0,0,0));break;case e.FLOAT_VEC4:d?f.applyFunc=f.upload4fv:(f.applyFunc=f.upload4f,f.cacheValue=new ze(0,0,0,0));break;case e.BOOL:case e.INT:d?f.applyFunc=f.upload1iv:(f.applyFunc=f.upload1i,f.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:d?f.applyFunc=f.upload2iv:(f.applyFunc=f.upload2i,f.cacheValue=new H(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:f.applyFunc=d?f.upload3iv:f.upload3i,f.cacheValue=new w(0,0,0);break;case e.BOOL_VEC4:case e.INT_VEC4:d?f.applyFunc=f.upload4iv:(f.applyFunc=f.upload4i,f.cacheValue=new ze(0,0,0));break;case e.FLOAT_MAT4:f.applyFunc=d?f.uploadMat4v:f.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:var g=h===e.SAMPLER_2D?t._engine._whiteTexture2D:t._engine._whiteTextureCube;if(_=!0,d){for(var m=new Array(u),y=new Int32Array(u),A=new Array(u),S=0;S<u;S++)m[S]=g,y[S]=t._activeTextureUint,A[S]=e.TEXTURE0+t._activeTextureUint++;f.textureDefault=m,f.textureIndex=A,f.applyFunc=f.uploadTextureArray,t.bind(),e.uniform1iv(v,y),f.uploadTextureArray(f,m)}else{var C=e.TEXTURE0+t._activeTextureUint;f.textureDefault=g,f.textureIndex=C,f.applyFunc=f.uploadTexture,t.bind(),e.uniform1i(v,t._activeTextureUint++),f.uploadTexture(f,g)}break}t._groupingUniform(f,p,_)}),o.forEach(function(c){var l=c.name;t.attributeLocation[l]=e.getAttribLocation(r,l)})},s._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=[],n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),o=0;o<n;++o){var c=t.getActiveUniform(e,o);r[o]=c}return r},s._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=[],n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<n;++o){var c=t.getActiveAttrib(e,o);r[o]=c}return r},Z(i,[{key:"isValid",get:function(){return this._isValid}}]),i}();oc._counter=0;var sc=function i(s){this._uniqueId=void 0,this._group=void 0,this.name=void 0,this.name=s,this._uniqueId=i._propertyNameCounter++};sc._propertyNameCounter=0;var z=function(){i.create=function(t,e,r){var n=i._shaderMap;if(n[t])throw'Shader named "'+t+'" already exists.';return n[t]=new i(t,e,r)},i.find=function(t){return i._shaderMap[t]},i.getMacroByName=function(t){var e=i._macroMap[t];if(!e){var r=i._macroMaskMap,n=i._macroCounter,o=Math.floor(n/32),c=n%32;e=new gu(t,o,1<<c),i._macroMap[t]=e,o==r.length&&(r.length++,r[o]=new Array(32)),r[o][c]=t,i._macroCounter++}return e},i.getPropertyByName=function(t){var e=i._propertyNameMap;if(e[t]!=null)return e[t];var r=new sc(t);return e[t]=r,r},i._getShaderPropertyGroup=function(t){var e=i._propertyNameMap[t];return e==null?void 0:e._group},i._getNamesByMacros=function(t,e){var r=i._macroMaskMap,n=t._mask;e.length=0;for(var o=0,c=t._length;o<c;o++)for(var l=r[o],u=n[o],h=u<0?32:Math.floor(Math.log2(u))+1,f=0;f<h;f++)u&1<<f&&e.push(l[f])};function i(a,t,e){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=i._shaderCounter++,this.name=a,this._vertexSource=t,this._fragmentSource=e}var s=i.prototype;return s.compileVariant=function(t,e){var r=i._compileMacros;r.clear();for(var n=0,o=e.length;n<o;n++)r.enable(i.getMacroByName(e[n]));return this._getShaderProgram(t,r).isValid},s._getShaderProgram=function(t,e){var r=t._getShaderProgramPool(this),n=r.get(e);if(n)return n;var o=t._hardwareRenderer.isWebGL2,c=[];i._getNamesByMacros(e,c);var l=Ur.parseCustomMacros(c),u=o?"#version 300 es":"#version 100",h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;t._hardwareRenderer.canIUse(Q.shaderTextureLod)&&(h+=`#define HAS_TEX_LOD
`),t._hardwareRenderer.canIUse(Q.standardDerivatives)&&(h+=`#define HAS_DERIVATIVES
`);var f=Ur.parseIncludes(" "+u+`
        `+h+`
        `+l+`
        `+this._vertexSource),d=Ur.parseIncludes(" "+u+`
        `+(o?"":Ur.parseExtension(i._shaderExtension))+`
        `+h+`
        `+l+`
      `+this._fragmentSource);return o&&(f=Ur.convertTo300(f),d=Ur.convertTo300(d,!0)),n=new oc(t,f,d),r.cache(n),n},i}();z._compileMacros=new ct;z._shaderCounter=0;z._shaderMap=Object.create(null);z._propertyNameMap=Object.create(null);z._macroMaskMap=[];z._macroCounter=0;z._macroMap=Object.create(null);z._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var tn=function(){function i(a){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new ct,this._variableMacros=Object.create(null),this._refCount=0,this._group=a}var s=i.prototype;return s.getFloat=function(t){return this._getData(t)},s.setFloat=function(t,e){this._setData(t,e)},s.getInt=function(t){return this._getData(t)},s.setInt=function(t,e){this._setData(t,e)},s.getFloatArray=function(t){return this._getData(t)},s.setFloatArray=function(t,e){this._setData(t,e)},s.getIntArray=function(t){return this._getData(t)},s.setIntArray=function(t,e){this._setData(t,e)},s.getVector2=function(t){return this._getData(t)},s.setVector2=function(t,e){this._setData(t,e)},s.getVector3=function(t){return this._getData(t)},s.setVector3=function(t,e){this._setData(t,e)},s.getVector4=function(t){return this._getData(t)},s.setVector4=function(t,e){this._setData(t,e)},s.getMatrix=function(t){return this._getData(t)},s.setMatrix=function(t,e){this._setData(t,e)},s.getColor=function(t){return this._getData(t)},s.setColor=function(t,e){this._setData(t,e)},s.getTexture=function(t){return this._getData(t)},s.setTexture=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);r&&r._addRefCount(-1),e&&e._addRefCount(1)}this._setData(t,e)},s.getTextureArray=function(t){return this._getData(t)},s.setTextureArray=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);if(r)for(var n=0,o=r.length;n<o;n++)r[n]._addRefCount(-1);if(e)for(var c=0,l=e.length;c<l;c++)e[c]._addRefCount(1)}this._setData(t,e)},s.enableMacro=function(t,e){e===void 0&&(e=null),e?this._enableVariableMacro(t,e):(typeof t=="string"&&(t=z.getMacroByName(t)),this._macroCollection.enable(t))},s.disableMacro=function(t){if(typeof t=="string"){var e=this._variableMacros[t];e?this._disableVariableMacro(t,e):(t=z.getMacroByName(t),this._macroCollection.disable(t))}else this._macroCollection.disable(t)},s.clone=function(){var t=new i(this._group);return this.cloneTo(t),t},s.cloneTo=function(t){wt.deepCloneObject(this._macroCollection,t._macroCollection),_i(t._variableMacros,this._variableMacros);for(var e=this._properties,r=t._properties,n=Object.keys(e),o=0,c=n.length;o<c;o++){var l=n[o],u=e[l];if(u!=null)if(typeof u=="number")r[l]=u;else if(u instanceof At)r[l]=u;else if(u instanceof Array||u instanceof Float32Array||u instanceof Int32Array)r[l]=u.slice();else{var h=r[l];h?u.cloneTo(h):r[l]=u.clone()}else r[l]=u}},s._getData=function(t){return typeof t=="string"&&(t=z.getPropertyByName(t)),this._properties[t._uniqueId]},s._setData=function(t,e){if(typeof t=="string"&&(t=z.getPropertyByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+xt[t._group]+" property.";this._properties[t._uniqueId]=e},s._getRefCount=function(){return this._refCount},s._addRefCount=function(t){this._refCount+=t;var e=this._properties;for(var r in e){var n=e[r];n&&n instanceof At&&n._addRefCount(t)}},s._enableVariableMacro=function(t,e){var r=this._variableMacros,n=r[t];if(n!==e){n&&this._disableVariableMacro(t,n);var o=z.getMacroByName(t+" "+e);this._macroCollection.enable(o),r[t]=e}},s._disableVariableMacro=function(t,e){var r=z.getMacroByName(t+" "+e);this._macroCollection.disable(r),delete this._variableMacros[t]},i}(),ue;(function(i){i[i.Zero=0]="Zero",i[i.One=1]="One",i[i.SourceColor=2]="SourceColor",i[i.OneMinusSourceColor=3]="OneMinusSourceColor",i[i.DestinationColor=4]="DestinationColor",i[i.OneMinusDestinationColor=5]="OneMinusDestinationColor",i[i.SourceAlpha=6]="SourceAlpha",i[i.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",i[i.DestinationAlpha=8]="DestinationAlpha",i[i.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",i[i.SourceAlphaSaturate=10]="SourceAlphaSaturate",i[i.BlendColor=11]="BlendColor",i[i.OneMinusBlendColor=12]="OneMinusBlendColor"})(ue||(ue={}));var ft;(function(i){i[i.Add=0]="Add",i[i.Subtract=1]="Subtract",i[i.ReverseSubtract=2]="ReverseSubtract",i[i.Min=3]="Min",i[i.Max=4]="Max"})(ft||(ft={}));var Dt;(function(i){i[i.None=0]="None",i[i.Red=1]="Red",i[i.Green=2]="Green",i[i.Blue=4]="Blue",i[i.Alpha=8]="Alpha",i[i.All=15]="All"})(Dt||(Dt={}));var yu=function(){this.enabled=!1,this.colorBlendOperation=ft.Add,this.alphaBlendOperation=ft.Add,this.sourceColorBlendFactor=ue.One,this.sourceAlphaBlendFactor=ue.One,this.destinationColorBlendFactor=ue.Zero,this.destinationAlphaBlendFactor=ue.Zero,this.colorWriteMask=Dt.All},xu=function(){function i(){this.targetBlendState=new yu,this.blendColor=new ne(0,0,0,0),this.alphaToCoverage=!1}i._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case ue.Zero:return r.ZERO;case ue.One:return r.ONE;case ue.SourceColor:return r.SRC_COLOR;case ue.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case ue.DestinationColor:return r.DST_COLOR;case ue.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case ue.SourceAlpha:return r.SRC_ALPHA;case ue.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case ue.DestinationAlpha:return r.DST_ALPHA;case ue.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case ue.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case ue.BlendColor:return r.CONSTANT_COLOR;case ue.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},i._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case ft.Add:return r.FUNC_ADD;case ft.Subtract:return r.FUNC_SUBTRACT;case ft.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case ft.Min:if(!t.canIUse(Q.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case ft.Max:if(!t.canIUse(Q.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}};var s=i.prototype;return s._apply=function(t,e){this._platformApply(t,e.blendState)},s._platformApply=function(t,e){var r=t.gl,n=e.targetBlendState,o=this.targetBlendState,c=o.enabled,l=o.colorBlendOperation,u=o.alphaBlendOperation,h=o.sourceColorBlendFactor,f=o.destinationColorBlendFactor,d=o.sourceAlphaBlendFactor,_=o.destinationAlphaBlendFactor,p=o.colorWriteMask;if(c!==n.enabled&&(c?r.enable(r.BLEND):r.disable(r.BLEND),n.enabled=c),c){(h!==n.sourceColorBlendFactor||f!==n.destinationColorBlendFactor||d!==n.sourceAlphaBlendFactor||_!==n.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(i._getGLBlendFactor(t,h),i._getGLBlendFactor(t,f),i._getGLBlendFactor(t,d),i._getGLBlendFactor(t,_)),n.sourceColorBlendFactor=h,n.destinationColorBlendFactor=f,n.sourceAlphaBlendFactor=d,n.destinationAlphaBlendFactor=_),(l!==n.colorBlendOperation||u!==n.alphaBlendOperation)&&(r.blendEquationSeparate(i._getGLBlendOperation(t,l),i._getGLBlendOperation(t,u)),n.colorBlendOperation=l,n.alphaBlendOperation=u);var v=this.blendColor;ne.equals(e.blendColor,v)||(r.blendColor(v.r,v.g,v.b,v.a),v.cloneTo(e.blendColor))}p!==n.colorWriteMask&&(r.colorMask((p&Dt.Red)!==0,(p&Dt.Green)!==0,(p&Dt.Blue)!==0,(p&Dt.Alpha)!==0),n.colorWriteMask=p);var g=this.alphaToCoverage;g!==e.alphaToCoverage&&(g?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=g)},i}(),Me;(function(i){i[i.Never=0]="Never",i[i.Less=1]="Less",i[i.Equal=2]="Equal",i[i.LessEqual=3]="LessEqual",i[i.Greater=4]="Greater",i[i.NotEqual=5]="NotEqual",i[i.GreaterEqual=6]="GreaterEqual",i[i.Always=7]="Always"})(Me||(Me={}));var bu=function(){function i(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=Me.Less}i._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Me.Never:return r.NEVER;case Me.Less:return r.LESS;case Me.Equal:return r.EQUAL;case Me.LessEqual:return r.LEQUAL;case Me.Greater:return r.GREATER;case Me.NotEqual:return r.NOTEQUAL;case Me.GreaterEqual:return r.GEQUAL;case Me.Always:return r.ALWAYS}};var s=i.prototype;return s._apply=function(t,e){this._platformApply(t,e.depthState)},s._platformApply=function(t,e){var r=t.gl,n=this.enabled,o=this.compareFunction,c=this.writeEnabled;n!=e.enabled&&(n?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=n),n&&(o!=e.compareFunction&&(r.depthFunc(i._getGLCompareFunction(t,o)),e.compareFunction=o),c!=e.writeEnabled&&(r.depthMask(c),e.writeEnabled=c))},i}(),dt;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(dt||(dt={}));var wu=function(){function i(){this.cullMode=dt.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var s=i.prototype;return s._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},s._platformApply=function(t,e,r){var n=t.gl,o=this.cullMode,c=this.depthBias,l=this.slopeScaledDepthBias,u=o!==dt.Off;u!==e._cullFaceEnable&&(u?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),e._cullFaceEnable=u),u&&o!==e.cullMode&&(o==dt.Back?n.cullFace(n.BACK):n.cullFace(n.FRONT),e.cullMode=o),r!==e._frontFaceInvert&&(r?n.frontFace(n.CW):n.frontFace(n.CCW),e._frontFaceInvert=r),(c!==e.depthBias||l!==e.slopeScaledDepthBias)&&(c!==0||l!==0?(n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(l,c)):n.disable(n.POLYGON_OFFSET_FILL),e.depthBias=c,e.slopeScaledDepthBias=l)},i}(),Ve;(function(i){i[i.Keep=0]="Keep",i[i.Zero=1]="Zero",i[i.Replace=2]="Replace",i[i.IncrementSaturate=3]="IncrementSaturate",i[i.DecrementSaturate=4]="DecrementSaturate",i[i.Invert=5]="Invert",i[i.IncrementWrap=6]="IncrementWrap",i[i.DecrementWrap=7]="DecrementWrap"})(Ve||(Ve={}));var Au=function(){function i(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=Me.Always,this.compareFunctionBack=Me.Always,this.passOperationFront=Ve.Keep,this.passOperationBack=Ve.Keep,this.failOperationFront=Ve.Keep,this.failOperationBack=Ve.Keep,this.zFailOperationFront=Ve.Keep,this.zFailOperationBack=Ve.Keep}i._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Me.Never:return r.NEVER;case Me.Less:return r.LESS;case Me.Equal:return r.EQUAL;case Me.LessEqual:return r.LEQUAL;case Me.Greater:return r.GREATER;case Me.NotEqual:return r.NOTEQUAL;case Me.GreaterEqual:return r.GEQUAL;case Me.Always:return r.ALWAYS}},i._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case Ve.Keep:return r.KEEP;case Ve.Zero:return r.ZERO;case Ve.Replace:return r.REPLACE;case Ve.IncrementSaturate:return r.INCR;case Ve.DecrementSaturate:return r.DECR;case Ve.Invert:return r.INVERT;case Ve.IncrementWrap:return r.INCR_WRAP;case Ve.DecrementWrap:return r.DECR_WRAP}};var s=i.prototype;return s._apply=function(t,e){this._platformApply(t,e.stencilState)},s._platformApply=function(t,e){var r=t.gl,n=this.enabled,o=this.referenceValue,c=this.mask,l=this.compareFunctionFront,u=this.compareFunctionBack,h=this.failOperationFront,f=this.zFailOperationFront,d=this.passOperationFront,_=this.failOperationBack,p=this.zFailOperationBack,v=this.passOperationBack,g=this.writeMask;if(n!=e.enabled&&(n?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=n),n){var m=o!==e.referenceValue||c!==e.mask;(m||l!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,i._getGLCompareFunction(t,l),o,c),e.compareFunctionFront=l),(m||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,i._getGLCompareFunction(t,u),o,c),e.compareFunctionBack=this.compareFunctionBack),m&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(h!==e.failOperationFront||f!==e.zFailOperationFront||d!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,i._getGLStencilOperation(t,h),i._getGLStencilOperation(t,f),i._getGLStencilOperation(t,d)),e.failOperationFront=h,e.zFailOperationFront=f,e.passOperationFront=d),(_!==e.failOperationBack||p!==e.zFailOperationBack||v!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,i._getGLStencilOperation(t,_),i._getGLStencilOperation(t,p),i._getGLStencilOperation(t,v)),e.failOperationBack=_,e.zFailOperationBack=p,e.passOperationBack=v),g!==e.writeMask&&(r.stencilMask(g),e.writeMask=g)}},i}(),cc=function(){function i(){this.blendState=new xu,this.depthState=new bu,this.stencilState=new Au,this.rasterState=new wu}var s=i.prototype;return s._apply=function(t,e){var r=t._hardwareRenderer,n=t._lastRenderState;this.blendState._apply(r,n),this.depthState._apply(r,n),this.stencilState._apply(r,n),this.rasterState._apply(r,n,e)},i}(),Qt=function(i){ee(s,i);function s(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.shader=void 0,r.renderQueueType=We.Opaque,r.shaderData=new tn(xt.Material),r.renderState=new cc,r.shader=e,r}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),wt.deepCloneObject(this.renderState,e.renderState)},a._addRefCount=function(e){i.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},a._preRender=function(e){},a._onDestroy=function(){},s}(Qr),jr=function(){function i(a){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=a}var s=i.prototype;return s.getFromPool=function(){var t=this._elementPoolIndex,e=this._elementPool;if(this._elementPoolIndex++,e.length===t){var r=new this._type;return e.push(r),r}else return e[t]},s.resetPool=function(){this._elementPoolIndex=0},i}(),Su=function(){function i(){this._camera=void 0,this._viewProjectMatrix=new ie}var s=i.prototype;return s._setContext=function(t){this._camera=t,ie.multiply(t.projectionMatrix,t.viewMatrix,this._viewProjectMatrix)},i}(),Pu=function(){function i(){this.component=void 0,this.mesh=void 0,this.subMesh=void 0,this.material=void 0}var s=i.prototype;return s.setValue=function(t,e,r,n){this.component=t,this.mesh=e,this.subMesh=r,this.material=n},i}(),Mu=function(){function i(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.color=void 0,this.material=void 0,this.camera=void 0}var s=i.prototype;return s.setValue=function(t,e,r,n,o,c,l){this.component=t,this.positions=e,this.uv=r,this.triangles=n,this.color=o,this.material=c,this.camera=l},i}(),Tu=function(){function i(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.material=void 0,this.isAdd=!0,this.camera=void 0}var s=i.prototype;return s.setValue=function(t,e,r,n,o){this.component=t,this.positions=e,this.uv=r,this.triangles=n,this.material=o},i}(),lr;(function(i){i[i.None=0]="None",i[i.VisibleInsideMask=1]="VisibleInsideMask",i[i.VisibleOutsideMask=2]="VisibleOutsideMask"})(lr||(lr={}));var Ue,pa,ga,ma,ya,xa,ba,wa,Aa,Sa,Pa,Ma,Ta,Ca,Ra,Ea,za,mr,Ba,Rn=(Ue=(Ba=mr=function(i){ee(s,i);function s(t){var e;e=i.call(this,t)||this,V(e,"shaderData",pa,F(e)),V(e,"isCulled",ga,F(e)),V(e,"_distanceForSort",ma,F(e)),V(e,"_onUpdateIndex",ya,F(e)),V(e,"_rendererIndex",xa,F(e)),V(e,"_globalShaderMacro",ba,F(e)),V(e,"_renderSortId",wa,F(e)),V(e,"_overrideUpdate",Aa,F(e)),V(e,"_materials",Sa,F(e)),V(e,"_transformChangeFlag",Pa,F(e)),V(e,"_bounds",Ma,F(e)),V(e,"_mvMatrix",Ta,F(e)),V(e,"_mvpMatrix",Ca,F(e)),V(e,"_mvInvMatrix",Ra,F(e)),V(e,"_normalMatrix",Ea,F(e)),V(e,"_materialsInstanced",za,F(e));var r=s.prototype;return e._overrideUpdate=e.update!==r.update,e._transformChangeFlag=e.entity.transform.registerWorldChangeFlag(),e.shaderData._addRefCount(1),e}var a=s.prototype;return a.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var n=r[e];if(n)return this._materialsInstanced[e]?n:this._createInstanceMaterial(n,e)}return null},a.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},a.setMaterial=function(e,r){r===void 0&&(r=null);var n;typeof e=="number"?n=e:(n=0,r=e);var o=this._materials;n>=o.length&&(o.length=n+1);var c=this._materialsInstanced,l=o[n];l!==r&&(o[n]=r,n<c.length&&(c[n]=!1),l&&l._addRefCount(-1),r&&r._addRefCount(1))},a.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,n=0,o=e.length;n<o;n++)r[n]||this._createInstanceMaterial(this._materials[n],n);return e},a.getMaterials=function(){return this._materials},a.setMaterials=function(e){for(var r=e.length,n=this._materials,o=this._materialsInstanced,c=r,l=n.length;c<l;c++){var u=n[c];u&&u._addRefCount(-1)}n.length!==r&&(n.length=r),o.length!==0&&(o.length=0);for(var h=0;h<r;h++){var f=n[h],d=e[h];f!==d&&(n[h]=d,f&&f._addRefCount(-1),d&&d._addRefCount(1))}},a.update=function(e){},a._updateShaderData=function(e){var r=this.shaderData,n=this.entity.transform.worldMatrix,o=this._mvMatrix,c=this._mvpMatrix,l=this._mvInvMatrix,u=this._normalMatrix;ie.multiply(e._camera.viewMatrix,n,o),ie.multiply(e._viewProjectMatrix,n,c),ie.invert(o,l),ie.invert(n,u),u.transpose(),r.setMatrix(s._localMatrixProperty,this.entity.transform.localMatrix),r.setMatrix(s._worldMatrixProperty,n),r.setMatrix(s._mvMatrixProperty,o),r.setMatrix(s._mvpMatrixProperty,c),r.setMatrix(s._mvInvMatrixProperty,l),r.setMatrix(s._normalMatrixProperty,u)},a._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},a._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},a._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var r=0,n=this._materials.length;r<n;r++)this._materials[r]._addRefCount(-1)},a._updateBounds=function(e){},a._createInstanceMaterial=function(e,r){var n=e.clone();return n.name=n.name+"(Instance)",e._addRefCount(-1),n._addRefCount(1),this._materialsInstanced[r]=!0,this._materials[r]=n,n},Z(s,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,n=this._materialsInstanced;r.length!==e&&(r.length=e),n.length>e&&(n.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),s}(Mt),mr._localMatrixProperty=z.getPropertyByName("u_localMat"),mr._worldMatrixProperty=z.getPropertyByName("u_modelMat"),mr._mvMatrixProperty=z.getPropertyByName("u_MVMat"),mr._mvpMatrixProperty=z.getPropertyByName("u_MVPMat"),mr._mvInvMatrixProperty=z.getPropertyByName("u_MVInvMat"),mr._normalMatrixProperty=z.getPropertyByName("u_normalMat"),Ba),pa=k(Ue.prototype,"shaderData",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn(xt.Renderer)}}),ga=k(Ue.prototype,"isCulled",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ma=k(Ue.prototype,"_distanceForSort",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ya=k(Ue.prototype,"_onUpdateIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),xa=k(Ue.prototype,"_rendererIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ba=k(Ue.prototype,"_globalShaderMacro",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ct}}),wa=k(Ue.prototype,"_renderSortId",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Aa=k(Ue.prototype,"_overrideUpdate",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sa=k(Ue.prototype,"_materials",[tl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pa=k(Ue.prototype,"_transformChangeFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ma=k(Ue.prototype,"_bounds",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ur(new w,new w)}}),Ta=k(Ue.prototype,"_mvMatrix",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),Ca=k(Ue.prototype,"_mvpMatrix",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),Ra=k(Ue.prototype,"_mvInvMatrix",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),Ea=k(Ue.prototype,"_normalMatrix",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),za=k(Ue.prototype,"_materialsInstanced",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ue),Xi;(function(i){i[i.Layer0=1]="Layer0",i[i.Layer1=2]="Layer1",i[i.Layer2=4]="Layer2",i[i.Layer3=8]="Layer3",i[i.Layer4=16]="Layer4",i[i.Layer5=32]="Layer5",i[i.Layer6=64]="Layer6",i[i.Layer7=128]="Layer7",i[i.Layer8=256]="Layer8",i[i.Layer9=512]="Layer9",i[i.Layer10=1024]="Layer10",i[i.Layer11=2048]="Layer11",i[i.Layer12=4096]="Layer12",i[i.Layer13=8192]="Layer13",i[i.Layer14=16384]="Layer14",i[i.Layer15=32768]="Layer15",i[i.Layer16=65536]="Layer16",i[i.Layer17=131072]="Layer17",i[i.Layer18=262144]="Layer18",i[i.Layer19=524288]="Layer19",i[i.Layer20=1048576]="Layer20",i[i.Layer21=2097152]="Layer21",i[i.Layer22=4194304]="Layer22",i[i.Layer23=8388608]="Layer23",i[i.Layer24=16777216]="Layer24",i[i.Layer25=33554432]="Layer25",i[i.Layer26=67108864]="Layer26",i[i.Layer27=134217728]="Layer27",i[i.Layer28=268435456]="Layer28",i[i.Layer29=536870912]="Layer29",i[i.Layer30=1073741824]="Layer30",i[i.Layer31=2147483648]="Layer31",i[i.Everything=4294967295]="Everything"})(Xi||(Xi={}));var ir,Da,Oa,Fa,Ia,La,Ua,Li,Na,mn=(ir=(Na=Li=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,e._maskElement=void 0,V(e,"_positions",Da,F(e)),V(e,"_worldMatrixDirtyFlag",Oa,F(e)),V(e,"_sprite",Fa,F(e)),V(e,"_alphaCutoff",Ia,F(e)),V(e,"_spriteDirty",La,F(e)),V(e,"influenceLayers",Ua,F(e)),e._worldMatrixDirtyFlag=t.transform.registerWorldChangeFlag(),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(s._alphaCutoffProperty,e._alphaCutoff),e}var a=s.prototype;return a._onDestroy=function(){this._worldMatrixDirtyFlag.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),i.prototype._onDestroy.call(this)},a._render=function(e){var r=this.sprite;if(!r)return null;var n=r.texture;if(!n)return null;var o=this._positions,c=this.entity.transform;if(r._updateMesh(),this._worldMatrixDirtyFlag.flag||this._spriteDirty.flag){for(var l=r._positions,u=s._tempVec3,h=c.worldMatrix,f=0,d=o.length;f<d;f++){var _=l[f];u.setValue(_.x,_.y,0),w.transformToVec3(u,h,o[f])}this._spriteDirty.flag=!1,this._worldMatrixDirtyFlag.flag=!1}this.shaderData.setTexture(s._textureProperty,n);var p=this._engine._spriteMaskElementPool,v=p.getFromPool();v.setValue(this,o,r._uv,r._triangles,this.getMaterial()),v.camera=e,e._renderPipeline._allSpriteMasks.add(this),this._maskElement=v},a._cloneTo=function(e){e.sprite=this._sprite},Z(s,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(s._alphaCutoffProperty,e))}}]),s}(Rn),Li._textureProperty=z.getPropertyByName("u_maskTexture"),Li._alphaCutoffProperty=z.getPropertyByName("u_maskAlphaCutoff"),Li._tempVec3=new w,Na),Da=k(ir.prototype,"_positions",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new w,new w,new w,new w]}}),Oa=k(ir.prototype,"_worldMatrixDirtyFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Fa=k(ir.prototype,"_sprite",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ia=k(ir.prototype,"_alphaCutoff",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return .5}}),La=k(ir.prototype,"_spriteDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ua=k(ir.prototype,"influenceLayers",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xi.Everything}}),ir),$;(function(i){i[i.Float=0]="Float",i[i.Vector2=1]="Vector2",i[i.Vector3=2]="Vector3",i[i.Vector4=3]="Vector4",i[i.Byte4=4]="Byte4",i[i.UByte4=5]="UByte4",i[i.NormalizedByte4=6]="NormalizedByte4",i[i.NormalizedUByte4=7]="NormalizedUByte4",i[i.Short2=8]="Short2",i[i.UShort2=9]="UShort2",i[i.NormalizedShort2=10]="NormalizedShort2",i[i.NormalizedUShort2=11]="NormalizedUShort2",i[i.Short4=12]="Short4",i[i.UShort4=13]="UShort4",i[i.NormalizedShort4=14]="NormalizedShort4",i[i.NormalizedUShort4=15]="NormalizedUShort4"})($||($={}));var _t;(function(i){i[i.Static=0]="Static",i[i.Dynamic=1]="Dynamic",i[i.Stream=2]="Stream"})(_t||(_t={}));var Xe;(function(i){i[i.UInt8=0]="UInt8",i[i.UInt16=1]="UInt16",i[i.UInt32=2]="UInt32"})(Xe||(Xe={}));var ji=function(){function i(){}return i._getGLBufferUsage=function(a,t){switch(t){case _t.Static:return a.STATIC_DRAW;case _t.Dynamic:return a.DYNAMIC_DRAW;case _t.Stream:return a.STREAM_DRAW}},i._getGLIndexType=function(a){switch(a){case Xe.UInt8:return Be.UNSIGNED_BYTE;case Xe.UInt16:return Be.UNSIGNED_SHORT;case Xe.UInt32:return Be.UNSIGNED_INT}},i._getGLIndexByteCount=function(a){switch(a){case Xe.UInt8:return 1;case Xe.UInt16:return 2;case Xe.UInt32:return 4}},i._getElementInfo=function(a){var t,e,r=!1;switch(a){case $.Float:t=1,e=Be.FLOAT;break;case $.Vector2:t=2,e=Be.FLOAT;break;case $.Vector3:t=3,e=Be.FLOAT;break;case $.Vector4:t=4,e=Be.FLOAT;break;case $.Byte4:t=4,e=Be.BYTE;break;case $.UByte4:t=4,e=Be.UNSIGNED_BYTE;break;case $.NormalizedByte4:t=4,e=Be.BYTE,r=!0;break;case $.NormalizedUByte4:t=4,e=Be.UNSIGNED_BYTE,r=!0;break;case $.Short2:t=2,e=Be.SHORT;break;case $.UShort2:t=2,e=Be.UNSIGNED_SHORT;break;case $.NormalizedShort2:t=2,e=Be.SHORT,r=!0;break;case $.NormalizedUShort2:t=2,e=Be.UNSIGNED_SHORT,r=!0;break;case $.Short4:t=4,e=Be.SHORT;break;case $.UShort4:t=4,e=Be.UNSIGNED_SHORT;break;case $.NormalizedShort4:t=4,e=Be.SHORT,r=!0;break;case $.NormalizedUShort4:t=4,e=Be.UNSIGNED_SHORT,r=!0;break}return{size:t,type:e,normalized:r}},i}(),we=function(){function i(s,a,t,e,r){r===void 0&&(r=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=s,this._offset=a,this._format=t,this._bindingIndex=e,this._glElementInfo=ji._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return Z(i,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),i}(),$t;(function(i){i[i.VertexBuffer=0]="VertexBuffer",i[i.IndexBuffer=1]="IndexBuffer"})($t||($t={}));var Ki;(function(i){i[i.None=0]="None",i[i.Discard=1]="Discard"})(Ki||(Ki={}));var qr=function(i){ee(s,i);function s(t,e,r,n){var o;n===void 0&&(n=_t.Static),o=i.call(this,t)||this,o._glBindTarget=void 0,o._glBufferUsage=void 0,o._nativeBuffer=void 0,o._hardwareRenderer=void 0,o._type=void 0,o._byteLength=void 0,o._bufferUsage=void 0,o._engine=t,o._type=e,o._bufferUsage=n;var c=t._hardwareRenderer,l=c.gl,u=ji._getGLBufferUsage(l,n),h=e===$t.VertexBuffer?l.ARRAY_BUFFER:l.ELEMENT_ARRAY_BUFFER;return o._nativeBuffer=l.createBuffer(),o._hardwareRenderer=c,o._glBufferUsage=u,o._glBindTarget=h,o.bind(),typeof r=="number"?(o._byteLength=r,l.bufferData(h,r,u)):(o._byteLength=r.byteLength,l.bufferData(h,r,u)),l.bindBuffer(h,null),o}var a=s.prototype;return a.bind=function(){var e=this._hardwareRenderer.gl;e.bindBuffer(this._glBindTarget,this._nativeBuffer)},a.setData=function(e,r,n,o,c){r===void 0&&(r=0),n===void 0&&(n=0),c===void 0&&(c=Ki.None);var l=this._hardwareRenderer.gl,u=this._hardwareRenderer.isWebGL2,h=this._glBindTarget;this.bind(),c===Ki.Discard&&l.bufferData(h,this._byteLength,this._glBufferUsage);var f=e.BYTES_PER_ELEMENT||1,d=o?f*o:e.byteLength;if(n!==0||d<e.byteLength){var _=e.byteOffset!==void 0;if(u&&_)l.bufferSubData(h,r,e,n,d/f);else{var p=new Uint8Array(_?e.buffer:e,n*f,d);l.bufferSubData(h,r,p)}}else l.bufferSubData(h,r,e);l.bindBuffer(h,null)},a.getData=function(e,r,n,o){r===void 0&&(r=0),n===void 0&&(n=0);var c=this._hardwareRenderer.isWebGL2;if(c){var l=this._hardwareRenderer.gl;this.bind(),l.getBufferSubData(this._glBindTarget,r,e,n,o)}else throw"Buffer is write-only on WebGL1.0 platforms."},a._onDestroy=function(){var e=this._hardwareRenderer.gl;e.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},a.resize=function(e){this.bind();var r=this._hardwareRenderer.gl;r.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},Z(s,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),s}(Qr),mi;(function(i){i[i.Points=0]="Points",i[i.Lines=1]="Lines",i[i.LineLoop=2]="LineLoop",i[i.LineStrip=3]="LineStrip",i[i.Triangles=4]="Triangles",i[i.TriangleStrip=5]="TriangleStrip",i[i.TriangleFan=6]="TriangleFan"})(mi||(mi={}));var yn=function(){function i(s,a){this._buffer=void 0,this._format=void 0,this._buffer=s,this._format=a}return Z(i,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),i}(),lc=function(s,a,t){s===void 0&&(s=0),a===void 0&&(a=0),t===void 0&&(t=mi.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=s,this.count=a,this.topology=t},uc=function(i){ee(s,i);function s(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.bounds=new ur,r._vertexElementMap={},r._glIndexType=void 0,r._glIndexByteCount=void 0,r._platformPrimitive=void 0,r._instanceCount=0,r._vertexBufferBindings=[],r._indexBufferBinding=null,r._vertexElements=[],r._subMeshes=[],r._updateFlagManager=new bi,r.name=e,r._platformPrimitive=r._engine._hardwareRenderer.createPlatformPrimitive(F(r)),r}var a=s.prototype;return a.addSubMesh=function(e,r,n){return n===void 0&&(n=mi.Triangles),typeof e=="number"&&(e=new lc(e,r,n)),this._subMeshes.push(e),e},a.removeSubMesh=function(e){var r=this._subMeshes,n=r.indexOf(e);n!==-1&&r.splice(n,1)},a.clearSubMesh=function(){this._subMeshes.length=0},a.registerUpdateFlag=function(){return this._updateFlagManager.register()},a._draw=function(e,r){this._platformPrimitive.draw(e,r)},a._addRefCount=function(e){i.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,n=0,o=r.length;n<o;n++)r[n]._buffer._addRefCount(e)},a._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},a._setVertexElements=function(e){this._clearVertexElements();for(var r=0,n=e.length;r<n;r++)this._addVertexElement(e[r])},a._setVertexBufferBinding=function(e,r){if(this._getRefCount()>0){var n=this._vertexBufferBindings[e];n&&n._buffer._addRefCount(-1),r._buffer._addRefCount(1)}this._vertexBufferBindings[e]=r},a._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=ji._getGLIndexType(e.format),this._glIndexByteCount=ji._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},a._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r]},a._addVertexElement=function(e){var r=e.semantic;this._vertexElementMap[r]=e,this._vertexElements.push(e),this._updateFlagManager.distribute()},Z(s,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),s}(Qr),hc=function(){function i(s,a){this._buffer=void 0,this._stride=void 0,this._buffer=s,this._stride=a}return Z(i,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),i}(),bt;(function(i){i[i.Point=0]="Point",i[i.Bilinear=1]="Bilinear",i[i.Trilinear=2]="Trilinear"})(bt||(bt={}));var ae;(function(i){i[i.R8G8B8=0]="R8G8B8",i[i.R8G8B8A8=1]="R8G8B8A8",i[i.R4G4B4A4=2]="R4G4B4A4",i[i.R5G5B5A1=3]="R5G5B5A1",i[i.R5G6B5=4]="R5G6B5",i[i.Alpha8=5]="Alpha8",i[i.LuminanceAlpha=6]="LuminanceAlpha",i[i.R32G32B32A32=7]="R32G32B32A32",i[i.DXT1=8]="DXT1",i[i.DXT5=9]="DXT5",i[i.ETC1_RGB=10]="ETC1_RGB",i[i.ETC2_RGB=11]="ETC2_RGB",i[i.ETC2_RGBA5=12]="ETC2_RGBA5",i[i.ETC2_RGBA8=13]="ETC2_RGBA8",i[i.PVRTC_RGB2=14]="PVRTC_RGB2",i[i.PVRTC_RGBA2=15]="PVRTC_RGBA2",i[i.PVRTC_RGB4=16]="PVRTC_RGB4",i[i.PVRTC_RGBA4=17]="PVRTC_RGBA4",i[i.ASTC_4x4=18]="ASTC_4x4",i[i.ASTC_5x5=19]="ASTC_5x5",i[i.ASTC_6x6=20]="ASTC_6x6",i[i.ASTC_8x8=21]="ASTC_8x8",i[i.ASTC_10x10=22]="ASTC_10x10",i[i.ASTC_12x12=23]="ASTC_12x12"})(ae||(ae={}));var nt;(function(i){i[i.Clamp=0]="Clamp",i[i.Repeat=1]="Repeat",i[i.Mirror=2]="Mirror"})(nt||(nt={}));var $r=function(i){ee(s,i);function s(t,e,r,n,o){var c;return n===void 0&&(n=ae.R8G8B8A8),o===void 0&&(o=!0),c=i.call(this,t)||this,c._format=void 0,c._mipmap=o,c._width=e,c._height=r,c._format=n,c._mipmapCount=c._getMipmapCount(),c._platformTexture=t._hardwareRenderer.createPlatformTexture2D(F(c)),c.filterMode=bt.Bilinear,c.wrapModeU=c.wrapModeV=nt.Repeat,c}var a=s.prototype;return a.setPixelBuffer=function(e,r,n,o,c,l){r===void 0&&(r=0),this._platformTexture.setPixelBuffer(e,r,n,o,c,l)},a.setImageSource=function(e,r,n,o,c,l){r===void 0&&(r=0),n===void 0&&(n=!1),o===void 0&&(o=!1),this._platformTexture.setImageSource(e,r,n,o,c,l)},a.getPixelBuffer=function(e,r,n,o,c,l){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):u===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):u===5?this._platformTexture.getPixelBuffer(e,r,n,o,0,c):u===6&&this._platformTexture.getPixelBuffer(e,r,n,o,c,l)},Z(s,[{key:"format",get:function(){return this._format}}]),s}(At),rt;(function(i){i[i.R8G8B8=0]="R8G8B8",i[i.R8G8B8A8=1]="R8G8B8A8",i[i.R4G4B4A4=2]="R4G4B4A4",i[i.R5G5B5A1=3]="R5G5B5A1",i[i.R5G6B5=4]="R5G6B5",i[i.Alpha8=5]="Alpha8",i[i.R16G16B16A16=6]="R16G16B16A16",i[i.R32G32B32A32=7]="R32G32B32A32"})(rt||(rt={}));var ke;(function(i){i[i.Depth=0]="Depth",i[i.DepthStencil=1]="DepthStencil",i[i.Stencil=2]="Stencil",i[i.Depth16=3]="Depth16",i[i.Depth24=4]="Depth24",i[i.Depth32=5]="Depth32",i[i.Depth24Stencil8=6]="Depth24Stencil8",i[i.Depth32Stencil8=7]="Depth32Stencil8"})(ke||(ke={}));var yt;(function(i){i[i.PositiveX=0]="PositiveX",i[i.NegativeX=1]="NegativeX",i[i.PositiveY=2]="PositiveY",i[i.NegativeY=3]="NegativeY",i[i.PositiveZ=4]="PositiveZ",i[i.NegativeZ=5]="NegativeZ"})(yt||(yt={}));var rn=function(i){ee(s,i);function s(t,e,r,n){var o;return r===void 0&&(r=ae.R8G8B8A8),n===void 0&&(n=!0),o=i.call(this,t)||this,o._format=void 0,o._mipmap=n,o._width=e,o._height=e,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTextureCubeMap(F(o)),o.filterMode=bt.Bilinear,o.wrapModeU=o.wrapModeV=nt.Clamp,o}var a=s.prototype;return a.setPixelBuffer=function(e,r,n,o,c,l,u){n===void 0&&(n=0),this._platformTexture.setPixelBuffer(e,r,n,o,c,l,u)},a.setImageSource=function(e,r,n,o,c,l,u){n===void 0&&(n=0),o===void 0&&(o=!1),c===void 0&&(c=!1),this._platformTexture.setImageSource(e,r,n,o,c,l,u)},a.getPixelBuffer=function(e,r,n,o,c,l,u){var h=arguments.length;h===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):h===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,n):h===6?this._platformTexture.getPixelBuffer(e,r,n,o,c,0,l):h===7&&this._platformTexture.getPixelBuffer(e,r,n,o,c,l,u)},Z(s,[{key:"format",get:function(){return this._format}}]),s}(At),si=function(i){ee(s,i);function s(a,t,e,r,n,o){var c;return r===void 0&&(r=ke.Depth),n===void 0&&(n=!1),o===void 0&&(o=!1),c=i.call(this,a)||this,c._autoMipmap=!1,c._format=void 0,c._isCube=!1,c._isCube=o,c._mipmap=n,c._width=t,c._height=e,c._format=r,c._mipmapCount=c._getMipmapCount(),c._platformTexture=a._hardwareRenderer.createPlatformRenderDepthTexture(F(c)),c.filterMode=bt.Bilinear,c.wrapModeU=c.wrapModeV=nt.Clamp,c}return Z(s,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(t){this._autoMipmap=t}}]),s}(At),fc=function(i){ee(s,i);function s(t,e,r,n,o,c){var l;return o===void 0&&(o=ke.Depth),c===void 0&&(c=1),l=i.call(this,t)||this,l._platformRenderTarget=void 0,l._colorTextures=void 0,l._depth=void 0,l._antiAliasing=void 0,l._width=void 0,l._height=void 0,l._depthTexture=void 0,l._width=e,l._height=r,l._antiAliasing=c,l._depth=o,n?l._colorTextures=n instanceof Array?n.slice():[n]:l._colorTextures=[],o instanceof si&&(l._depthTexture=o),l._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(F(l)),l}var a=s.prototype;return a.getColorTexture=function(e){return e===void 0&&(e=0),this._colorTextures[e]},a.generateMipmaps=function(){var e,r=this.colorTextureCount;(e=this._depthTexture)!==null&&e!==void 0&&e.autoGenerateMipmaps&&this._depthTexture.generateMipmaps();for(var n=0;n<r;n++){var o=this._colorTextures[n];o.autoGenerateMipmaps&&o.generateMipmaps()}},a.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},a._setRenderTargetInfo=function(e,r){this._platformRenderTarget.setRenderTargetInfo(e,r)},a._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},Z(s,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),s}(dr),dc=function(i){ee(s,i);function s(t,e,r,n,o,c){var l;return n===void 0&&(n=rt.R8G8B8A8),o===void 0&&(o=!1),c===void 0&&(c=!1),l=i.call(this,t)||this,l._autoMipmap=!1,l._format=void 0,l._isCube=!1,l._isCube=c,l._mipmap=o,l._width=e,l._height=r,l._format=n,l._mipmapCount=l._getMipmapCount(),l._platformTexture=t._hardwareRenderer.createPlatformRenderColorTexture(F(l)),l.filterMode=bt.Bilinear,l.wrapModeU=l.wrapModeV=nt.Clamp,l}var a=s.prototype;return a.getPixelBuffer=function(e,r,n,o,c,l,u){l===void 0&&(l=0),this._platformTexture.getPixelBuffer(e,r,n,o,c,l,u)},Z(s,[{key:"format",get:function(){return this._format}},{key:"isCube",get:function(){return this._isCube}},{key:"autoGenerateMipmaps",get:function(){return this._autoMipmap},set:function(e){this._autoMipmap=e}}]),s}(At),Xt=function(i){ee(s,i);function s(t,e){var r;return r=i.call(this,t)||this,r._hasBlendShape=!1,r._useBlendShapeNormal=!1,r._useBlendShapeTangent=!1,r._blendShapeTexture=void 0,r._vertexCount=0,r._accessible=!0,r._verticesFloat32=null,r._verticesUint8=null,r._indices=null,r._indicesFormat=null,r._vertexSlotChanged=!0,r._vertexChangeFlag=0,r._indicesChangeFlag=!1,r._elementCount=0,r._vertexElementsCache=[],r._positions=[],r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r._blendShapes=[],r._blendShapeUpdateFlags=[],r.name=e,r}var a=s.prototype;return a.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";var r=e.length;this._positions=e,this._vertexChangeFlag|=pe.Position,this._vertexCount!==r&&(this._vertexCount=r)},a.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},a.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=pe.Normal,this._normals=e},a.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},a.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=pe.Color,this._colors=e},a.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},a.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=e!=null,this._vertexChangeFlag|=pe.BoneWeight,this._boneWeights=e},a.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},a.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=pe.BoneIndex,this._boneIndices=e},a.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},a.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=pe.Tangent,this._tangents=e},a.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},a.setUVs=function(e,r){var n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(r=(n=r)!=null?n:0,r){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=pe.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=pe.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=pe.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=pe.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=pe.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=pe.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=pe.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=pe.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},a.getUVs=function(e){var r;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=(r=e)!=null?r:0,e){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},a.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=Xe.UInt8:e instanceof Uint16Array?this._indicesFormat=Xe.UInt16:e instanceof Uint32Array&&(this._indicesFormat=Xe.UInt32)),this._indicesChangeFlag=!0},a.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},a.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._vertexChangeFlag|=pe.BlendShape,this._useBlendShapeNormal=this._useBlendShapeNormal||e._useBlendShapeNormal,this._useBlendShapeTangent=this._useBlendShapeTangent||e._useBlendShapeTangent,this._blendShapes.push(e),this._blendShapeUpdateFlags.push(e._registerChangeFlag()),this._hasBlendShape=!0},a.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._vertexChangeFlag|=pe.BlendShape,this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1,this._blendShapes.length=0;for(var e=this._blendShapeUpdateFlags,r=0,n=e.length;r<n;r++)e[r].destroy();e.length=0,this._hasBlendShape=!1},a.uploadData=function(e){var r,n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var o=this._indices;if(this._vertexSlotChanged){var c=this._updateVertexElements();this._setVertexElements(c),this._vertexChangeFlag=pe.All,this._vertexSlotChanged=!1}var l=this._vertexBufferBindings,u=this._elementCount,h=(r=l[0])===null||r===void 0?void 0:r._buffer,f=u*this._vertexCount;if(!h||this._verticesFloat32.length!==f){h==null||h.destroy();var d=new Float32Array(f);this._verticesFloat32=d,this._verticesUint8=new Uint8Array(d.buffer),this._vertexChangeFlag=pe.All,this._updateVertices(d);var _=new qr(this._engine,$t.VertexBuffer,d,e?_t.Static:_t.Dynamic);this._setVertexBufferBinding(0,new hc(_,u*4))}else if(this._vertexChangeFlag&pe.All){var p=this._verticesFloat32;this._updateVertices(p),h.setData(p)}var v=(n=this._indexBufferBinding)===null||n===void 0?void 0:n._buffer;if(o)if(!v||o.byteLength!=v.byteLength){v==null||v.destroy();var g=new qr(this._engine,$t.IndexBuffer,o);this._setIndexBufferBinding(new yn(g,this._indicesFormat))}else this._indicesChangeFlag&&(this._indicesChangeFlag=!1,v.setData(o),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new yn(v,this._indicesFormat)));else v&&(v.destroy(),this._setIndexBufferBinding(null));e&&(this._accessible=!1,this._releaseCache())},a._onDestroy=function(){i.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},a._updateVertexElements=function(){var e=this._vertexElementsCache;e.length=1,e[0]=Cu;var r=12,n=3;this._normals&&(e.push(new we("NORMAL",r,$.Vector3,0)),r+=12,n+=3),this._colors&&(e.push(new we("COLOR_0",r,$.Vector4,0)),r+=16,n+=4),this._boneWeights&&(e.push(new we("WEIGHTS_0",r,$.Vector4,0)),r+=16,n+=4),this._boneIndices&&(e.push(new we("JOINTS_0",r,$.UByte4,0)),r+=4,n+=1),this._tangents&&(e.push(new we("TANGENT",r,$.Vector4,0)),r+=16,n+=4),this._uv&&(e.push(new we("TEXCOORD_0",r,$.Vector2,0)),r+=8,n+=2),this._uv1&&(e.push(new we("TEXCOORD_1",r,$.Vector2,0)),r+=8,n+=2),this._uv2&&(e.push(new we("TEXCOORD_2",r,$.Vector2,0)),r+=8,n+=2),this._uv3&&(e.push(new we("TEXCOORD_3",r,$.Vector2,0)),r+=8,n+=2),this._uv4&&(e.push(new we("TEXCOORD_4",r,$.Vector2,0)),r+=8,n+=2),this._uv5&&(e.push(new we("TEXCOORD_5",r,$.Vector2,0)),r+=8,n+=2),this._uv6&&(e.push(new we("TEXCOORD_6",r,$.Vector2,0)),r+=8,n+=2),this._uv7&&(e.push(new we("TEXCOORD_7",r,$.Vector2,0)),r+=8,n+=2);for(var o=Math.min(this._blendShapes.length,4),c=0,l=o;c<l;c++)e.push(new we("POSITION_BS"+c,r,$.Vector3,0)),r+=12,n+=3,this._useBlendShapeNormal&&(e.push(new we("NORMAL_BS"+c,r,$.Vector3,0)),r+=12,n+=3),this._useBlendShapeTangent&&(e.push(new we("TANGENT_BS"+c,r,$.Vector3,0)),r+=12,n+=3);return this._elementCount=n,e},a._updateVertices=function(e){var r=this._elementCount,n=this._vertexCount,o=this._positions,c=this._normals,l=this._colors,u=this._vertexChangeFlag,h=this._boneWeights,f=this._boneIndices,d=this._tangents,_=this._uv,p=this._uv1,v=this._uv2,g=this._uv3,m=this._uv4,y=this._uv5,A=this._uv6,S=this._uv7;if(u&pe.Position)for(var C=0;C<n;C++){var P=r*C,R=o[C];e[P]=R.x,e[P+1]=R.y,e[P+2]=R.z}var T=3;if(c){if(u&pe.Normal)for(var E=0;E<n;E++){var D=r*E+T,B=c[E];B&&(e[D]=B.x,e[D+1]=B.y,e[D+2]=B.z)}T+=3}if(l){if(u&pe.Color)for(var O=0;O<n;O++){var G=r*O+T,L=l[O];L&&(e[G]=L.r,e[G+1]=L.g,e[G+2]=L.b,e[G+3]=L.a)}T+=4}if(h){if(u&pe.BoneWeight)for(var W=0;W<n;W++){var K=r*W+T,Y=h[W];Y&&(e[K]=Y.x,e[K+1]=Y.y,e[K+2]=Y.z,e[K+3]=Y.w)}T+=4}if(f){if(u&pe.BoneIndex)for(var U=this._verticesUint8,j=0;j<n;j++){var oe=r*j+T,te=f[j];if(te){var fe=oe*4;U[fe]=te.x,U[fe+1]=te.y,U[fe+2]=te.z,U[fe+3]=te.w}}T+=1}if(d){if(u&pe.Tangent)for(var me=0;me<n;me++){var de=r*me+T,ye=d[me];ye&&(e[de]=ye.x,e[de+1]=ye.y,e[de+2]=ye.z)}T+=4}if(_){if(u&pe.UV)for(var ge=0;ge<n;ge++){var Re=r*ge+T,Ae=_[ge];Ae&&(e[Re]=Ae.x,e[Re+1]=Ae.y)}T+=2}if(p){if(u&pe.UV1)for(var Pe=0;Pe<n;Pe++){var Ye=r*Pe+T,Le=p[Pe];Le&&(e[Ye]=Le.x,e[Ye+1]=Le.y)}T+=2}if(v){if(u&pe.UV2)for(var x=0;x<n;x++){var M=r*x+T,b=v[x];b&&(e[M]=b.x,e[M+1]=b.y)}T+=2}if(g){if(u&pe.UV3)for(var I=0;I<n;I++){var q=r*I+T,X=g[I];X&&(e[q]=X.x,e[q+1]=X.y)}T+=2}if(m){if(u&pe.UV4)for(var re=0;re<n;re++){var se=r*re+T,be=m[re];be&&(e[se]=be.x,e[se+1]=be.y)}T+=2}if(y){if(u&pe.UV5)for(var De=0;De<n;De++){var Ct=r*De+T,Fe=y[De];Fe&&(e[Ct]=Fe.x,e[Ct+1]=Fe.y)}T+=2}if(A){if(u&pe.UV6)for(var _r=0;_r<n;_r++){var vr=r*_r+T,pr=A[_r];pr&&(e[vr]=pr.x,e[vr+1]=pr.y)}T+=2}if(S){if(u&pe.UV7)for(var gr=0;gr<n;gr++){var ei=r*gr+T,tr=S[gr];tr&&(e[ei]=tr.x,e[ei+1]=tr.y)}T+=2}if(u&pe.BlendShape){var Fn=this._blendShapes,Gc=this._blendShapeUpdateFlags,Hc=Math.min(Fn.length,4);this.engine._hardwareRenderer;for(var Ci=0;Ci<Hc;Ci++){var In=Gc[Ci];if(In.flag){var Wc=Fn[Ci],Ln=Wc.frames,Un=Ln.length,Ri=Ln[Un-1];if(Un>0&&Ri.deltaPositions.length!==this._vertexCount)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var Xc=Ri.deltaPositions,Ei=0;Ei<n;Ei++){var an=r*Ei+T,zi=Xc[Ei];zi&&(e[an]=zi.x,e[an+1]=zi.y,e[an+2]=zi.z)}if(T+=3,this._useBlendShapeNormal){var Nn=Ri.deltaNormals;if(Nn)for(var Bi=0;Bi<n;Bi++){var on=r*Bi+T,Di=Nn[Bi];Di&&(e[on]=Di.x,e[on+1]=Di.y,e[on+2]=Di.z)}T+=3}if(this._useBlendShapeTangent){var Vn=Ri.deltaTangents;if(Vn)for(var Oi=0;Oi<n;Oi++){var sn=r*Oi+T,Fi=Vn[Oi];Fi&&(e[sn]=Fi.x,e[sn+1]=Fi.y,e[sn+2]=Fi.z)}T+=3}In.flag=!1}}}this._vertexChangeFlag=0},a._releaseCache=function(){for(var e=this._blendShapeUpdateFlags,r=0,n=e.length;r<n;r++)e[r].destroy();this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapes=null,this._blendShapeUpdateFlags=null},Z(s,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapes}}]),s}(uc),Cu=new we("POSITION",0,$.Vector3,0),pe;(function(i){i[i.Position=1]="Position",i[i.Normal=2]="Normal",i[i.Color=4]="Color",i[i.Tangent=8]="Tangent",i[i.BoneWeight=16]="BoneWeight",i[i.BoneIndex=32]="BoneIndex",i[i.UV=64]="UV",i[i.UV1=128]="UV1",i[i.UV2=256]="UV2",i[i.UV3=512]="UV3",i[i.UV4=1024]="UV4",i[i.UV5=2048]="UV5",i[i.UV6=4096]="UV6",i[i.UV7=8192]="UV7",i[i.BlendShape=16384]="BlendShape",i[i.All=65535]="All"})(pe||(pe={}));var Ru=function(i){ee(s,i);function s(a){var t;return t=i.call(this,null)||this,t.name=a,t.inverseBindMatrices=void 0,t.joints=void 0,t.skeleton=void 0,t.inverseBindMatrices=[],t.joints=[],t.skeleton="none",t}return s}(dr),Ui,Va,ka,ri,Ga,Zr=(Ui=(Ga=ri=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,V(e,"_mesh",Va,F(e)),V(e,"_meshUpdateFlag",ka,F(e)),e}var a=s.prototype;return a._render=function(e){var r=this._mesh;if(r){if(this._meshUpdateFlag.flag){var n=this.shaderData,o=r._vertexElements;n.disableMacro(s._uvMacro),n.disableMacro(s._normalMacro),n.disableMacro(s._tangentMacro),n.disableMacro(s._vertexColorMacro);for(var c=0,l=o.length;c<l;c++){var u=o[c].semantic;switch(u){case"TEXCOORD_0":n.enableMacro(s._uvMacro);break;case"NORMAL":n.enableMacro(s._normalMacro);break;case"TANGENT":n.enableMacro(s._tangentMacro);break;case"COLOR_0":n.enableMacro(s._vertexColorMacro);break}}this._meshUpdateFlag.flag=!1}for(var h=r.subMeshes,f=e._renderPipeline,d=this._engine._renderElementPool,_=0,p=h.length;_<p;_++){var v=this._materials[_];if(v){var g=d.getFromPool();g.setValue(this,r,h[_],v),f.pushPrimitive(g)}}}},a._onDestroy=function(){i.prototype._onDestroy.call(this);var e=this._mesh;e&&!e.destroyed&&(e._addRefCount(-1),this._mesh=null)},a._cloneTo=function(e){e.mesh=this._mesh},a._updateBounds=function(e){var r=this._mesh;if(r){var n=r.bounds,o=this._entity.transform.worldMatrix;ur.transform(n,o,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},Z(s,[{key:"mesh",get:function(){return this._mesh},set:function(e){var r=this._mesh;r!==e&&(r&&(r._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e)}}]),s}(Rn),ri._uvMacro=z.getMacroByName("O3_HAS_UV"),ri._normalMacro=z.getMacroByName("O3_HAS_NORMAL"),ri._tangentMacro=z.getMacroByName("O3_HAS_TANGENT"),ri._vertexColorMacro=z.getMacroByName("O3_HAS_VERTEXCOLOR"),Ga),Va=k(Ui.prototype,"_mesh",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ka=k(Ui.prototype,"_meshUpdateFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ui),nr,Ha,Wa,Xa,ja,Ka,qa,Vt,Ya,yi=(nr=(Ya=Vt=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,V(e,"matrixPalette",Ha,F(e)),V(e,"jointNodes",Wa,F(e)),V(e,"jointTexture",Xa,F(e)),V(e,"_hasInitJoints",ja,F(e)),V(e,"_mat",Ka,F(e)),V(e,"_useJointTexture",qa,F(e)),e._skin=void 0,e._blendShapeWeights=void 0,e._mat=new ie,e._skin=null,e}var a=s.prototype;return a._updateShaderData=function(e){i.prototype._updateShaderData.call(this,e);var r=this.shaderData;!this._useJointTexture&&this.matrixPalette&&r.setFloatArray(s._jointMatrixProperty,this.matrixPalette);var n=this.mesh;n._hasBlendShape?(r.setFloatArray(s._blendShapeWeightsProperty,this._blendShapeWeights),r.enableMacro(s._blendShapeMacro),n._useBlendShapeNormal?r.enableMacro(s._blendShapeNormalMacro):r.disableMacro(s._blendShapeNormalMacro),n._useBlendShapeTangent?r.enableMacro(s._blendShapeTangentMacro):r.disableMacro(s._blendShapeTangentMacro)):r.disableMacro(s._blendShapeMacro)},a._initJoints=function(){if(!!this._skin){for(var e=this._skin,r=e.joints,n=[],o=r.length-1;o>=0;o--)n[o]=this.findByNodeName(this.entity,r[o]);this.matrixPalette=new Float32Array(n.length*16),this.jointNodes=n;var c=this.entity.engine._hardwareRenderer;if(!!c){var l=c.renderStates.getParameter(c.gl.MAX_VERTEX_UNIFORM_VECTORS),u=Math.floor((l-30)/4),h=this.shaderData,f=n.length;if(f)if(h.enableMacro("O3_HAS_SKIN"),h.setInt(s._jointCountProperty,f),f>u)c.canIUseMoreJoints&&(this._useJointTexture=!0);else{var d=Math.max(s._maxJoints,f);s._maxJoints=d,h.disableMacro("O3_USE_JOINT_TEXTURE"),h.enableMacro("O3_JOINTS_NUM",d.toString())}else h.disableMacro("O3_HAS_SKIN")}}},a.findByNodeName=function(e,r){if(!e)return null;var n=e.findByName(r);return n||this.findByNodeName(e.parent,r)},a.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,r=this._skin.inverseBindMatrices,n=this.matrixPalette,o=this.entity.getInvModelMatrix(),c=this._mat,l=e.length-1;l>=0;l--)c.identity(),e[l]?ie.multiply(e[l].transform.worldMatrix,r[l],c):r[l].cloneTo(c),ie.multiply(o,c,c),n.set(c.elements,l*16);this._useJointTexture&&this.createJointTexture()}},a.createJointTexture=function(){if(!this.jointTexture){var e=this.engine,r=e._hardwareRenderer;if(!r)return;this.jointTexture=new $r(e,4,this.jointNodes.length,ae.R32G32B32A32,!1),this.jointTexture.filterMode=bt.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(s._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},Z(s,[{key:"blendShapeWeights",get:function(){return this._blendShapeWeights},set:function(e){this._blendShapeWeights=e}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),s}(Zr),Vt._blendShapeMacro=z.getMacroByName("OASIS_BLENDSHAPE"),Vt._blendShapeNormalMacro=z.getMacroByName("OASIS_BLENDSHAPE_NORMAL"),Vt._blendShapeTangentMacro=z.getMacroByName("OASIS_BLENDSHAPE_TANGENT"),Vt._jointCountProperty=z.getPropertyByName("u_jointCount"),Vt._jointSamplerProperty=z.getPropertyByName("u_jointSampler"),Vt._jointMatrixProperty=z.getPropertyByName("u_jointMatrix"),Vt._blendShapeWeightsProperty=z.getPropertyByName("u_blendShapeWeights"),Vt._maxJoints=0,Ya),Ha=k(nr.prototype,"matrixPalette",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wa=k(nr.prototype,"jointNodes",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xa=k(nr.prototype,"jointTexture",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ja=k(nr.prototype,"_hasInitJoints",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ka=k(nr.prototype,"_mat",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qa=k(nr.prototype,"_useJointTexture",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nr),Hr=function(){function i(){}return i.createSphere=function(a,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var n=new Xt(a);e=Math.max(2,Math.floor(e));for(var o=e+1,c=o*o,l=e*e,u=i._generateIndices(a,c,l*6),h=Math.PI,f=h*2,d=1/o,_=1/e,p=new Array(c),v=new Array(c),g=new Array(c),m=0;m<c;++m){var y=m%o,A=m*d|0,S=y*_,C=A*_,P=S*f,R=C*h,T=Math.sin(R),E=-t*Math.cos(P)*T,D=t*Math.cos(R),B=t*Math.sin(P)*T;p[m]=new w(E,D,B),v[m]=new w(E,D,B),g[m]=new H(S,C)}for(var O=0,G=0;G<l;++G){var L=G%e,W=G*_|0,K=W*o+L,Y=K+1,U=K+o,j=U+1;u[O++]=Y,u[O++]=K,u[O++]=j,u[O++]=K,u[O++]=U,u[O++]=j}var oe=n.bounds;return oe.min.setValue(-t,-t,-t),oe.max.setValue(t,t,t),i._initialize(n,p,v,g,u,r),n},i.createCuboid=function(a,t,e,r,n){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),n===void 0&&(n=!0);var o=new Xt(a),c=t/2,l=e/2,u=r/2,h=new Array(24),f=new Array(24),d=new Array(24);h[0]=new w(-c,l,-u),h[1]=new w(c,l,-u),h[2]=new w(c,l,u),h[3]=new w(-c,l,u),f[0]=new w(0,1,0),f[1]=new w(0,1,0),f[2]=new w(0,1,0),f[3]=new w(0,1,0),d[0]=new H(0,0),d[1]=new H(1,0),d[2]=new H(1,1),d[3]=new H(0,1),h[4]=new w(-c,-l,-u),h[5]=new w(c,-l,-u),h[6]=new w(c,-l,u),h[7]=new w(-c,-l,u),f[4]=new w(0,-1,0),f[5]=new w(0,-1,0),f[6]=new w(0,-1,0),f[7]=new w(0,-1,0),d[4]=new H(0,1),d[5]=new H(1,1),d[6]=new H(1,0),d[7]=new H(0,0),h[8]=new w(-c,l,-u),h[9]=new w(-c,l,u),h[10]=new w(-c,-l,u),h[11]=new w(-c,-l,-u),f[8]=new w(-1,0,0),f[9]=new w(-1,0,0),f[10]=new w(-1,0,0),f[11]=new w(-1,0,0),d[8]=new H(0,0),d[9]=new H(1,0),d[10]=new H(1,1),d[11]=new H(0,1),h[12]=new w(c,l,-u),h[13]=new w(c,l,u),h[14]=new w(c,-l,u),h[15]=new w(c,-l,-u),f[12]=new w(1,0,0),f[13]=new w(1,0,0),f[14]=new w(1,0,0),f[15]=new w(1,0,0),d[12]=new H(1,0),d[13]=new H(0,0),d[14]=new H(0,1),d[15]=new H(1,1),h[16]=new w(-c,l,u),h[17]=new w(c,l,u),h[18]=new w(c,-l,u),h[19]=new w(-c,-l,u),f[16]=new w(0,0,1),f[17]=new w(0,0,1),f[18]=new w(0,0,1),f[19]=new w(0,0,1),d[16]=new H(0,0),d[17]=new H(1,0),d[18]=new H(1,1),d[19]=new H(0,1),h[20]=new w(-c,l,-u),h[21]=new w(c,l,-u),h[22]=new w(c,-l,-u),h[23]=new w(-c,-l,-u),f[20]=new w(0,0,-1),f[21]=new w(0,0,-1),f[22]=new w(0,0,-1),f[23]=new w(0,0,-1),d[20]=new H(1,0),d[21]=new H(0,0),d[22]=new H(0,1),d[23]=new H(1,1);var _=new Uint16Array(36);_[0]=0,_[1]=2,_[2]=1,_[3]=2,_[4]=0,_[5]=3,_[6]=4,_[7]=6,_[8]=7,_[9]=6,_[10]=4,_[11]=5,_[12]=8,_[13]=10,_[14]=9,_[15]=10,_[16]=8,_[17]=11,_[18]=12,_[19]=14,_[20]=15,_[21]=14,_[22]=12,_[23]=13,_[24]=16,_[25]=18,_[26]=17,_[27]=18,_[28]=16,_[29]=19,_[30]=20,_[31]=22,_[32]=23,_[33]=22,_[34]=20,_[35]=21;var p=o.bounds;return p.min.setValue(-c,-l,-u),p.max.setValue(c,l,u),i._initialize(o,h,f,d,_,n),o},i.createPlane=function(a,t,e,r,n,o){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),n===void 0&&(n=1),o===void 0&&(o=!0);var c=new Xt(a);r=Math.max(1,Math.floor(r)),n=Math.max(1,Math.floor(n));for(var l=r+1,u=n+1,h=t/2,f=e/2,d=t/r,_=e/n,p=l*u,v=n*r,g=i._generateIndices(a,p,v*6),m=1/l,y=1/r,A=1/n,S=new Array(p),C=new Array(p),P=new Array(p),R=0;R<p;++R){var T=R%l,E=R*m|0;S[R]=new w(T*d-h,0,E*_-f),C[R]=new w(0,1,0),P[R]=new H(T*y,E*A)}for(var D=0,B=0;B<v;++B){var O=B%r,G=B*y|0,L=G*l+O,W=L+1,K=L+l,Y=K+1;g[D++]=L,g[D++]=K,g[D++]=W,g[D++]=K,g[D++]=Y,g[D++]=W}var U=c.bounds;return U.min.setValue(-h,0,-f),U.max.setValue(h,0,f),i._initialize(c,S,C,P,g,o),c},i.createCylinder=function(a,t,e,r,n,o,c){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),n===void 0&&(n=20),o===void 0&&(o=1),c===void 0&&(c=!0);var l=new Xt(a);n=Math.floor(n),o=Math.floor(o);for(var u=n+1,h=o+1,f=r*.5,d=r/o,_=u*h,p=n*o,v=n*2,g=_+2+v,m=i._generateIndices(a,g,p*6+v*3),y=1/u,A=1/n,S=1/o,C=new Array(g),P=new Array(g),R=new Array(g),T=0,E=Math.PI,D=Math.PI*2,B=e-t,O=B/r,G=B/o,L=0;L<_;++L){var W=L%u,K=L*y|0,Y=W*A,U=K*S,j=E+Y*D,oe=Math.sin(j),te=Math.cos(j),fe=e-K*G,me=fe*oe,de=K*d-f,ye=fe*te;C[L]=new w(me,de,ye),P[L]=new w(oe,O,te),R[L]=new H(Y,1-U)}for(var ge=0;ge<p;++ge){var Re=ge%n,Ae=ge*A|0,Pe=Ae*u+Re,Ye=Pe+1,Le=Pe+u,x=Le+1;m[T++]=Ye,m[T++]=Le,m[T++]=Pe,m[T++]=Ye,m[T++]=x,m[T++]=Le}C[_]=new w(0,-f,0),P[_]=new w(0,-1,0),R[_]=new H(.5,.5),C[_+1]=new w(0,f,0),P[_+1]=new w(0,1,0),R[_+1]=new H(.5,.5);for(var M=_+2,b=1/(t*2),I=1/(e*2),q=u*o,X=0;X<n;++X){var re=C[X],se=re.x,be=re.z;C[M]=new w(se,-f,be),P[M]=new w(0,-1,0),R[M++]=new H(se*I+.5,.5-be*I);var De=C[X+q];se=De.x,be=De.z,C[M]=new w(se,f,be),P[M]=new w(0,1,0),R[M++]=new H(se*b+.5,be*b+.5)}for(var Ct=_+1,Fe=_+2,_r=Fe+1,vr=0;vr<n;++vr){var pr=vr*2,gr=vr===n-1?0:pr+2;m[T++]=_,m[T++]=Fe+gr,m[T++]=Fe+pr,m[T++]=Ct,m[T++]=_r+pr,m[T++]=_r+gr}var ei=l.bounds,tr=Math.max(t,e);return ei.min.setValue(-tr,-f,-tr),ei.max.setValue(tr,f,tr),i._initialize(l,C,P,R,m,c),l},i.createTorus=function(a,t,e,r,n,o,c){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),n===void 0&&(n=30),o===void 0&&(o=360),c===void 0&&(c=!0);var l=new Xt(a);r=Math.floor(r),n=Math.floor(n);var u=(r+1)*(n+1),h=r*n,f=i._generateIndices(a,u,h*6),d=new Array(u),_=new Array(u),p=new Array(u);o=o/180*Math.PI;for(var v=0,g=0;g<=r;g++)for(var m=0;m<=n;m++){var y=m/n*o,A=g/r*Math.PI*2,S=Math.cos(A),C=Math.sin(A),P=Math.cos(y),R=Math.sin(y),T=new w((t+e*S)*P,(t+e*S)*R,e*C);d[v]=T;var E=t*P,D=t*R;_[v]=new w(T.x-E,T.y-D,T.z).normalize(),p[v++]=new H(m/n,g/r)}v=0;for(var B=1;B<=r;B++)for(var O=1;O<=n;O++){var G=(n+1)*B+O-1,L=(n+1)*(B-1)+O-1,W=(n+1)*(B-1)+O,K=(n+1)*B+O;f[v++]=G,f[v++]=L,f[v++]=K,f[v++]=L,f[v++]=W,f[v++]=K}var Y=l.bounds,U=t+e;return Y.min.setValue(-U,-U,-e),Y.max.setValue(U,U,e),i._initialize(l,d,_,p,f,c),l},i.createCone=function(a,t,e,r,n,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),n===void 0&&(n=1),o===void 0&&(o=!0);var c=new Xt(a);r=Math.floor(r),n=Math.floor(n);for(var l=r+1,u=n+1,h=e*.5,f=e/n,d=l*u,_=r*n,p=d+1+r,v=i._generateIndices(a,p,_*6+r*3),g=1/l,m=1/r,y=1/n,A=new Array(p),S=new Array(p),C=new Array(p),P=0,R=Math.PI,T=Math.PI*2,E=t/e,D=0;D<d;++D){var B=D%l,O=D*g|0,G=B*m,L=O*y,W=R+G*T,K=Math.sin(W),Y=Math.cos(W),U=t-O*t,j=U*K,oe=O*f-h,te=U*Y;A[D]=new w(j,oe,te),S[D]=new w(K,E,Y),C[D]=new H(G,1-L)}for(var fe=0;fe<_;++fe){var me=fe%r,de=fe*m|0,ye=de*l+me,ge=ye+1,Re=ye+l,Ae=Re+1;v[P++]=ge,v[P++]=Re,v[P++]=ye,v[P++]=ge,v[P++]=Ae,v[P++]=Re}A[d]=new w(0,-h,0),S[d]=new w(0,-1,0),C[d]=new H(.5,.5);for(var Pe=d+1,Ye=1/(t*2),Le=0;Le<r;++Le){var x=A[Le],M=x.x,b=x.z;A[Pe]=new w(M,-h,b),S[Pe]=new w(0,-1,0),C[Pe++]=new H(M*Ye+.5,.5-b*Ye)}for(var I=d+1,q=0;q<r;++q){var X=q,re=q===r-1?0:X+1;v[P++]=d,v[P++]=I+re,v[P++]=I+X}var se=c.bounds;return se.min.setValue(-t,-h,-t),se.max.setValue(t,h,t),i._initialize(c,A,S,C,v,o),c},i.createCapsule=function(a,t,e,r,n,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),n===void 0&&(n=1),o===void 0&&(o=!0);var c=new Xt(a);r=Math.max(2,Math.floor(r)),n=Math.floor(n);for(var l=r+1,u=n+1,h=e*.5,f=e/n,d=l*u,_=r*n,p=l*l,v=r*r,g=d+2*p,m=i._generateIndices(a,g,(_+2*v)*6),y=1/l,A=1/r,S=1/n,C=Math.PI/2,P=Math.PI*2,R=new Array(g),T=new Array(g),E=new Array(g),D=0,B=0;B<d;++B){var O=B%l,G=B*y|0,L=O*A,W=G*S,K=-C+L*P,Y=Math.sin(K),U=Math.cos(K);R[B]=new w(t*Y,G*f-h,t*U),T[B]=new w(Y,0,U),E[B]=new H(L,1-W)}for(var j=0;j<_;++j){var oe=j%r,te=j*A|0,fe=te*l+oe,me=fe+1,de=fe+l,ye=de+1;m[D++]=me,m[D++]=de,m[D++]=fe,m[D++]=me,m[D++]=ye,m[D++]=de}i._createCapsuleCap(t,e,r,P,d,1,R,T,E,m,D),i._createCapsuleCap(t,e,r,-P,d+p,-1,R,T,E,m,D+6*v);var ge=c.bounds;return ge.min.setValue(-t,-t-h,-t),ge.max.setValue(t,t+h,t),i._initialize(c,R,T,E,m,o),c},i._initialize=function(a,t,e,r,n,o){a.setPositions(t),a.setNormals(e),a.setUVs(r),a.setIndices(n),a.uploadData(o),a.addSubMesh(0,n.length)},i._generateIndices=function(a,t,e){var r=null;if(t>65535)if(a._hardwareRenderer.canIUse(Q.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},i._createCapsuleCap=function(a,t,e,r,n,o,c,l,u,h,f){for(var d=e+1,_=t*.5,p=d*d,v=e*e,g=1/d,m=1/e,y=0;y<p;++y){var A=y%d,S=y*g|0,C=A*m,P=S*m,R=C*r,T=P*Math.PI/2,E=Math.sin(T),D=-a*Math.cos(R)*E,B=(a*Math.cos(T)+_)*o,O=a*Math.sin(R)*E,G=y+n;c[G]=new w(D,B,O),l[G]=new w(D,B,O),u[G]=new H(C,P)}for(var L=0;L<v;++L){var W=L%e,K=L*m|0,Y=K*d+W+n,U=Y+1,j=Y+d,oe=j+1;h[f++]=U,h[f++]=Y,h[f++]=oe,h[f++]=Y,h[f++]=j,h[f++]=oe}},i}(),_c=function(i){ee(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.setVertexElements=function(e){this._setVertexElements(e)},a.setVertexBufferBinding=function(e,r,n){r===void 0&&(r=0),n===void 0&&(n=0);var o=e,c=o.buffer!==void 0;c||(o=new hc(e,r));var l=this._vertexBufferBindings;l.length<=n&&(l.length=n+1),this._setVertexBufferBinding(c?r:n,o)},a.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var n=this._vertexBufferBindings,o=e.length,c=r+o;n.length<c&&(n.length=c);for(var l=0;l<o;l++)this._setVertexBufferBinding(r+l,e[l])},a.setIndexBufferBinding=function(e,r){var n=e;if(n){var o=n.buffer!==void 0;o||(n=new yn(e,r))}this._setIndexBufferBinding(n)},Z(s,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),s}(uc),Eu=function(s,a,t,e){if(t===void 0&&(t=null),e===void 0&&(e=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,t&&t.length!==a.length)throw"deltaNormals length must same with deltaPositions length.";if(e&&e.length!==a.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=s,this.deltaPositions=a,this.deltaNormals=t,this.deltaTangents=e},zu=function(){function i(a){this.name=void 0,this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1,this._frames=[],this._updateFlagManager=new bi,this.name=a}var s=i.prototype;return s.addFrame=function(t,e,r,n){if(typeof t=="number"){var o=new Eu(t,e,r,n);return this._addFrame(o),o}else this._addFrame(t);this._updateFlagManager.distribute()},s.clearFrames=function(){this._frames.length=0,this._updateFlagManager.distribute(),this._useBlendShapeNormal=!1,this._useBlendShapeTangent=!1},s._registerChangeFlag=function(){return this._updateFlagManager.register()},s._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._useBlendShapeNormal=this._useBlendShapeNormal||t.deltaNormals!==null,this._useBlendShapeTangent=this._useBlendShapeTangent||t.deltaTangents!==null,this._frames.push(t)},Z(i,[{key:"frames",get:function(){return this._frames}}]),i}(),nn=function(){function i(a){this._subMeshPool=new jr(lc),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0;var t=i.MAX_VERTEX_COUNT;this._vertices=new Float32Array(t*9),this._indices=new Uint16Array(t*3);for(var e=this._meshes,r=this._meshCount,n=0;n<r;n++)e[n]=this._createMesh(a,n)}var s=i.prototype;return s.drawElement=function(t){var e=t.positions.length;this._vertexCount+e>i.MAX_VERTEX_COUNT&&this.flush(t.camera.engine),this._vertexCount+=e,this._batchedQueue[this._elementCount++]=t},s.flush=function(t){var e=this._batchedQueue;e.length!==0&&(this._updateData(t),this.drawBatches(t),i._canUploadSameBuffer||this._flushId++,e.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},s.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},s.destroy=function(){this._batchedQueue=null;for(var t=this._meshes,e=this._vertexBuffers,r=this._indiceBuffers,n=0,o=t.length;n<o;++n)t[n].destroy();this._meshes=null;for(var c=0,l=e.length;c<l;++c)e[c].destroy();this._vertexBuffers=null;for(var u=0,h=r.length;u<h;++u)r[u].destroy();this._indiceBuffers=null},s._createMesh=function(t,e){var r=i.MAX_VERTEX_COUNT,n=new _c(t,"BufferMesh"+e),o=[],c=this.createVertexElements(o);return this._vertexBuffers[e]=new qr(t,$t.VertexBuffer,r*4*c,_t.Dynamic),this._indiceBuffers[e]=new qr(t,$t.IndexBuffer,r*3,_t.Dynamic),n.setVertexBufferBinding(this._vertexBuffers[e],c),n.setIndexBufferBinding(this._indiceBuffers[e],Xe.UInt16),n.setVertexElements(o),n},s._updateData=function(t){var e=this._meshes,r=this._flushId;!i._canUploadSameBuffer&&this._meshCount<=r&&(this._meshCount++,e[r]=this._createMesh(t,r));var n=this._batchedQueue,o=this._vertices,c=this._indices,l=e[r];l.clearSubMesh();for(var u=0,h=0,f=0,d=0,_=0,p=0,v=null,g=0,m=n.length;g<m;g++){var y=n[g];u=this.updateVertices(y,o,u);for(var A=y.triangles,S=A.length,C=0;C<S;C++)c[h++]=A[C]+_;_+=y.positions.length,v===null||this.canBatch(v,y)?d+=S:(l.addSubMesh(this._getSubMeshFromPool(f,d)),f+=d,d=S,n[p++]=v),v=y}l.addSubMesh(this._getSubMeshFromPool(f,d)),n[p]=v,this._vertexBuffers[r].setData(o,0,0,u),this._indiceBuffers[r].setData(c,0,0,h)},s._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=mi.Triangles,r},i}();nn.MAX_VERTEX_COUNT=4096;nn._canUploadSameBuffer=!0;var Bu=function(i){ee(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.createVertexElements=function(e){return e[0]=new we("POSITION",0,$.Vector3,0),e[1]=new we("TEXCOORD_0",12,$.Vector2,0),20},a.canBatch=function(e,r){if(e.isAdd!==r.isAdd)return!1;var n=e.component.shaderData,o=r.component.shaderData,c=mn._textureProperty,l=mn._alphaCutoffProperty;return n.getTexture(c)===o.getTexture(c)&&n.getTexture(l)===o.getTexture(l)},a.updateVertices=function(e,r,n){for(var o=e.positions,c=e.uv,l=o.length,u=0;u<l;u++){var h=o[u],f=c[u];r[n++]=h.x,r[n++]=h.y,r[n++]=h.z,r[n++]=f.x,r[n++]=f.y}return n},a.drawBatches=function(e){for(var r=this._meshes[this._flushId],n=r.subMeshes,o=this._batchedQueue,c=0,l=n.length;c<l;c++){var u=n[c],h=o[c];if(!u||!h)return;var f=h.component,d=h.material,_=z._compileMacros;ct.unionCollection(f._globalShaderMacro,d.shaderData._macroCollection,_);var p=d.renderState.stencilState,v=h.isAdd?Ve.IncrementSaturate:Ve.DecrementSaturate;p.passOperationFront=v,p.passOperationBack=v;var g=d.shader._getShaderProgram(e,_);if(!g.isValid)return;var m=h.camera;g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.sceneUniformBlock,m.scene.shaderData),g.uploadAll(g.cameraUniformBlock,m.shaderData),g.uploadAll(g.rendererUniformBlock,f.shaderData),g.uploadAll(g.materialUniformBlock,d.shaderData),d.renderState._apply(e,!1),e._hardwareRenderer.drawPrimitive(r,u,g)}},s}(nn),Du=function(){function i(a){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new Bu(a)}var s=i.prototype;return s.clear=function(){this._preMaskLayer=0,this._batcher.clear()},s.preRender=function(t,e){e.maskInteraction!==lr.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t.engine))},s.postRender=function(t){t.maskInteraction!==lr.None&&(this._preMaskLayer=t.maskLayer)},s.destroy=function(){this._batcher.destroy(),this._batcher=null},s._processMasksDiff=function(t,e){var r=this._preMaskLayer,n=e.maskLayer;if(r!==n)for(var o=t._renderPipeline._allSpriteMasks,c=r&n,l=n&~r,u=r&~n,h=o._elements,f=0,d=o.length;f<d;f++){var _=h[f],p=_.influenceLayers;if(!(p&c)){if(p&l){var v=_._maskElement;v.isAdd=!0,this._batcher.drawElement(v);continue}if(p&u){var g=_._maskElement;g.isAdd=!1,this._batcher.drawElement(g)}}}},i}(),Cr;(function(i){i[i.SolidColor=0]="SolidColor",i[i.Sky=1]="Sky",i[i.Texture=2]="Texture"})(Cr||(Cr={}));var br;(function(i){i[i.AspectFitWidth=0]="AspectFitWidth",i[i.AspectFitHeight=1]="AspectFitHeight",i[i.Fill=2]="Fill"})(br||(br={}));var Ou=function(){this.material=void 0,this.mesh=void 0,this._matrix=new ie},Fu=function(){function i(a){this._engine=a,this.mode=Cr.SolidColor,this.solidColor=new ne(.25,.25,.25,1),this.sky=new Ou,this._textureFillMode=br.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(a)}var s=i.prototype;return s._resizeBackgroundTexture=function(){if(!!this._texture){var t=this._engine.canvas,e=t.width,r=t.height,n=this._mesh,o=n.getPositions();switch(this._textureFillMode){case br.Fill:o[0].setValue(-1,-1,1),o[1].setValue(1,-1,1),o[2].setValue(-1,1,1),o[3].setValue(1,1,1);break;case br.AspectFitWidth:var c=this._texture.height*e/this.texture.width/r;o[0].setValue(-1,-c,1),o[1].setValue(1,-c,1),o[2].setValue(-1,c,1),o[3].setValue(1,c,1);break;case br.AspectFitHeight:var l=this._texture.width*r/this.texture.height/e;o[0].setValue(-l,-1,1),o[1].setValue(l,-1,1),o[2].setValue(-l,1,1),o[3].setValue(l,1,1);break}n.setPositions(o),n.uploadData(!1)}},s._createPlane=function(t){var e=new Xt(t);e.isGCIgnored=!0;for(var r=new Uint8Array([1,2,0,1,3,2]),n=new Array(4),o=new Array(4),c=0;c<4;++c)n[c]=new w,o[c]=new H(c%2,1-(c*.5|0));return e.setPositions(n),e.setUVs(o),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},Z(i,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",t))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),i}(),Rr;(function(i){i[i.SolidColor=0]="SolidColor",i[i.SphericalHarmonics=1]="SphericalHarmonics"})(Rr||(Rr={}));var lt=function(){function i(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new ne(.212,.227,.259),this._diffuseIntensity=1,this._specularReflection=void 0,this._specularIntensity=1,this._diffuseMode=Rr.SolidColor,this._shArray=new Float32Array(27),this._scene=void 0,this._specularTextureDecodeRGBM=!1}var s=i.prototype;return s._setScene=function(t){if(this._scene=t,!!t){var e=t.shaderData;e.setColor(i._diffuseColorProperty,this._diffuseSolidColor),this.diffuseMode=this._diffuseMode,this.diffuseSphericalHarmonics=this._diffuseSphericalHarmonics,this.diffuseIntensity=this._diffuseIntensity,this.specularTexture=this._specularReflection,this.specularIntensity=this._specularIntensity,this.specularTextureDecodeRGBM=this._specularTextureDecodeRGBM}},s._preComputeSH=function(t,e){var r=t.coefficients;return e[0]=r[0]*.886227,e[1]=r[1]*.886227,e[2]=r[2]*.886227,e[3]=r[3]*-1.023327,e[4]=r[4]*-1.023327,e[5]=r[5]*-1.023327,e[6]=r[6]*1.023327,e[7]=r[7]*1.023327,e[8]=r[8]*1.023327,e[9]=r[9]*-1.023327,e[10]=r[10]*-1.023327,e[11]=r[11]*-1.023327,e[12]=r[12]*.858086,e[13]=r[13]*.858086,e[14]=r[14]*.858086,e[15]=r[15]*-.858086,e[16]=r[16]*-.858086,e[17]=r[17]*-.858086,e[18]=r[18]*.247708,e[19]=r[19]*.247708,e[20]=r[20]*.247708,e[21]=r[21]*-.858086,e[22]=r[22]*-.858086,e[23]=r[23]*-.858086,e[24]=r[24]*.429042,e[25]=r[25]*.429042,e[26]=r[26]*.429042,e},Z(i,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(t){this._specularTextureDecodeRGBM=t,this._scene&&(t?this._scene.shaderData.enableMacro(i._decodeRGBMMacro):this._scene.shaderData.disableMacro(i._decodeRGBMMacro))}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(t){this._diffuseMode=t,this._scene&&(t===Rr.SphericalHarmonics?this._scene.shaderData.enableMacro(i._shMacro):this._scene.shaderData.disableMacro(i._shMacro))}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(t){t!==this._diffuseSolidColor&&t.cloneTo(this._diffuseSolidColor)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(t){this._diffuseSphericalHarmonics=t,!!this._scene&&t&&this._scene.shaderData.setFloatArray(i._diffuseSHProperty,this._preComputeSH(t,this._shArray))}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(t){this._diffuseIntensity=t,this._scene&&this._scene.shaderData.setFloat(i._diffuseIntensityProperty,t)}},{key:"specularTexture",get:function(){return this._specularReflection},set:function(t){if(this._specularReflection=t,!!this._scene){var e=this._scene.shaderData;t?(e.setTexture(i._specularTextureProperty,t),e.setFloat(i._mipLevelProperty,this._specularReflection.mipmapCount-1),e.enableMacro(i._specularMacro)):e.disableMacro(i._specularMacro)}}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(t){this._specularIntensity=t,this._scene&&this._scene.shaderData.setFloat(i._specularIntensityProperty,t)}}]),i}();lt._shMacro=z.getMacroByName("O3_USE_SH");lt._specularMacro=z.getMacroByName("O3_USE_SPECULAR_ENV");lt._decodeRGBMMacro=z.getMacroByName("O3_DECODE_ENV_RGBM");lt._diffuseColorProperty=z.getPropertyByName("u_envMapLight.diffuse");lt._diffuseSHProperty=z.getPropertyByName("u_env_sh");lt._diffuseIntensityProperty=z.getPropertyByName("u_envMapLight.diffuseIntensity");lt._specularTextureProperty=z.getPropertyByName("u_env_specularSampler");lt._specularIntensityProperty=z.getPropertyByName("u_envMapLight.specularIntensity");lt._mipLevelProperty=z.getPropertyByName("u_envMapLight.mipMapLevel");var vc=function(){function i(){}var s=i.prototype;return s.preUpdate=function(t){},s.postUpdate=function(t){},s.preRender=function(t,e){},s.postRender=function(t,e){},s.destroy=function(t){},i}(),qe=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t._viewMat=void 0,t._inverseViewMat=void 0,t}var a=s.prototype;return a._onEnable=function(){this.scene.findFeature(Er).attachRenderLight(this)},a._onDisable=function(){this.scene.findFeature(Er).detachRenderLight(this)},Z(s,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new ie),ie.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new ie),ie.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),s}(Mt);qe._maxLight=10;var Ut=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.color=new ne(1,1,1,1),t.intensity=1,t._forward=new w,t._lightColor=new ne(1,1,1,1),t._reverseDirection=new w,t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._directionProperty,r.direction)};var a=s.prototype;return a._appendData=function(e){var r=e*3,n=e*3,o=this.lightColor,c=this.direction,l=s._combinedData;l.color[r]=o.r,l.color[r+1]=o.g,l.color[r+2]=o.b,l.direction[n]=c.x,l.direction[n+1]=c.y,l.direction[n+2]=c.z},Z(s,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),s}(qe);Ut._colorProperty=z.getPropertyByName("u_directLightColor");Ut._directionProperty=z.getPropertyByName("u_directLightDirection");Ut._combinedData={color:new Float32Array(3*qe._maxLight),direction:new Float32Array(3*qe._maxLight)};var Zt=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.color=new ne(1,1,1,1),t.intensity=1,t.distance=100,t._lightColor=new ne(1,1,1,1),t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._distanceProperty,r.distance)};var a=s.prototype;return a._appendData=function(e){var r=e*3,n=e*3,o=e,c=this.lightColor,l=this.position,u=s._combinedData;u.color[r]=c.r,u.color[r+1]=c.g,u.color[r+2]=c.b,u.position[n]=l.x,u.position[n+1]=l.y,u.position[n+2]=l.z,u.distance[o]=this.distance},Z(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),s}(qe);Zt._colorProperty=z.getPropertyByName("u_pointLightColor");Zt._positionProperty=z.getPropertyByName("u_pointLightPosition");Zt._distanceProperty=z.getPropertyByName("u_pointLightDistance");Zt._combinedData={color:new Float32Array(3*qe._maxLight),position:new Float32Array(3*qe._maxLight),distance:new Float32Array(qe._maxLight)};var vt=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.color=new ne(1,1,1,1),t.intensity=1,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new w,t._lightColor=new ne(1,1,1,1),t._inverseDirection=new w,t}s._updateShaderData=function(e){var r=s._combinedData;e.setFloatArray(s._colorProperty,r.color),e.setFloatArray(s._positionProperty,r.position),e.setFloatArray(s._directionProperty,r.direction),e.setFloatArray(s._distanceProperty,r.distance),e.setFloatArray(s._angleCosProperty,r.angleCos),e.setFloatArray(s._penumbraCosProperty,r.penumbraCos)};var a=s.prototype;return a._appendData=function(e){var r=e*3,n=e*3,o=e*3,c=e,l=e,u=e,h=this.lightColor,f=this.position,d=this.direction,_=s._combinedData;_.color[r]=h.r,_.color[r+1]=h.g,_.color[r+2]=h.b,_.position[n]=f.x,_.position[n+1]=f.y,_.position[n+2]=f.z,_.direction[o]=d.x,_.direction[o+1]=d.y,_.direction[o+2]=d.z,_.distance[c]=this.distance,_.angleCos[u]=Math.cos(this.angle),_.penumbraCos[l]=Math.cos(this.angle+this.penumbra)},Z(s,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),s}(qe);vt._colorProperty=z.getPropertyByName("u_spotLightColor");vt._positionProperty=z.getPropertyByName("u_spotLightPosition");vt._directionProperty=z.getPropertyByName("u_spotLightDirection");vt._distanceProperty=z.getPropertyByName("u_spotLightDistance");vt._angleCosProperty=z.getPropertyByName("u_spotLightAngleCos");vt._penumbraCosProperty=z.getPropertyByName("u_spotLightPenumbraCos");vt._combinedData={color:new Float32Array(3*qe._maxLight),position:new Float32Array(3*qe._maxLight),direction:new Float32Array(3*qe._maxLight),distance:new Float32Array(qe._maxLight),angleCos:new Float32Array(qe._maxLight),penumbraCos:new Float32Array(qe._maxLight)};function Iu(){return this.findFeature(Er).visibleLights.length>0}var Er=function(i){ee(s,i);function s(){var t;return t=i.call(this)||this,t.visibleLights=void 0,t.visibleLights=[],t}var a=s.prototype;return a.attachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r==-1&&this.visibleLights.push(e)},a.detachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r!=-1&&this.visibleLights.splice(r,1)},a._updateShaderData=function(e){for(var r=0,n=0,o=0,c=this.visibleLights,l=0,u=c.length;l<u;l++){var h=c[l];h instanceof Ut?h._appendData(r++):h instanceof Zt?h._appendData(n++):h instanceof vt&&h._appendData(o++)}r?(Ut._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",r.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),n?(Zt._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",n.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),o?(vt._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",o.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},s}(vc),Tr=function(i){ee(s,i);function s(t,e){var r;r=i.call(this,t)||this,r.name=void 0,r.background=new Fu(r._engine),r.shaderData=new tn(xt.Scene),r._activeCameras=[],r._isActiveInEngine=!1,r._globalShaderMacro=new ct,r._rootEntities=[],r._ambientLight=void 0,r.features=[],r.name=e||"";var n=r.shaderData;return s.sceneFeatureManager.addObject(F(r)),n._addRefCount(1),r.ambientLight=new lt,r}var a=s.prototype;return a.createRootEntity=function(e){var r=new Kt(this._engine,e);return this.addRootEntity(r),r},a.addRootEntity=function(e){var r=e._isRoot;r||(e._isRoot=!0,e._removeFromParent());var n=e._scene;n!==this?(n&&r&&n._removeEntity(e),this._rootEntities.push(e),Kt._traverseSetOwnerScene(e,this)):r||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},a.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._processInActive(),Kt._traverseSetOwnerScene(e,null))},a.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},a.findEntityByName=function(e){for(var r=this._rootEntities,n=r.length-1;n>=0;n--){var o=r[n];if(o.name===e)return o}for(var c=r.length-1;c>=0;c--){var l=r[c],u=l.findByName(e);if(u)return u}return null},a.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),n=0,o=this.rootEntitiesCount;n<o;n++){var c=this.getRootEntity(n);if(c.name==r[0]){for(var l=1,u=r.length;l<u&&(c=Kt._findChildByName(c,r[l]),!!c);++l);return c}}return null},a.destroy=function(){if(!this._destroyed){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),s.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,r=this.rootEntitiesCount;e<r;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,s.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1)}},a._attachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r===-1&&this._activeCameras.push(e)},a._detachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r!==-1&&this._activeCameras.splice(r,1)},a._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,n=r.length-1;n>=0;n--){var o=r[n];o._isActive&&(e?o._processActive():o._processInActive())}},a._updateShaderData=function(){ct.unionCollection(this.engine._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro);var e=this.findFeature(Er);e._updateShaderData(this.shaderData)},a._removeEntity=function(e){var r=this._rootEntities;r.splice(r.indexOf(e),1)},s.registerFeature=function(e){s.sceneFeatureManager.registerFeature(e)},a.findFeature=function(e){return s.sceneFeatureManager.findFeature(this,e)},Z(s,[{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!!e){var r=this._ambientLight;r!==e&&(r&&r._setScene(null),e._setScene(this),this._ambientLight=e)}}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),s}(dr);Tr.sceneFeatureManager=new ic;var Lu=function(){function i(a){this.engine=a,this._activeScene=void 0}var s=i.prototype;return s.loadScene=function(t,e){var r=this;e===void 0&&(e=!0);var n=this.engine.resourceManager.load(t);return n.then(function(o){var c=r._activeScene;r.activeScene=o,c&&e&&c.destroy()}),n},s.mergeScenes=function(t,e){for(var r=t.rootEntities,n=0,o=r.length;n<o;n++)e.addRootEntity(r[n])},Z(i,[{key:"activeScene",get:function(){return this._activeScene},set:function(t){var e=this._activeScene;e!==t&&(e&&e._processActive(!1),t&&t._processActive(!0),this._activeScene=t)}}]),i}(),Uu=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <mobile_material_frag>
#include <fog_share>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;
#ifndef OASIS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
#include <fog_frag>
}`,Nu=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,Vu=`#define GLSLIFY 1
varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;
#ifdef fadeIn
float fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);
#endif
#ifdef fadeOut
float fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;
#endif
#ifdef particleTexture
vec4 tex=texture2D(u_texture,v_uv);
#ifdef useOriginColor
gl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);
#else
gl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);
#endif
#else
gl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);
#endif
}`,ku=`#define GLSLIFY 1
attribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;
#ifdef is2d
uniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;
#endif
mat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;
#ifdef isScaleByLifetime
scale*=v_lifeLeft;
#else
scale*=pow(a_lifeAndSize.w,deltaTime);
#endif
#ifdef rotateToVelocity
vec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;
#else
float deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;
#endif
#ifdef is2d
vec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);
#else
#ifdef rotateToVelocity
float s=sin(angle);float c=cos(angle);
#else
float s=sin(angle);float c=cos(angle);
#endif
vec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;
#endif
}`,Gu=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,Hu=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,Qa=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,Wu=`#define GLSLIFY 1
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}`,$a=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
#include <shadow_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <shadow_vert>
#include <position_vert>
}`,Xu=`#define GLSLIFY 1
#ifdef O3_SHADOW_MAP_COUNT
uniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}
#endif
void main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);
#ifdef O3_SHADOW_MAP_COUNT
float visibility=1.0;
#if (O3_SHADOW_MAP_COUNT == 1)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);
#elif (O3_SHADOW_MAP_COUNT == 2)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);
#elif (O3_SHADOW_MAP_COUNT == 3)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);
#endif
visibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);
#endif
gl_FragColor=shadowColor;}`,ju=`#define GLSLIFY 1
#include <common>
uniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}`,Ku=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=POSITION.xyz;gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}`,qu=`#define GLSLIFY 1
uniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}`,Yu=`#define GLSLIFY 1
uniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Qu=`#define GLSLIFY 1
#ifdef USE_CUSTOM_TEXTURE
uniform sampler2D u_cusTomTexture;
#else
uniform sampler2D u_spriteTexture;
#endif
varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_CUSTOM_TEXTURE
vec4 baseColor=texture2D(u_cusTomTexture,v_uv);
#else
vec4 baseColor=texture2D(u_spriteTexture,v_uv);
#endif
gl_FragColor=baseColor*v_color;}`,$u=`#define GLSLIFY 1
#ifdef USE_MODEL_MATRIX
uniform mat4 u_MVPMat;
#else
uniform mat4 u_VPMat;
#endif
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_MODEL_MATRIX
gl_Position=u_MVPMat*vec4(POSITION,1.0);
#else
gl_Position=u_VPMat*vec4(POSITION,1.0);
#endif
v_uv=TEXCOORD_0;v_color=COLOR_0;}`,Zu=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <fog_share>
uniform vec4 u_baseColor;uniform float u_alphaCutoff;
#ifdef O3_BASE_TEXTURE
uniform sampler2D u_baseTexture;
#endif
void main(){vec4 baseColor=u_baseColor;
#ifdef O3_BASE_TEXTURE
vec4 textureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<u_alphaCutoff){discard;}
#endif
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=linearToGamma(baseColor);
#endif
gl_FragColor=baseColor;
#include <fog_frag>
}`,Ju=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <fog_vert>
}`,eh=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,th=`#define GLSLIFY 1
uniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}`,rh=function(){function i(){}return i.init=function(){z.create("blinn-phong",Nu,Uu),z.create("pbr",Qa,Gu),z.create("pbr-specular",Qa,Hu),z.create("unlit",Ju,Zu),z.create("shadow-map",$a,Wu),z.create("shadow",$a,Xu),z.create("skybox",Ku,ju),z.create("particle-shader",ku,Vu),z.create("SpriteMask",Yu,qu),z.create("Sprite",$u,Qu),z.create("background-texture",eh,th)},i}(),ih=function(){function i(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var s=i.prototype;return s.get=function(t){var e=this._cacheMap,r=t._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(e,0,r);for(var n=t._mask,o=t._length-1,c=this._cacheHierarchy-1,l=0;l<c;l++){var u=o<l?0:n[l],h=e[u];h||(e[u]=h=Object.create(null)),e=h}var f=o<c?0:n[c],d=e[f];return d||(this._lastQueryKey=f,this._lastQueryMap=e),d},s.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},s._resizeCacheMapHierarchy=function(t,e,r){var n=this._cacheHierarchy-1;if(e==n){for(var o in t)for(var c=t[o],l=0,u=r-n;l<u;l++)l==u-1?t[0]=c:t=t[l==0?o:0]=Object.create(null);this._cacheHierarchy=r}else for(var h in t)this._resizeCacheMapHierarchy(t[h],++e,r)},i}(),ar=new ic;rh.init();var pc=function(i){ee(s,i);function s(t,e,r,n){var o;o=i.call(this)||this,o.physicsManager=void 0,o.inputManager=void 0,o._componentsManager=new Cn,o._hardwareRenderer=void 0,o._lastRenderState=new cc,o._renderElementPool=new jr(Pu),o._spriteElementPool=new jr(Mu),o._spriteMaskElementPool=new jr(Tu),o._spriteDefaultMaterial=void 0,o._spriteMaskDefaultMaterial=void 0,o._renderContext=new Su,o._whiteTexture2D=void 0,o._whiteTextureCube=void 0,o._backgroundTextureMaterial=void 0,o._renderCount=0,o._shaderProgramPools=[],o._spriteMaskManager=void 0,o._macroCollection=new ct,o._canvas=void 0,o._settings={},o._resourceManager=new Ji(F(o)),o._sceneManager=new Lu(F(o)),o._vSyncCount=1,o._targetFrameRate=60,o._time=new ol,o._isPaused=!0,o._requestId=void 0,o._timeoutId=void 0,o._vSyncCounter=1,o._targetFrameInterval=1e3/60,o._animate=function(){o._vSyncCount?(o._requestId=requestAnimationFrame(o._animate),o._vSyncCounter++%o._vSyncCount===0&&(o.update(),o._vSyncCounter=1)):(o._timeoutId=window.setTimeout(o._animate,o._targetFrameInterval),o.update())},o.features=[],o._hardwareRenderer=e,o._hardwareRenderer.init(t),r&&(Lt._nativePhysics=r,o.physicsManager=new Lt),o._canvas=t,ar.addObject(F(o)),o._sceneManager.activeScene=new Tr(F(o),"DefaultScene"),o._spriteMaskManager=new Du(F(o)),o._spriteDefaultMaterial=o._createSpriteMaterial(),o._spriteMaskDefaultMaterial=o._createSpriteMaskMaterial(),o.inputManager=new ml(F(o));var c=new Uint8Array([255,255,255,255]),l=new $r(F(o),1,1,ae.R8G8B8A8,!1);l.setPixelBuffer(c),l.isGCIgnored=!0;var u=new rn(F(o),1,ae.R8G8B8A8,!1);u.setPixelBuffer(yt.PositiveX,c),u.setPixelBuffer(yt.NegativeX,c),u.setPixelBuffer(yt.PositiveY,c),u.setPixelBuffer(yt.NegativeY,c),u.setPixelBuffer(yt.PositiveZ,c),u.setPixelBuffer(yt.NegativeZ,c),u.isGCIgnored=!0,o._whiteTexture2D=l,o._whiteTextureCube=u,o._backgroundTextureMaterial=new Qt(F(o),z.find("background-texture")),o._backgroundTextureMaterial.isGCIgnored=!0,o._backgroundTextureMaterial.renderState.depthState.compareFunction=Me.LessEqual;var h=(n==null?void 0:n.colorSpace)||Mr.Linear;return h===Mr.Gamma&&o._macroCollection.enable(s._gammaMacro),o._settings.colorSpace=h,o}var a=s.prototype;return a.createEntity=function(e){return new Kt(this,e)},a.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},a.resume=function(){!this._isPaused||(this._isPaused=!1,this.time.reset(),requestAnimationFrame(this._animate))},a.update=function(){var e=this._time,r=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),ar.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var n=this._sceneManager._activeScene,o=this._componentsManager;n&&(n._activeCameras.sort(function(c,l){return c.priority-l.priority}),o.callScriptOnStart(),this.physicsManager&&(o.callColliderOnUpdate(),this.physicsManager._update(r/1e3),o.callColliderOnLateUpdate()),this.inputManager._update(),o.callScriptOnUpdate(r),o.callAnimationUpdate(r),o.callScriptOnLateUpdate(r),this._render(n)),this._componentsManager.callComponentDestroy(),ar.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},a.run=function(){ar.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new Xn("run",this))},a.destroy=function(){this._sceneManager&&(this._whiteTexture2D.destroy(!0),this._whiteTextureCube.destroy(!0),this.inputManager._destroy(),this.trigger(new Xn("shutdown",this)),ar.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._resourceManager._destroy(),this._componentsManager.callComponentDestroy(),this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,this._spriteMaskManager.destroy(),ar._objects=[],this.removeAllEventListeners())},a._getShaderProgramPool=function(e){var r=e._shaderId,n=this._shaderProgramPools,o=n[r];if(!o){var c=r+1;c<n.length&&(n.length=c),n[r]=o=new ih}return o},a._render=function(e){var r=e._activeCameras,n=this._componentsManager,o=this.time.deltaTime;if(n.callRendererOnUpdate(o),e._updateShaderData(),r.length>0)for(var c=0,l=r.length;c<l;c++){var u=r[c],h=u.entity;u.enabled&&h.isActiveInHierarchy&&(n.callCameraOnBeginRender(u),Tr.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,u]),u.render(),Tr.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,u]),n.callCameraOnEndRender(u))}},a._createSpriteMaterial=function(){var e=new Qt(this,z.find("Sprite")),r=e.renderState,n=r.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=ue.SourceAlpha,n.destinationColorBlendFactor=ue.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=ue.One,n.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha,n.colorBlendOperation=n.alphaBlendOperation=ft.Add,r.depthState.writeEnabled=!1,r.rasterState.cullMode=dt.Off,e.renderQueueType=We.Transparent,e.isGCIgnored=!0,e},a._createSpriteMaskMaterial=function(){var e=new Qt(this,z.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=Dt.None,r.rasterState.cullMode=dt.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},a.findFeature=function(e){return ar.findFeature(this,e)},s.registerFeature=function(e){ar.registerFeature(e)},Z(s,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}}]),s}(rc);pc._gammaMacro=z.getMacroByName("OASIS_COLORSPACE_GAMMA");var kt,Za,Ja,eo,to,ro,io,no,Jr=(kt=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,V(t,"_started",Za,F(t)),V(t,"_onStartIndex",Ja,F(t)),V(t,"_onUpdateIndex",eo,F(t)),V(t,"_onLateUpdateIndex",to,F(t)),V(t,"_onPreRenderIndex",ro,F(t)),V(t,"_onPostRenderIndex",io,F(t)),V(t,"_entityCacheIndex",no,F(t)),t}var a=s.prototype;return a.onAwake=function(){},a.onEnable=function(){},a.onStart=function(){},a.onUpdate=function(e){},a.onLateUpdate=function(e){},a.onBeginRender=function(e){},a.onEndRender=function(e){},a.onTriggerEnter=function(e){},a.onTriggerExit=function(e){},a.onTriggerStay=function(e){},a.onPointerDown=function(){},a.onPointerUp=function(){},a.onPointerClick=function(){},a.onPointerEnter=function(){},a.onPointerExit=function(){},a.onPointerDrag=function(){},a.onDisable=function(){},a.onDestroy=function(){},a._onAwake=function(){this.onAwake()},a._onEnable=function(){var e=this.engine._componentsManager,r=s.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this._entity._addScript(this),this.onEnable()},a._onDisable=function(){var e=this.engine._componentsManager;this._onStartIndex!==-1&&e.removeOnStartScript(this),this._onUpdateIndex!==-1&&e.removeOnUpdateScript(this),this._onLateUpdateIndex!==-1&&e.removeOnLateUpdateScript(this),this._entityCacheIndex!==-1&&this._entity._removeScript(this),this.onDisable()},a._onDestroy=function(){this.engine._componentsManager.addDestroyComponent(this)},s}(Mt),Za=k(kt.prototype,"_started",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ja=k(kt.prototype,"_onStartIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),eo=k(kt.prototype,"_onUpdateIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),to=k(kt.prototype,"_onLateUpdateIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ro=k(kt.prototype,"_onPreRenderIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),io=k(kt.prototype,"_onPostRenderIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),no=k(kt.prototype,"_entityCacheIndex",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),kt),nh=0,wr=function(){function i(a,t,e,r,n){a===void 0&&(a="RENDER_PASS"+nh++),t===void 0&&(t=0),e===void 0&&(e=null),r===void 0&&(r=null),n===void 0&&(n=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=a,this.enabled=!0,this.priority=t,this.renderTarget=e,this.replaceMaterial=r,this.mask=n||ht.Everything,this.renderOverride=!1}var s=i.prototype;return s.render=function(t,e,r,n){},s.preRender=function(t,e,r,n){},s.postRender=function(t,e,r,n){},i}(),gc=function(i){ee(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.createVertexElements=function(e){return e[0]=new we("POSITION",0,$.Vector3,0),e[1]=new we("TEXCOORD_0",12,$.Vector2,0),e[2]=new we("COLOR_0",20,$.Vector4,0),36},a.canBatch=function(e,r){var n=e.component,o=r.component;if(!this.checkBatchWithMask(n,o))return!1;var c=s._textureProperty;return n.shaderData.getTexture(c)!==o.shaderData.getTexture(c)?!1:e.material===r.material},a.checkBatchWithMask=function(e,r){var n=e.maskInteraction;return n!==r.maskInteraction?!1:n===lr.None?!0:e.maskLayer===r.maskLayer},a.updateVertices=function(e,r,n){for(var o=e.positions,c=e.uv,l=e.color,u=o.length,h=0;h<u;h++){var f=o[h],d=c[h];r[n++]=f.x,r[n++]=f.y,r[n++]=f.z,r[n++]=d.x,r[n++]=d.y,r[n++]=l.r,r[n++]=l.g,r[n++]=l.b,r[n++]=l.a}return n},a.drawBatches=function(e){for(var r=this._meshes[this._flushId],n=r.subMeshes,o=this._batchedQueue,c=e._spriteMaskManager,l=0,u=n.length;l<u;l++){var h=n[l],f=o[l];if(!h||!f)return;var d=f.component,_=f.camera,p=f.material;c.preRender(_,d);var v=z._compileMacros;ct.unionCollection(d._globalShaderMacro,p.shaderData._macroCollection,v);var g=p.shader._getShaderProgram(e,v);if(!g.isValid)return;g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.sceneUniformBlock,_.scene.shaderData),g.uploadAll(g.cameraUniformBlock,_.shaderData),g.uploadAll(g.rendererUniformBlock,d.shaderData),g.uploadAll(g.materialUniformBlock,p.shaderData),p.renderState._apply(e,!1),e._hardwareRenderer.drawPrimitive(r,h,g),c.postRender(d)}},a.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,r=this._vertexBuffers,n=this._indiceBuffers,o=0,c=e.length;o<c;++o)e[o].destroy();this._meshes=null;for(var l=0,u=r.length;l<u;++l)r[l].destroy();this._vertexBuffers=null;for(var h=0,f=n.length;h<f;++h)n[h].destroy();this._indiceBuffers=null},s}(nn);gc._textureProperty=z.getPropertyByName("u_spriteTexture");var Nr=function(){i._compareFromNearToFar=function(t,e){return t.material.renderQueueType-e.material.renderQueueType||t.component._distanceForSort-e.component._distanceForSort||e.component._renderSortId-t.component._renderSortId},i._compareFromFarToNear=function(t,e){return t.material.renderQueueType-e.material.renderQueueType||e.component._distanceForSort-t.component._distanceForSort||e.component._renderSortId-t.component._renderSortId};function i(a){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new gc(a)}var s=i.prototype;return s.pushPrimitive=function(t){this.items.push(t)},s.render=function(t,e,r){var n=this.items;if(n.length!==0){for(var o=t.engine,c=t.scene,l=o._renderCount,u=o._hardwareRenderer,h=c.shaderData,f=t.shaderData,d=0,_=n.length;d<_;d++){var p=n[d],v=p.component.entity.layer;if(!!(v&r))if(p.mesh){this._spriteBatcher.flush(o);var g=z._compileMacros,m=p,y=m.component,A=e||m.material,S=y.shaderData,C=A.shaderData;A._preRender(m),ct.unionCollection(y._globalShaderMacro,C._macroCollection,g);var P=A.shader._getShaderProgram(o,g);if(!P.isValid)continue;var R=P.bind(),T=l!==P._uploadRenderCount;T?(P.groupingOtherUniformBlock(),P.uploadAll(P.sceneUniformBlock,h),P.uploadAll(P.cameraUniformBlock,f),P.uploadAll(P.rendererUniformBlock,S),P.uploadAll(P.materialUniformBlock,C),P.uploadUnGroupTextures(),P._uploadCamera=t,P._uploadRenderer=y,P._uploadMaterial=A,P._uploadRenderCount=l):(P._uploadCamera!==t?(P.uploadAll(P.cameraUniformBlock,f),P._uploadCamera=t):R&&P.uploadTextures(P.cameraUniformBlock,f),P._uploadRenderer!==y?(P.uploadAll(P.rendererUniformBlock,S),P._uploadRenderer=y):R&&P.uploadTextures(P.rendererUniformBlock,S),P._uploadMaterial!==A?(P.uploadAll(P.materialUniformBlock,C),P._uploadMaterial=A):R&&P.uploadTextures(P.materialUniformBlock,C),R&&P.uploadUnGroupTextures()),A.renderState._apply(t.engine,y.entity.transform._isFrontFaceInvert()),u.drawPrimitive(m.mesh,m.subMesh,P)}else{var E=p;this._spriteBatcher.drawElement(E)}}this._spriteBatcher.flush(o)}},s.clear=function(){this.items.length=0,this._spriteBatcher.clear()},s.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},s.sort=function(t){this._quickSort(this.items,0,this.items.length,t)},s._quickSort=function(t,e,r,n){for(;;){if(r-e<=10){this._insertionSort(t,e,r,n);return}var o=e+r>>1,c=t[e],l=t[r-1],u=t[o],h=n(c,l);if(h>0){var f=c;c=l,l=f}var d=n(c,u);if(d>=0){var _=c;c=u,u=l,l=_}else{var p=n(l,u);if(p>0){var v=l;l=u,u=v}}t[e]=c,t[r-1]=u;var g=l,m=e+1,y=r-1;t[o]=t[m],t[m]=g;e:for(var A=m+1;A<y;A++){var S=t[A],C=n(S,g);if(C<0)t[A]=t[m],t[m]=S,m++;else if(C>0){do{if(y--,y==A)break e;var P=t[y];C=n(P,g)}while(C>0);t[A]=t[y],t[y]=S,C<0&&(S=t[A],t[A]=t[m],t[m]=S,m++)}}r-y<m-e?(this._quickSort(t,y,r,n),r=m):(this._quickSort(t,e,m,n),e=y)}},s._insertionSort=function(t,e,r,n){for(var o=e+1;o<r;o++){var c=void 0,l=t[o];for(c=o-1;c>=e;c--){var u=t[c],h=n(u,l);if(h>0)t[c+1]=u;else break}t[c+1]=l}},i}(),ah=function(){function i(a){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new Wt,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new H,this._camera=a;var t=a.engine;this._opaqueQueue=new Nr(t),this._alphaTestQueue=new Nr(t),this._transparentQueue=new Nr(t),this._renderPassArray=[],this._defaultPass=new wr("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var s=i.prototype;return s.addRenderPass=function(t,e,r,n,o){if(e===void 0&&(e=null),r===void 0&&(r=null),n===void 0&&(n=null),o===void 0&&(o=null),typeof t=="string"){var c=new wr(t,e,r,n,o);this._renderPassArray.push(c)}else t instanceof wr&&this._renderPassArray.push(t);this._renderPassArray.sort(function(l,u){return l.priority-u.priority})},s.removeRenderPass=function(t){var e;if(typeof t=="string"?e=this.getRenderPass(t):t instanceof wr&&(e=t),e){var r=this._renderPassArray.indexOf(e);this._renderPassArray.splice(r,1)}},s.getRenderPass=function(t){for(var e=0,r=this._renderPassArray.length;e<r;e++){var n=this._renderPassArray[e];if(n.name===t)return n}return null},s.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},s.render=function(t,e,r){var n=this._camera,o=this._opaqueQueue,c=this._alphaTestQueue,l=this._transparentQueue;n.engine._spriteMaskManager.clear(),o.clear(),c.clear(),l.clear(),this._allSpriteMasks.length=0,n.engine._componentsManager.callRender(t),o.sort(Nr._compareFromNearToFar),c.sort(Nr._compareFromNearToFar),l.sort(Nr._compareFromFarToNear);for(var u=0,h=this._renderPassArray.length;u<h;u++)this._drawRenderPass(this._renderPassArray[u],n,e,r)},s._drawRenderPass=function(t,e,r,n){if(t.preRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),t.enabled){var o,c,l=e.engine,u=e.scene,h=u.background,f=l._hardwareRenderer,d=e.renderTarget||t.renderTarget;f.activeRenderTarget(d,e,n),d==null||d._setRenderTargetInfo(r,n);var _=(o=t.clearFlags)!=null?o:e.clearFlags,p=(c=t.clearColor)!=null?c:h.solidColor;_!==hr.None&&f.clearRenderTarget(e.engine,_,p),t.renderOverride?t.render(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(e,t.replaceMaterial,t.mask),this._alphaTestQueue.render(e,t.replaceMaterial,t.mask),e.clearFlags===hr.DepthColor&&(h.mode===Cr.Sky?this._drawSky(l,e,h.sky):h.mode===Cr.Texture&&h.texture&&this._drawBackgroundTexture(l,h)),this._transparentQueue.render(e,t.replaceMaterial,t.mask)),d==null||d._blitRenderTarget(),d==null||d.generateMipmaps()}t.postRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},s.pushPrimitive=function(t){var e=t.material.renderQueueType;e>We.Transparent+We.AlphaTest>>1?this._transparentQueue.pushPrimitive(t):e>We.AlphaTest+We.Opaque>>1?this._alphaTestQueue.pushPrimitive(t):this._opaqueQueue.pushPrimitive(t)},s._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,n=t._backgroundTextureMaterial,o=t.canvas,c=e._mesh;(this._lastCanvasSize.x!==o.width||this._lastCanvasSize.y!==o.height)&&e._textureFillMode!==br.Fill&&(this._lastCanvasSize.setValue(o.width,o.height),e._resizeBackgroundTexture());var l=n.shader._getShaderProgram(t,z._compileMacros);l.bind(),l.uploadAll(l.materialUniformBlock,n.shaderData),l.uploadUnGroupTextures(),n.renderState._apply(t,!1),r.drawPrimitive(c,c.subMesh,l)},s._drawSky=function(t,e,r){var n=r.material,o=r.mesh,c=r._matrix;if(!!n&&!!o){var l=t._hardwareRenderer,u=n.shaderData,h=n.shader,f=n.renderState,d=z._compileMacros;ct.unionCollection(e._globalShaderMacro,u._macroCollection,d);var _=e.viewMatrix,p=e.projectionMatrix;_.cloneTo(c);var v=c.elements;v[12]=v[13]=v[14]=0,ie.multiply(p,c,c),u.setMatrix("u_mvpNoscale",c);var g=h._getShaderProgram(t,d);g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.materialUniformBlock,u),g.uploadUnGroupTextures(),f._apply(t,!1),l.drawPrimitive(o,o.subMesh,g)}},Z(i,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),i}(),ao,oo,tt,so,co,lo,uo,ho,fo,_o,vo,po,go,mo,yo,yr,xo,Ar=function(){};Ar.tempVec4=new ze;Ar.tempVec3=new w;Ar.tempVec2=new H;var En=(ao=cl(Ot),ao(oo=(tt=(xo=yr=function(i){ee(s,i);function s(t){var e;e=i.call(this,t)||this,e.shaderData=new tn(xt.Camera),e.priority=0,e.enableFrustumCulling=!0,e.clearFlags=hr.DepthColor,e.cullingMask=ht.Everything,e._globalShaderMacro=new ct,V(e,"_frustum",so,F(e)),V(e,"_renderPipeline",co,F(e)),e._isOrthographic=!1,e._isProjMatSetting=!1,e._nearClipPlane=.1,e._farClipPlane=100,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._isFrustumProjectDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,V(e,"_frustumViewChangeFlag",lo,F(e)),V(e,"_transform",uo,F(e)),V(e,"_isViewMatrixDirty",ho,F(e)),V(e,"_isInvViewProjDirty",fo,F(e)),V(e,"_projectionMatrix",_o,F(e)),V(e,"_viewMatrix",vo,F(e)),V(e,"_viewport",po,F(e)),V(e,"_inverseProjectionMatrix",go,F(e)),V(e,"_lastAspectSize",mo,F(e)),V(e,"_invViewProjMat",yo,F(e));var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumViewChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new ah(F(e)),e.shaderData._addRefCount(1),e}var a=s.prototype;return a.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},a.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},a.worldToViewportPoint=function(e,r){var n=Ar.tempVec3,o=Ar.tempVec4;w.transformCoordinate(e,this.viewMatrix,n),w.transformToVec4(n,this.projectionMatrix,o);var c=o.w;return r.setValue((o.x/c+1)*.5,(1-o.y/c)*.5,-n.z),r},a.viewportToWorldPoint=function(e,r){var n=this.nearClipPlane,o=this.farClipPlane,c=1/(n-o),l;if(this.isOrthographic)l=-e.z*2*c,l+=(o+n)*c;else{var u=e.z;l=-u*(n+o)*c,l+=2*n*o*c,l=l/u}return this._innerViewportToWorldPoint(e.x,e.y,(l+1)/2,this._getInvViewProjMat(),r),r},a.viewportPointToRay=function(e,r){var n=this._getInvViewProjMat(),o=this._innerViewportToWorldPoint(e.x,e.y,0,n,r.origin),c=this._innerViewportToWorldPoint(e.x,e.y,1,n,r.direction);return w.subtract(c,o,c),c.normalize(),r},a.screenToViewportPoint=function(e,r){var n=this.engine.canvas,o=this.viewport;return r.x=(e.x/n.width-o.x)/o.z,r.y=(e.y/n.height-o.y)/o.w,e.z!==void 0&&(r.z=e.z),r},a.viewportToScreenPoint=function(e,r){var n=this.engine.canvas,o=this.viewport;return r.x=(o.x+e.x*o.z)*n.width,r.y=(o.y+e.y*o.w)*n.height,e.z!==void 0&&(r.z=e.z),r},a.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},a.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},a.screenPointToRay=function(e,r){var n=Ar.tempVec2;return this.screenToViewportPoint(e,n),this.viewportPointToRay(n,r)},a.render=function(e,r){r===void 0&&(r=0);var n=this.engine._renderContext;n._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(n._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(n),ct.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0),this._renderPipeline.render(n,e,r),this._engine._renderCount++},a._onActive=function(){this.entity.scene._attachRenderCamera(this)},a._onInActive=function(){this.entity.scene._detachRenderCamera(this)},a._onDestroy=function(){var e;(e=this._renderPipeline)===null||e===void 0||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},a._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},a._innerViewportToWorldPoint=function(e,r,n,o,c){var l=Ar.tempVec3;return l.setValue(e*2-1,1-r*2,n*2-1),w.transformCoordinate(l,o,c),c},a._updateShaderData=function(e){var r=this.shaderData;r.setMatrix(s._viewMatrixProperty,this.viewMatrix),r.setMatrix(s._projectionMatrixProperty,this.projectionMatrix),r.setMatrix(s._vpMatrixProperty,e._viewProjectMatrix),r.setMatrix(s._inverseViewMatrixProperty,this._transform.worldMatrix),r.setMatrix(s._inverseProjectionMatrixProperty,this._getInverseProjectionMatrix()),r.setVector3(s._cameraPositionProperty,this._transform.worldPosition)},a._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,ie.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},a._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,ie.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},Z(s,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,r=this._entity.engine.canvas;return(e=this._customAspectRatio)!=null?e:r.width*this._viewport.z/(r.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,ie.invert(this._transform.worldMatrix,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var r=this.aspectRatio;if(!this._isOrthographic)ie.perspective(N.degreeToRadian(this._fieldOfView),r,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);else{var n=this._orthographicSize*r,o=this._orthographicSize;ie.ortho(-n,n,-o,o,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),s}(Mt),yr._viewMatrixProperty=z.getPropertyByName("u_viewMat"),yr._projectionMatrixProperty=z.getPropertyByName("u_projMat"),yr._vpMatrixProperty=z.getPropertyByName("u_VPMat"),yr._inverseViewMatrixProperty=z.getPropertyByName("u_viewInvMat"),yr._inverseProjectionMatrixProperty=z.getPropertyByName("u_projInvMat"),yr._cameraPositionProperty=z.getPropertyByName("u_cameraPos"),xo),so=k(tt.prototype,"_frustum",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jc}}),co=k(tt.prototype,"_renderPipeline",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lo=k(tt.prototype,"_frustumViewChangeFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uo=k(tt.prototype,"_transform",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ho=k(tt.prototype,"_isViewMatrixDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fo=k(tt.prototype,"_isInvViewProjDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_o=k(tt.prototype,"_projectionMatrix",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),vo=k(tt.prototype,"_viewMatrix",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),po=k(tt.prototype,"_viewport",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ze(0,0,1,1)}}),go=k(tt.prototype,"_inverseProjectionMatrix",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),mo=k(tt.prototype,"_lastAspectSize",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new H(0,0)}}),yo=k(tt.prototype,"_invViewProjMat",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ie}}),tt))||oo),oh={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},sh=4,ch=15e3,lh=500;function Gi(i,s){return s===void 0&&(s={}),new st(function(a,t,e){var r,n,o,c,l=(r=s.retryCount)!=null?r:sh,u=(n=s.retryInterval)!=null?n:lh;s.timeout=(o=s.timeout)!=null?o:ch,s.type=(c=s.type)!=null?c:fh(i);var h=s.type==="image"?uh:hh,f,d=new dh(function(){return h(i,s).onProgress(e).then(function(_){a(_),d.stop()}).catch(function(_){return f=_})},l,u);d.start(function(){t(f)})})}function uh(i,s){return new st(function(a,t){var e=s.timeout,r=new Image,n=function(){t(new Error("request "+i+" fail"))};r.onerror=n,r.onabort=n;var o=setTimeout(function(){t(new Error("request "+i+" timeout"))},e);r.onload=function(c){return function(){requestAnimationFrame(function(){a(r),r.onload=null,r.onerror=null,r.onabort=null}),clearTimeout(c)}}(o),r.crossOrigin="anonymous",r.src=i})}function hh(i,s){return new st(function(a,t,e){var r,n=new XMLHttpRequest;n.timeout=s.timeout,s.method=(r=s.method)!=null?r:"get",n.onload=function(){var c;if(n.status<200||n.status>=300){t(new Error("request failed from: "+i));return}var l=(c=n.response)!=null?c:n.responseText;a(l)},n.onerror=function(){t(new Error("request failed from: "+i))},n.ontimeout=function(){t(new Error("request timeout from: "+i))},n.onprogress=function(c){e(c.loaded/c.total)},n.open(s.method,i,!0),n.withCredentials=s.credentials==="include",n.responseType=s.type;var o=s.headers;o&&Object.keys(o).forEach(function(c){n.setRequestHeader(c,o[c])}),n.send(s.body)})}function fh(i){var s=i.substring(i.lastIndexOf(".")+1);return oh[s]}var dh=function(){function i(a,t,e){this.execFunc=a,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var s=i.prototype;return s.start=function(t){this.done=t,this.exec()},s.stop=function(){clearTimeout(this._timeoutId)},s.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this.done&&this.done();return}this._currentCount++,this.execFunc(this._currentCount).then(function(){t._timeoutId=setTimeout(t.exec,t.interval)})},i}(),er=function(s){this.useCache=s,this.request=Gi},Te;(function(i){i.Text="text",i.JSON="json",i.Buffer="buffer",i.Texture2D="texture2d",i.TextureCube="texture-cube",i.Material="material",i.Mesh="mesh",i.AnimationClip="animation-clip",i.Prefab="prefab",i.KTX="ktx",i.KTXCube="ktx-cube",i.SpriteAtlas="sprite-atlas",i.Env="environment"})(Te||(Te={}));var cr;(function(i){i[i.Front=0]="Front",i[i.Back=1]="Back",i[i.Double=2]="Double"})(cr||(cr={}));var ui;(function(i){i[i.Normal=0]="Normal",i[i.Additive=1]="Additive"})(ui||(ui={}));var Ai=function(i){ee(s,i);function s(t,e){var r;return r=i.call(this,t,e)||this,r._renderFace=cr.Front,r._isTransparent=!1,r._blendMode=void 0,r.blendMode=ui.Normal,r.shaderData.setFloat(s._alphaCutoffProp,0),r}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){i.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},Z(s,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){if(e!==this._isTransparent){this._isTransparent=e;var r=this.renderState,n=r.depthState,o=r.blendState.targetBlendState;e?(o.enabled=!0,n.writeEnabled=!1,this.renderQueueType=We.Transparent):(o.enabled=!1,n.writeEnabled=!0,this.renderQueueType=this.shaderData.getFloat(s._alphaCutoffProp)?We.AlphaTest:We.Opaque)}}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(s._alphaCutoffProp)},set:function(e){this.shaderData.setFloat(s._alphaCutoffProp,e),e>0?(this.shaderData.enableMacro(s._alphaCutoffMacro),this.renderQueueType=this._isTransparent?We.Transparent:We.AlphaTest):(this.shaderData.disableMacro(s._alphaCutoffMacro),this.renderQueueType=this._isTransparent?We.Transparent:We.Opaque)}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){if(e!==this._renderFace)switch(this._renderFace=e,e){case cr.Front:this.renderState.rasterState.cullMode=dt.Back;break;case cr.Back:this.renderState.rasterState.cullMode=dt.Front;break;case cr.Double:this.renderState.rasterState.cullMode=dt.Off;break}}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){if(e!==this._blendMode){this._blendMode=e;var r=this.renderState.blendState.targetBlendState;switch(e){case ui.Normal:r.sourceColorBlendFactor=ue.SourceAlpha,r.destinationColorBlendFactor=ue.OneMinusSourceAlpha,r.sourceAlphaBlendFactor=ue.One,r.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=ft.Add;break;case ui.Additive:r.sourceColorBlendFactor=ue.SourceAlpha,r.destinationColorBlendFactor=ue.One,r.sourceAlphaBlendFactor=ue.One,r.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=ft.Add;break}}}}]),s}(Qt);Ai._alphaCutoffMacro=z.getMacroByName("ALPHA_CUTOFF");Ai._alphaCutoffProp=z.getPropertyByName("u_alphaCutoff");var et=function(i){ee(s,i);function s(t){var e;e=i.call(this,t,z.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._diffuseColorProp,new ne(1,1,1,1)),r.setColor(s._specularColorProp,new ne(1,1,1,1)),r.setColor(s._emissiveColorProp,new ne(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ze(1,1,0,0)),r.setFloat(s._shininessProp,16),r.setFloat(s._normalIntensityProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},Z(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._diffuseColorProp)},set:function(e){var r=this.shaderData.getColor(s._diffuseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro("O3_DIFFUSE_TEXTURE"):this.shaderData.disableMacro("O3_DIFFUSE_TEXTURE")}},{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(s._specularTextureProp)},set:function(e){this.shaderData.setTexture(s._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(s._emissiveColorProp);e!==r&&e.cloneTo(r)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(s._emissiveTextureProp,e),e?this.shaderData.enableMacro("O3_EMISSIVE_TEXTURE"):this.shaderData.disableMacro("O3_EMISSIVE_TEXTURE")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(e){this.shaderData.setTexture(s._normalTextureProp,e),e?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(s._normalIntensityProp)},set:function(e){this.shaderData.setFloat(s._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(s._shininessProp)},set:function(e){this.shaderData.setFloat(s._shininessProp,e)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),s}(Ai);et._diffuseColorProp=z.getPropertyByName("u_diffuseColor");et._specularColorProp=z.getPropertyByName("u_specularColor");et._emissiveColorProp=z.getPropertyByName("u_emissiveColor");et._tilingOffsetProp=z.getPropertyByName("u_tilingOffset");et._shininessProp=z.getPropertyByName("u_shininess");et._normalIntensityProp=z.getPropertyByName("u_normalIntensity");et._baseTextureProp=z.getPropertyByName("u_diffuseTexture");et._specularTextureProp=z.getPropertyByName("u_specularTexture");et._emissiveTextureProp=z.getPropertyByName("u_emissiveTexture");et._normalTextureProp=z.getPropertyByName("u_normalTexture");var Tt=function(i){ee(s,i);function s(a,t){var e;e=i.call(this,a,t)||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._baseColorProp,new ne(1,1,1,1)),r.setColor(s._emissiveColorProp,new ne(0,0,0,1)),r.setVector4(s._tilingOffsetProp,new ze(1,1,0,0)),r.setFloat(s._normalTextureIntensityProp,1),r.setFloat(s._occlusionTextureIntensityProp,1),e}return Z(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(t){var e=this.shaderData.getColor(s._baseColorProp);t!==e&&t.cloneTo(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(t){this.shaderData.setTexture(s._baseTextureProp,t),t?this.shaderData.enableMacro("HAS_BASECOLORMAP"):this.shaderData.disableMacro("HAS_BASECOLORMAP")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(s._normalTextureProp)},set:function(t){this.shaderData.setTexture(s._normalTextureProp,t),t?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(s._normalTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._normalTextureIntensityProp,t),this.shaderData.setFloat("u_normalIntensity",t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(s._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(s._emissiveColorProp);t!==e&&t.cloneTo(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(s._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(s._emissiveTextureProp,t),t?this.shaderData.enableMacro("HAS_EMISSIVEMAP"):this.shaderData.disableMacro("HAS_EMISSIVEMAP")}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(s._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(s._occlusionTextureProp,t),t?this.shaderData.enableMacro("HAS_OCCLUSIONMAP"):this.shaderData.disableMacro("HAS_OCCLUSIONMAP")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(s._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(s._occlusionTextureIntensityProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(s._tilingOffsetProp);t!==e&&t.cloneTo(e)}}]),s}(Ai);Tt._baseColorProp=z.getPropertyByName("u_baseColor");Tt._emissiveColorProp=z.getPropertyByName("u_emissiveColor");Tt._tilingOffsetProp=z.getPropertyByName("u_tilingOffset");Tt._baseTextureProp=z.getPropertyByName("u_baseColorSampler");Tt._normalTextureProp=z.getPropertyByName("u_normalTexture");Tt._normalTextureIntensityProp=z.getPropertyByName("u_normalIntensity");Tt._occlusionTextureIntensityProp=z.getPropertyByName("u_occlusionStrength");Tt._emissiveTextureProp=z.getPropertyByName("u_emissiveSampler");Tt._occlusionTextureProp=z.getPropertyByName("u_occlusionSampler");var fr=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t,z.find("pbr"))||this,e.shaderData.setFloat(s._metallicProp,1),e.shaderData.setFloat(s._roughnessProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},Z(s,[{key:"metallic",get:function(){return this.shaderData.getFloat(s._metallicProp)},set:function(e){this.shaderData.setFloat(s._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(s._roughnessProp)},set:function(e){this.shaderData.setFloat(s._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(s._metallicRoughnessTextureProp)},set:function(e){this.shaderData.setTexture(s._metallicRoughnessTextureProp,e),e?this.shaderData.enableMacro("HAS_METALROUGHNESSMAP"):this.shaderData.disableMacro("HAS_METALROUGHNESSMAP")}}]),s}(Tt);fr._metallicProp=z.getPropertyByName("u_metal");fr._roughnessProp=z.getPropertyByName("u_roughness");fr._metallicRoughnessTextureProp=z.getPropertyByName("u_metallicRoughnessSampler");var zr=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t,z.find("pbr-specular"))||this,e.shaderData.setColor(s._specularColorProp,new ne(1,1,1,1)),e.shaderData.setFloat(s._glossinessProp,1),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},Z(s,[{key:"specularColor",get:function(){return this.shaderData.getColor(s._specularColorProp)},set:function(e){var r=this.shaderData.getColor(s._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(s._glossinessProp)},set:function(e){this.shaderData.setFloat(s._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(s._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(s._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro("HAS_SPECULARGLOSSINESSMAP"):this.shaderData.disableMacro("HAS_SPECULARGLOSSINESSMAP")}}]),s}(Tt);zr._specularColorProp=z.getPropertyByName("u_specularColor");zr._glossinessProp=z.getPropertyByName("u_glossiness");zr._specularGlossinessTextureProp=z.getPropertyByName("u_specularGlossinessSampler");var Br=function(i){ee(s,i);function s(t){var e;e=i.call(this,t,z.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("OMIT_NORMAL"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(s._baseColorProp,new ne(1,1,1,1)),r.setVector4(s._tilingOffsetProp,new ze(1,1,0,0)),e}var a=s.prototype;return a.clone=function(){var e=new s(this._engine);return this.cloneTo(e),e},Z(s,[{key:"baseColor",get:function(){return this.shaderData.getColor(s._baseColorProp)},set:function(e){var r=this.shaderData.getColor(s._baseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(s._baseTextureProp)},set:function(e){this.shaderData.setTexture(s._baseTextureProp,e),e?this.shaderData.enableMacro("O3_BASE_TEXTURE"):this.shaderData.disableMacro("O3_BASE_TEXTURE")}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(s._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(s._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),s}(Ai);Br._baseColorProp=z.getPropertyByName("u_baseColor");Br._baseTextureProp=z.getPropertyByName("u_baseTexture");Br._tilingOffsetProp=z.getPropertyByName("u_tilingOffset");var mc=function(i){ee(a,i);var s=a.prototype;s.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},s.getSprites=function(e,r){r.length=0;var n=this._spriteNamesToIndex[e];if(n!==void 0)for(var o=this._sprites;n>=0;n--){var c=o[n];c.name===e&&r.push(c)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r};function a(t){var e;return e=i.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}return s._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},s._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},Z(a,[{key:"sprites",get:function(){return this._sprites}}]),a}(Qr),zn=function(i){ee(s,i);function s(t,e,r,n,o,c){var l;return e===void 0&&(e=null),r===void 0&&(r=null),n===void 0&&(n=null),o===void 0&&(o=128),c===void 0&&(c=null),l=i.call(this,t)||this,l.name=void 0,l._uv=[new H,new H,new H,new H],l._positions=[new H,new H,new H,new H],l._bounds=new ur,l._triangles=void 0,l._assetID=void 0,l._pixelsPerUnit=void 0,l._texture=null,l._atlasRotated=!1,l._region=new vn(0,0,1,1),l._pivot=new H(.5,.5),l._atlasRegion=new vn(0,0,1,1),l._atlasRegionOffset=new ze(0,0,0,0),l._dirtyFlag=Ie.all,l._updateFlagManager=new bi,l.name=c,l._texture=e,l._pixelsPerUnit=o,r&&r.cloneTo(l._region),n&&n.cloneTo(l._pivot),l._triangles=s._rectangleTriangles,l}var a=s.prototype;return a.clone=function(){var e=new s(this._engine,this._texture,this._region,this._pivot,this._pixelsPerUnit,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,this._atlasRegion.cloneTo(e._atlasRegion),this._atlasRegionOffset.cloneTo(e._atlasRegionOffset),e},a._registerUpdateFlag=function(){return this._updateFlagManager.register()},a._onDestroy=function(){this._texture&&(this._texture=null)},a._updatePositionsAndBounds=function(){var e=this._texture,r=this._bounds;if(e){var n=this._atlasRegion,o=this._pivot,c=this._atlasRegionOffset,l=this._region,u=l.x,h=l.y,f=l.width,d=l.height,_=1/this._pixelsPerUnit,p,v,g,m,y,A;if(this._atlasRotated?(y=e.height*n.height*_,A=e.width*n.width*_):(y=e.width*n.width*_,A=e.height*n.height*_),c.x==0&&c.y==0&&c.z==0&&c.w==0){var S=y*f,C=A*d;p=-o.x*S,m=-o.y*C,g=S+p,v=C+m}else{var P=c.x,R=c.y,T=c.z,E=c.w,D=y/(1-T-P),B=A/(1-E-R);p=(-o.x*f+Math.max(P,u)-u)*D,v=(o.y*d-Math.max(R,h)+h)*B,g=(-o.x*f+Math.min(1-T,u+f)-u)*D,m=(o.y*d-Math.min(1-E,h+d)+h)*B}var O=this._positions;O[0].setValue(p,v),O[1].setValue(g,v),O[2].setValue(g,m),O[3].setValue(p,m),r.min.setValue(p,m,0),r.max.setValue(g,v,0)}else r.min.setValue(0,0,0),r.max.setValue(0,0,0)},a._updateMesh=function(){if(this._isContainDirtyFlag(Ie.positions)&&this._updatePositionsAndBounds(),this._isContainDirtyFlag(Ie.uv)){var e=this._atlasRegion,r=this._uv,n=this._region,o=this._atlasRotated,c=this._atlasRegionOffset,l,u,h,f;if(c.x==0&&c.y==0&&c.z==0&&c.w==0){var d=e.width,_=e.height;o?(l=d*(1-n.y-n.height)+e.x,u=_*n.x+e.y,h=d*n.height+l,f=_*n.width+u):(l=d*n.x+e.x,u=_*n.y+e.y,h=d*n.width+l,f=_*n.height+u)}else{var p=n.x,v=n.y,g=e.x,m=e.y,y=c.x,A=c.y,S=c.z,C=c.w;if(o){var P=e.width/(1-C-A),R=e.height/(1-S-y);l=(Math.max(C,1-v-n.height)-C)*P+g,u=(Math.max(y,p)-y)*R+m,h=(Math.min(1-A,1-v)-C)*P+g,f=(Math.min(1-S,p+n.width)-y)*R+m}else{var T=e.width/(1-S-y),E=e.height/(1-C-A);l=(Math.max(y,p)-y)*T+g,u=(Math.max(A,v)-A)*E+m,h=(Math.min(1-S,p+n.width)-y)*T+g,f=(Math.min(1-C,v+n.height)-A)*E+m}}o?(r[0].setValue(h,u),r[1].setValue(h,f),r[2].setValue(l,f),r[3].setValue(l,u)):(r[0].setValue(l,u),r[1].setValue(h,u),r[2].setValue(h,f),r[3].setValue(l,f))}this._setDirtyFlagFalse(Ie.all)},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e,this._updateFlagManager.distribute()},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},Z(s,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._setDirtyFlagTrue(Ie.positions))}},{key:"bounds",get:function(){return this._isContainDirtyFlag(Ie.positions)&&this._texture&&(this._updatePositionsAndBounds(),this._setDirtyFlagFalse(Ie.positions)),this._bounds}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e,this._setDirtyFlagTrue(Ie.positions|Ie.uv))}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=N.clamp(e.x,0,1),n=N.clamp(e.y,0,1);this._atlasRegion.setValue(r,n,N.clamp(e.width,0,1-r),N.clamp(e.height,0,1-n)),this._setDirtyFlagTrue(Ie.positions|Ie.uv)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=N.clamp(e.x,0,1),n=N.clamp(e.y,0,1);this._atlasRegionOffset.setValue(r,n,N.clamp(e.z,0,1-r),N.clamp(e.w,0,1-n)),this._setDirtyFlagTrue(Ie.positions|Ie.uv)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var r=this._pivot,n=N.clamp(e.x,0,1),o=N.clamp(e.y,0,1);(r===e||r.x!==n||r.y!==o)&&(r.setValue(n,o),this._setDirtyFlagTrue(Ie.positions))}},{key:"region",get:function(){return this._region},set:function(e){var r=this._region,n=N.clamp(e.x,0,1),o=N.clamp(e.y,0,1);r.setValue(n,o,N.clamp(e.width,0,1-n),N.clamp(e.height,0,1-o)),this._setDirtyFlagTrue(Ie.positions|Ie.uv)}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._setDirtyFlagTrue(Ie.positions))}}]),s}(Qr);zn._rectangleTriangles=[0,2,1,2,0,3];var Ie;(function(i){i[i.positions=1]="positions",i[i.uv=2]="uv",i[i.all=3]="all"})(Ie||(Ie={}));var je,bo,wo,Ao,So,Po,Mo,To,Co,Ro,Eo,zo,Bo,Do,Oo,un,Fo,_h=(je=(Fo=un=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,V(e,"_customLocalBounds",bo,F(e)),V(e,"_customRootEntity",wo,F(e)),V(e,"_positions",Ao,F(e)),V(e,"_sprite",So,F(e)),V(e,"_color",Po,F(e)),V(e,"_flipX",Mo,F(e)),V(e,"_flipY",To,F(e)),V(e,"_cacheFlipX",Co,F(e)),V(e,"_cacheFlipY",Ro,F(e)),V(e,"_dirtyFlag",Eo,F(e)),V(e,"_isWorldMatrixDirty",zo,F(e)),V(e,"_spriteDirty",Bo,F(e)),V(e,"_maskInteraction",Do,F(e)),V(e,"_maskLayer",Oo,F(e)),e._isWorldMatrixDirty=t.transform.registerWorldChangeFlag(),e.setMaterial(e._engine._spriteDefaultMaterial),e}var a=s.prototype;return a._render=function(e){var r=this.sprite;if(!!r){var n=r.texture;if(!!n){var o=this._positions,c=this.entity.transform;if(r._updateMesh(),this._isWorldMatrixDirty.flag||this._spriteDirty.flag){for(var l=r._positions,u=s._tempVec3,h=c.worldMatrix,f=this.flipX,d=this.flipY,_=0,p=o.length;_<p;_++){var v=l[_];u.setValue(f?-v.x:v.x,d?-v.y:v.y,0),w.transformToVec3(u,h,o[_])}this._setDirtyFlagFalse(Et.Flip),this._isWorldMatrixDirty.flag=!1,this._spriteDirty.flag=!1,this._cacheFlipX=f,this._cacheFlipY=d}else if(this._isContainDirtyFlag(Et.Flip)){var g=this.flipX,m=this.flipY,y=this._cacheFlipX!==g,A=this._cacheFlipY!==m;if(y||A)for(var S=c.worldPosition,C=S.x,P=S.y,R=0,T=o.length;R<T;R++){var E=o[R];y&&(E.x=C*2-E.x),A&&(E.y=P*2-E.y)}this._setDirtyFlagFalse(Et.Flip),this._cacheFlipX=g,this._cacheFlipY=m}this._isContainDirtyFlag(Et.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(Et.MaskInteraction)),this.shaderData.setTexture(s._textureProperty,n);var D=this.getMaterial(),B=this._engine._spriteElementPool,O=B.getFromPool();O.setValue(this,o,r._uv,r._triangles,this.color,D,e),e._renderPipeline.pushPrimitive(O)}}},a._onDestroy=function(){this._isWorldMatrixDirty.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),i.prototype._onDestroy.call(this)},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._cloneTo=function(e){e.sprite=this._sprite},a._updateBounds=function(e){var r=this._sprite;if(r)if(this._customLocalBounds&&this._customRootEntity){var n=this._customRootEntity.transform.worldMatrix;ur.transform(this._customLocalBounds,n,e)}else{var o=r.bounds,c=this._entity.transform.worldMatrix;ur.transform(o,c,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},a._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,n=this._maskInteraction;if(n===lr.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=Me.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=n===lr.VisibleInsideMask?Me.LessEqual:Me.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},Z(s,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&e.cloneTo(this._color)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._setDirtyFlagTrue(Et.Flip))}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._setDirtyFlagTrue(Et.Flip))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(Et.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}}]),s}(Rn),un._textureProperty=z.getPropertyByName("u_spriteTexture"),un._tempVec3=new w,Fo),bo=k(je.prototype,"_customLocalBounds",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wo=k(je.prototype,"_customRootEntity",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ao=k(je.prototype,"_positions",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new w,new w,new w,new w]}}),So=k(je.prototype,"_sprite",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Po=k(je.prototype,"_color",[Ee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ne(1,1,1,1)}}),Mo=k(je.prototype,"_flipX",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),To=k(je.prototype,"_flipY",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Co=k(je.prototype,"_cacheFlipX",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ro=k(je.prototype,"_cacheFlipY",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Eo=k(je.prototype,"_dirtyFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zo=k(je.prototype,"_isWorldMatrixDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Bo=k(je.prototype,"_spriteDirty",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Do=k(je.prototype,"_maskInteraction",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lr.None}}),Oo=k(je.prototype,"_maskLayer",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xi.Layer0}}),je),Et;(function(i){i[i.Flip=1]="Flip",i[i.MaskInteraction=2]="MaskInteraction"})(Et||(Et={}));var vh=function(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0},ph=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0},_e;(function(i){i[i.Position=0]="Position",i[i.Rotation=1]="Rotation",i[i.Scale=2]="Scale",i[i.BlendShapeWeights=3]="BlendShapeWeights"})(_e||(_e={}));var gh=function(){},mh=function(i){ee(s,i);function s(t){var e;return e=i.call(this)||this,e.name=t,e._curveBindings=[],e._length=0,e._events=[],e}var a=s.prototype;return a.addEvent=function(e,r,n){if(typeof e=="string"){var o=new ph;o.functionName=e,o.time=r,o.parameter=n,this._events.push(o)}else this._events.push(e);this._events.sort(function(c,l){return c.time-l.time})},a.clearEvents=function(){this._events.length=0},a.addCurveBinding=function(e,r,n,o){var c;switch(n){case"position":c=_e.Position;break;case"rotation":c=_e.Rotation;break;case"scale":c=_e.Scale;break;case"blendShapeWeights":c=_e.BlendShapeWeights;break}var l=new vh;l.relativePath=e,l.type=r,l.property=c,l.curve=o,o.length>this._length&&(this._length=o.length),this._curveBindings.push(l)},a.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},a._sampleAnimation=function(e,r){for(var n=this._curveBindings.length,o=n-1;o>=0;o--){var c=this._curveBindings[o],l=c.curve,u=c.property,h=c.relativePath,f=c.type,d=l.evaluate(r),_=e.findByName(h),p=_.transform;if(f===Ot)switch(u){case _e.Position:p.position=d;break;case _e.Rotation:p.rotationQuaternion=d;break;case _e.Scale:p.scale=d;break}}},Z(s,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),s}(gh),qi=function(){function i(){}return i.scaleWeight=function(a,t,e){var r=a.x,n=a.y,o=a.z;e.x=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),e.y=n>0?Math.pow(Math.abs(n),t):-Math.pow(Math.abs(n),t),e.z=o>0?Math.pow(Math.abs(o),t):-Math.pow(Math.abs(o),t)},i.scaleBlend=function(a,t,e,r){var n=i._tempVector30,o=i._tempVector31;i.scaleWeight(a,1-e,n),i.scaleWeight(t,e,o);var c=e>.5?t:a;r.x=c.x>0?Math.abs(n.x*o.x):-Math.abs(n.x*o.x),r.y=c.y>0?Math.abs(n.y*o.y):-Math.abs(n.y*o.y),r.z=c.z>0?Math.abs(n.z*o.z):-Math.abs(n.z*o.z)},i.quaternionWeight=function(a,t,e){e.x=a.x*t,e.y=a.y*t,e.z=a.z*t,e.w=a.w},i}();qi._tempVector30=new w;qi._tempVector31=new w;var xi;(function(i){i[i.Override=0]="Override",i[i.Additive=1]="Additive"})(xi||(xi={}));var Je;(function(i){i[i.UnStarted=0]="UnStarted",i[i.Playing=1]="Playing",i[i.Finished=2]="Finished"})(Je||(Je={}));var Ne;(function(i){i[i.Standby=0]="Standby",i[i.Playing=1]="Playing",i[i.CrossFading=2]="CrossFading",i[i.FixedCrossFading=3]="FixedCrossFading"})(Ne||(Ne={}));var yh=function(){function i(a,t,e){switch(this.crossCurveMark=0,this.crossCurveIndex=void 0,this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this._hasSavedDefaultValue=!1,this.target=a,this.type=t,this.property=e,e){case _e.Position:this.defaultValue=new w,this.fixedPoseValue=new w,this.component=a.transform;break;case _e.Rotation:this.defaultValue=new Se,this.fixedPoseValue=new Se,this.component=a.transform;break;case _e.Scale:this.defaultValue=new w,this.fixedPoseValue=new w,this.component=a.transform;break;case _e.BlendShapeWeights:this.defaultValue=new Float32Array(4),this.fixedPoseValue=new Float32Array(4),this.component=a.getComponent(yi);break}}var s=i.prototype;return s.saveDefaultValue=function(){switch(this.property){case _e.Position:this.target.transform.position.cloneTo(this.defaultValue);break;case _e.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.defaultValue);break;case _e.Scale:this.target.transform.scale.cloneTo(this.defaultValue);break;case _e.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,n=e.length;r<n;++r)this.defaultValue[r]=this.component.blendShapeWeights[r];break}this._hasSavedDefaultValue=!0},s.saveFixedPoseValue=function(){switch(this.property){case _e.Position:this.target.transform.position.cloneTo(this.fixedPoseValue);break;case _e.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.fixedPoseValue);break;case _e.Scale:this.target.transform.scale.cloneTo(this.fixedPoseValue);break;case _e.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,n=e.length;r<n;++r)this.fixedPoseValue[r]=this.component.blendShapeWeights[r];break}},i}(),xh=function(){this.event=void 0,this.handlers=[]},yc=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0},Yi;(function(i){i[i.Once=0]="Once",i[i.Loop=1]="Loop"})(Yi||(Yi={}));var Io=function(){function i(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var s=i.prototype;return s.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=Je.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0},s.update=function(){var t=this.state,e=this.frameTime,r=t._getDuration();this.playState=Je.Playing,e>r&&(t.wrapMode===Yi.Loop?e=e%r:(e=r,this.playState=Je.Finished)),this.clipTime=e+t.clipStartTime*t.clip.length},i}(),bh=function(){function i(){this.animatorStateDataMap={},this.srcPlayData=new Io,this.destPlayData=new Io,this.layerState=Ne.Standby,this.crossCurveMark=0,this.manuallyTransition=new yc,this.crossFadeTransition=void 0}var s=i.prototype;return s.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},i}(),wh=function(){this.curveOwners=[],this.eventHandlers=[]},Ah=function(){this.layerIndex=void 0,this.state=void 0},Sh=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},Gt,Lo,Uo,No,Vo,ko,Go,Ho,Ni,Wo,Dr=(Gt=(Wo=Ni=function(i){ee(s,i);function s(t){var e;return e=i.call(this,t)||this,e._animatorController=void 0,V(e,"_speed",Lo,F(e)),V(e,"_controllerUpdateFlag",Uo,F(e)),V(e,"_animatorLayersData",No,F(e)),V(e,"_crossCurveDataCollection",Vo,F(e)),V(e,"_animationCurveOwners",ko,F(e)),V(e,"_crossCurveDataPool",Go,F(e)),V(e,"_animationEventHandlerPool",Ho,F(e)),e}var a=s.prototype;return a.play=function(e,r,n){var o;r===void 0&&(r=-1),n===void 0&&(n=0),(o=this._controllerUpdateFlag)!==null&&o!==void 0&&o.flag&&this._clearPlayData();var c=this._getAnimatorStateInfo(e,r,s._animatorInfo),l=c.state;if(!!l){if(!l.clip){console.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(c.layerIndex),h=u.srcPlayData,f=h.state;f&&f!==l&&this._revertDefaultValue(h.state,h.stateData);var d=this._getAnimatorStateData(e,l,u);u.layerState=Ne.Playing,h.reset(l,d,l._getDuration()*n),this._saveDefaultValues(d)}},a._reset=function(){var e=this._animatorController;if(e)for(var r=e.layers,n=0,o=r.length;n<o;++n)for(var c=r[n].stateMachine.states,l=this._getAnimatorLayerData(n),u=0,h=c.length;u<h;++u){var f=c[u],d=this._getAnimatorStateData(f.name,f,l);this._revertDefaultValue(f,d)}this._clearPlayData()},a.crossFade=function(e,r,n,o){var c;n===void 0&&(n=-1),o===void 0&&(o=0),(c=this._controllerUpdateFlag)!==null&&c!==void 0&&c.flag&&this._clearPlayData();var l=this._getAnimatorStateInfo(e,n,s._animatorInfo),u=l.state,h=this._getAnimatorLayerData(n),f=h.manuallyTransition;f.duration=r,f.offset=o,f.destinationState=u,this._crossFadeByTransition(f,n)},a.update=function(e){var r;if(this.speed!==0){var n=this._animatorController;if(!!n&&!((r=this._controllerUpdateFlag)!==null&&r!==void 0&&r.flag)){e*=this.speed;for(var o=0,c=n.layers.length;o<c;o++){var l=this._getAnimatorLayerData(o);l.layerState!==Ne.Standby&&this._updateLayer(o,o===0,e/1e3)}}}},a.getCurrentAnimatorState=function(e){var r,n;return(r=this._animatorLayersData[e])===null||r===void 0||(n=r.srcPlayData)===null||n===void 0?void 0:n.state},a._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},a._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},a._getAnimatorStateInfo=function(e,r,n){var o=null,c=this._animatorController;if(c){var l=c.layers;if(r===-1){for(var u=0,h=l.length;u<h;u++)if(o=l[u].stateMachine.findStateByName(e),o){r=u;break}}else o=l[r].stateMachine.findStateByName(e)}return n.layerIndex=r,n.state=o,n},a._saveDefaultValues=function(e){for(var r=e.curveOwners,n=r.length-1;n>=0;n--)r[n].saveDefaultValue()},a._getAnimatorStateData=function(e,r,n){var o=n.animatorStateDataMap,c=o[e];return c||(c=new wh,o[e]=c,this._saveAnimatorStateData(r,c),this._saveAnimatorEventHandlers(r,c)),c},a._saveAnimatorStateData=function(e,r){for(var n=this.entity,o=this._animationCurveOwners,c=r.curveOwners,l=e.clip._curveBindings,u=l.length-1;u>=0;u--){var h=l[u],f=h.relativePath===""?n:n.findByPath(h.relativePath),d=h.property,_=f.instanceId,p=o[_]||(o[_]=[]);c[u]=p[d]||(p[d]=new yh(f,h.type,d))}},a._saveAnimatorEventHandlers=function(e,r){var n=this._animationEventHandlerPool,o=this._entity._scripts,c=o.length,l=r.eventHandlers,u=e.clip.events;n.resetPool(),l.length=0;for(var h=0,f=u.length;h<f;h++){var d=u[h],_=n.getFromPool(),p=d.functionName,v=_.handlers;_.event=d,v.length=0;for(var g=c-1;g>=0;g--){var m=o.get(g)[p];m&&v.push(m)}l.push(_)}},a._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},a._addCrossCurveData=function(e,r,n,o){var c=this._crossCurveDataPool.getFromPool();c.curveOwner=r,c.srcCurveIndex=n,c.destCurveIndex=o,e.push(c)},a._prepareCrossFading=function(e){var r=this._crossCurveDataCollection,n=e.crossCurveMark;this._prepareSrcCrossData(r,e.srcPlayData,n,!1),this._prepareDestCrossData(r,e.destPlayData,n,!1)},a._prepareStandbyCrossFading=function(e){var r=this._crossCurveDataCollection,n=e.srcPlayData,o=e.crossCurveMark;n&&this._prepareSrcCrossData(r,n,o,!0),this._prepareDestCrossData(r,e.destPlayData,o,!0)},a._prepareFixedPoseCrossFading=function(e){for(var r=this._crossCurveDataCollection,n=r.length-1;n>=0;n--){var o=r[n];o.curveOwner.saveFixedPoseValue(),o.destCurveIndex=-1}this._prepareDestCrossData(r,e.destPlayData,e.crossCurveMark,!0)},a._prepareSrcCrossData=function(e,r,n,o){for(var c=r.stateData.curveOwners,l=c.length-1;l>=0;l--){var u=c[l];u.crossCurveMark=n,u.crossCurveIndex=e.length,o&&u.saveFixedPoseValue(),this._addCrossCurveData(e,u,l,-1)}},a._prepareDestCrossData=function(e,r,n,o){for(var c=r.stateData.curveOwners,l=c.length-1;l>=0;l--){var u=c[l];u.crossCurveMark===n?e[u.crossCurveIndex].destCurveIndex=l:(u.saveDefaultValue(),o&&u.saveFixedPoseValue(),u.crossCurveMark=n,u.crossCurveIndex=e.length,this._addCrossCurveData(e,u,-1,l))}},a._evaluateCurve=function(e,r,n,o){var c=r.evaluate(n);if(o){var l=r.keys[0].value;switch(e){case _e.Position:var u=s._tempVector3;return w.subtract(c,l,u),u;case _e.Rotation:var h=s._tempQuaternion;return Se.conjugate(l,h),Se.multiply(h,c,h),h;case _e.Scale:var f=s._tempVector3;return w.divide(c,l,f),f}}return c},a._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new bh),r},a._updateLayer=function(e,r,n){var o=this._animatorController.layers[e],c=o.blendingMode,l=o.weight,u=this._animatorLayersData[e],h=u.srcPlayData,f=u.destPlayData,d=u.crossFadeTransition,_=c===xi.Additive,p=r?1:l;switch(this._checkTransition(h,d,e),u.layerState){case Ne.Playing:this._updatePlayingState(h,u,e,p,n,_);break;case Ne.FixedCrossFading:this._updateCrossFadeFromPose(f,u,e,p,n,_);break;case Ne.CrossFading:this._updateCrossFade(h,f,u,e,p,n,_);break}},a._updatePlayingState=function(e,r,n,o,c,l){var u=e.stateData,h=u.curveOwners,f=u.eventHandlers,d=e.state,_=e.playState,p=e.clipTime,v=d.clip._curveBindings;e.update();var g=e.clipTime,m=e.playState;f.length&&this._fireAnimationEvents(e,f,p,g),_===Je.UnStarted&&this._callAnimatorScriptOnEnter(d,n),m===Je.Finished?this._callAnimatorScriptOnExit(d,n):this._callAnimatorScriptOnUpdate(d,n);for(var y=v.length-1;y>=0;y--){var A=h[y],S=this._evaluateCurve(A.property,v[y].curve,g,l);l?this._applyClipValueAdditive(A,S,o):this._applyClipValue(A,S,o)}e.frameTime+=d.speed*c,m===Je.Finished&&(r.layerState=Ne.Standby)},a._updateCrossFade=function(e,r,n,o,c,l,u){var h=this._crossCurveDataCollection,f=e.state.clip._curveBindings,d=e.state,_=e.stateData,p=e.playState,v=_.eventHandlers,g=r.state,m=r.stateData,y=r.playState,A=m.eventHandlers,S=g.clip._curveBindings,C=e.clipTime,P=r.clipTime,R=r.frameTime/(g._getDuration()*n.crossFadeTransition.duration);R>=1&&(R=1),e.update(),r.update();var T=e.playState,E=r.playState;this._updateCrossFadeData(n,R,l,!1);var D=e.clipTime,B=r.clipTime;v.length&&this._fireAnimationEvents(e,v,C,D),A.length&&this._fireAnimationEvents(r,A,P,B),p===Je.UnStarted&&this._callAnimatorScriptOnEnter(d,o),R===1||T===Je.Finished?this._callAnimatorScriptOnExit(d,o):this._callAnimatorScriptOnUpdate(d,o),y===Je.UnStarted&&this._callAnimatorScriptOnEnter(g,o),E===Je.Finished?this._callAnimatorScriptOnExit(g,o):this._callAnimatorScriptOnUpdate(g,o);for(var O=h.length-1;O>=0;O--){var G=h[O],L=G.curveOwner,W=G.srcCurveIndex,K=G.destCurveIndex,Y=L.property,U=L.defaultValue,j=W>=0?this._evaluateCurve(Y,f[W].curve,D,u):U,oe=K>=0?this._evaluateCurve(Y,S[K].curve,B,u):U;this._applyCrossClipValue(L,j,oe,R,c,u)}},a._updateCrossFadeFromPose=function(e,r,n,o,c,l){var u=this._crossCurveDataCollection,h=e.state,f=e.stateData,d=e.playState,_=f.eventHandlers,p=h.clip._curveBindings,v=e.clipTime,g=e.frameTime/(h._getDuration()*r.crossFadeTransition.duration);g>=1&&(g=1),e.update();var m=e.playState;this._updateCrossFadeData(r,g,c,!0);var y=e.clipTime;_.length&&this._fireAnimationEvents(e,_,v,y),d===Je.UnStarted&&this._callAnimatorScriptOnEnter(h,n),m===Je.Finished?this._callAnimatorScriptOnExit(h,n):this._callAnimatorScriptOnUpdate(h,n);for(var A=u.length-1;A>=0;A--){var S=u[A],C=S.curveOwner,P=S.destCurveIndex,R=P>=0?this._evaluateCurve(C.property,p[P].curve,y,l):C.defaultValue;this._applyCrossClipValue(C,C.fixedPoseValue,R,g,o,l)}},a._updateCrossFadeData=function(e,r,n,o){var c=e.destPlayData;c.frameTime+=c.state.speed*n,r===1?(c.playState===Je.Finished?e.layerState=Ne.Standby:e.layerState=Ne.Playing,e.switchPlayData()):o||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*n)},a._applyCrossClipValue=function(e,r,n,o,c,l){var u;if(e.type===Ot){var h=e.target.transform;switch(e.property){case _e.Position:w.lerp(r,n,o,s._tempVector3),u=s._tempVector3;break;case _e.Rotation:Se.slerp(r,n,o,s._tempQuaternion),u=s._tempQuaternion;break;case _e.Scale:{var f=h.scale;w.lerp(r,n,o,s._tempVector3),h.scale=f,u=s._tempVector3;break}}}else if(e.type===yi)switch(e.property){case _e.BlendShapeWeights:e.component.blendShapeWeights=u;break}l?this._applyClipValueAdditive(e,u,c):this._applyClipValue(e,u,c)},a._applyClipValue=function(e,r,n){if(e.type===Ot){var o=e.target.transform;switch(e.property){case _e.Position:if(n===1)o.position=r;else{var c=o.position;w.lerp(c,r,n,c),o.position=c}break;case _e.Rotation:if(n===1)o.rotationQuaternion=r;else{var l=o.rotationQuaternion;Se.slerp(l,r,n,l),o.rotationQuaternion=l}break;case _e.Scale:if(n===1)o.scale=r;else{var u=o.scale;w.lerp(u,r,n,u),o.scale=u}break}}else if(e.type===yi)switch(e.property){case _e.BlendShapeWeights:e.component.blendShapeWeights=r;break}},a._applyClipValueAdditive=function(e,r,n){if(e.type===Ot){var o=e.target.transform;switch(e.property){case _e.Position:var c=o.position;c.x+=r.x*n,c.y+=r.y*n,c.z+=r.z*n,o.position=c;break;case _e.Rotation:var l=o.rotationQuaternion;qi.quaternionWeight(r,n,r),r.normalize(),l.multiply(r),o.rotationQuaternion=l;break;case _e.Scale:var u=o.scale;qi.scaleWeight(u,n,u),w.multiply(u,r,u),o.scale=u;break}}},a._revertDefaultValue=function(e,r){var n=e.clip;if(n)for(var o=n._curveBindings,c=r.curveOwners,l=o.length-1;l>=0;l--){var u=c[l],h=u.target.transform;if(!!u._hasSavedDefaultValue)switch(u.property){case _e.Position:h.position=u.defaultValue;break;case _e.Rotation:h.rotationQuaternion=u.defaultValue;break;case _e.Scale:h.scale=u.defaultValue;break;case _e.BlendShapeWeights:for(var f=u.component,d=f.blendShapeWeights,_=0,p=d.length;_<p;++_)u.component.blendShapeWeights[_]=u.defaultValue[_];break}}},a._checkTransition=function(e,r,n){for(var o=e.state,c=e.clipTime,l=o._getDuration(),u=o.transitions,h=0,f=u.length;h<f;++h){var d=u[h];l*d.exitTime<=c&&r!==d&&this._crossFadeByTransition(d,n)}},a._crossFadeByTransition=function(e,r){var n=e.destinationState.name,o=this._getAnimatorStateInfo(n,r,s._animatorInfo),c=o.state;if(!!c){if(!c.clip){console.warn("The state named "+n+" has no AnimationClip data.");return}var l=this._getAnimatorLayerData(o.layerIndex),u=l.layerState,h=l.destPlayData,f=this._getAnimatorStateData(n,c,l),d=c._getDuration(),_=d*e.offset;switch(h.reset(c,f,_),u){case Ne.Standby:l.layerState=Ne.FixedCrossFading,this._clearCrossData(l),this._prepareStandbyCrossFading(l);break;case Ne.Playing:l.layerState=Ne.CrossFading,this._clearCrossData(l),this._prepareCrossFading(l);break;case Ne.CrossFading:l.layerState=Ne.FixedCrossFading,this._prepareFixedPoseCrossFading(l);break;case Ne.FixedCrossFading:this._prepareFixedPoseCrossFading(l);break}l.crossFadeTransition=e}},a._fireAnimationEvents=function(e,r,n,o){var c=e.state,l=c.clip.length;o<n?(this._fireSubAnimationEvents(e,r,n,c.clipEndTime*l),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,c.clipStartTime*l,o)):this._fireSubAnimationEvents(e,r,n,o)},a._fireSubAnimationEvents=function(e,r,n,o){for(var c=e.currentEventIndex,l=r.length;c<l;c++){var u=r[c],h=u.event,f=h.time,d=h.parameter;if(f>o)break;var _=u.handlers;if(f>=n){for(var p=_.length-1;p>=0;p--)_[p](d);e.currentEventIndex=c+1}}},a._callAnimatorScriptOnEnter=function(e,r){for(var n=e._onStateEnterScripts,o=0,c=n.length;o<c;o++)n[o].onStateEnter(this,e,r)},a._callAnimatorScriptOnUpdate=function(e,r){for(var n=e._onStateUpdateScripts,o=0,c=n.length;o<c;o++)n[o].onStateUpdate(this,e,r)},a._callAnimatorScriptOnExit=function(e,r){for(var n=e._onStateExitScripts,o=0,c=n.length;o<c;o++)n[o].onStateExit(this,e,r)},a._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},Z(s,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),s}(Mt),Ni._tempVector3=new w,Ni._tempQuaternion=new Se,Ni._animatorInfo=new Ah,Wo),Lo=k(Gt.prototype,"_speed",[Bt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uo=k(Gt.prototype,"_controllerUpdateFlag",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),No=k(Gt.prototype,"_animatorLayersData",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vo=k(Gt.prototype,"_crossCurveDataCollection",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ko=k(Gt.prototype,"_animationCurveOwners",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Go=k(Gt.prototype,"_crossCurveDataPool",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jr(Sh)}}),Ho=k(Gt.prototype,"_animationEventHandlerPool",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jr(xh)}}),Gt),Bn=function(){function i(){this._updateFlagManager=new bi,this._layers=[],this._layersMap={}}var s=i.prototype;return s.findLayerByName=function(t){return this._layersMap[t]},s.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._distributeUpdateFlag()},s.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._distributeUpdateFlag()},s.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._distributeUpdateFlag()},s._registerChangeFlag=function(){return this._updateFlagManager.register()},s._distributeUpdateFlag=function(){this._updateFlagManager.distribute()},Z(i,[{key:"layers",get:function(){return this._layers}}]),i}(),Qi=function(s){this.name=s,this.weight=1,this.blendingMode=xi.Override,this.stateMachine=void 0},Xo=function(){function i(){this._destroyed=!1,this._state=void 0}var s=i.prototype;return s.onStateEnter=function(t,e,r){},s.onStateUpdate=function(t,e,r){},s.onStateExit=function(t,e,r){},s.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},i}(),Ph=function(){function i(a){this.name=a,this.speed=1,this.wrapMode=Yi.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var s=i.prototype;return s.addTransition=function(t){this._transitions.push(t)},s.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},s.addStateMachineScript=function(t){var e=new t;e._state=this;var r=Xo.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},s.clearTransitions=function(){this._transitions.length=0},s._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},s._removeStateMachineScript=function(t){var e=Xo.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var n=this._onStateUpdateScripts.indexOf(t);n!==-1&&this._onStateUpdateScripts.splice(n,1)}if(t.onStateExit!==e.onStateExit){var o=this._onStateExitScripts.indexOf(t);o!==-1&&this._onStateExitScripts.splice(o,1)}},Z(i,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),i}(),$i=function(){function i(){this.states=[],this._statesMap={}}var s=i.prototype;return s.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new Ph(t),this.states.push(e),this._statesMap[t]=e),e},s.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},s.findStateByName=function(t){return this._statesMap[t]},s.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,n=0;e[t];)t=r+" "+n,n++;return t},i}(),ot;(function(i){i[i.Float=0]="Float",i[i.FloatArray=1]="FloatArray",i[i.Vector2=2]="Vector2",i[i.Vector3=3]="Vector3",i[i.Vector4=4]="Vector4",i[i.Quaternion=5]="Quaternion"})(ot||(ot={}));var qt;(function(i){i[i.Linear=0]="Linear",i[i.CubicSpine=1]="CubicSpine",i[i.Step=2]="Step",i[i.Hermite=3]="Hermite"})(qt||(qt={}));var Mh=function(){function i(){this.keys=[],this.interpolation=void 0,this._valueSize=void 0,this._valueType=void 0,this._currentValue=void 0,this._length=0,this._currentIndex=0}var s=i.prototype;return s.addKey=function(t){var e=t.time;if(this.keys.push(t),e>this._length&&(this._length=e),!this._valueSize&&(typeof t.value=="number"&&(this._valueSize=1,this._valueType=ot.Float,this._currentValue=0),t.value instanceof H&&(this._valueSize=2,this._valueType=ot.Vector2,this._currentValue=new H),t.value instanceof w&&(this._valueSize=3,this._valueType=ot.Vector3,this._currentValue=new w),t.value instanceof ze&&(this._valueSize=4,this._valueType=ot.Vector4,this._currentValue=new ze),t.value instanceof Se&&(this._valueSize=4,this._valueType=ot.Quaternion,this._currentValue=new Se),t.value instanceof Float32Array)){var r=t.value.length;this._valueSize=r,this._valueType=ot.FloatArray,this._currentValue=new Float32Array(r)}this.keys.sort(function(n,o){return n.time-o.time})},s.evaluate=function(t){var e=this.keys,r=this.interpolation,n=this.keys.length,o=this._currentIndex;o!==-1&&t<e[o].time&&(o=-1);for(var c=o+1;c<n&&!(t<e[c].time);)o++,c++;this._currentIndex=o;var l;if(o===-1)l=e[0].value;else if(c===n)l=e[o].value;else{var u=e[o].time,h=e[c].time-u,f=(t-u)/h,d=h;switch(r){case qt.Linear:l=this._evaluateLinear(o,c,f);break;case qt.Step:l=this._evaluateStep(c);break;case qt.CubicSpine:case qt.Hermite:l=this._evaluateHermite(o,c,f,d)}}return l},s.moveKey=function(t,e){this.keys[t]=e},s.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=this.keys.length,n=0,o=r-1;o>=0;o--)e[o].time>length&&(n=e[o].time);this._length=n},s._evaluateLinear=function(t,e,r){var n=this._valueType,o=this.keys;switch(n){case ot.Float:return o[t].value*(1-r)+o[e].value*r;case ot.FloatArray:for(var c=this._currentValue,l=o[t].value,u=o[e].value,h=0,f=l.length;h<f;h++)c[h]=l[h]*(1-r)+u[h]*r;return c;case ot.Vector2:return H.lerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue;case ot.Vector3:return w.lerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue;case ot.Quaternion:return Se.slerp(o[t].value,o[e].value,r,this._currentValue),this._currentValue}},s._evaluateStep=function(t){var e=this._valueSize,r=this.keys;return r[t].value},s._evaluateHermite=function(t,e,r,n){var o=this._valueSize,c=this.keys,l=c[t],u=c[e];switch(o){case 1:{var h=l.outTangent,f=u.inTangent,d=l.value,_=u.value;if(Number.isFinite(h)&&Number.isFinite(f)){var p=r*r,v=p*r,g=2*v-3*p+1,m=v-2*p+r,y=v-p,A=-2*v+3*p;return g*d+m*h*n+y*f*n+A*_}else return l.value}case 2:{var S=l.value,C=l.outTangent,P=u.value,R=u.inTangent,T=r*r,E=T*r,D=2*E-3*T+1,B=E-2*T+r,O=E-T,G=-2*E+3*T,L=C.x,W=R.x;return Number.isFinite(L)&&Number.isFinite(W)?this._currentValue.x=D*S.x+B*L*n+O*W*n+G*P.x:this._currentValue.x=S.x,L=C.y,W=R.y,Number.isFinite(L)&&Number.isFinite(W)?this._currentValue.y=D*S.y+B*L*n+O*W*n+G*P.y:this._currentValue.y=S.y,this._currentValue}case 3:{var K=l.value,Y=l.outTangent,U=u.value,j=u.inTangent,oe=r*r,te=oe*r,fe=2*te-3*oe+1,me=te-2*oe+r,de=te-oe,ye=-2*te+3*oe,ge=Y.x,Re=j.x;return Number.isFinite(ge)&&Number.isFinite(Re)?this._currentValue.x=fe*K.x+me*ge*n+de*Re*n+ye*U.x:this._currentValue.x=K.x,ge=Y.y,Re=j.y,Number.isFinite(ge)&&Number.isFinite(Re)?this._currentValue.y=fe*K.y+me*ge*n+de*Re*n+ye*U.y:this._currentValue.y=K.y,ge=Y.z,Re=j.z,Number.isFinite(ge)&&Number.isFinite(Re)?this._currentValue.z=fe*K.z+me*ge*n+de*Re*n+ye*U.z:this._currentValue.z=K.z,this._currentValue}case 4:{var Ae=l.value,Pe=l.outTangent,Ye=u.value,Le=u.inTangent,x=r*r,M=x*r,b=2*M-3*x+1,I=M-2*x+r,q=M-x,X=-2*M+3*x,re=Pe.x,se=Le.x;return Number.isFinite(re)&&Number.isFinite(se)?this._currentValue.x=b*Ae.x+I*re*n+q*se*n+X*Ye.x:this._currentValue.x=Ae.x,re=Pe.y,se=Le.y,Number.isFinite(re)&&Number.isFinite(se)?this._currentValue.y=b*Ae.y+I*re*n+q*se*n+X*Ye.y:this._currentValue.y=Ae.y,re=Pe.z,se=Le.z,Number.isFinite(re)&&Number.isFinite(se)?this._currentValue.z=b*Ae.z+I*re*n+q*se*n+X*Ye.z:this._currentValue.z=Ae.z,re=Pe.w,se=Le.w,Number.isFinite(re)&&Number.isFinite(se)?this._currentValue.w=b*Ae.w+I*re*n+q*se*n+X*Ye.w:this._currentValue.w=Ae.w,this._currentValue}}},Z(i,[{key:"length",get:function(){return this._length}}]),i}(),Th=function(){this.time=void 0,this.value=void 0},ii=function(i){ee(s,i);function s(){for(var a,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return a=i.call.apply(i,[this].concat(e))||this,a.inTangent=void 0,a.outTangent=void 0,a}return s}(Th),jo;(function(i){i[i.If=0]="If",i[i.IfNot=1]="IfNot",i[i.Greater=2]="Greater",i[i.Less=3]="Less",i[i.Equals=4]="Equals",i[i.NotEquals=5]="NotEquals"})(jo||(jo={}));var xc=function(i){ee(s,i);function s(a){var t;return t=i.call(this,a,z.find("skybox"))||this,t._decodeParam=new ze(0,5,0,0),t.renderState.rasterState.cullMode=dt.Off,t.renderState.depthState.compareFunction=Me.LessEqual,t.shaderData.setVector4("u_cubeDecodeParam",t._decodeParam),t}return Z(s,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(t){this._decodeParam.x=Number(t)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(t){this._decodeParam.y=t}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(t){this.shaderData.setTexture("u_cube",t)}}]),s}(Qt),ve;(function(i){i[i.Position=1]="Position",i[i.Velocity=2]="Velocity",i[i.Acceleration=4]="Acceleration",i[i.Color=8]="Color",i[i.Alpha=16]="Alpha",i[i.Size=32]="Size",i[i.StartAngle=64]="StartAngle",i[i.StartTime=128]="StartTime",i[i.LifeTime=256]="LifeTime",i[i.RotateVelocity=512]="RotateVelocity",i[i.Scale=1024]="Scale",i[i.Everything=4294967295]="Everything"})(ve||(ve={}));var hi;(function(i){i[i.Transparent=0]="Transparent",i[i.Additive=1]="Additive"})(hi||(hi={}));var bc=function(i){ee(s,i),s._getRandom=function(){return Math.random()-.5};function s(t){var e;return e=i.call(this,t)||this,e._vertexStride=void 0,e._vertices=void 0,e._vertexBuffer=void 0,e._maxCount=1e3,e._position=new w,e._positionRandomness=new w,e._positionArray=void 0,e._velocity=new w,e._velocityRandomness=new w,e._acceleration=new w,e._accelerationRandomness=new w,e._color=new ne(1,1,1,1),e._colorRandomness=0,e._size=1,e._sizeRandomness=0,e._alpha=1,e._alphaRandomness=0,e._startAngle=0,e._startAngleRandomness=0,e._rotateVelocity=0,e._rotateVelocityRandomness=0,e._lifetime=5,e._startTimeRandomness=0,e._scale=1,e._isOnce=!1,e._onceTime=0,e._time=0,e._isInit=!1,e._isStart=!1,e._updateDirtyFlag=ve.Everything,e._isRotateToVelocity=!1,e._isUseOriginColor=!1,e._isScaleByLifetime=!1,e._is2d=!0,e._isFadeIn=!1,e._isFadeOut=!1,e._playOnEnable=!0,e._blendMode=hi.Transparent,e.spriteSheet=void 0,e.setMaterial(e._createMaterial()),e}var a=s.prototype;return a.update=function(e){if(!(!this._isInit||!this._isStart)){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},a._onEnable=function(){i.prototype._onEnable.call(this),this._playOnEnable&&this.start()},a.start=function(){this._isStart=!0,this._time=0},a.stop=function(){this._isStart=!1},a._createMaterial=function(){var e=new Qt(this.engine,z.find("particle-shader")),r=e.renderState,n=r.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=ue.SourceAlpha,n.destinationColorBlendFactor=ue.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=ue.One,n.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,e.renderQueueType=We.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},a._createMesh=function(){var e=new _c(this._entity.engine,"particleMesh"),r=96,n=this._maxCount*4,o=n*r,c=new Float32Array(o),l=null,u=!1;if(n>s._uint16VertexLimit)if(this.engine._hardwareRenderer.canIUse(Q.elementIndexUint))u=!0,l=new Uint32Array(6*this._maxCount);else throw Error("The vertex count is over limit.");else l=new Uint16Array(6*this._maxCount);for(var h=0,f=0;h<this._maxCount;++h){var d=h*4;l[f++]=d,l[f++]=d+1,l[f++]=d+2,l[f++]=d,l[f++]=d+2,l[f++]=d+3}var _=[new we("a_position",0,$.Vector3,0),new we("a_velocity",12,$.Vector3,0),new we("a_acceleration",24,$.Vector3,0),new we("a_color",36,$.Vector4,0),new we("a_lifeAndSize",52,$.Vector4,0),new we("a_rotation",68,$.Vector2,0),new we("a_uv",76,$.Vector3,0),new we("a_normalizedUv",88,$.Vector2,0)],p=new qr(this.engine,$t.VertexBuffer,o*4,_t.Dynamic),v=new qr(this.engine,$t.IndexBuffer,l,_t.Dynamic);return e.setVertexBufferBinding(p,r),e.setIndexBufferBinding(v,u?Xe.UInt32:Xe.UInt16),e.setVertexElements(_),e.addSubMesh(0,l.length),this._vertexBuffer=p,this._vertexStride=r/4,this._vertices=c,e},a._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},a._updateSingleBuffer=function(e){var r=this._updateDirtyFlag,n=this._vertices,o=this._vertexStride,c=s._getRandom,l=e*4,u=l*o,h=(l+1)*o,f=(l+2)*o,d=(l+3)*o;if(r&ve.Position){var _=this._position,p=_.x,v=_.y,g=_.z,m=this._positionArray,y=this._positionRandomness;if(m){if(m.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var A=m[e];p+=A.x,v+=A.y,g+=A.z}else p+=c()*y.x,v+=c()*y.y,g+=c()*y.z;n[u]=n[h]=n[f]=n[d]=p,n[u+1]=n[h+1]=n[f+1]=n[d+1]=v,n[u+2]=n[h+2]=n[f+2]=n[d+2]=g}if(r&ve.Velocity){var S=this._velocity,C=this._velocityRandomness;n[u+3]=n[h+3]=n[f+3]=n[d+3]=S.x+c()*C.x,n[u+4]=n[h+4]=n[f+4]=n[d+4]=S.y+c()*C.y,n[u+5]=n[h+5]=n[f+5]=n[d+5]=S.z+c()*C.z}if(r&ve.Acceleration){var P=this._acceleration,R=this._accelerationRandomness;n[u+6]=n[h+6]=n[f+6]=n[d+6]=P.x+c()*R.x,n[u+7]=n[h+7]=n[f+7]=n[d+7]=P.y+c()*R.y,n[u+8]=n[h+8]=n[f+8]=n[d+8]=P.z+c()*R.z}if(r&ve.Color){var T=this._color,E=this._colorRandomness;n[u+9]=n[h+9]=n[f+9]=n[d+9]=N.clamp(T.r+c()*E,0,1),n[u+10]=n[h+10]=n[f+10]=n[d+10]=N.clamp(T.g+c()*E,0,1),n[u+11]=n[h+11]=n[f+11]=n[d+11]=N.clamp(T.b+c()*E,0,1)}if(r&ve.Alpha&&(n[u+12]=n[h+12]=n[f+12]=n[d+12]=N.clamp(this._alpha+c()*this._alphaRandomness,0,1)),r&ve.StartTime&&(n[u+13]=n[h+13]=n[f+13]=n[d+13]=Math.random()*this._startTimeRandomness),r&ve.LifeTime){var D=this._lifetime;n[u+14]=n[h+14]=n[f+14]=n[d+14]=D+c()*D}if((r&ve.StartTime||r&ve.LifeTime)&&(this._onceTime=Math.max(this._onceTime,n[u+13]+n[u+14])),r&ve.Size){var B=this._size;n[u+15]=n[h+15]=n[f+15]=n[d+15]=Math.max(B+c()*this._sizeRandomness*B*2,0)}r&ve.Scale&&(n[u+16]=n[h+16]=n[f+16]=n[d+16]=this._scale),r&ve.StartAngle&&(n[u+17]=n[h+17]=n[f+17]=n[d+17]=this._startAngle+c()*Math.PI*this._startAngleRandomness*2),r&ve.RotateVelocity&&(n[u+18]=n[h+18]=n[f+18]=n[d+18]=this._rotateVelocity+c()*this._rotateVelocityRandomness),this._updateSingleUv(e,u,h,f,d)},a._updateSingleUv=function(e,r,n,o,c){var l=this.spriteSheet,u=this.getMaterial().shaderData.getTexture("u_texture"),h=this._vertices;if(u){var f=u.width,d=u.height;if(l){var _=l[e%l.length],p=_.x,v=_.y,g=_.w,m=_.h,y=p/f,A=v/d,S=y+g/f,C=A+m/d,P=m/g;h[r+19]=y,h[r+20]=C,h[r+21]=P,h[n+19]=S,h[n+20]=C,h[n+21]=P,h[o+19]=S,h[o+20]=A,h[o+21]=P,h[c+19]=y,h[c+20]=A,h[c+21]=P}else{var R=d/f;h[r+19]=0,h[r+20]=1,h[r+21]=R,h[n+19]=1,h[n+20]=1,h[n+21]=R,h[o+19]=1,h[o+20]=0,h[o+21]=R,h[c+19]=0,h[c+20]=0,h[c+21]=R}}else h[r+19]=0,h[r+20]=0,h[r+21]=1,h[n+19]=1,h[n+20]=0,h[n+21]=1,h[o+19]=1,h[o+20]=1,h[o+21]=1,h[c+19]=0,h[c+20]=1,h[c+21]=1;h[r+22]=-.5,h[r+23]=-.5,h[n+22]=.5,h[n+23]=-.5,h[o+22]=.5,h[o+23]=.5,h[c+22]=-.5,h[c+23]=.5},Z(s,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=ve.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=ve.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=ve.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=ve.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=ve.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=ve.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=ve.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=ve.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=ve.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=ve.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=ve.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=ve.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=ve.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=ve.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=ve.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=ve.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=ve.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=ve.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=ve.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=ve.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=ve.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=dt.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var r=this.getMaterial().renderState.blendState,n=r.targetBlendState;e===hi.Transparent?(n.enabled=!0,n.sourceColorBlendFactor=ue.SourceAlpha,n.destinationColorBlendFactor=ue.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=ue.One,n.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha):e===hi.Additive&&(n.enabled=!0,n.sourceColorBlendFactor=ue.SourceAlpha,n.destinationColorBlendFactor=ue.One,n.sourceAlphaBlendFactor=ue.One,n.destinationAlphaBlendFactor=ue.OneMinusSourceAlpha),this._blendMode=e}}]),s}(Zr);bc._uint16VertexLimit=65535;var Ch=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,Rh=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;z.create("trail",Rh,Ch);new w;z.getPropertyByName("u_fogColor");z.getPropertyByName("u_fogDensity");z.getPropertyByName("u_fogNear");z.getPropertyByName("u_fogFar");new w;new w;new w;var Ge=function(){i._updateShaderData=function(t){var e=i._combinedData;t.setFloatArray(i._viewMatFromLightProperty,e.viewMatrix),t.setFloatArray(i._projMatFromLightProperty,e.projectionMatrix),t.setFloatArray(i._shadowBiasProperty,e.bias),t.setFloatArray(i._shadowIntensityProperty,e.intensity),t.setFloatArray(i._shadowRadiusProperty,e.radius),t.setFloatArray(i._shadowMapSizeProperty,e.mapSize),t.setTextureArray(i._shadowMapsProperty,e.map)},i.clearMap=function(){i._combinedData.map.length=0};function i(a,t){t===void 0&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new ie,this.light=a;var e=t,r=e.engine,n=e.width,o=e.height;this._mapSize=new H(n,o),this._renderTarget=new fc(r,n,o,new dc(r,n,o))}var s=i.prototype;return s.initShadowProjectionMatrix=function(t){if(t instanceof Ut&&ie.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),t instanceof Zt&&ie.perspective(N.degreeToRadian(50),1,.5,50,this.projectionMatrix),t instanceof vt){var e=Math.min(Math.PI/2,t.angle*2*Math.sqrt(2));ie.perspective(e,1,.1,t.distance+5,this.projectionMatrix)}},s.appendData=function(t){var e=t*16,r=t*16,n=t,o=t,c=t,l=t*2,u=t,h=i._combinedData;h.viewMatrix.set(this.light.viewMatrix.elements,e),h.projectionMatrix.set(this.projectionMatrix.elements,r),h.bias[n]=this.bias,h.intensity[o]=this.intensity,h.radius[c]=this.radius,h.mapSize[l]=this.mapSize.x,h.mapSize[l+1]=this.mapSize.y,h.map[u]=this.map},Z(i,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),i}();Ge._viewMatFromLightProperty=z.getPropertyByName("u_viewMatFromLight");Ge._projMatFromLightProperty=z.getPropertyByName("u_projMatFromLight");Ge._shadowBiasProperty=z.getPropertyByName("u_shadowBias");Ge._shadowIntensityProperty=z.getPropertyByName("u_shadowIntensity");Ge._shadowRadiusProperty=z.getPropertyByName("u_shadowRadius");Ge._shadowMapSizeProperty=z.getPropertyByName("u_shadowMapSize");Ge._shadowMapsProperty=z.getPropertyByName("u_shadowMaps");Ge._maxLight=3;Ge._combinedData={viewMatrix:new Float32Array(16*Ge._maxLight),projectionMatrix:new Float32Array(16*Ge._maxLight),bias:new Float32Array(Ge._maxLight),intensity:new Float32Array(Ge._maxLight),radius:new Float32Array(Ge._maxLight),mapSize:new Float32Array(2*Ge._maxLight),map:[]};Object.defineProperty(qe.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(s){if(this._enableShadow=s,this._enableShadow){if(this instanceof lt){this._enableShadow=!1;return}this.shadow=this.shadow||new Ge(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}});Object.defineProperty(Mt.prototype,"receiveShadow",{get:function(){return this._recieveShadow},set:function(s){this._recieveShadow=s}});Object.defineProperty(Mt.prototype,"castShadow",{get:function(){return this._castShadow},set:function(s){this._castShadow=s}});var Eh=function(i){ee(s,i);function s(a){var t;return t=i.call(this,a,z.find("shadow-map"))||this,t.shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),t}return s}(Qt),Dn=function(i){ee(s,i);function s(t,e,r,n,o,c){var l;return l=i.call(this,t,e,r,n,o)||this,l.light=void 0,l.light=c,l.clearColor=new ne(1,1,1,1),l}var a=s.prototype;return a.preRender=function(e,r){var n=this.replaceMaterial.shaderData;n.setMatrix(s._viewMatFromLightProperty,this.light.viewMatrix),n.setMatrix(s._projMatFromLightProperty,this.light.shadow.projectionMatrix)},s}(wr);Dn._viewMatFromLightProperty=z.getPropertyByName("u_viewMatFromLight");Dn._projMatFromLightProperty=z.getPropertyByName("u_projMatFromLight");var zh=function(i){ee(s,i);function s(a){var t;t=i.call(this,a,z.find("shadow"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=ue.DestinationColor,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=ue.Zero,t.renderState.depthState.compareFunction=Me.LessEqual,t.renderQueueType=We.Transparent,t}return s}(Qt),Bh=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.clearFlags=hr.None,t}var a=s.prototype;return a.preRender=function(e,r){this.enabled=!1;var n=e.scene.findFeature(Er),o=n.visibleLights,c=this.replaceMaterial.shaderData,l=e._renderPipeline.defaultRenderPass;this.renderTarget=l.renderTarget;var u=0;Ge.clearMap();for(var h=0,f=o.length;h<f;h++){var d=o[h];d.enableShadow&&d.shadow.appendData(u++)}u?(this.enabled=!0,Ge._updateShaderData(c),c.enableMacro("O3_SHADOW_MAP_COUNT",u.toString())):c.disableMacro("O3_SHADOW_MAP_COUNT")},s}(wr),Dh=function(i){ee(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t._shadowPass=void 0,t._shadowMapMaterial=void 0,t}var a=s.prototype;return a.preRender=function(e,r){var n=e.findFeature(Er).visibleLights;if(n.length>0){this._shadowPass||this.addShadowPass(r);for(var o=r._renderPipeline,c=0,l=n.length;c<l;c++){var u=n[c];u.enableShadow&&!u.shadowMapPass?u.shadowMapPass=this.addShadowMapPass(r,u):!u.enableShadow&&u.shadowMapPass&&(o.removeRenderPass(u.shadowMapPass),u.shadowMapPass=null)}this.updatePassRenderFlag(o._opaqueQueue),this.updatePassRenderFlag(o._alphaTestQueue),this.updatePassRenderFlag(o._transparentQueue)}},a.addShadowPass=function(e){var r=new zh(e.engine);this._shadowPass=new Bh("ShadowPass",1,null,r,ht.Layer30);var n=e._renderPipeline;n.addRenderPass(this._shadowPass)},a.addShadowMapPass=function(e,r){this._shadowMapMaterial=this._shadowMapMaterial||new Eh(e.engine);var n=new Dn("ShadowMapPass",-1,r.shadow.renderTarget,this._shadowMapMaterial,ht.Layer31,r),o=e._renderPipeline;return o.addRenderPass(n),n},a.updatePassRenderFlag=function(e){for(var r=e.items,n=0,o=r.length;n<o;n++){var c=r[n],l=c.component,u=l.recieveShadow,h=l.castShadow;u===!0?l.entity.layer|=ht.Layer30:u===!1&&(l.entity.layer&=~ht.Layer30),h===!0?l.entity.layer|=ht.Layer31:h===!1&&(l.entity.layer&=~ht.Layer31)}},s}(vc);Tr.registerFeature(Dh);Tr.registerFeature(Er);Tr.prototype.hasLight=Iu;var ce;(function(i){i[i.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",i[i.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",i[i.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",i[i.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",i[i.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",i[i.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",i[i.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",i[i.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",i[i.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",i[i.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",i[i.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",i[i.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",i[i.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",i[i.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",i[i.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",i[i.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",i[i.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",i[i.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",i[i.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",i[i.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",i[i.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",i[i.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",i[i.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",i[i.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",i[i.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",i[i.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",i[i.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",i[i.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",i[i.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",i[i.R11_EAC=37488]="R11_EAC",i[i.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",i[i.RG11_EAC=37490]="RG11_EAC",i[i.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",i[i.RGB8_ETC2=37492]="RGB8_ETC2",i[i.SRGB8_ETC2=37493]="SRGB8_ETC2",i[i.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",i[i.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",i[i.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",i[i.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",i[i.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",i[i.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",i[i.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",i[i.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",i[i.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",i[i.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT"})(ce||(ce={}));function Ko(i,s){var a=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);s&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),a.push.apply(a,t)}return a}function Oh(i){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?Ko(Object(a),!0).forEach(function(t){Fh(i,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):Ko(Object(a)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(a,t))})}return i}function qo(i,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Si(i,s,a){return s&&qo(i.prototype,s),a&&qo(i,a),i}function Fh(i,s,a){return s in i?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,i}function Pi(i,s){i.prototype=Object.create(s.prototype),i.prototype.constructor=i,xn(i,s)}function xn(i,s){return xn=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},xn(i,s)}var Ih=function(){var i=s.prototype;i.resizeByClientSize=function(t){t===void 0&&(t=window.devicePixelRatio);var e=this._webCanvas;e instanceof HTMLCanvasElement&&(this.width=e.clientWidth*t,this.height=e.clientHeight*t)};function s(a){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new H;var t=a.width,e=a.height;this._webCanvas=a,this._width=t,this._height=e}return i.setScale=function(t,e){this._scale.setValue(t,e),this.scale=this._scale},Si(s,[{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._webCanvas.width=t,this._width=t)}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._webCanvas.height=t,this._height=t)}},{key:"scale",get:function(){var t=this._webCanvas;return t instanceof HTMLCanvasElement&&this._scale.setValue(t.clientWidth*devicePixelRatio/t.width,t.clientHeight*devicePixelRatio/t.height),this._scale},set:function(t){var e=this._webCanvas;e instanceof HTMLCanvasElement&&(e.style.transformOrigin="left top",e.style.transform="scale("+t.x+", "+t.y+")")}}]),s}(),Lh=function(){function i(a){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=a,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var s=i.prototype;return s.canIUse=function(t){return this.capabilityList.get(t)},s.canIUseCompressedTextureInternalFormat=function(t){var e=ce.RGBA_ASTC_4X4_KHR,r=ce.RGBA_ASTC_12X12_KHR,n=ce.SRGB8_ALPHA8_ASTC_4X4_KHR,o=ce.SRGB8_ALPHA8_ASTC_12X12_KHR,c=ce.RGB_ETC1_WEBGL,l=ce.R11_EAC,u=ce.SRGB8_ALPHA8_ETC2_EAC,h=ce.RGB_PVRTC_4BPPV1_IMG,f=ce.RGBA_PVRTC_2BPPV1_IMG,d=ce.RGB_S3TC_DXT1_EXT,_=ce.RGBA_S3TC_DXT5_EXT;return t>=e&&r<=r||t>=n&&t<=o?this.canIUse(Q.astc):t===c?this.canIUse(Q.etc1):t>=l&&t<=u?this.canIUse(Q.etc):t>=h&&t<=f?this.canIUse(Q.pvrtc):t>=d&&t<=_?this.canIUse(Q.s3tc):!1},s._init=function(){var t=this.capabilityList,e=this.rhi.isWebGL2,r=this.rhi.requireExtension.bind(this.rhi),n=Q.shaderVertexID,o=Q.standardDerivatives,c=Q.shaderTextureLod,l=Q.elementIndexUint,u=Q.depthTexture,h=Q.vertexArrayObject,f=Q.instancedArrays,d=Q.multipleSample,_=Q.drawBuffers,p=Q.astc,v=Q.astc_webkit,g=Q.etc,m=Q.etc_webkit,y=Q.etc1,A=Q.etc1_webkit,S=Q.pvrtc,C=Q.pvrtc_webkit,P=Q.s3tc,R=Q.s3tc_webkit,T=Q.textureFloat,E=Q.textureHalfFloat,D=Q.textureFloatLinear,B=Q.textureHalfFloatLinear,O=Q.WEBGL_colorBufferFloat,G=Q.colorBufferFloat,L=Q.colorBufferHalfFloat,W=Q.textureFilterAnisotropic;t.set(n,e),t.set(o,e||!!r(o)),t.set(c,e||!!r(c)),t.set(l,e||!!r(l)),t.set(u,e||!!r(u)),t.set(h,e||!!r(h)),t.set(f,e||!!r(f)),t.set(d,e),t.set(_,e||!!r(_)),t.set(T,e||!!r(T)),t.set(E,e||!!r(E)),t.set(D,!!r(D)),t.set(B,e||!!r(B)),t.set(G,e&&!!r(G)||!!r(O)),t.set(L,e&&!!r(G)||!!r(L)),t.set(W,!!r(W)),t.set(p,!!(r(p)||r(v))),t.set(g,!!(r(g)||r(m))),t.set(y,!!(r(y)||r(A))),t.set(S,!!(r(S)||r(C))),t.set(P,!!(r(P)||r(R)))},s._compatibleInterface=function(t,e){var r=this.rhi,n=r.gl,o=null;if(o=r.requireExtension(t))for(var c in e){var l=e[c],u=o[l];u!=null&&u.bind?n[c]=u.bind(o):n[c]=u}},s._compatibleAllInterface=function(){var t=Q.depthTexture,e=Q.vertexArrayObject,r=Q.instancedArrays,n=Q.drawBuffers,o=Q.textureFilterAnisotropic,c=Q.textureHalfFloat,l=Q.colorBufferHalfFloat,u=Q.WEBGL_colorBufferFloat,h=this.rhi.isWebGL2;if(!h){this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(e,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(r,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(n,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var f={};if(this.canIUse(Q.drawBuffers)){for(var d=this.maxDrawBuffers,_=0;_<d;_++)_!=0&&(f["COLOR_ATTACHMENT"+_]="COLOR_ATTACHMENT"+_+"_WEBGL"),f["DRAW_BUFFER"+_]="DRAW_BUFFER"+_+"_WEBGL";this._compatibleInterface(n,Oh({drawBuffers:"drawBuffersWEBGL"},f))}this._compatibleInterface(c,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(l,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(u,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(o,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},Si(i,[{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(Q.shaderVertexID)&&this.canIUse(Q.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(Q.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(Q.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(Q.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,e=this.canIUse(Q.multipleSample);this._maxAntiAliasing=e?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),i}(),Uh=function(){function i(a){this.rhi=void 0,this._requireResult=void 0,this.rhi=a,this._requireResult={}}var s=i.prototype;return s.requireExtension=function(t){return this._requireResult[t]!==void 0?this._requireResult[t]:(this._requireResult[t]=this.rhi.gl.getExtension(t),this._requireResult[t])},i}(),Nh=function(){function i(a,t){this.attribLocArray=void 0,this._primitive=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=t,this.canUseInstancedArrays=a.canIUse(Q.instancedArrays),this._useVao=a.canIUse(Q.vertexArrayObject),this.gl=a.gl}var s=i.prototype;return s.draw=function(t,e){var r=this.gl,n=this._primitive;if(this._useVao){this.vao.has(t.id)||this.registerVAO(t);var o=this.vao.get(t.id);r.bindVertexArray(o)}else this.bindBufferAndAttrib(t);var c=n._indexBufferBinding,l=n._instanceCount,u=n._glIndexType,h=n._glIndexByteCount,f=e.topology,d=e.start,_=e.count;if(l){if(this.canUseInstancedArrays)if(c)if(this._useVao)r.drawElementsInstanced(f,_,u,d*h,l);else{var v=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,v),r.drawElementsInstanced(f,_,u,d*h,l),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(f,d,_,l)}else if(c)if(this._useVao)r.drawElements(f,_,u,d*h);else{var p=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.drawElements(f,_,u,d*h),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(f,d,_);this._useVao?r.bindVertexArray(null):this.disableAttrib()},s.destroy=function(){if(this._useVao){var t=this.gl;this.vao.forEach(function(e){t.deleteVertexArray(e)}),this.vao.clear()}},s.bindBufferAndAttrib=function(t){var e=this.gl,r=this._primitive,n=r._vertexBufferBindings;this.attribLocArray=[];var o=t.attributeLocation,c=r._vertexElementMap,l,u;for(var h in o){var f=o[h];if(f!==-1){var d=c[h];if(d){var _=n[d.bindingIndex],p=_.buffer,v=_.stride;l=p._nativeBuffer,u!==l&&(u=l,e.bindBuffer(e.ARRAY_BUFFER,l)),e.enableVertexAttribArray(f);var g=d._glElementInfo,m=g.size,y=g.type,A=g.normalized;e.vertexAttribPointer(f,m,y,A,v,d.offset),this.canUseInstancedArrays&&e.vertexAttribDivisor(f,d.instanceStepRate),this.attribLocArray.push(f)}}}e.bindBuffer(e.ARRAY_BUFFER,null)},s.disableAttrib=function(){for(var t=this.gl,e=0,r=this.attribLocArray.length;e<r;e++)t.disableVertexAttribArray(this.attribLocArray[e])},s.registerVAO=function(t){var e=this.gl,r=e.createVertexArray();e.bindVertexArray(r);var n=this._primitive._indexBufferBinding;n&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.buffer._nativeBuffer),this.bindBufferAndAttrib(t),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(t.id,r)},i}(),Ce=function(){i._isPowerOf2=function(t){return(t&t-1)===0},i._getFormatDetail=function(t,e,r){switch(t){case ae.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ae.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ae.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case ae.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case ae.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case ae.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ae.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ae.R32G32B32A32:return{internalFormat:e.RGBA32F,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case ae.DXT1:return{internalFormat:ce.RGB_S3TC_DXT1_EXT,isCompressed:!0};case ae.DXT5:return{internalFormat:ce.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case ae.ETC1_RGB:return{internalFormat:ce.RGB_ETC1_WEBGL,isCompressed:!0};case ae.ETC2_RGB:return{internalFormat:ce.RGB8_ETC2,isCompressed:!0};case ae.ETC2_RGBA5:return{internalFormat:ce.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case ae.ETC2_RGBA8:return{internalFormat:ce.RGBA8_ETC2_EAC,isCompressed:!0};case ae.PVRTC_RGB2:return{internalFormat:ce.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case ae.PVRTC_RGBA2:return{internalFormat:ce.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case ae.PVRTC_RGB4:return{internalFormat:ce.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case ae.PVRTC_RGBA4:return{internalFormat:ce.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case ae.ASTC_4x4:return{internalFormat:ce.RGBA_ASTC_4X4_KHR,isCompressed:!0};case ae.ASTC_5x5:return{internalFormat:ce.RGBA_ASTC_5X5_KHR,isCompressed:!0};case ae.ASTC_6x6:return{internalFormat:ce.RGBA_ASTC_6X6_KHR,isCompressed:!0};case ae.ASTC_8x8:return{internalFormat:ce.RGBA_ASTC_8X8_KHR,isCompressed:!0};case ae.ASTC_10x10:return{internalFormat:ce.RGBA_ASTC_10X10_KHR,isCompressed:!0};case ae.ASTC_12x12:return{internalFormat:ce.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},i._getRenderBufferColorFormatDetail=function(t,e,r){switch(t){case rt.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case rt.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case rt.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case rt.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case rt.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case rt.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case rt.R16G16B16A16:return{internalFormat:e.RGBA16F,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case rt.R32G32B32A32:return{internalFormat:e.RGBA32F,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};default:throw new Error("this RenderBufferColorFormat is not supported in Oasis Engine: "+t)}},i._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case ke.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ke.DepthStencil:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case ke.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case ke.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ke.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ke.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ke.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case ke.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this RenderBufferDepthFormat is not supported in Oasis Engine: "+t)}},i._supportTextureFormat=function(t,e){var r=!0;switch(t){case ae.R32G32B32A32:e.canIUse(Q.textureFloat)||(r=!1);break}return r},i._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case rt.R32G32B32A32:(!e.canIUse(Q.colorBufferFloat)||!e.canIUse(Q.textureFloat))&&(r=!1);break;case rt.R16G16B16A16:(!e.canIUse(Q.colorBufferHalfFloat)||!e.canIUse(Q.textureHalfFloat))&&(r=!1);break}return r},i._supportRenderBufferDepthFormat=function(t,e,r){var n=e.isWebGL2,o=!0;if(r&&!e.canIUse(Q.depthTexture))return!1;switch(t){case ke.Stencil:o=!1;break;case ke.Depth24:case ke.Depth32:case ke.Depth32Stencil8:n||(o=!1);break}return o};function i(a,t,e){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=a,this._gl=a.gl,this._isWebGL2=a.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var s=i.prototype;return s.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},s.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},s._bind=function(){this._rhi.bindTexture(this)},s._initMipmap=function(t){var e=this._gl,r=this._isWebGL2,n=this._formatDetail,o=n.internalFormat,c=n.baseFormat,l=n.dataType,u=this._texture,h=u.mipmapCount,f=u.width,d=u.height;if(this._bind(),r&&!(c===e.LUMINANCE_ALPHA||c===e.ALPHA))e.texStorage2D(this._target,h,o,f,d);else if(c!==o&&(o=c),t)for(var g=0;g<h;g++)for(var m=Math.max(1,f>>g),y=0;y<6;y++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+y,g,o,m,m,0,c,l,null);else for(var _=0;_<h;_++){var p=Math.max(1,f>>_),v=Math.max(1,d>>_);e.texImage2D(this._target,_,o,p,v,0,c,l,null)}},s._getPixelBuffer=function(t,e,r,n,o,c,l){var u=this._gl,h=this._formatDetail,f=h.baseFormat,d=h.dataType;i._readFrameBuffer||(i._readFrameBuffer=u.createFramebuffer()),u.bindFramebuffer(u.FRAMEBUFFER,i._readFrameBuffer),c>0&&!this._isWebGL2&&(c=0),t!=null?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,c):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,this._glTexture,c),u.readPixels(e,r,n,o,f,d,l),u.bindFramebuffer(u.FRAMEBUFFER,null)},s._setWrapMode=function(t,e){var r=this._gl,n=this._isWebGL2,o=this._target,c=this._texture,l=c.width,u=c.height;switch(!n&&t!==nt.Clamp&&(!i._isPowerOf2(l)||!i._isPowerOf2(u))&&(t=nt.Clamp),t){case nt.Clamp:r.texParameteri(o,e,r.CLAMP_TO_EDGE);break;case nt.Repeat:r.texParameteri(o,e,r.REPEAT);break;case nt.Mirror:r.texParameteri(o,e,r.MIRRORED_REPEAT);break}},Si(i,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,n=this._texture._mipmap;switch(this._bind(),t){case bt.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,n?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case bt.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,n?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case bt.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,n?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}}]),i}();Ce._readFrameBuffer=null;var Vh=function(i){Pi(s,i);function s(t,e){var r;r=i.call(this,t,e,e.isCube?t.gl.TEXTURE_CUBE_MAP:t.gl.TEXTURE_2D)||this;var n=e.format,o=e._mipmap,c=e.width,l=e.height,u=e.isCube,h=r._isWebGL2;if(!Ce._supportRenderBufferColorFormat(n,t))throw new Error("RenderBufferColorFormat is not supported:"+rt[n]);if(u&&c!==l)throw new Error("The cube texture must have the same width and height");return o&&!h&&(!Ce._isPowerOf2(c)||!Ce._isPowerOf2(l))&&(e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Ce._getRenderBufferColorFormatDetail(n,r._gl,h),r._initMipmap(u),r}var a=s.prototype;return a.getPixelBuffer=function(e,r,n,o,c,l,u){i.prototype._getPixelBuffer.call(this,e,r,n,o,c,l,u)},s}(Ce),kh=function(i){Pi(s,i);function s(a,t){var e;e=i.call(this,a,t,t.isCube?a.gl.TEXTURE_CUBE_MAP:a.gl.TEXTURE_2D)||this;var r=t.format,n=t._mipmap,o=t.width,c=t.height,l=t.isCube,u=e._isWebGL2;if(!Ce._supportRenderBufferDepthFormat(r,a,!0))throw new Error("RenderBufferDepthFormat is not supported:"+ke[r]);if(l&&o!==c)throw new Error("The cube texture must have the same width and height");return n&&!u&&(!Ce._isPowerOf2(o)||!Ce._isPowerOf2(c))&&(t._mipmap=!1,t._mipmapCount=t._getMipmapCount()),e._formatDetail=Ce._getRenderBufferDepthFormatDetail(r,e._gl,u),e._initMipmap(l),e}return s}(Ce),Gh=function(){function i(a){this._gl=void 0,this._parameters={},this._gl=a,this._parameters={},this._parameters[a.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[a.MAX_VERTEX_UNIFORM_VECTORS]=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[a.MAX_VERTEX_ATTRIBS]=a.getParameter(a.MAX_VERTEX_ATTRIBS),this._parameters[a.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[a.MAX_TEXTURE_SIZE]=a.getParameter(a.MAX_TEXTURE_SIZE),a.blendFuncSeparate(a.ONE,a.ZERO,a.ONE,a.ZERO),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.colorMask(!0,!0,!0,!0),a.blendColor(0,0,0,0),a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!0),a.disable(a.STENCIL_TEST),a.stencilFuncSeparate(a.FRONT,a.ALWAYS,0,255),a.stencilFuncSeparate(a.BACK,a.ALWAYS,0,255),a.stencilOpSeparate(a.FRONT,a.KEEP,a.KEEP,a.KEEP),a.stencilOpSeparate(a.BACK,a.KEEP,a.KEEP,a.KEEP),a.stencilMask(255),a.enable(a.CULL_FACE),a.cullFace(a.BACK),a.disable(a.POLYGON_OFFSET_FILL),a.polygonOffset(0,0)}var s=i.prototype;return s.getParameter=function(t){return this._parameters[t]},i}(),Hh=function(){function i(a,t){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._curMipLevel=0,this._gl=a.gl,this._isWebGL2=a.isWebGL2,this._target=t;var e=t._colorTextures,r=t._depth,n=t.width,o=t.height;if(!(r instanceof si)&&!Ce._supportRenderBufferDepthFormat(r,a,!1))throw new Error("RenderBufferDepthFormat is not supported:"+ke[r]);if(e.length>1&&!a.canIUse(Q.drawBuffers))throw new Error("MRT is not supported");if(e.some(function(l){return l.width!==n||l.height!==o}))throw new Error("RenderColorTexture's size must as same as RenderTarget");if(r instanceof si&&(r.width!==n||r.height!==o))throw new Error("RenderDepthTexture's size must as same as RenderTarget");if(e.length>1&&e.some(function(l){return l.isCube}))throw new Error("MRT+Cube+[,MSAA] is not supported");var c=a.capability.maxAntiAliasing;t.antiAliasing>c&&(t._antiAliasing=c),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var s=i.prototype;return s.setRenderTargetInfo=function(t,e){var r=this._gl,n=this._target,o=n.depthTexture,c=n.getColorTexture(0),l=e!==this._curMipLevel;if(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),c){var u=c.isCube;(l||u)&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,u?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,c._platformTexture._glTexture,e)}if(o){var h=o.isCube;if(l||h){var f=o._platformTexture;r.framebufferTexture2D(r.FRAMEBUFFER,f._formatDetail.attachment,h?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,f._glTexture,e)}}else if(l){var d=Ce._getRenderBufferDepthFormatDetail(n._depth,r,this._isWebGL2),_=d.internalFormat;r.bindRenderbuffer(r.RENDERBUFFER,this._depthRenderBuffer),r.renderbufferStorage(r.RENDERBUFFER,_,n.width>>e,n.height>>e)}this._curMipLevel=e,this._activeRenderTarget()},s.blitRenderTarget=function(){if(!!this._MSAAFrameBuffer){var t=this._gl,e=t.COLOR_BUFFER_BIT|(this._target.depthTexture?t.DEPTH_BUFFER_BIT:0),r=this._target,n=r.colorTextureCount,o=r.width,c=r.height;t.bindFramebuffer(t.READ_FRAMEBUFFER,this._MSAAFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._frameBuffer);for(var l=0;l<n;l++){var u=t.COLOR_ATTACHMENT0+l;this._blitDrawBuffers[l]=u,t.readBuffer(u),t.drawBuffers(this._blitDrawBuffers),t.blitFramebuffer(0,0,o,c,0,0,o,c,e,t.NEAREST),this._blitDrawBuffers[l]=t.NONE}t.bindFramebuffer(t.FRAMEBUFFER,null)}},s.destroy=function(){var t=this._gl;this._frameBuffer&&t.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&t.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&t.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&t.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var e=0;e<this._MSAAColorRenderBuffers.length;e++)t.deleteRenderbuffer(this._MSAAColorRenderBuffers[e]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},s._activeRenderTarget=function(){var t=this._gl;this._MSAAFrameBuffer?t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer)},s._bindMainFBO=function(){var t=this._gl,e=this._isWebGL2,r=this._target,n=r._depth,o=r.colorTextureCount,c=r.width,l=r.height,u=new Array(o);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var h=0;h<o;h++){var f=this._target.getColorTexture(h),d=t.COLOR_ATTACHMENT0+h;u[h]=d,f.isCube||t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,f._platformTexture._glTexture,0)}if(o>1&&t.drawBuffers(u),this._oriDrawBuffers=u,n!==null){if(n instanceof si)n.isCube||t.framebufferTexture2D(t.FRAMEBUFFER,n._platformTexture._formatDetail.attachment,t.TEXTURE_2D,n._platformTexture._glTexture,0);else if(this._target.antiAliasing<=1){var _=Ce._getRenderBufferDepthFormatDetail(n,t,e),p=_.internalFormat,v=_.attachment,g=t.createRenderbuffer();this._depthRenderBuffer=g,t.bindRenderbuffer(t.RENDERBUFFER,g),t.renderbufferStorage(t.RENDERBUFFER,p,c,l),t.framebufferRenderbuffer(t.FRAMEBUFFER,v,t.RENDERBUFFER,g)}}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._bindMSAAFBO=function(){var t=this._gl,e=this._isWebGL2,r=t.createRenderbuffer(),n=this._target,o=n._depth,c=n.colorTextureCount,l=n.antiAliasing,u=n.width,h=n.height;this._blitDrawBuffers=new Array(c),this._MSAADepthRenderBuffer=r,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var f=0;f<c;f++){var d=t.createRenderbuffer();this._MSAAColorRenderBuffers[f]=d,this._blitDrawBuffers[f]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,d),t.renderbufferStorageMultisample(t.RENDERBUFFER,l,this._target.getColorTexture(f)._platformTexture._formatDetail.internalFormat,u,h),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+f,t.RENDERBUFFER,d)}if(t.drawBuffers(this._oriDrawBuffers),o!==null){var _=o instanceof si?o._platformTexture._formatDetail:Ce._getRenderBufferDepthFormatDetail(o,t,e),p=_.internalFormat,v=_.attachment;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,l,p,u,h),t.framebufferRenderbuffer(t.FRAMEBUFFER,v,t.RENDERBUFFER,r)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},s._checkFrameBuffer=function(){var t=this._gl,e=this._isWebGL2,r=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case t.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(e&&r===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},i}(),Wh=function(i){Pi(s,i);function s(t,e){var r;r=i.call(this,t,e,t.gl.TEXTURE_2D)||this,r._compressedMipFilled=0;var n=e.format,o=e._mipmap,c=e.width,l=e.height,u=r._isWebGL2;if(!Ce._supportTextureFormat(n,t))throw new Error("Texture format is not supported:"+ae[n]);return o&&!u&&(!Ce._isPowerOf2(c)||!Ce._isPowerOf2(l))&&(e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Ce._getFormatDetail(n,r._gl,u),r._formatDetail.isCompressed&&!u||r._initMipmap(!1),r}var a=s.prototype;return a.setPixelBuffer=function(e,r,n,o,c,l){r===void 0&&(r=0);var u=this._gl,h=this._isWebGL2,f=this._formatDetail,d=f.internalFormat,_=f.baseFormat,p=f.dataType,v=f.isCompressed,g=Math.max(1,this._texture.width>>r),m=Math.max(1,this._texture.height>>r);if(n=n||0,o=o||0,c=c||g-n,l=l||m-o,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),v){var y=1<<r;h||this._compressedMipFilled&y?u.compressedTexSubImage2D(this._target,r,n,o,c,l,d,e):(u.compressedTexImage2D(this._target,r,d,c,l,0,e),this._compressedMipFilled|=y)}else u.texSubImage2D(this._target,r,n,o,c,l,_,p,e)},a.setImageSource=function(e,r,n,o,c,l){r===void 0&&(r=0),n===void 0&&(n=!1),o===void 0&&(o=!1);var u=this._gl,h=this._formatDetail,f=h.baseFormat,d=h.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+n),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+o),u.texSubImage2D(this._target,r,c||0,l||0,f,d,e)},a.getPixelBuffer=function(e,r,n,o,c,l){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");i.prototype._getPixelBuffer.call(this,null,e,r,n,o,c,l)},s}(Ce),Xh=function(i){Pi(s,i);function s(t,e){var r;r=i.call(this,t,e,t.gl.TEXTURE_CUBE_MAP)||this,r._compressedFaceFilled=[0,0,0,0,0,0];var n=e.format,o=e._mipmap,c=e.width,l=r._isWebGL2;if(!Ce._supportTextureFormat(n,t))throw new Error("Texture format is not supported:"+ae[n]);return o&&!l&&!Ce._isPowerOf2(c)&&(e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Ce._getFormatDetail(n,r._gl,l),r._formatDetail.isCompressed&&!l||r._initMipmap(!0),r}var a=s.prototype;return a.setPixelBuffer=function(e,r,n,o,c,l,u){n===void 0&&(n=0);var h=this._gl,f=this._isWebGL2,d=this._formatDetail,_=d.internalFormat,p=d.baseFormat,v=d.dataType,g=d.isCompressed,m=Math.max(1,this._texture.width>>n);if(o=o||0,c=c||0,l=l||m-o,u=u||m-c,this._bind(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,0),h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),g){var y=1<<n;f||this._compressedFaceFilled[e]&y?h.compressedTexSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,o,c,l,u,_,r):(h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,_,l,u,0,r),this._compressedFaceFilled[e]|=y)}else h.texSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,o,c,l,u,p,v,r)},a.setImageSource=function(e,r,n,o,c,l,u){n===void 0&&(n=0),o===void 0&&(o=!1),c===void 0&&(c=!1);var h=this._gl,f=this._formatDetail,d=f.baseFormat,_=f.dataType;this._bind(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,+o),h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+c),h.texSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,l||0,u||0,d,_,r)},a.getPixelBuffer=function(e,r,n,o,c,l,u){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");i.prototype._getPixelBuffer.call(this,e,r,n,o,c,l,u)},s}(Ce),xr;(function(i){i[i.Auto=0]="Auto",i[i.WebGL2=1]="WebGL2",i[i.WebGL1=2]="WebGL1"})(xr||(xr={}));var jh=function(){function i(a){a===void 0&&(a={}),this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._capability=void 0,this._isWebGL2=void 0,this._activeTextureID=void 0,this._activeTextures=new Array(32),this._lastViewport=new ze(null,null,null,null),this._lastClearColor=new ne(null,null,null,null),this._options=a}var s=i.prototype;return s.init=function(t){var e=this._options;e.alpha===void 0&&(e.alpha=!1),e.stencil===void 0&&(e.stencil=!0);var r=t._webCanvas,n=e.webGLMode||xr.Auto,o;if((n==xr.Auto||n==xr.WebGL2)&&(o=r.getContext("webgl2",e),!o&&r instanceof HTMLCanvasElement&&(o=r.getContext("experimental-webgl2",e)),this._isWebGL2=!0,o&&!o.deleteQuery&&(this._isWebGL2=!1)),o||(n==xr.Auto||n==xr.WebGL1)&&(o=r.getContext("webgl",e),!o&&r instanceof HTMLCanvasElement&&(o=r.getContext("experimental-webgl",e)),this._isWebGL2=!1),!o)throw new Error("Get GL Context FAILED.");this._gl=o,this._activeTextureID=o.TEXTURE0,this._renderStates=new Gh(o),this._extensions=new Uh(this),this._capability=new Lh(this),o.activeTexture(o.TEXTURE0),this._options=null},s.createPlatformPrimitive=function(t){return new Nh(this,t)},s.createPlatformTexture2D=function(t){return new Wh(this,t)},s.createPlatformTextureCubeMap=function(t){return new Xh(this,t)},s.createPlatformRenderColorTexture=function(t){return new Vh(this,t)},s.createPlatformRenderDepthTexture=function(t){return new kh(this,t)},s.createPlatformRenderTarget=function(t){return new Hh(this,t)},s.requireExtension=function(t){return this._extensions.requireExtension(t)},s.canIUse=function(t){return this.capability.canIUse(t)},s.canIUseCompressedTextureInternalFormat=function(t){return this.capability.canIUseCompressedTextureInternalFormat(t)},s.viewport=function(t,e,r,n){var o=this._gl,c=this._lastViewport;(t!==c.x||e!==c.y||r!==c.z||n!==c.w)&&(o.viewport(t,e,r,n),c.setValue(t,e,r,n))},s.colorMask=function(t,e,r,n){this._gl.colorMask(t,e,r,n)},s.clearRenderTarget=function(t,e,r){var n=this._gl,o=t._lastRenderState,c=o.blendState.targetBlendState,l=o.depthState,u=o.stencilState,h=n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT;if(e===hr.DepthColor){h|=n.COLOR_BUFFER_BIT;var f=this._lastClearColor,d=r.r,_=r.g,p=r.b,v=r.a;r&&(d!==f.r||_!==f.g||p!==f.b||v!==f.a)&&(n.clearColor(d,_,p,v),f.setValue(d,_,p,v)),c.colorWriteMask!==Dt.All&&(n.colorMask(!0,!0,!0,!0),c.colorWriteMask=Dt.All)}l.writeEnabled!==!0&&(n.depthMask(!0),l.writeEnabled=!0),u.writeMask!==255&&(n.stencilMask(255),u.writeMask=255),n.clear(h)},s.drawPrimitive=function(t,e,r){t&&t._draw(r,e)},s.activeRenderTarget=function(t,e,r){var n=this._gl;if(t){var o;(o=t._platformRenderTarget)===null||o===void 0||o._activeRenderTarget();var c=t.width,l=t.height;this.viewport(0,0,c>>r,l>>r)}else{n.bindFramebuffer(n.FRAMEBUFFER,null);var u=e.viewport,h=n.drawingBufferWidth,f=n.drawingBufferHeight,d=h*u.z,_=f*u.w,p=u.x*h,v=f-u.y*f-_;this.viewport(p,v,d,_)}},s.destroy=function(){},s.activeTexture=function(t){this._activeTextureID!==t&&(this._gl.activeTexture(t),this._activeTextureID=t)},s.bindTexture=function(t){var e=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[e]!==t&&(this._gl.bindTexture(t._target,t._glTexture),this._activeTextures[e]=t)},Si(i,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),i}(),Kh=function(i){Pi(s,i);function s(a,t,e){var r=new Ih(typeof a=="string"?document.getElementById(a):a),n=new jh(e);return i.call(this,r,n,t)||this}return Si(s,[{key:"canvas",get:function(){return this._canvas}}]),s}(pc);function Yo(i,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function qh(i,s,a){return s&&Yo(i.prototype,s),a&&Yo(i,a),i}var Yh=function(){function i(a,t){var e=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(a),this._worker.onmessage=function(r){var n=r.data;switch(n.type){case"decode":e._callbacks[n.id].resolve(n.geometry);break;case"error":e._callbacks[n.id].reject(n);break;default:pt.error('DRACOWorker: Unexpected message, "'+n.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var s=i.prototype;return s.setCosts=function(t,e){this._costs[t]=e},s.addCurrentLoad=function(t){this._currentLoad+=t},s.setCallback=function(t,e,r){this._callbacks[t]={resolve:e,reject:r}},s.decode=function(t,e,r){this._worker.postMessage({type:"decode",id:t,taskConfig:e,buffer:r},[r])},s.releaseTask=function(t){this._currentLoad-=this._costs[t],delete this._callbacks[t],delete this._costs[t]},qh(i,[{key:"currentLoad",get:function(){return this._currentLoad}}]),i}(),Qo=`let decoderPending;
let decoderConfig;

onmessage = function(e) {
  const message = e.data;

  switch (message.type) {
    case "init":
      decoderConfig = message.decoderConfig;
      decoderPending = new Promise(function(resolve /*, reject*/) {
        decoderConfig.onModuleLoaded = function(draco) {
          // Module is Promise-like. Wrap before resolving to avoid loop.
          resolve({ draco: draco });
        };
        DracoDecoderModule(decoderConfig);
      });
      break;

    case "decode":
      const buffer = message.buffer;
      const taskConfig = message.taskConfig;
      decoderPending.then(module => {
        const draco = module.draco;
        const decoder = new draco.Decoder();
        const decoderBuffer = new draco.DecoderBuffer();
        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);
        try {
          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);
          const buffers = geometry.attributes.map(attr => attr.array.buffer);
          if (geometry.index) buffers.push(geometry.index.array.buffer);
          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);
        } catch (error) {
          console.error(error);
          self.postMessage({ type: "error", id: message.id, error: error.message });
        } finally {
          draco.destroy(decoderBuffer);
          draco.destroy(decoder);
        }
      });
      break;
  }
};

function decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {
  const attributeIDs = taskConfig.attributeIDs;
  const attributeTypes = taskConfig.attributeTypes;

  let dracoGeometry;
  let decodingStatus;

  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);
  if (geometryType === draco.TRIANGULAR_MESH) {
    dracoGeometry = new draco.Mesh();
    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);
  } else {
    throw new Error("DRACODecoder worker: Unexpected geometry type.");
  }

  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {
    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());
  }

  const geometry = { index: null, attributes: [] };

  // Gather all vertex attributes.
  for (let attributeName in attributeIDs) {
    const attributeType = self[attributeTypes[attributeName]];

    let attribute;
    let attributeID;

    // A Draco file may be created with default vertex attributes, whose attribute IDs
    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,
    // a Draco file may contain a custom set of attributes, identified by known unique
    // IDs. glTF files always do the latter, and .drc files typically do the former.
    if (taskConfig.useUniqueIDs) {
      attributeID = attributeIDs[attributeName];
      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);
    } else {
      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);
      if (attributeID === -1) continue;
      attribute = decoder.GetAttribute(dracoGeometry, attributeID);
    }
    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));
  }
  // Add index.
  if (geometryType === draco.TRIANGULAR_MESH) {
    // Generate mesh faces.
    const numFaces = dracoGeometry.num_faces();
    const numIndices = numFaces * 3;
    let dataSize;
    let ptr;
    let index;
    const indexType = self[taskConfig.indexType];

    switch (indexType) {
      case Uint16Array:
        dataSize = numIndices * 2;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);
        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      case Uint32Array:
        dataSize = numIndices * 4;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);
        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      default:
        throw new Error("DRACODecoder: Unexpected index type.");
    }
    geometry.index = { array: index, itemSize: 1 };
  }
  draco.destroy(dracoGeometry);
  return geometry;
}

function decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {
  const numComponents = attribute.num_components();
  const numPoints = dracoGeometry.num_points();
  const numValues = numPoints * numComponents;
  let ptr;
  let array;
  let dataSize;
  switch (attributeType) {
    case Float32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);
      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);
      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);
      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);
      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);
      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);
      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);
      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    default:
      throw new Error("DRACODecoder: Unexpected attribute type.");
  }

  return {
    name: attributeName,
    array: array,
    itemSize: numComponents
  };
}
`,hn="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",Qh="draco_decoder_gltf.js",$h="draco_decoder_gltf.r3bin",Zh="draco_wasm_wrapper_gltf.js",Jh=function(){function i(a){if(a===void 0&&(a={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,a.workerLimit>this.workerLimit)pt.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+a.workerLimit);else{var t;this.workerLimit=(t=a.workerLimit)!=null?t:4}this.useJS=typeof WebAssembly!="object"||a.type==="js",this.loadLibPromise=this.preloadLib()}var s=i.prototype;return s.preloadLib=function(){var t=this;return this.loadLibPromise?this.loadLibPromise:new Promise(function(e,r){t.useJS?Gi(""+hn+Qh,{type:"text"}).then(function(n){var o=[n,Qo].join(`
`),c=URL.createObjectURL(new Blob([o]));e({workerSourceURL:c,decoderWASMBinary:null})}).catch(function(n){r(n)}):Promise.all([Gi(""+hn+Zh,{type:"text"}),Gi(""+hn+$h,{type:"arraybuffer"})]).then(function(n){var o=n[0],c=n[1],l=[o,Qo].join(`
`),u=URL.createObjectURL(new Blob([l]));e({workerSourceURL:u,decoderWASMBinary:c})}).catch(function(n){r(n)})})},s.getWorker=function(){var t=this;return this.preloadLib().then(function(e){if(t.pool.length<t.workerLimit){var r=new Yh(e.workerSourceURL,e.decoderWASMBinary);t.pool.push(r)}else t.pool.sort(function(n,o){return n.currentLoad>o.currentLoad?-1:1});return t.pool[t.pool.length-1]})},s.decode=function(t,e){var r=this,n=JSON.stringify(e);if(this.taskCache.has(t)){var o=this.taskCache.get(t);if(o.key===n)return o.promise;if(t.byteLength===0)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var c=this.currentTaskId++,l=t.byteLength,u,h=new Promise(function(f,d){r.getWorker().then(function(_){u=_,_.setCosts(c,l),_.addCurrentLoad(l),_.setCallback(c,f,d),_.decode(c,e,t)}).catch(function(_){d(_)})});return h.finally(function(){u&&c&&u.releaseTask(c)}),this.taskCache.set(t,{key:n,promise:h}),h},i}();function $o(i,s){var a=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);s&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),a.push.apply(a,t)}return a}function He(i){for(var s=1;s<arguments.length;s++){var a=arguments[s]!=null?arguments[s]:{};s%2?$o(Object(a),!0).forEach(function(t){ef(i,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(a)):$o(Object(a)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(a,t))})}return i}function Zo(i,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Mi(i,s,a){return s&&Zo(i.prototype,s),a&&Zo(i,a),i}function ef(i,s,a){return s in i?Object.defineProperty(i,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[s]=a,i}function bn(){return bn=Object.assign||function(i){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(i[t]=a[t])}return i},bn.apply(this,arguments)}function he(i,s){i.prototype=Object.create(s.prototype),i.prototype.constructor=i,wn(i,s)}function wn(i,s){return wn=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},wn(i,s)}function ni(i){if(i===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return i}function tf(i,s){if(!!i){if(typeof i=="string")return Jo(i,s);var a=Object.prototype.toString.call(i).slice(8,-1);if(a==="Object"&&i.constructor&&(a=i.constructor.name),a==="Map"||a==="Set")return Array.from(i);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Jo(i,s)}}function Jo(i,s){(s==null||s>i.length)&&(s=i.length);for(var a=0,t=new Array(s);a<s;a++)t[a]=i[a];return t}function rf(i,s){var a=typeof Symbol!="undefined"&&i[Symbol.iterator]||i["@@iterator"];if(a)return(a=a.call(i)).next.bind(a);if(Array.isArray(i)||(a=tf(i))||s&&i&&typeof i.length=="number"){a&&(i=a);var t=0;return function(){return t>=i.length?{done:!0}:{done:!1,value:i[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ft(i,s,a,t,e){var r={};return Object.keys(t).forEach(function(n){r[n]=t[n]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(n,o){return o(i,s,n)||n},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(i,s,r),r=null),r}var es,ts;function nf(i){return/^data:(.+?);base64,/.test(i)}es=Jt(Te.Buffer,["bin","r3bin"],!1),es(ts=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e){var r=e.url;return nf(r)?new st(function(n){var o=r.slice(13+RegExp.$1.length),c=Uint8Array.from(atob(o),function(l){return l.charCodeAt(0)});n(c.buffer)}):this.request(r,He(He({},e),{},{type:"arraybuffer"}))},s}(er));var Ke;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT"})(Ke||(Ke={}));var it;(function(i){i.SCALAR="SCALAR",i.VEC2="VEC2",i.VEC3="VEC3",i.VEC4="VEC4",i.MAT2="MAT2",i.MAT3="MAT3",i.MAT4="MAT4"})(it||(it={}));var Wr;(function(i){i.TRANSLATION="translation",i.ROTATION="rotation",i.SCALE="scale",i.WEIGHTS="weights"})(Wr||(Wr={}));var Xr;(function(i){i.Linear="LINEAR",i.Step="STEP",i.CubicSpine="CUBICSPLINE"})(Xr||(Xr={}));var Zi;(function(i){i.PERSPECTIVE="perspective",i.ORTHOGRAPHIC="orthographic"})(Zi||(Zi={}));var rs;(function(i){i.JPEG="image/jpeg",i.PNG="image/png"})(rs||(rs={}));var fi;(function(i){i.OPAQUE="OPAQUE",i.MASK="MASK",i.BLEND="BLEND"})(fi||(fi={}));var is;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR"})(is||(is={}));var ns;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ns||(ns={}));var as;(function(i){i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT"})(as||(as={}));var xe=function(){function i(){}return i.floatBufferToVector2Array=function(a){for(var t=a.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new H(a[r],a[r+1]);return e},i.floatBufferToVector3Array=function(a){for(var t=a.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new w(a[r],a[r+1],a[r+2]);return e},i.floatBufferToVector4Array=function(a){for(var t=a.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new ze(a[r],a[r+1],a[r+2],a[r+3]);return e},i.floatBufferToColorArray=function(a,t){var e=a.length,r=new Array(e/(t?3:4));if(t)for(var n=0;n<e;n+=3)r[n/3]=new ne(a[n],a[n+1],a[n+2],1);else for(var o=0;o<e;o+=4)r[o/4]=new ne(a[o],a[o+1],a[o+2],a[o+3]);return r},i.decodeText=function(a){if(typeof TextDecoder!="undefined")return new TextDecoder().decode(a);for(var t="",e=0,r=a.length;e<r;e++)t+=String.fromCharCode(a[e]);return decodeURIComponent(encodeURIComponent(t))},i.getAccessorTypeSize=function(a){switch(a){case it.SCALAR:return 1;case it.VEC2:return 2;case it.VEC3:return 3;case it.VEC4:return 4;case it.MAT2:return 4;case it.MAT3:return 9;case it.MAT4:return 16}},i.getComponentType=function(a){switch(a){case Ke.BYTE:return Int8Array;case Ke.UNSIGNED_BYTE:return Uint8Array;case Ke.SHORT:return Int16Array;case Ke.UNSIGNED_SHORT:return Uint16Array;case Ke.UNSIGNED_INT:return Uint32Array;case Ke.FLOAT:return Float32Array}},i.getAccessorData=function(a,t,e){var r,n=a.bufferViews,o=n[t.bufferView],c=e[o.buffer],l=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=o.hasOwnProperty("byteOffset")?o.byteOffset:0,h=l+u,f=i.getAccessorTypeSize(t.type),d=f*t.count,_=(r=o.byteStride)!=null?r:0,p=i.getComponentType(t.componentType),v;if(_){var g=f*p.BYTES_PER_ELEMENT;v=new Uint8Array(t.count*g);for(var m=new Uint8Array(c,u,o.byteLength),y=0;y<t.count;y++)for(var A=0;A<g;A++)v[y*g+A]=m[y*_+l+A]}else v=new Uint8Array(c.slice(h,h+d*p.BYTES_PER_ELEMENT));var S=new p(v.buffer);if(t.sparse)for(var C,P,R,T,E=t.sparse,D=E.count,B=E.indices,O=E.values,G=n[B.bufferView],L=n[O.bufferView],W=e[G.buffer],K=e[L.buffer],Y=((C=B.byteOffset)!=null?C:0)+((P=G.byteOffset)!=null?P:0),U=G.byteLength,j=((R=O.byteOffset)!=null?R:0)+((T=L.byteOffset)!=null?T:0),oe=L.byteLength,te=i.getComponentType(B.componentType),fe=new te(W,Y,U/te.BYTES_PER_ELEMENT),me=new p(K,j,oe/p.BYTES_PER_ELEMENT),de=0;de<D;de++)for(var ye=fe[de],ge=0;ge<f;ge++)S[ye*f+ge]=me[de*f+ge];return S},i.getBufferViewData=function(a,t){var e=a.buffer,r=a.byteOffset,n=r===void 0?0:r,o=a.byteLength,c=t[e];return c.slice(n,n+o)},i.getVertexStride=function(a,t){var e,r=a.bufferViews[(e=t.bufferView)!=null?e:0].byteStride;if(r)return r;var n=i.getAccessorTypeSize(t.type),o=i.getComponentType(t.componentType);return n*o.BYTES_PER_ELEMENT},i.createVertexElement=function(a,t,e){var r=i.getAccessorTypeSize(t.type);return new we(a,0,i.getElementFormat(t.componentType,r,t.normalized),e)},i.getIndexFormat=function(a){switch(a){case Ke.UNSIGNED_BYTE:return Xe.UInt8;case Ke.UNSIGNED_SHORT:return Xe.UInt16;case Ke.UNSIGNED_INT:return Xe.UInt32}},i.getElementFormat=function(a,t,e){if(e===void 0&&(e=!1),a==Ke.FLOAT)switch(t){case 1:return $.Float;case 2:return $.Vector2;case 3:return $.Vector3;case 4:return $.Vector4}if(a==Ke.SHORT)switch(t){case 2:return e?$.NormalizedShort2:$.Short2;case 3:case 4:return e?$.NormalizedShort4:$.Short4}if(a==Ke.UNSIGNED_SHORT)switch(t){case 2:return e?$.NormalizedUShort2:$.UShort2;case 3:case 4:return e?$.NormalizedUShort4:$.UShort4}if(a==Ke.BYTE)switch(t){case 2:case 3:case 4:return e?$.NormalizedByte4:$.Byte4}if(a==Ke.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?$.NormalizedUByte4:$.UByte4}},i.loadImageBuffer=function(a,t){return new Promise(function(e,r){var n=new window.Blob([a],{type:t}),o=new Image;o.src=URL.createObjectURL(n),o.crossOrigin="anonymous",o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){requestAnimationFrame(function(){e(o),o.onload=null,o.onerror=null,o.onabort=null})}})},i.isAbsoluteUrl=function(a){return/^(?:http|blob|data:|\/)/.test(a)},i.parseRelativeUrl=function(a,t){if(i.isAbsoluteUrl(t))return t;var e=t.charAt(0);return e==="."?i._formatRelativePath(t+t):a.substring(0,a.lastIndexOf("/")+1)+t},i.parseGLB=function(a){var t=4,e=1179937895,r=12,n={JSON:1313821514,BIN:5130562},o=new DataView(a),c={magic:o.getUint32(0,!0),version:o.getUint32(t,!0),length:o.getUint32(2*t,!0)};if(c.magic!==e)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+c.magic.toString(16)),null;var l=o.getUint32(r,!0),u=o.getUint32(r+t,!0);if(u!==n.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var h=new Uint8Array(a,r+2*t,l),f=JSON.parse(i.decodeText(h)),d=[],_=r+2*t+l;_<c.length;){if(l=o.getUint32(_,!0),u=o.getUint32(_+t,!0),u!==n.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var p=_+2*t,v=a.slice(p,p+l);d.push(v),_+=l+2*t}return{gltf:f,buffers:d}},i._formatRelativePath=function(a){for(var t=a.split("/"),e=0,r=t.length;e<r;e++)t[e]==".."&&(t.splice(e-1,2),e-=2);return t.join("/")},i}(),Oe=function(){function i(){}return i.parseEngineResource=function(a,t,e,r){var n=i._extensionParsers[a];if(n!=null&&n.length){for(var o=arguments.length,c=new Array(o>4?o-4:0),l=4;l<o;l++)c[l-4]=arguments[l];for(var u=0;u<n.length;u++){var h;(h=n[u]).parseEngineResource.apply(h,[t,e,r].concat(c))}}},i.createEngineResource=function(a,t,e){var r=i._extensionParsers[a];if(r!=null&&r.length){for(var n,o=arguments.length,c=new Array(o>3?o-3:0),l=3;l<o;l++)c[l-3]=arguments[l];return(n=r[0]).createEngineResource.apply(n,[t,e].concat(c))}},i.hasExtensionParser=function(a){var t=i._extensionParsers[a];return!!(t!=null&&t.length)},i.initialize=function(a){var t=i._extensionParsers[a];if(t!=null&&t.length)for(var e=0;e<t.length;e++)t[e].initialize()},i._addExtensionParser=function(a,t){i._extensionParsers[a]||(i._extensionParsers[a]=[]),i._extensionParsers[a].push(t)},i}();Oe._extensionParsers={};function Or(i){return function(s){var a=new s;Oe._addExtensionParser(i,a)}}var af=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,n=e.buffers,o=e.entities,c=r.animations,l=r.accessors;if(!!c){for(var u=c.length,h=new Array(u),f=new Array(u),d=0;d<u;d++){for(var _=c[d],p=_.channels,v=_.samplers,g=_.name,m=g===void 0?"AnimationClip"+d:g,y=new mh(m),A=new Array,S=0;S<v.length;S++){var C,P=v[S],R=l[P.input],T=l[P.output],E=xe.getAccessorData(r,R,n),D=xe.getAccessorData(r,T,n),B=D.length/E.length,O=(C=P.interpolation)!=null?C:Xr.Linear,G=void 0;switch(O){case Xr.CubicSpine:G=qt.CubicSpine;break;case Xr.Step:G=qt.Step;break;case Xr.Linear:G=qt.Linear;break}E[E.length-1],A.push({type:T.type,interpolation:G,input:E,output:D,outputSize:B})}for(var L=0;L<p.length;L++){for(var W=p[L],K=W.target,Y=o[K.node],U="",j=Y;j.parent;)U=U===""?""+j.name:j.name+"/"+U,j=j.parent;var oe=void 0,te=void 0;switch(K.path){case Wr.TRANSLATION:oe=Ot,te="position";break;case Wr.ROTATION:oe=Ot,te="rotation";break;case Wr.SCALE:oe=Ot,te="scale";break;case Wr.WEIGHTS:oe=yi,te="blendShapeWeights";break}var fe=this._addCurve(W,A);y.addCurveBinding(U,oe,te,fe)}h[d]=y,f[d]={name:m,index:d}}e.animations=h,e._animationsIndices=f}},a._addCurve=function(e,r){var n=new Mh,o=r[e.sampler],c=o.type,l=o.input,u=o.output,h=o.outputSize;n.interpolation=o.interpolation;for(var f=0,d=l.length;f<d;f++){var _=f*h;if(c===it.SCALAR){var p=h>1?new ii:new ii;p.time=l[f],p.inTangent=0,p.outTangent=0,p.value=h>1?u.subarray(_,_+h):u[_],n.addKey(p)}if(c===it.VEC2){var v=new ii;v.time=l[f],v.value=new H(u[_],u[_+1]),v.inTangent=new H,v.outTangent=new H,n.addKey(v)}if(c===it.VEC3){var g=new ii;g.time=l[f],g.value=new w(u[_],u[_+1],u[_+2]),g.inTangent=new w,g.outTangent=new w,n.addKey(g)}if(c===it.VEC4){var m=new ii;m.time=l[f],m.value=new Se(u[_],u[_+1],u[_+2],u[_+3]),m.inTangent=new ze,m.outTangent=new ze,n.addKey(m)}}return n},s}(Oe),of=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.url,n=e.engine;return this._isGLB(r)?n.resourceManager.load({url:r,type:Te.Buffer}).then(xe.parseGLB).then(function(o){var c=o.gltf,l=o.buffers;e.gltf=c,e.buffers=l}):n.resourceManager.load({url:r,type:Te.JSON}).then(function(o){return e.gltf=o,Promise.all(o.buffers.map(function(c){return n.resourceManager.load({type:Te.Buffer,url:xe.parseRelativeUrl(r,c.uri)})})).then(function(c){e.buffers=c})})},a._isGLB=function(e){return e.substring(e.lastIndexOf(".")+1)==="glb"},s}(Oe),wc=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.engine,n=e.gltf.nodes;if(!!n){for(var o=[],c=0;c<n.length;c++){var l=n[c],u=l.matrix,h=l.translation,f=l.rotation,d=l.scale,_=new Kt(r,l.name||""+s._defaultName+c),p=_.transform;if(u){var v=p.localMatrix;v.setValueByArray(u),p.localMatrix=v}else h&&p.setPosition(h[0],h[1],h[2]),f&&p.setRotationQuaternion(f[0],f[1],f[2],f[3]),d&&p.setScale(d[0],d[1],d[2]);o[c]=_}e.entities=o,this._buildEntityTree(e),this._createSceneRoots(e)}},a._buildEntityTree=function(e){for(var r=e.gltf.nodes,n=e.entities,o=0;o<r.length;o++){var c=r[o].children,l=n[o];if(c)for(var u=0;u<c.length;u++){var h=n[c[u]];l.addChild(h)}}},a._createSceneRoots=function(e){var r=e.engine,n=e.gltf,o=n.scene,c=o===void 0?0:o,l=n.scenes,u=e.entities;if(!!l){for(var h=[],f=0;f<l.length;f++){var d=l[f].nodes;if(!!d)if(d.length===1)h[f]=u[d[0]];else{for(var _=new Kt(r,"GLTF_ROOT"),p=0;p<d.length;p++)_.addChild(u[d[p]]);h[f]=_}}e.sceneRoots=h,e.defaultSceneRoot=h[c]}},s}(Oe);wc._defaultName="_GLTF_ENTITY_";var An=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}s._parseTextureTransform=function(e,r,n){r===void 0&&(r={});var o=r.KHR_texture_transform;o&&Oe.parseEngineResource("KHR_texture_transform",o,e,n)};var a=s.prototype;return a.parse=function(e){var r=e.gltf,n=e.engine,o=e.textures;if(!!r.materials){for(var c=[],l=0;l<r.materials.length;l++){var u=r.materials[l],h=u.extensions,f=h===void 0?{}:h,d=u.pbrMetallicRoughness,_=u.normalTexture,p=u.occlusionTexture,v=u.emissiveTexture,g=u.emissiveFactor,m=u.alphaMode,y=u.alphaCutoff,A=u.doubleSided,S=u.name,C=S===void 0?"":S,P=f.KHR_materials_unlit,R=f.KHR_materials_pbrSpecularGlossiness,T=null;if(P?T=Oe.createEngineResource("KHR_materials_unlit",P,e):R?T=Oe.createEngineResource("KHR_materials_pbrSpecularGlossiness",R,e):T=new fr(n),T.name=C,d){var E=d.baseColorFactor,D=d.baseColorTexture,B=d.metallicFactor,O=d.roughnessFactor,G=d.metallicRoughnessTexture;if(E&&(T.baseColor=new ne(ne.linearToGammaSpace(E[0]),ne.linearToGammaSpace(E[1]),ne.linearToGammaSpace(E[2]),E[3])),D&&(T.baseTexture=o[D.index],s._parseTextureTransform(T,D.extensions,e)),!P&&!R){var L=T;L.metallic=B!=null?B:1,L.roughness=O!=null?O:1,G&&(L.roughnessMetallicTexture=o[G.index],s._parseTextureTransform(T,G.extensions,e))}}if(!P){var W=T;if(v&&(W.emissiveTexture=o[v.index],s._parseTextureTransform(T,v.extensions,e)),g&&(W.emissiveColor=new ne(ne.linearToGammaSpace(g[0]),ne.linearToGammaSpace(g[1]),ne.linearToGammaSpace(g[2]))),_){var K=_.index,Y=_.scale;W.normalTexture=o[K],s._parseTextureTransform(T,_.extensions,e),Y!==void 0&&(W.normalTextureIntensity=Y)}if(p){var U=p.index,j=p.strength;W.occlusionTexture=o[U],s._parseTextureTransform(T,p.extensions,e),j!==void 0&&(W.occlusionTextureIntensity=j)}}switch(A?T.renderFace=cr.Double:T.renderFace=cr.Front,m){case fi.OPAQUE:T.isTransparent=!1;break;case fi.BLEND:T.isTransparent=!0;break;case fi.MASK:T.alphaCutoff=y!=null?y:.5;break}c[l]=T}e.materials=c}},s}(Oe),Ac=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=this,n=e.engine,o=e.gltf,c=e.buffers;if(!!o.meshes){for(var l=[],u=function(d){for(var _=o.meshes[d],p=[],v=function(y){var A=_.primitives[y],S=A.extensions,C=S===void 0?{}:S,P=C.KHR_draco_mesh_compression;p.push(new Promise(function(R){var T=new Xt(n,_.name||y+"");P?Oe.createEngineResource("KHR_draco_mesh_compression",P,e,A).then(function(E){return r._parseMeshFromGLTFPrimitive(T,_,A,o,function(D){for(var B=0;B<E.attributes.length;B++)if(E.attributes[B].name===D)return E.attributes[B].array;return null},function(D,B){throw"BlendShape animation is not supported when using draco."},function(){return E.index.array},n)}).then(R):r._parseMeshFromGLTFPrimitive(T,_,A,o,function(E){var D=A.attributes[E],B=o.accessors[D];return xe.getAccessorData(o,B,c)},function(E,D){var B=A.targets[D],O=B[E];if(O){var G=o.accessors[O];return xe.getAccessorData(o,G,c)}else return null},function(){var E=o.accessors[A.indices];return xe.getAccessorData(o,E,c)},n).then(R)}))},g=0;g<_.primitives.length;g++)v(g);l.push(Promise.all(p))},h=0;h<o.meshes.length;h++)u(h);return Promise.all(l).then(function(f){e.meshes=f})}},a._parseMeshFromGLTFPrimitive=function(e,r,n,o,c,l,u,h){var f=n.attributes,d=n.targets,_=n.indices,p=n.mode,v,g=o.accessors,m=g[f.POSITION],y=c("POSITION"),A=xe.floatBufferToVector3Array(y);e.setPositions(A);var S=e.bounds;if(v=m.count,m.min&&m.max)S.min.setValueByArray(m.min),S.max.setValueByArray(m.max);else{var C=s._tempVector3,P=S.min,R=S.max;P.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),R.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var T=y.length/v,E=0;E<v;E++){var D=E*T;C.setValueByArray(y,D),w.min(P,C,P),w.max(R,C,R)}}for(var B in f)if(B!=="POSITION"){var O=c(B);switch(B){case"NORMAL":var G=xe.floatBufferToVector3Array(O);e.setNormals(G);break;case"TEXCOORD_0":var L=xe.floatBufferToVector2Array(O);e.setUVs(L,0);break;case"TEXCOORD_1":var W=xe.floatBufferToVector2Array(O);e.setUVs(W,1);break;case"TEXCOORD_2":var K=xe.floatBufferToVector2Array(O);e.setUVs(K,2);break;case"TEXCOORD_3":var Y=xe.floatBufferToVector2Array(O);e.setUVs(Y,3);break;case"TEXCOORD_4":var U=xe.floatBufferToVector2Array(O);e.setUVs(U,4);break;case"TEXCOORD_5":var j=xe.floatBufferToVector2Array(O);e.setUVs(j,5);break;case"TEXCOORD_6":var oe=xe.floatBufferToVector2Array(O);e.setUVs(oe,6);break;case"TEXCOORD_7":var te=xe.floatBufferToVector2Array(O);e.setUVs(te,7);break;case"COLOR_0":var fe=xe.floatBufferToColorArray(O,g[f.COLOR_0].type===it.VEC3);e.setColors(fe);break;case"TANGENT":var me=xe.floatBufferToVector4Array(O);e.setTangents(me);break;case"JOINTS_0":var de=xe.floatBufferToVector4Array(O);e.setBoneIndices(de);break;case"WEIGHTS_0":var ye=xe.floatBufferToVector4Array(O);e.setBoneWeights(ye);break}}if(_!==void 0){var ge=o.accessors[_],Re=u();e.setIndices(Re),e.addSubMesh(0,ge.count,p)}else e.addSubMesh(0,v,p);return d&&this._createBlendShape(e,r,d,l),e.uploadData(!0),Promise.resolve(e)},a._createBlendShape=function(e,r,n,o){for(var c=r.extras?r.extras.targetNames:null,l=0,u=n.length;l<u;l++){var h=c?c[l]:"blendShape"+l,f=o("POSITION",l),d=o("NORMAL",l),_=o("TANGENT",l),p=f?xe.floatBufferToVector3Array(f):null,v=d?xe.floatBufferToVector3Array(d):null,g=_?xe.floatBufferToVector3Array(_):null,m=new zu(h);m.addFrame(1,p,v,g),e.addBlendShape(m)}},s}(Oe);Ac._tempVector3=new w;var Sc=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}s._getDefaultMaterial=function(e){return s._defaultMaterial||(s._defaultMaterial=new et(e)),s._defaultMaterial};var a=s.prototype;return a.parse=function(e){var r=e.gltf,n=r.nodes,o=r.cameras,c=e.entities;if(!!n){for(var l=0;l<n.length;l++){var u=n[l],h=u.camera,f=u.mesh,d=u.extensions,_=d===void 0?{}:d,p=_.KHR_lights_punctual,v=c[l];if(h!==void 0&&this._createCamera(e,o[h],v),f!==void 0&&this._createRenderer(e,u,v),p){var g=p.light,m=e.gltf.extensions.KHR_lights_punctual.lights;Oe.parseEngineResource("KHR_lights_punctual",m[g],v,e)}}e.defaultSceneRoot&&this._createAnimator(e)}},a._createCamera=function(e,r,n){var o=r.orthographic,c=r.perspective,l=r.type,u=n.addComponent(En);if(l===Zi.ORTHOGRAPHIC){var h=o.xmag,f=o.ymag,d=o.zfar,_=o.znear;u.isOrthographic=!0,_!==void 0&&(u.nearClipPlane=_),d!==void 0&&(u.farClipPlane=d),u.orthographicSize=Math.max(f!=null?f:0,h!=null?h:0)/2}else if(l===Zi.PERSPECTIVE){var p=c.aspectRatio,v=c.yfov,g=c.zfar,m=c.znear;p!==void 0&&(u.aspectRatio=p),v!==void 0&&(u.fieldOfView=v*180/Math.PI),g!==void 0&&(u.farClipPlane=g),m!==void 0&&(u.nearClipPlane=m)}e.cameras||(e.cameras=[]),e.cameras.push(u),u.enabled=!1},a._createRenderer=function(e,r,n){for(var o=e.engine,c=e.gltf.meshes,l=e.meshes,u=e.materials,h=e.skins,f=r.mesh,d=r.skin,_=c[f],p=_.primitives,v=r.weights||_.weights,g=0;g<p.length;g++){var m=l[f][g],y=void 0;if(d!==void 0||v){var A=n.addComponent(yi);A.mesh=m,d!==void 0&&(A.skin=h[d]),v&&(A.blendShapeWeights=new Float32Array(v)),y=A}else y=n.addComponent(Zr),y.mesh=m;var S=p[g].material,C=(u==null?void 0:u[S])||s._getDefaultMaterial(o);y.setMaterial(C);var P=p[g].extensions,R=P===void 0?{}:P,T=R.KHR_materials_variants;T&&Oe.parseEngineResource("KHR_materials_variants",T,y,e)}},a._createAnimator=function(e){var r=e.defaultSceneRoot,n=e.animations;if(!!n){var o=r.addComponent(Dr),c=new Bn,l=new Qi("layer"),u=new $i;if(c.addLayer(l),o.animatorController=c,l.stateMachine=u,n)for(var h=0;h<n.length;h++){var f=n[h],d=f.name,_=u.makeUniqueStateName(d);_!==d&&console.warn("AnimatorState name is existed, name: "+d+" reset to "+_);var p=u.addState(_);p.clip=f}}},s}(Oe);Sc._defaultMaterial=void 0;var sf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,n=e.buffers,o=e.entities,c=e.defaultSceneRoot,l=r.skins;if(!!l){for(var u=[],h=0;h<l.length;h++){var f=l[h],d=f.inverseBindMatrices,_=f.skeleton,p=f.joints,v=f.name,g=v===void 0?"SKIN_"+h:v,m=p.length,y=new Ru(g);y.inverseBindMatrices.length=m;for(var A=r.accessors[d],S=xe.getAccessorData(r,A,n),C=0;C<m;C++){var P=new ie;P.setValueByArray(S,C*16),y.inverseBindMatrices[C]=P}for(var R=0;R<m;R++)y.joints[R]=o[p[R]].name;_!==void 0?y.skeleton=o[_].name:y.skeleton=c.name,u[h]=y}e.skins=u}},s}(Oe),Pc=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=this,n=e.gltf,o=e.buffers,c=e.engine,l=e.url;if(n.textures)return Promise.all(n.textures.map(function(u,h){var f=u.sampler,d=u.source,_=d===void 0?0:d,p=u.name,v=n.images[_],g=v.uri,m=v.bufferView,y=v.mimeType,A=v.name;if(g)return c.resourceManager.load({url:xe.parseRelativeUrl(l,g),type:Te.Texture2D}).then(function(P){return P.name||(P.name=p||A||"texture_"+h),f!==void 0&&r._parseSampler(P,n.samplers[f]),P});var S=n.bufferViews[m],C=xe.getBufferViewData(S,o);return xe.loadImageBuffer(C,y).then(function(P){var R=new $r(c,P.width,P.height);return R.setImageSource(P),R.generateMipmaps(),R.name=p||A||"texture_"+h,f!==void 0&&r._parseSampler(R,n.samplers[f]),R})})).then(function(u){e.textures=u})},a._parseSampler=function(e,r){r.magFilter,r.minFilter;var n=r.wrapS,o=r.wrapT;n&&(e.wrapModeU=s._wrapMap[n]),o&&(e.wrapModeV=s._wrapMap[o])},s}(Oe);Pc._wrapMap={33071:nt.Clamp,33648:nt.Mirror,10497:nt.Repeat};var cf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parse=function(e){var r=e.gltf,n=r.asset.version,o=r.extensionsUsed,c=r.extensionsRequired,l=Number(n);if(!(l>=2&&l<3))throw"Only support gltf 2.x.";if(o)for(var u=0;u<o.length;u++)Oe.hasExtensionParser(o[u])||pt.warn("Extension "+o[u]+" is not implemented, you can customize this extension in gltf.");if(c)for(var h=0;h<c.length;h++){var f=c[h];Oe.hasExtensionParser(f)&&Oe.initialize(f)}},s}(Oe),Sn=function(){function i(a){var t=this;this._pipes=[],a.forEach(function(e,r){t._pipes[r]=new e})}var s=i.prototype;return s.parse=function(t){var e=this,r;return new Promise(function(n,o){e._pipes.forEach(function(c){r?r=r.then(function(){return c.parse(t)}):r=c.parse(t)}),r?r.then(function(){n(t)}).catch(o):n(t)})},i}();Sn.instance=new Sn([of,cf,Pc,An,Ac,wc,sf,af,Sc]);var lf=function(i){he(s,i);function s(){for(var a,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return a=i.call.apply(i,[this].concat(e))||this,a.url=void 0,a.gltf=void 0,a.buffers=void 0,a.textures=void 0,a.materials=void 0,a.meshes=void 0,a.skins=void 0,a.animations=void 0,a.entities=void 0,a.cameras=void 0,a.lights=void 0,a.sceneRoots=void 0,a.defaultSceneRoot=void 0,a.variants=void 0,a}return s}(dr),os,ss;os=Jt(Te.Prefab,["gltf","glb"]),os(ss=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=e.url;return new st(function(o,c){var l=new lf(r.engine);l.url=n,Sn.instance.parse(l).then(o).catch(function(u){console.error(u),c("Error loading glTF model from "+n+" .")})})},s}(er));var cs,ls;cs=Jt(Te.JSON,["json"],!1),cs(ls=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e){return this.request(e.url,He(He({},e),{},{type:"json"}))},s}(er));var uf=12+13*4,hf=0;function ff(i,s){for(var a=[],t=uf+i.bytesOfKeyValueData,e=i.pixelWidth,r=i.pixelHeight,n=s?i.numberOfMipmapLevels:1,o=0;o<n;o++){var c=new Int32Array(i.buffer,t,1)[0];t+=4;for(var l=0;l<i.numberOfFaces;l++){var u=new Uint8Array(i.buffer,t,c);a.push({data:u,width:e,height:r}),t+=c,t+=3-(c+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return a}function df(i){if(i.byteLength>=12){var s=new Uint8Array(i,0,12);if(s[0]===171&&s[1]===75&&s[2]===84&&s[3]===88&&s[4]===32&&s[5]===49&&s[6]===49&&s[7]===187&&s[8]===13&&s[9]===10&&s[10]===26&&s[11]===10)return!0}return!1}function _f(i){switch(i){case ce.RGB_S3TC_DXT1_EXT:return ae.DXT1;case ce.RGBA_S3TC_DXT5_EXT:return ae.DXT5;case ce.RGB_ETC1_WEBGL:return ae.ETC1_RGB;case ce.RGB8_ETC2:return ae.ETC2_RGB;case ce.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return ae.ETC2_RGBA5;case ce.RGBA8_ETC2_EAC:return ae.ETC2_RGBA8;case ce.RGB_PVRTC_2BPPV1_IMG:return ae.PVRTC_RGB2;case ce.RGBA_PVRTC_2BPPV1_IMG:return ae.PVRTC_RGBA2;case ce.RGB_PVRTC_4BPPV1_IMG:return ae.PVRTC_RGB4;case ce.RGBA_PVRTC_4BPPV1_IMG:return ae.PVRTC_RGBA4;case ce.RGBA_ASTC_4X4_KHR:return ae.ASTC_4x4;case ce.RGBA_ASTC_5X5_KHR:return ae.ASTC_5x5;case ce.RGBA_ASTC_6X6_KHR:return ae.ASTC_6x6;case ce.RGBA_ASTC_8X8_KHR:return ae.ASTC_8x8;case ce.RGBA_ASTC_10X10_KHR:return ae.ASTC_10x10;case ce.RGBA_ASTC_12X12_KHR:return ae.ASTC_12x12;default:var s=ce[i];throw new Error("this format is not supported in Oasis Engine: "+s)}}var Mc={parse:function(s,a,t,e){if(e===void 0&&(e=!1),!df(s))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(s,12,13*r),o=n.getUint32(0,!0),c=o===67305985,l={buffer:s,glType:n.getUint32(1*r,c),glTypeSize:n.getUint32(2*r,c),glFormat:n.getUint32(3*r,c),glInternalFormat:n.getUint32(4*r,c),glBaseInternalFormat:n.getUint32(5*r,c),pixelWidth:n.getUint32(6*r,c),pixelHeight:n.getUint32(7*r,c),pixelDepth:n.getUint32(8*r,c),numberOfArrayElements:n.getUint32(9*r,c),numberOfFaces:n.getUint32(10*r,c),numberOfMipmapLevels:n.getUint32(11*r,c),bytesOfKeyValueData:n.getUint32(12*r,c),loadType:hf};if(l.glType!==0)throw new Error("only compressed formats currently supported");if(l.numberOfMipmapLevels=Math.max(1,l.numberOfMipmapLevels),l.pixelHeight===0||l.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(l.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(l.numberOfFaces!==a)throw new Error("number of faces expected"+a+", but found "+l.numberOfFaces);return t&&(l.mipmaps=ff(l,!0)),e&&(l.engineFormat=_f(l.glInternalFormat)),l}};function vf(i){var s=Mc.parse(i,1,!0,!0);return{mipmaps:s.mipmaps,engineFormat:s.engineFormat,internalFormat:s.glInternalFormat,width:s.pixelWidth,height:s.pixelHeight}}function pf(i){for(var s=[],a,t,e,r,n=0;n<i.length;n++){var o=Mc.parse(i[n],1,!0,!0);s.push(o.mipmaps),n===0&&(e=o.pixelWidth,r=o.pixelHeight,a=o.glInternalFormat,t=o.engineFormat)}return{mipmapsFaces:s,engineFormat:t,internalFormat:a,width:e,height:r}}var us,hs;us=Jt(Te.KTXCube,[]),us(hs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new st(function(o,c){Promise.all(e.urls.map(function(l){return n.request(l,He(He({},e),{},{type:"arraybuffer"}))})).then(function(l){for(var u=pf(l),h=u.width,f=u.mipmapsFaces,d=u.engineFormat,_=f[0].length>1,p=new rn(r.engine,h,d,_),v=0;v<6;v++)for(var g=f[v].length,m=0;m<g;m++){var y=f[v][m],A=y.data,S=y.width,C=y.height;p.setPixelBuffer(yt.PositiveX+v,A,m,0,0,S,C)}o(p)}).catch(function(l){c(l)})})},s}(er));var fs,ds;fs=Jt(Te.KTX,["ktx"]),fs(ds=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new st(function(o,c){n.request(e.url,He(He({},e),{},{type:"arraybuffer"})).then(function(l){for(var u=vf(l),h=u.width,f=u.height,d=u.mipmaps,_=u.engineFormat,p=d.length>1,v=new $r(r.engine,h,f,_,p),g=0;g<d.length;g++){var m=d[g],y=m.width,A=m.height,S=m.data;v.setPixelBuffer(S,g,0,0,y,A)}o(v)}).catch(function(l){c(l)})})},s}(er));var _s,vs;_s=Jt(Te.Texture2D,["png","jpg","webp","jpeg"]),_s(vs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new st(function(o,c){n.request(e.url,He(He({},e),{},{type:"image"})).then(function(l){var u=new $r(r.engine,l.width,l.height);if(!!u._platformTexture){if(u.setImageSource(l),u.generateMipmaps(),e.url.indexOf("data:")!==0){var h=e.url.split("/");u.name=h[h.length-1]}o(u)}}).catch(function(l){c(l)})})},s}(er));var ps,gs;ps=Jt(Te.TextureCube,[""]),ps(gs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new st(function(o,c){Promise.all(e.urls.map(function(l){return n.request(l,He(He({},e),{},{type:"image"}))})).then(function(l){var u=l[0],h=u.width,f=u.height;if(h!==f){console.error("The cube texture must have the same width and height");return}var d=new rn(r.engine,h);if(!!d._platformTexture){for(var _=0;_<6;_++)d.setImageSource(yt.PositiveX+_,l[_],0);d.generateMipmaps(),o(d)}}).catch(function(l){c(l)})})},s}(er));var ms,ys;ms=Jt(Te.SpriteAtlas,["atlas"],!1),ms(ys=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new st(function(o,c){n.request(e.url,He(He({},e),{},{type:"json"})).then(function(l){var u=l.atlasItems,h=l.format,f=u.length;Promise.all(u.map(function(d){var _=d.img;return n.request(xe.parseRelativeUrl(e.url,_),He(He({},e),{},{type:"image"}))})).then(function(d){for(var _=r.engine,p=new vn,v=new H,g=new mc(_),m=0;m<f;m++){var y=d[m],A=y.width,S=y.height,C=new $r(_,A,S,h);C.setImageSource(y),C.generateMipmaps();for(var P=u[m],R=P.sprites,T=1/A,E=1/S,D=R.length-1;D>=0;D--){var B=R[D],O=B.region,G=B.pivot,L=B.atlasRegionOffset,W=B.atlasRegion,K=B.id,Y=new zn(_,C,O?p.setValue(O.x,O.y,O.w,O.h):void 0,G?v.setValue(G.x,G.y):void 0,B.pixelsPerUnit||void 0,B.name);if(Y.atlasRegion.setValue(W.x*T,W.y*E,W.w*T,W.h*E),B.atlasRotated&&(Y.atlasRotated=!0),L){var U=L.x,j=L.y,oe=L.z,te=L.w,fe=void 0,me=void 0;B.atlasRotated?(fe=1/(U+W.h+oe),me=1/(j+W.w+te)):(fe=1/(U+W.w+oe),me=1/(j+W.h+te)),Y.atlasRegionOffset.setValue(U*fe,j*me,oe*fe,te*me)}K!==void 0&&(Y._assetID=K),g._addSprite(Y)}}o(g)})}).catch(function(l){c(l)})})},s}(er));var xs,bs;xs=Jt(Te.Env,["env"]),xs(bs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){return new st(function(n,o){r.load({type:Te.Buffer,url:e.url}).then(function(c){var l,u=new Float32Array(c,0,27),h=27*4,f=(l=new Uint16Array(c,h,1))===null||l===void 0?void 0:l[0],d=new rn(r.engine,f);d.filterMode=bt.Trilinear;for(var _=d.mipmapCount,p=h+2,v=0;v<_;v++)for(var g=f>>v,m=0;m<6;m++){var y=g*g*4,A=new Uint8Array(c,p,y);p+=y,d.setPixelBuffer(yt.PositiveX+m,A,v)}var S=new lt,C=new qc;S.diffuseMode=Rr.SphericalHarmonics,C.setValueByArray(u),S.diffuseSphericalHarmonics=C,S.specularTexture=d,S.specularTextureDecodeRGBM=!0,n(S)}).catch(function(c){o(c)})})},s}(er));var Fr=function(){function i(){}var s=i.prototype;return s.initialize=function(){},s.parseEngineResource=function(t,e,r){},s.createEngineResource=function(t,e){return null},i}(),ws,As,Ss,Ps;ws=Or("KHR_draco_mesh_compression"),ws(As=(Ps=Ss=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.initialize=function(){s._decoder||(s._decoder=new Jh)},a.createEngineResource=function(e,r,n){var o=r.gltf,c=r.buffers,l=o.bufferViews,u=o.accessors,h=e.bufferView,f=e.attributes,d={},_={};for(var p in f)d[p]=f[p];for(var v in n.attributes)if(f[v]!==void 0){var g=u[n.attributes[v]];_[v]=xe.getComponentType(g.componentType).name}var m=u[n.indices],y=xe.getComponentType(m.componentType).name,A={attributeIDs:d,attributeTypes:_,useUniqueIDs:!0,indexType:y},S=xe.getBufferViewData(l[h],c);return s._decoder.decode(S,A).then(function(C){return C})},s}(Fr),Ss._decoder=void 0,Ps));var Ms,Ts;Ms=Or("KHR_lights_punctual"),Ms(Ts=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,n){var o=e.color,c=e.intensity,l=c===void 0?1:c,u=e.type,h=e.range,f=e.spot,d;if(u==="directional"?d=r.addComponent(Ut):u==="point"?d=r.addComponent(Zt):u==="spot"&&(d=r.addComponent(vt)),o&&d.color.setValue(o[0],o[1],o[2],1),d.intensity=l,h&&!(d instanceof Ut)&&(d.distance=h),f&&d instanceof vt){var _=f.innerConeAngle,p=_===void 0?0:_,v=f.outerConeAngle,g=v===void 0?Math.PI/4:v;d.angle=p,d.penumbra=g-p}n.lights||(n.lights=[]),n.lights.push(d)},s}(Fr));var Cs,Rs;Cs=Or("KHR_materials_pbrSpecularGlossiness"),Cs(Rs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.createEngineResource=function(e,r){var n=r.engine,o=r.textures,c=new zr(n),l=e.diffuseFactor,u=e.diffuseTexture,h=e.specularFactor,f=e.glossinessFactor,d=e.specularGlossinessTexture;return l&&(c.baseColor=new ne(ne.linearToGammaSpace(l[0]),ne.linearToGammaSpace(l[1]),ne.linearToGammaSpace(l[2]),l[3])),u&&(c.baseTexture=o[u.index],An._parseTextureTransform(c,u.extensions,r)),h&&(c.specularColor=new ne(ne.linearToGammaSpace(h[0]),ne.linearToGammaSpace(h[1]),ne.linearToGammaSpace(h[2]))),f!==void 0&&(c.glossiness=f),d&&(c.specularGlossinessTexture=o[d.index],An._parseTextureTransform(c,d.extensions,r)),c},s}(Fr));var Es,zs;Es=Or("KHR_materials_unlit"),Es(zs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.createEngineResource=function(e,r){var n=r.engine,o=new Br(n);return o},s}(Fr));var Bs,Ds;Bs=Or("KHR_materials_variants"),Bs(Ds=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,n){for(var o=n.gltf.extensions.KHR_materials_variants.variants,c=n.materials,l=e.mappings,u=0;u<l.length;u++){var h=l[u],f=h.material,d=h.variants;n.variants||(n.variants=[]),n.variants.push({renderer:r,material:c[f],variants:d.map(function(_){return o[_].name})})}},s}(Fr));var Os,Fs;Os=Or("KHR_mesh_quantization"),Os(Fs=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}return s}(Fr));var Is,Ls;Is=Or("KHR_texture_transform"),Is(Ls=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.parseEngineResource=function(e,r,n){var o=e.offset;e.rotation;var c=e.scale;e.texCoord,o&&(r.tilingOffset.z=o[0],r.tilingOffset.w=o[1]),c&&(r.tilingOffset.x=c[0],r.tilingOffset.y=c[1])},s}(Fr));var gf=function(i){he(s,i);function s(t){var e;return e=i.call(this,t)||this,e._animatorController=void 0,e._speed=1,e._animator=void 0,e._asset=void 0,e._glTFEntity=void 0,e._clipPreview=void 0,e._hasBuiltNode=!1,e._controllerUpdateFlag=void 0,e}var a=s.prototype;return a.init=function(e){var r=e.asset,n=r===void 0?null:r,o=e.speed,c=e.animatorController,l=e.clipPreview,u=e.isClone;if(u){var h=e.gltfRootName;h&&(this._glTFEntity=this.entity.findByName(h))}if(this._glTFEntity)this._hasBuiltNode=!0;else{var f="GLTF-"+Date.now();e.gltfRootName=f,this._glTFEntity=this.entity.createChild(f),this._hasBuiltNode=!1}this.asset=n,this.animatorController=c,this.speed=o,this.clipPreview=l},a.update=function(){if(this._animator){var e;(e=this._controllerUpdateFlag)!==null&&e!==void 0&&e.flag&&this._playState()}},a._onEnable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!0),this.engine._componentsManager.addOnUpdateAnimations(this)},a._onDisable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!1),this.engine._componentsManager.removeOnUpdateAnimations(this)},a._playState=function(){var e,r=this._clipPreview;r?r==="_default"?this._playDefaultState():this._animator.play(r,0):this._animator._reset(),(e=this._controllerUpdateFlag)!==null&&e!==void 0&&e.flag&&(this._controllerUpdateFlag.flag=!1)},a._playDefaultState=function(){var e=this._animatorController,r=this._animator;if(!!r&&e)for(var n=e.layers,o=0,c=n.length;o<c;++o){var l,u,h,f=(l=n[o])===null||l===void 0||(u=l.stateMachine)===null||u===void 0?void 0:u._defaultState,d=f==null?void 0:f.name;d?r.play(d,o):r._reset(),(h=this._controllerUpdateFlag)!==null&&h!==void 0&&h.flag&&(this._controllerUpdateFlag.flag=!1)}},Mi(s,[{key:"asset",get:function(){return this._asset},set:function(e){var r=this._animatorController,n=this._speed,o=this._glTFEntity;if(!(e&&e.defaultSceneRoot===this._glTFEntity)){if(!this._hasBuiltNode&&(o.clearChildren(),e!==null)){o==null||o.destroy();var c=e.defaultSceneRoot.clone();this._animator=c.getComponent(Dr),this.entity.addChild(c),c.isActive=this.enabled,this._glTFEntity=c}r&&(this._animator.animatorController=r,this._animator.speed=n,this._playState()),this._asset=e}}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){var r=this._animator;e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e,r&&(r.animatorController=e,this._playState()))}},{key:"speed",get:function(){return this._speed},set:function(e){var r=this._animator;this._speed=e,r&&(r.speed=e,this._playState())}},{key:"animator",get:function(){return this._animator}},{key:"clipPreview",get:function(){return this._clipPreview},set:function(e){this._animator&&(e?e==="_default"?this._playDefaultState():this._animator.play(e,0):this._animator._reset()),this._clipPreview=e}}]),s}(Mt),Tc=function(i){he(s,i);function s(t){var e;return e=i.call(this,t)||this,e._props=null,e.setMaterial(new et(e.engine)),e}var a=s.prototype;return a.setProps=function(e){switch(e===void 0&&(e={}),this._props!==e&&(this._props=e),e.geometryType){case"Sphere":this.mesh=Hr.createSphere(this._engine,e.sphereRadius,e.sphereSegments);break;case"Cylinder":this.mesh=Hr.createCylinder(this._engine,e.cylinderRadiusTop,e.cylinderRadiusBottom,e.cylinderHeight,e.cylinderRadialSegments,e.cylinderHeightSegments);break;case"Plane":this.mesh=Hr.createPlane(this._engine,e.planeWidth,e.planeHeight,e.planeHorizontalSegments,e.planeVerticalSegments);break;case"Box":this.mesh=Hr.createCuboid(this._engine,e.boxWidth,e.boxHeight,e.boxDepth);break}},a.updateProp=function(e,r){var n=this._props;n[e]=r,this.setProps(n)},Mi(s,[{key:"material",get:function(){return this.getMaterial()},set:function(e){this.setMaterial(e)}}]),s}(Zr),mf=function(){function i(){this.registeredPlugins=new Set,this.plugins=[]}var s=i.prototype;return s.register=function(t){this.registeredPlugins.add(t)},s.boot=function(t){for(var e=rf(this.registeredPlugins.values()),r;!(r=e()).done;){var n=r.value;typeof n=="function"&&(n=n(t)),this.plugins.push(n)}},s.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},s.nodeAdded=function(t){this.delegateMethod("nodeAdded",t)},s.delegateMethod=function(t){for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this.plugins.forEach(function(o){return o[t]&&o[t].apply(o,r)})},i}();function It(i){return function(s,a,t){var e=t.value;t.value=function(){for(var r,n=this,o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return i.before&&(r=this.oasis.pluginManager).delegateMethod.apply(r,[i.before].concat(c)),Promise.resolve(e.apply(this,arguments)).then(function(u){return i.after&&n.oasis.pluginManager.delegateMethod(i.after,u),u})}}}function yf(i){for(var s=i.abilities,a=s===void 0?{}:s,t=i.assets,e=t===void 0?{}:t,r=i.scene,n=r===void 0?{}:r,o=Object.keys(a),c=Object.keys(e),l=Object.keys(n||{}),u=0,h=o.length;u<h;++u)xf(a[o[u]].props);for(var f=0,d=c.length;f<d;++f)wf(e[c[f]].props);for(var _=0,p=l.length;_<p;++_)bf(n[l[_]].props);return i}function xf(i){for(var s=Object.keys(i),a=0,t=s.length;a<t;++a){var e=s[a],r=i[e];Array.isArray(r)&&typeof r[0]!="object"&&(["color","diffuseColor","specularColor"].indexOf(e)!==-1?i[e]=new ne(r[0],r[1],r[2],r[3]):r.length===4?i[e]=new ze(r[0],r[1],r[2],r[3]):r.length===3?i[e]=new w(r[0],r[1],r[2]):r.length===2&&(i[e]=new H(r[0],r[1])))}}function bf(i){for(var s=Object.keys(i),a=0,t=s.length;a<t;++a){var e=s[a],r=i[e];Array.isArray(r)&&typeof r[0]!="object"&&(/color/i.test(e)?i[e]=new ne(r[0],r[1],r[2],r[3]):r.length===4?i[e]=new ze(r[0],r[1],r[2],r[3]):r.length===3?i[e]=new w(r[0],r[1],r[2]):r.length===2&&(i[e]=new H(r[0],r[1])))}}function wf(i){if(i===void 0&&(i={}),!!i)for(var s=Object.keys(i),a=0,t=s.length;a<t;a++){var e=s[a],r=i[e];e==="newMaterial"||e==="scripts"||Array.isArray(r)&&typeof r[0]!="object"&&(["emissiveColor","diffuseColor","specularColor","baseColor"].indexOf(e)!==-1?i[e]=new ne(r[0],r[1],r[2],r[3]):r.length===4?i[e]=new ze(r[0],r[1],r[2],r[3]):r.length===3?i[e]=new w(r[0],r[1],r[2]):r.length===2&&(i[e]=new H(r[0],r[1])))}}var Us=3,Ti=function(){var i=s.prototype;i.parse=function(t){var e;if((t==null||(e=t.config)===null||e===void 0?void 0:e.version)!==Us){var r;console.warn('schema-parser: schema version "'+(t==null||(r=t.config)===null||r===void 0?void 0:r.version)+'" is out of date, please re-pull the latest version (version '+Us+") of the schema")}return yf(t.config),Ff.create(t,this.pluginManager)},i.register=function(t){this.pluginManager.register(t)},i.resetPlugins=function(){this.pluginManager.reset()};function s(){this.pluginManager=new mf}return s.create=function(){var t=new s;return t},s.registerComponents=function(t,e){this._components[t]||(this._components[t]={}),bn(this._components[t],e)},s}();Ti._components={};Ti.create();function Cc(i,s,a){if(!(s===a||a===null||a===void 0)){var t=[i[a],i[s]];i[s]=t[0],i[a]=t[1]}}function St(i){return i&&i.type==="asset"}function Yr(i){for(var s=[],a=Object.getPrototypeOf(i),t=Object.getOwnPropertyDescriptors(a),e=0,r=Object.entries(t);e<r.length;e++){var n=r[e],o=n[0],c=n[1];typeof c.get=="function"&&s.push(o)}return s}var at=function(){var i=s.prototype;i.setMeta=function(){};function s(a,t){this.resourceManager=a,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}return i.loadWithAttachedResources=function(t,e,r){var n=this;return new Promise(function(o,c){n.load(t,e,r).then(function(){o({resources:[n],structure:{index:0,props:{}}})}).catch(function(l){c(l)})})},i.getProps=function(){return{}},i.bind=function(){},i.attach=function(){},i.update=function(t,e){if(St(e)){var r=this.resourceManager.get(e.id);r?this._resource[t]=r.resource:pt.warn("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+e.id)}else this._resource[t]=e},i.updateMeta=function(t,e){this._meta[t]=e},i.onDestroy=function(){},Mi(s,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),s}(),Rc=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){n._resource=r.props||{},n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.props?l=n.load(e,r):c("Load AnimationClip Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}};o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){return this._resource},s}(at),Ec=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.gltf=void 0,t.animatorControllerData=void 0,t.animationClipAssets=void 0,t.animationsIndices=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=r.props||{},l=c.animatorController,u=c.animationClips,h=c.animationsIndices,f=c.gltf;n._resource=new Bn,n.animatorControllerData=l,n.animationsIndices=h||[],n.animationClipAssets=u||[],n.gltf=f,!l&&n._setDefaultDataByAnimationClip(),n.setMetaData("name",r.name),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l=[];n.load(e,r).then(function(){for(var u={resources:[n],structure:{index:0,props:{animationClips:[]}}},h=n.animationsIndices,f=0,d=h.length;f<d;++f){var _=h[f],p=new Rc(n.resourceManager);n.attachedResources.push(p),l.push(p.loadWithAttachedResources(e,{type:"animationClip",name:_.name,props:_}))}Promise.all(l).then(function(v){var g=u.structure.props.animationClips;v.forEach(function(m){var y=m.structure,A=m.resources[y.index];u.resources.push(A),y.index=u.resources.length-1,g.push(y)}),o(u)})})})},a.setMetaData=function(e,r){this._meta[e]=r},a.update=function(e,r){this._initAnimatorController(r)},a.bind=function(){var e=this.animatorControllerData,r=this.animationClipAssets;this._bindClips(r),e?this._initAnimatorController(e):this._setDefaultDataByAnimationClipAsset()},a._initAnimatorController=function(e){var r=this.gltf||{},n=r.animations,o=e.layers;if(!(!n||!o)){this._resource.clearLayers();for(var c=0,l=o.length;c<l;++c){var u=o[c],h=u.name,f=u.blending,d=u.weight,_=u.stateMachine;if(!!_){var p=new Qi(h);p.blendingMode=f,p.weight=d;for(var v=_.states,g=new $i,m=[],y=0,A=v.length;y<A;++y){var S=v[y],C=S.name,P=S.transitions,R=S.clip,T=S.speed,E=S.wrapMode,D=S.clipStartNormalizedTime,B=S.clipEndNormalizedTime,O=S.isDefaultState,G=R||{},L=G.id;if(!!L){var W=g.makeUniqueStateName(C);W!==C&&console.warn("AnimatorState name is existed, name: "+C+" reset to "+W);var K=g.addState(W);K.speed=T,K.wrapMode=E;var Y=this.resourceManager.get(L).resource,U=n[Y.index];if(!!U){K.clip=U,K.clipStartTime=D,K.clipEndTime=B;for(var j=0,oe=P.length;j<oe;++j){var te=P[j];P[j].srcState=K,m.push(te)}O&&(g._defaultState=K)}}}for(var fe=0,me=m.length;fe<me;++fe){var de=m[fe],ye=new yc;ye.duration=de.duration,ye.offset=de.offset,ye.exitTime=de.exitTime,ye.destinationState=g.findStateByName(de.targetStateName),de.srcState.addTransition(ye),delete de.srcState}p.stateMachine=g,this._resource.addLayer(p)}}}},a._bindClips=function(e){for(var r=0,n=e.length;r<n;r++){var o=e[r],c=this.resourceManager.get(o.id);c?this._attachedResources.push(c):""+this.meta.name+o.id}},a._setDefaultDataByAnimationClipAsset=function(){var e=this.animationClipAssets;if(!!e.length){for(var r=[],n=0,o=e.length;n<o;n++){var c=this.resourceManager.get(e[n].id);r.push(c.resource)}this.animationsIndices=r,this._setDefaultDataByAnimationClip()}},a._setDefaultDataByAnimationClip=function(){var e=this.animationsIndices,r=this._resource,n=this.gltf;if(!(!e.length||!n)){var o=n.animations,c=new Qi("layer"),l=new $i;r.addLayer(c),c.stateMachine=l;for(var u=0,h=e.length;u<h;u++){var f=e[u],d=f.name,_=f.index,p=l.makeUniqueStateName(d);p!==d&&console.warn("AnimatorState name is existed, name: "+d+" reset to "+p);var v=l.addState(p);v.clip=o[_]}}},s}(at),Pt=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,n){var o=this;return new Promise(function(c,l){var u,h,f,d,_=Te.Texture2D;if(o.resourceManager.useCompressedTexture&&r!==null&&r!==void 0&&(u=r.props)!==null&&u!==void 0&&(h=u.compression)!==null&&h!==void 0&&h.compressions.length)for(var p=n.engine._hardwareRenderer,v=r.props.compression.compressions,g=0;g<v.length;g++){var m=v[g];if(m.container==="ktx"&&p.canIUse(Q[m.type])){d=m.url,_=Te.KTX;break}}d=(f=d)!=null?f:r.url,e.load({url:d,type:_}).then(function(y){o._resource=y,c(o)}).catch(function(y){l(y)})})},a.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},s}(at),zc=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=new et(e.engine);n.configProps=r.props,n._resource=c;for(var l in n.configProps)St(n.configProps[l])||(c[l]=n.configProps[l]);n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.resource instanceof et?l=new Promise(function(u){n._resource=r.resource,n.setMeta(),u(n)}):r.props?l=n.load(e,r):c("Load BlinnPhongMaterial Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}},h=n._resource;Yr(n._resource).forEach(function(f){if(h[f]instanceof At){var d=new Pt(n.resourceManager,h[f]);n.attachedResources.push(d),u.resources.push(d),u.structure.props[f]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(n){var o=e.configProps[n];if(St(o)){var c=e.resourceManager.get(o.id);c&&c instanceof Pt?(r[n]=c.resource,e._attachedResources.push(c)):(r[n]=null,pt.warn("BlinnPhongMaterialResource: "+e.meta.name+` can't find asset "`+n+'", which id is: '+o.id))}else r[n]=o})},s}(at),Ns=["metallic","roughness","roughnessMetallicTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],Bc=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=new fr(e.engine);n.configProps=r.props;for(var l in n.configProps)St(n.configProps[l])||(c[l]=n.configProps[l]);n._resource=c,n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.resource instanceof fr?l=new Promise(function(u){n._resource=r.resource,n.setMeta(),u(n)}):r.props?l=n.load(e,r):c("Load PBRMaterial Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}},h=n._resource;Ns.forEach(function(f){if(h[f]instanceof At){var d=new Pt(n.resourceManager,h[f]);n.attachedResources.push(d),u.resources.push(d),u.structure.props[f]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={};return Ns.forEach(function(n){return r[n]=e.resource[n]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(n){var o=e.configProps[n];if(St(o)){var c=e.resourceManager.get(o.id);c&&c instanceof Pt?(r[n]=c.resource,e._attachedResources.push(c)):(r[n]=null,pt.warn("PBRMaterialResource: "+e.meta.name+` can't find asset "`+n+'", which id is: '+o.id))}else r[n]=o})},s}(at),Af=["specularColor","glossiness","specularGlossinessTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],Dc=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=new zr(e.engine);n.configProps=r.props,n._resource=c;for(var l in n.configProps)St(n.configProps[l])||(c[l]=n.configProps[l]);n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.resource instanceof zr?l=new Promise(function(u){n._resource=r.resource,n.setMeta(),u(n)}):r.props?l=n.load(e,r):c("Load PBRSpecularMaterial Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}},h=n._resource;Object.keys(n._resource).forEach(function(f){if(h[f]instanceof At){var d=new Pt(n.resourceManager,h[f]);n.attachedResources.push(d),u.resources.push(d),u.structure.props[f]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={};return Af.forEach(function(n){return r[n]=e.resource[n]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(n){var o=e.configProps[n];if(St(o)){var c=e.resourceManager.get(o.id);c&&c instanceof Pt?(r[n]=c.resource,e._attachedResources.push(c)):(r[n]=null,pt.warn("PBRSpecularMaterialResource: "+e.meta.name+` can't find asset "`+n+'", which id is: '+o.id))}else r[n]=o})},s}(at),Oc=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=new Br(e.engine);n.configProps=r.props;for(var l in n.configProps)St(n.configProps[l])||(c[l]=n.configProps[l]);n._resource=c,n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.resource instanceof Br?l=new Promise(function(u){n._resource=r.resource,n.setMeta(),u(n)}):r.props?l=n.load(e,r):c("Load PBRMaterial Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}},h=n._resource;Yr(n._resource).forEach(function(f){if(h[f]instanceof At){var d=new Pt(n.resourceManager,h[f]);n.attachedResources.push(d),u.resources.push(d),u.structure.props[f]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},n=Yr(this.resource);return n.forEach(function(o){return r[o]=e.resource[o]}),r},a.bind=function(){var e=this,r=this._resource;Object.keys(this.configProps).forEach(function(n){var o=e.configProps[n];if(St(o)){var c=e.resourceManager.get(o.id);c&&c instanceof Pt?(r[n]=c.resource,e._attachedResources.push(c)):(r[n]=null,pt.warn("PBRMaterialResource: "+e.meta.name+` can't find asset "`+n+'", which id is: '+o.id))}else r[n]=o})},s}(at),Sf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,n){var o=this;return e.load({url:r.url,type:Te.Prefab}).then(function(c){var l=c;r.props&&(l.newMaterial=r.props.newMaterial,l.animatorControllers=r.props.animatorControllers),o._resource=l})},a.loadWithAttachedResources=function(e,r,n){var o=this;return new Promise(function(c){o.load(e,r,n).then(function(){var l=o.resource,u=l.materials,h=u===void 0?[]:u,f=l._animationsIndices,d=f===void 0?[]:f,_=[],p,v={resources:[o],structure:{index:0,props:{newMaterial:[],animatorControllers:[]}}};if(h!=null&&h.length)for(var g=0;g<h.length;g++){var m=h[g],y=null,A="";m instanceof fr?(y=new Bc(o.resourceManager),A="PBRMaterial"):m instanceof Br?(y=new Oc(o.resourceManager),A="UnlitMaterial"):m instanceof zr?(y=new Dc(o.resourceManager),A="PBRSpecularMaterial"):(y=new zc(o.resourceManager),A="BlinnPhongMaterial"),o._attachedResources.push(y),_.push(y.loadWithAttachedResources(e,{type:A,name:m.name,resource:m}))}if(d.length){var S=new Ec(o.resourceManager);o._attachedResources.push(S),p=S.loadWithAttachedResources(e,{type:"animatorController",name:"AnimatorController",props:{animationsIndices:d,gltf:o._resource}})}var C=Promise.all(_).then(function(R){var T=v.structure.props.newMaterial;R.forEach(function(E){var D=E.structure,B=E.resources[D.index];v.resources.push(B),D.index=v.resources.length-1;for(var O in D.props)if(D.props.hasOwnProperty(O)){var G=D.props[O],L=E.resources[G.index];v.resources.push(L),G.index=v.resources.length-1}T.push(D)})}),P=p?p.then(function(R){var T=v.structure.props.animatorControllers,E=R.structure,D=R.resources[E.index];v.resources.push(D),E.index=v.resources.length-1;var B=E.props.animationClips;if(B)for(var O=0,G=B.length;O<G;++O){var L=B[O],W=R.resources[L.index];v.resources.push(W),L.index=v.resources.length-1}T.push(E)}):Promise.resolve();Promise.all([C,P]).then(function(){c(v)})})})},a.setMeta=function(e){e&&(this.meta.name=e.name)},a.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial),this.bindAnimatorControllers(e.animatorControllers)},a.update=function(e,r){e==="newMaterial"?this.bindMaterials(r):this._resource[e]=r},a.bindMaterials=function(e){var r=e.length;if(!(!e||!e.length)){var n=this._resource,o=new Array(r);n.newMaterial=o;for(var c=0;c<e.length;c++){var l=this.resourceManager.get(e[c].id);l?(this._attachedResources.push(l),o[c]=l.resource):pt.warn("GLTFResource: "+this.meta.name+` can't find asset "material", which id is: `+e[c].id)}for(var u=n.defaultSceneRoot,h=n.materials,f=u.getComponentsIncludeChildren(Zr,[]),d=0;d<r;d++)for(var _=o[d],p=h[d],v=0;v<f.length;v++)for(var g=f[v],m=g.getMaterials(),y=0;y<m.length;y++)p===m[y]&&g.setMaterial(y,_)}},a.bindAnimatorControllers=function(e){for(var r=0,n=e.length;r<n;r++){var o=e[r],c=this.resourceManager.get(o.id);c.gltf=this._resource,c?this._attachedResources.push(c):""+this.meta.name+o.id}},s}(at),Hi={},Pf=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.isInit=!1,t}var a=s.prototype;return a.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:Ti._components.o3,script:function(r){return function(n){Hi[r]=n}}})},a.load=function(e,r,n){var o=this;return this.initScriptContext(),new Promise(function(c){var l=r,u=l.props.scripts;if(o.resourceManager.isLocal){for(var f=0;f<u.length;f++){var d,_=u[f].name;Hi[_]=(d=n.options)===null||d===void 0?void 0:d.scripts[_]}c(o)}else{var h=document.createElement("script");h.crossOrigin="anonymous",o.setMeta(r),h.onload=function(){for(var p=window.o3Scripts,v=0;v<u.length;v++){var g=u[v].name;o._resource=p&&p[g],Hi[g]=o._resource}c(o)},h.src=r.url,document.body.appendChild(h)}})},a.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},s}(at),Fc=function(i){he(s,i);function s(){for(var t,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t=i.call.apply(i,[this].concat(r))||this,t.configProps=void 0,t}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){var c=new zn(e.engine);n.configProps=r.props;var l=n.configProps,u=l.pivotType,h=l.pivot;if(typeof h!="undefined"&&typeof u!="undefined"&&u!==ut.Custom)switch(u){case ut.Center:h.x=.5,h.y=.5;break;case ut.TopLeft:h.x=0,h.y=1;break;case ut.Top:h.x=.5,h.y=1;break;case ut.TopRight:h.x=1,h.y=1;break;case ut.Left:h.x=0,h.y=.5;break;case ut.Right:h.x=1,h.y=.5;break;case ut.BottomLeft:h.x=0,h.y=0;break;case ut.Bottom:h.x=.5,h.y=0;break;case ut.BottomRight:h.x=1,h.y=0;break}for(var f in l)!St(l[f])&&typeof l[f]!="undefined"&&(c[f]=l[f]);n._resource=c,n.setMeta(),o(n)})},a.loadWithAttachedResources=function(e,r){var n=this;return new Promise(function(o,c){var l;r.resource instanceof s?l=new Promise(function(u){n._resource=r.resource,n.setMeta(),u(n)}):r.props?l=n.load(e,r):c("Load Sprite Error"),l&&l.then(function(){var u={resources:[n],structure:{index:0,props:{}}},h=n._resource;Yr(n._resource).forEach(function(f){if(h[f]instanceof At){var d=new Pt(n.resourceManager,h[f]);n.attachedResources.push(d),u.resources.push(d),u.structure.props[f]={index:u.resources.length-1}}}),o(u)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},n=Yr(this.resource);return n.forEach(function(o){return r[o]=e.resource[o]}),r},a.bind=function(){var e=this,r=this._resource;this.configProps&&Object.keys(this.configProps).forEach(function(n){var o=e.configProps[n];if(St(o)){var c=e.resourceManager.get(o.id);c&&c instanceof Pt?(r[n]=c.resource,e._attachedResources.push(c)):(r[n]=null,pt.warn("SpriteResource: "+e.meta.name+` can't find asset "`+n+'", which id is: '+o.id))}else r[n]=o})},s}(at),ut;(function(i){i[i.Center=0]="Center",i[i.TopLeft=1]="TopLeft",i[i.Top=2]="Top",i[i.TopRight=3]="TopRight",i[i.Left=4]="Left",i[i.Right=5]="Right",i[i.BottomLeft=6]="BottomLeft",i[i.Bottom=7]="Bottom",i[i.BottomRight=8]="BottomRight",i[i.Custom=9]="Custom"})(ut||(ut={}));var Vs={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Mf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,n){var o=this;return new Promise(function(c,l){var u,h,f=[],d=Te.TextureCube;if(o.resourceManager.useCompressedTexture&&r!==null&&r!==void 0&&(u=r.props)!==null&&u!==void 0&&(h=u.compression)!==null&&h!==void 0&&h.compressions.length)for(var _=n.engine._hardwareRenderer,p=r.props.compression.compressions,v=0;v<p.length;v++){var g=p[v];if(g.container==="ktx"&&_.canIUse(Q[g.type])){for(var m in g.files)if(g.files.hasOwnProperty(m)){var y=g.files[m];f[Vs[m]]=y.url}console.warn(g.type),d=Te.KTXCube;break}}if(d===Te.TextureCube){for(var A in r.props.images)if(r.props.images.hasOwnProperty(A)){var S=r.props.images[A];f[Vs[A]]=S.url}}e.load({urls:f,type:d}).then(function(C){o._resource=C,c(o)}).catch(function(C){l(C)})})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},s}(at),Tf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){n._resource=r,n.setMetaData("name",n.resource.name),n.setMetaData("url",n.resource.url),o(n)})},a.setMetaData=function(e,r){this._meta[e]=r},s}(at),Cf=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r,n){var o=this;return new Promise(function(c,l){var u=r.url;e.load({url:u,type:Te.Env}).then(function(h){o._resource=h,c(o)}).catch(function(h){l(h)})})},a.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},s}(at);function Rf(i,s){i.isShowCollider=s.isShowCollider;for(var a=s.colliderShapes,t=0;t<a.length;t++){var e=a[t];switch(e._shapes){case"BoxColliderShape":{var r=new fl;e.size&&r.setSize(e.size[0],e.size[1],e.size[2]),e.position&&r.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(r.isTrigger=e.isTrigger),i.addShape(r);break}case"CapsuleColliderShape":{var n=new vl;if(e.radius&&(n.radius=e.radius),e.height&&(n.height=e.height),e.upAxis)switch(e.upAxis){case"X":n.upAxis=Pr.X;break;case"Y":n.upAxis=Pr.Y;break;case"Z":n.upAxis=Pr.Z;break}e.position&&n.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(n.isTrigger=e.isTrigger),i.addShape(n);break}case"PlaneColliderShape":{var o=new _l;e.rotation&&o.setRotation(e.rotation[0],e.rotation[1],e.rotation[2]),e.position&&o.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(o.isTrigger=e.isTrigger),i.addShape(o);break}case"SphereColliderShape":{var c=new dl;e.radius&&(c.radius=e.radius),e.position&&c.setPosition(e.position[0],e.position[1],e.position[2]),e.isTrigger&&(c.isTrigger=e.isTrigger),i.addShape(c);break}}}if(i instanceof ac){var l=s.force;l&&i.applyForce(new w(l[0],l[1],l[2]));var u=s.torque;u&&i.applyTorque(new w(u[0],u[1],u[2]))}}var ks,Gs,Hs,gt,Ef=(ks=It({after:"abilityAdded",before:"beforeAbilityAdded"}),Gs=It({before:"beforeAbilityUpdated",after:"abilityUpdated"}),Hs=It({after:"abilityDeleted",before:"beforeAbilityDeleted"}),gt=function(){function i(a){this.oasis=a,this.abilityMap={}}var s=i.prototype;return s.add=function(t){var e=t.type,r=t.node,n=t.props,o=t.id,c=t.index,l=this.oasis.nodeManager.get(r),u=this.getCompConstructor(e);if(!!u){var h=this.mixPropsToExplicitProps(n),f=l.addComponent(u),d=h.enabled;if(d!==void 0&&(f.enabled=d),e==="GLTFModel")f.init(h);else if(e==="Model")f.setProps(h),h.material&&(f.material=h.material);else if(e==="StaticCollider"||e==="DynamicCollider")Rf(f,h);else for(var _ in h)h[_]!==null&&(f[_]=h[_]);var p=l._components,v=p.length-1;return Cc(p,v,c),f.id=o,this.abilityMap[o]=f,f}},s.update=function(t,e,r){return r&&this.checkIsAsset(r)?this.get(t)[e]=this.oasis.resourceManager.get(r.id).resource:this.get(t).constructor===Tc?this.get(t).updateProp(e,r):this.get(t)[e]=r,{id:t,key:e,value:r}},s.addRuntimeComponent=function(t,e){return e.id=t,this.abilityMap[t]=e,e},s.get=function(t){return this.abilityMap[t]},s.delete=function(t){var e=this.abilityMap[t];return e.destroy(),delete this.abilityMap[t],t},s.getCompConstructor=function(t){var e=t.split(".");if(e[0]==="script")return Hi[e[1]];var r=Ti._components.o3[t];return r||console.warn(t+" is not defined"),r},s.mixPropsToExplicitProps=function(t){var e=He({},t);for(var r in t){var n=t[r];if(n&&this.checkIsAsset(n)){var o=this.oasis.resourceManager.get(n.id);o?e[r]=o.resource:(e[r]=null,pt.warn(`AbilityManager: can't get asset "`+r+'", which id is '+n.id))}}return e},s.checkIsAsset=function(t){return t.type==="asset"},i}(),Ft(gt.prototype,"add",[ks],Object.getOwnPropertyDescriptor(gt.prototype,"add"),gt.prototype),Ft(gt.prototype,"update",[Gs],Object.getOwnPropertyDescriptor(gt.prototype,"update"),gt.prototype),Ft(gt.prototype,"delete",[Hs],Object.getOwnPropertyDescriptor(gt.prototype,"delete"),gt.prototype),gt),Ws,Xs,js,mt,zf=(Ws=It({after:"nodeAdded"}),Xs=It({before:"beforeNodeUpdated",after:"nodeUpdated"}),js=It({before:"beforeNodeDeleted"}),mt=function(){function i(a){this.oasis=a,this.nodeMap={},this.root=void 0,this.root=new Kt(this.oasis.engine,"root")}var s=i.prototype;return s.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},s.add=function(t){return this.create(t),this.append(t.id,t.parent,t.index),this.get(t.id)},s.update=function(t,e,r){return this.get(t)[e]=r,{id:t,key:e,value:r}},s.get=function(t){return this.nodeMap[t]},s.reset=function(){this.nodeMap={}},s.delete=function(t){this.nodeMap[t].destroy(),delete this.nodeMap[t]},s.create=function(t){var e=t.isActive,r=t.position,n=t.rotation,o=t.scale,c=t.id,l=t.name,u=new Kt(this.oasis.engine,l);return u.isActive=e,u.transform.position=new w(r[0],r[1],r[2]),u.transform.rotation=new w(n[0],n[1],n[2]),u.transform.scale=new w(o[0],o[1],o[2]),u.id=c,this.nodeMap[c]=u,u},s.append=function(t,e,r){var n=this.nodeMap[t],o=this.nodeMap[e]||this.root;o.addChild(n);var c=o._children,l=c.length-1;Cc(c,l,r)},i}(),Ft(mt.prototype,"add",[Ws],Object.getOwnPropertyDescriptor(mt.prototype,"add"),mt.prototype),Ft(mt.prototype,"update",[Xs],Object.getOwnPropertyDescriptor(mt.prototype,"update"),mt.prototype),Ft(mt.prototype,"delete",[js],Object.getOwnPropertyDescriptor(mt.prototype,"delete"),mt.prototype),mt),Ks,ai,Bf=(Ks=It({before:"beforeSceneUpdated",after:"sceneUpdated"}),ai=function(){function i(a){this.oasis=a}var s=i.prototype;return s.init=function(){var t=this,e=this.oasis.options.config.scene;e&&Object.keys(e).forEach(function(r){var n=e[r];Object.keys(n.props).forEach(function(o){var c=n.props[o];t.setProp(r,o,c)})})},s.update=function(t,e,r){return this.setProp(t,e,r),{field:t,key:e,value:r}},s.setProp=function(t,e,r){var n=this.oasis.engine.sceneManager.activeScene;if(t==="background"&&e==="skyboxTexture"){var o=n.background.sky;if(r){o.mesh=Hr.createCuboid(n.engine,2,2,2);var c=new xc(n.engine);c.textureCubeMap=this.oasis.resourceManager.get(r.id).resource,o.material=c}else o.mesh=null,o.material=null}else if(n[t]&&t==="ambientLight"&&e==="specularTexture")if(r&&r.type==="asset"){var l=this.oasis.resourceManager.get(r.id).resource;n.ambientLight.specularTexture=l.specularTexture,n.ambientLight.diffuseSphericalHarmonics=l.diffuseSphericalHarmonics,n.ambientLight.diffuseMode=Rr.SphericalHarmonics,n.ambientLight.specularTextureDecodeRGBM=!0}else n.ambientLight.specularTexture=null,n.ambientLight.diffuseMode=Rr.SolidColor;else n[t]&&(r&&r.type==="asset"?n[t][e]=this.oasis.resourceManager.get(r.id).resource:n[t][e]=r)},i}(),Ft(ai.prototype,"update",[Ks],Object.getOwnPropertyDescriptor(ai.prototype,"update"),ai.prototype),ai),Ic=function(i){he(s,i);function s(){return i.apply(this,arguments)||this}var a=s.prototype;return a.load=function(e,r){var n=this;return new Promise(function(o){n.setMeta(),r.source?e.load({url:r.source,type:Te.SpriteAtlas}).then(function(c){n._resource=c;for(var l=c.sprites,u=n.resourceManager,h=l.length-1;h>=0;h--){var f=l[h],d=new Fc(u,f),_=f._assetID;u.maxId=Math.max(_,u.maxId),u.resourceMap[_]=d,u.resourceIdMap.set(d,""+_)}o(n)}):(s.defaultAtlas||(s.defaultAtlas=new mc(e.engine)),n._resource=s.defaultAtlas,o(n))})},a.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},a.getProps=function(){var e=this,r={},n=Yr(this.resource);return n.forEach(function(o){return r[o]=e.resource[o]}),r},a.update=function(){},s}(at);Ic.defaultAtlas=void 0;var qs,Ys,or,di={script:Pf,gltf:Sf,texture:Pt,cubeTexture:Mf,PBRMaterial:Bc,PBRSpecularMaterial:Dc,UnlitMaterial:Oc,BlinnPhongMaterial:zc,base:Tf,sprite:Fc,SpriteAtlas:Ic,animatorController:Ec,animationClip:Rc,environment:Cf},Lc=new Map;for(var fn in di)if(di.hasOwnProperty(fn)){var Df=di[fn];Lc.set(Df,fn)}var Qs={createResource:function(s,a){return new di[a](s)}},Of=(qs=It({before:"beforeResourceRemove"}),Ys=It({after:"resourceUpdated",before:"beforeResourceUpdate"}),or=function(){function i(a){this.oasis=a,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=void 0,this.engineResourceManager=this.oasis.engine.resourceManager}var s=i.prototype;return s.load=function(t){var e=this,r=Qs.createResource(this,t.type),n=r.load(this.oasis.engine.resourceManager,t,this.oasis);return this.maxId=Math.max(+t.id,this.maxId),n.then(function(){e.resourceMap[t.id]=r,e.resourceIdMap.set(r,t.id)}),n},s.add=function(t){var e=this,r=Qs.createResource(this,t.type);return new Promise(function(n){r.loadWithAttachedResources(e.oasis.engine.resourceManager,t,e.oasis).then(function(o){n(e.getAddResourceResult(o.resources,o.structure))})})},s.remove=function(t){var e=this;return new Promise(function(r){var n=e.resourceMap[t],o=[t],c=!1;if(delete e.resourceMap[t],n)for(var l=n.attachedResources,u=0;u<l.length;u++){var h=l[u],f=e.resourceIdMap.get(h);f&&(c=!0,e.remove(f).then(function(d){o.push.apply(o,d),r(o)}))}c||r(o)})},s.update=function(t,e,r){var n=this.get(t);return n&&n.update(e,r),{resource:n,id:t,key:e,value:r}},s.updateMeta=function(t,e,r){var n=this.get(t);n&&n.updateMeta(e,r)},s.get=function(t){return this.resourceMap[t]},s.getAll=function(){return pi(this.resourceMap)},s.getAddResourceResult=function(t,e){var r=this,n={},o=t[e.index],c=""+ ++this.maxId;this.resourceMap[c]=o,this.resourceIdMap.set(o,c),n.id=this.maxId,n.type=Lc.get(o.constructor),n.meta=o.meta,n.props={};for(var l in e.props)if(e.props.hasOwnProperty(l)){var u=e.props[l];u&&(Array.isArray(u)?n.props[l]=u.map(function(h){return r.getAddResourceResult(t,h)}):n.props[l]=this.getAddResourceResult(t,u))}return n},Mi(i,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var t;return(t=this.oasis.options.useCompressedTexture)!=null?t:!0}}]),i}(),Ft(or.prototype,"remove",[qs],Object.getOwnPropertyDescriptor(or.prototype,"remove"),or.prototype),Ft(or.prototype,"update",[Ys],Object.getOwnPropertyDescriptor(or.prototype,"update"),or.prototype),or),$s,oi,Ff=($s=It({after:"schemaParsed"}),oi=function(i){he(s,i);function s(t,e){var r,n;return n=i.call(this)||this,n._options=t,n.pluginManager=e,n.nodeManager=void 0,n.abilityManager=void 0,n.sceneManager=void 0,n.resourceManager=void 0,n._canvas=void 0,n.schema=void 0,n.timeout=void 0,n.oasis=ni(n),n.engine=void 0,n.engine=t.engine,n.schema=t.config,n.timeout=t.timeout,t.scripts=(r=t.scripts)!=null?r:{},n.nodeManager=new zf(ni(n)),n.abilityManager=new Ef(ni(n)),n.nodeManager.add=n.nodeManager.add.bind(n.nodeManager),n.abilityManager.add=n.abilityManager.add.bind(n.abilityManager),n.resourceManager=new Of(ni(n)),n.sceneManager=new Bf(ni(n)),t.fps&&(n.engine.targetFrameRate=t.fps,n.engine.vSyncCount=0),n}var a=s.prototype;return a.updateConfig=function(e){this.schema=e,this.init()},a.init=function(){var e=this;return this.loadResources().then(function(){e.bindResources(),e.parseEntities(),e.attach(),e.nodeManager.addRootEntity(),e.sceneManager.init(),e.parseNodeAbilities(),e.pluginManager.boot(e)})},a.loadResources=function(){var e=this,r=this.schema.assets,n=r===void 0?{}:r,o=pi(n).filter(function(c){return di[c.type]?!0:(console.warn(c.type+" loader is not defined. the "+c.type+" type will be ignored."),!1)}).map(function(c){return e.resourceManager.load(c)});return Promise.all(o)},a.bindResources=function(){this.resourceManager.getAll().forEach(function(e){e.bind()})},a.parseEntities=function(){var e=this.schema.nodes,r=this.bfsNodes();r.map(function(n){return e[n]}).forEach(this.nodeManager.add)},a.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map(function(r){return He({id:r},e[r])}).forEach(this.abilityManager.add)},a.bfsNodes=function(){var e=this.schema.nodes,r=pi(e).filter(function(c){return!e[c.parent]}).map(function(c){return c.id}),n=[],o=function c(l){n=n.concat(l),l.forEach(function(u){var h=e[u].children;h&&c(h)})};return o(r),n},a.attach=function(){this.resourceManager.getAll().forEach(function(e){e.attach()})},s.create=function(e,r){var n=new s(e,r);return n.init().then(function(){return e.autoPlay&&n.engine.run(),n})},Mi(s,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),s}(rc),Ft(oi.prototype,"init",[$s],Object.getOwnPropertyDescriptor(oi.prototype,"init"),oi.prototype),oi);Ti.registerComponents("o3",{GLTFModel:gf,SpriteRenderer:_h,SpriteMask:mn,PointLight:Zt,AmbientLight:lt,DirectLight:Ut,ParticleRenderer:bc,Camera:En,Model:Tc,Component:Mt,StaticCollider:pl,DynamicCollider:ac,Animator:Dr});var If="0.6.8";console.log("oasis engine version: "+If);var Uc={exports:{}};(function(i){(function(s){var a=/^\s+/,t=/\s+$/,e=0,r=s.round,n=s.min,o=s.max,c=s.random;function l(x,M){if(x=x||"",M=M||{},x instanceof l)return x;if(!(this instanceof l))return new l(x,M);var b=u(x);this._originalInput=x,this._r=b.r,this._g=b.g,this._b=b.b,this._a=b.a,this._roundA=r(100*this._a)/100,this._format=M.format||b.format,this._gradientType=M.gradientType,this._r<1&&(this._r=r(this._r)),this._g<1&&(this._g=r(this._g)),this._b<1&&(this._b=r(this._b)),this._ok=b.ok,this._tc_id=e++}l.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var x=this.toRgb();return(x.r*299+x.g*587+x.b*114)/1e3},getLuminance:function(){var x=this.toRgb(),M,b,I,q,X,re;return M=x.r/255,b=x.g/255,I=x.b/255,M<=.03928?q=M/12.92:q=s.pow((M+.055)/1.055,2.4),b<=.03928?X=b/12.92:X=s.pow((b+.055)/1.055,2.4),I<=.03928?re=I/12.92:re=s.pow((I+.055)/1.055,2.4),.2126*q+.7152*X+.0722*re},setAlpha:function(x){return this._a=U(x),this._roundA=r(100*this._a)/100,this},toHsv:function(){var x=_(this._r,this._g,this._b);return{h:x.h*360,s:x.s,v:x.v,a:this._a}},toHsvString:function(){var x=_(this._r,this._g,this._b),M=r(x.h*360),b=r(x.s*100),I=r(x.v*100);return this._a==1?"hsv("+M+", "+b+"%, "+I+"%)":"hsva("+M+", "+b+"%, "+I+"%, "+this._roundA+")"},toHsl:function(){var x=f(this._r,this._g,this._b);return{h:x.h*360,s:x.s,l:x.l,a:this._a}},toHslString:function(){var x=f(this._r,this._g,this._b),M=r(x.h*360),b=r(x.s*100),I=r(x.l*100);return this._a==1?"hsl("+M+", "+b+"%, "+I+"%)":"hsla("+M+", "+b+"%, "+I+"%, "+this._roundA+")"},toHex:function(x){return v(this._r,this._g,this._b,x)},toHexString:function(x){return"#"+this.toHex(x)},toHex8:function(x){return g(this._r,this._g,this._b,this._a,x)},toHex8String:function(x){return"#"+this.toHex8(x)},toRgb:function(){return{r:r(this._r),g:r(this._g),b:r(this._b),a:this._a}},toRgbString:function(){return this._a==1?"rgb("+r(this._r)+", "+r(this._g)+", "+r(this._b)+")":"rgba("+r(this._r)+", "+r(this._g)+", "+r(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:r(j(this._r,255)*100)+"%",g:r(j(this._g,255)*100)+"%",b:r(j(this._b,255)*100)+"%",a:this._a}},toPercentageRgbString:function(){return this._a==1?"rgb("+r(j(this._r,255)*100)+"%, "+r(j(this._g,255)*100)+"%, "+r(j(this._b,255)*100)+"%)":"rgba("+r(j(this._r,255)*100)+"%, "+r(j(this._g,255)*100)+"%, "+r(j(this._b,255)*100)+"%, "+this._roundA+")"},toName:function(){return this._a===0?"transparent":this._a<1?!1:K[v(this._r,this._g,this._b,!0)]||!1},toFilter:function(x){var M="#"+m(this._r,this._g,this._b,this._a),b=M,I=this._gradientType?"GradientType = 1, ":"";if(x){var q=l(x);b="#"+m(q._r,q._g,q._b,q._a)}return"progid:DXImageTransform.Microsoft.gradient("+I+"startColorstr="+M+",endColorstr="+b+")"},toString:function(x){var M=!!x;x=x||this._format;var b=!1,I=this._a<1&&this._a>=0,q=!M&&I&&(x==="hex"||x==="hex6"||x==="hex3"||x==="hex4"||x==="hex8"||x==="name");return q?x==="name"&&this._a===0?this.toName():this.toRgbString():(x==="rgb"&&(b=this.toRgbString()),x==="prgb"&&(b=this.toPercentageRgbString()),(x==="hex"||x==="hex6")&&(b=this.toHexString()),x==="hex3"&&(b=this.toHexString(!0)),x==="hex4"&&(b=this.toHex8String(!0)),x==="hex8"&&(b=this.toHex8String()),x==="name"&&(b=this.toName()),x==="hsl"&&(b=this.toHslString()),x==="hsv"&&(b=this.toHsvString()),b||this.toHexString())},clone:function(){return l(this.toString())},_applyModification:function(x,M){var b=x.apply(null,[this].concat([].slice.call(M)));return this._r=b._r,this._g=b._g,this._b=b._b,this.setAlpha(b._a),this},lighten:function(){return this._applyModification(C,arguments)},brighten:function(){return this._applyModification(P,arguments)},darken:function(){return this._applyModification(R,arguments)},desaturate:function(){return this._applyModification(y,arguments)},saturate:function(){return this._applyModification(A,arguments)},greyscale:function(){return this._applyModification(S,arguments)},spin:function(){return this._applyModification(T,arguments)},_applyCombination:function(x,M){return x.apply(null,[this].concat([].slice.call(M)))},analogous:function(){return this._applyCombination(G,arguments)},complement:function(){return this._applyCombination(E,arguments)},monochromatic:function(){return this._applyCombination(L,arguments)},splitcomplement:function(){return this._applyCombination(O,arguments)},triad:function(){return this._applyCombination(D,arguments)},tetrad:function(){return this._applyCombination(B,arguments)}},l.fromRatio=function(x,M){if(typeof x=="object"){var b={};for(var I in x)x.hasOwnProperty(I)&&(I==="a"?b[I]=x[I]:b[I]=ye(x[I]));x=b}return l(x,M)};function u(x){var M={r:0,g:0,b:0},b=1,I=null,q=null,X=null,re=!1,se=!1;return typeof x=="string"&&(x=Ye(x)),typeof x=="object"&&(Pe(x.r)&&Pe(x.g)&&Pe(x.b)?(M=h(x.r,x.g,x.b),re=!0,se=String(x.r).substr(-1)==="%"?"prgb":"rgb"):Pe(x.h)&&Pe(x.s)&&Pe(x.v)?(I=ye(x.s),q=ye(x.v),M=p(x.h,I,q),re=!0,se="hsv"):Pe(x.h)&&Pe(x.s)&&Pe(x.l)&&(I=ye(x.s),X=ye(x.l),M=d(x.h,I,X),re=!0,se="hsl"),x.hasOwnProperty("a")&&(b=x.a)),b=U(b),{ok:re,format:x.format||se,r:n(255,o(M.r,0)),g:n(255,o(M.g,0)),b:n(255,o(M.b,0)),a:b}}function h(x,M,b){return{r:j(x,255)*255,g:j(M,255)*255,b:j(b,255)*255}}function f(x,M,b){x=j(x,255),M=j(M,255),b=j(b,255);var I=o(x,M,b),q=n(x,M,b),X,re,se=(I+q)/2;if(I==q)X=re=0;else{var be=I-q;switch(re=se>.5?be/(2-I-q):be/(I+q),I){case x:X=(M-b)/be+(M<b?6:0);break;case M:X=(b-x)/be+2;break;case b:X=(x-M)/be+4;break}X/=6}return{h:X,s:re,l:se}}function d(x,M,b){var I,q,X;x=j(x,360),M=j(M,100),b=j(b,100);function re(De,Ct,Fe){return Fe<0&&(Fe+=1),Fe>1&&(Fe-=1),Fe<1/6?De+(Ct-De)*6*Fe:Fe<1/2?Ct:Fe<2/3?De+(Ct-De)*(2/3-Fe)*6:De}if(M===0)I=q=X=b;else{var se=b<.5?b*(1+M):b+M-b*M,be=2*b-se;I=re(be,se,x+1/3),q=re(be,se,x),X=re(be,se,x-1/3)}return{r:I*255,g:q*255,b:X*255}}function _(x,M,b){x=j(x,255),M=j(M,255),b=j(b,255);var I=o(x,M,b),q=n(x,M,b),X,re,se=I,be=I-q;if(re=I===0?0:be/I,I==q)X=0;else{switch(I){case x:X=(M-b)/be+(M<b?6:0);break;case M:X=(b-x)/be+2;break;case b:X=(x-M)/be+4;break}X/=6}return{h:X,s:re,v:se}}function p(x,M,b){x=j(x,360)*6,M=j(M,100),b=j(b,100);var I=s.floor(x),q=x-I,X=b*(1-M),re=b*(1-q*M),se=b*(1-(1-q)*M),be=I%6,De=[b,re,X,X,se,b][be],Ct=[se,b,b,re,X,X][be],Fe=[X,X,se,b,b,re][be];return{r:De*255,g:Ct*255,b:Fe*255}}function v(x,M,b,I){var q=[de(r(x).toString(16)),de(r(M).toString(16)),de(r(b).toString(16))];return I&&q[0].charAt(0)==q[0].charAt(1)&&q[1].charAt(0)==q[1].charAt(1)&&q[2].charAt(0)==q[2].charAt(1)?q[0].charAt(0)+q[1].charAt(0)+q[2].charAt(0):q.join("")}function g(x,M,b,I,q){var X=[de(r(x).toString(16)),de(r(M).toString(16)),de(r(b).toString(16)),de(ge(I))];return q&&X[0].charAt(0)==X[0].charAt(1)&&X[1].charAt(0)==X[1].charAt(1)&&X[2].charAt(0)==X[2].charAt(1)&&X[3].charAt(0)==X[3].charAt(1)?X[0].charAt(0)+X[1].charAt(0)+X[2].charAt(0)+X[3].charAt(0):X.join("")}function m(x,M,b,I){var q=[de(ge(I)),de(r(x).toString(16)),de(r(M).toString(16)),de(r(b).toString(16))];return q.join("")}l.equals=function(x,M){return!x||!M?!1:l(x).toRgbString()==l(M).toRgbString()},l.random=function(){return l.fromRatio({r:c(),g:c(),b:c()})};function y(x,M){M=M===0?0:M||10;var b=l(x).toHsl();return b.s-=M/100,b.s=oe(b.s),l(b)}function A(x,M){M=M===0?0:M||10;var b=l(x).toHsl();return b.s+=M/100,b.s=oe(b.s),l(b)}function S(x){return l(x).desaturate(100)}function C(x,M){M=M===0?0:M||10;var b=l(x).toHsl();return b.l+=M/100,b.l=oe(b.l),l(b)}function P(x,M){M=M===0?0:M||10;var b=l(x).toRgb();return b.r=o(0,n(255,b.r-r(255*-(M/100)))),b.g=o(0,n(255,b.g-r(255*-(M/100)))),b.b=o(0,n(255,b.b-r(255*-(M/100)))),l(b)}function R(x,M){M=M===0?0:M||10;var b=l(x).toHsl();return b.l-=M/100,b.l=oe(b.l),l(b)}function T(x,M){var b=l(x).toHsl(),I=(b.h+M)%360;return b.h=I<0?360+I:I,l(b)}function E(x){var M=l(x).toHsl();return M.h=(M.h+180)%360,l(M)}function D(x){var M=l(x).toHsl(),b=M.h;return[l(x),l({h:(b+120)%360,s:M.s,l:M.l}),l({h:(b+240)%360,s:M.s,l:M.l})]}function B(x){var M=l(x).toHsl(),b=M.h;return[l(x),l({h:(b+90)%360,s:M.s,l:M.l}),l({h:(b+180)%360,s:M.s,l:M.l}),l({h:(b+270)%360,s:M.s,l:M.l})]}function O(x){var M=l(x).toHsl(),b=M.h;return[l(x),l({h:(b+72)%360,s:M.s,l:M.l}),l({h:(b+216)%360,s:M.s,l:M.l})]}function G(x,M,b){M=M||6,b=b||30;var I=l(x).toHsl(),q=360/b,X=[l(x)];for(I.h=(I.h-(q*M>>1)+720)%360;--M;)I.h=(I.h+q)%360,X.push(l(I));return X}function L(x,M){M=M||6;for(var b=l(x).toHsv(),I=b.h,q=b.s,X=b.v,re=[],se=1/M;M--;)re.push(l({h:I,s:q,v:X})),X=(X+se)%1;return re}l.mix=function(x,M,b){b=b===0?0:b||50;var I=l(x).toRgb(),q=l(M).toRgb(),X=b/100,re={r:(q.r-I.r)*X+I.r,g:(q.g-I.g)*X+I.g,b:(q.b-I.b)*X+I.b,a:(q.a-I.a)*X+I.a};return l(re)},l.readability=function(x,M){var b=l(x),I=l(M);return(s.max(b.getLuminance(),I.getLuminance())+.05)/(s.min(b.getLuminance(),I.getLuminance())+.05)},l.isReadable=function(x,M,b){var I=l.readability(x,M),q,X;switch(X=!1,q=Le(b),q.level+q.size){case"AAsmall":case"AAAlarge":X=I>=4.5;break;case"AAlarge":X=I>=3;break;case"AAAsmall":X=I>=7;break}return X},l.mostReadable=function(x,M,b){var I=null,q=0,X,re,se,be;b=b||{},re=b.includeFallbackColors,se=b.level,be=b.size;for(var De=0;De<M.length;De++)X=l.readability(x,M[De]),X>q&&(q=X,I=l(M[De]));return l.isReadable(x,I,{level:se,size:be})||!re?I:(b.includeFallbackColors=!1,l.mostReadable(x,["#fff","#000"],b))};var W=l.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},K=l.hexNames=Y(W);function Y(x){var M={};for(var b in x)x.hasOwnProperty(b)&&(M[x[b]]=b);return M}function U(x){return x=parseFloat(x),(isNaN(x)||x<0||x>1)&&(x=1),x}function j(x,M){fe(x)&&(x="100%");var b=me(x);return x=n(M,o(0,parseFloat(x))),b&&(x=parseInt(x*M,10)/100),s.abs(x-M)<1e-6?1:x%M/parseFloat(M)}function oe(x){return n(1,o(0,x))}function te(x){return parseInt(x,16)}function fe(x){return typeof x=="string"&&x.indexOf(".")!=-1&&parseFloat(x)===1}function me(x){return typeof x=="string"&&x.indexOf("%")!=-1}function de(x){return x.length==1?"0"+x:""+x}function ye(x){return x<=1&&(x=x*100+"%"),x}function ge(x){return s.round(parseFloat(x)*255).toString(16)}function Re(x){return te(x)/255}var Ae=function(){var x="[-\\+]?\\d+%?",M="[-\\+]?\\d*\\.\\d+%?",b="(?:"+M+")|(?:"+x+")",I="[\\s|\\(]+("+b+")[,|\\s]+("+b+")[,|\\s]+("+b+")\\s*\\)?",q="[\\s|\\(]+("+b+")[,|\\s]+("+b+")[,|\\s]+("+b+")[,|\\s]+("+b+")\\s*\\)?";return{CSS_UNIT:new RegExp(b),rgb:new RegExp("rgb"+I),rgba:new RegExp("rgba"+q),hsl:new RegExp("hsl"+I),hsla:new RegExp("hsla"+q),hsv:new RegExp("hsv"+I),hsva:new RegExp("hsva"+q),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();function Pe(x){return!!Ae.CSS_UNIT.exec(x)}function Ye(x){x=x.replace(a,"").replace(t,"").toLowerCase();var M=!1;if(W[x])x=W[x],M=!0;else if(x=="transparent")return{r:0,g:0,b:0,a:0,format:"name"};var b;return(b=Ae.rgb.exec(x))?{r:b[1],g:b[2],b:b[3]}:(b=Ae.rgba.exec(x))?{r:b[1],g:b[2],b:b[3],a:b[4]}:(b=Ae.hsl.exec(x))?{h:b[1],s:b[2],l:b[3]}:(b=Ae.hsla.exec(x))?{h:b[1],s:b[2],l:b[3],a:b[4]}:(b=Ae.hsv.exec(x))?{h:b[1],s:b[2],v:b[3]}:(b=Ae.hsva.exec(x))?{h:b[1],s:b[2],v:b[3],a:b[4]}:(b=Ae.hex8.exec(x))?{r:te(b[1]),g:te(b[2]),b:te(b[3]),a:Re(b[4]),format:M?"name":"hex8"}:(b=Ae.hex6.exec(x))?{r:te(b[1]),g:te(b[2]),b:te(b[3]),format:M?"name":"hex"}:(b=Ae.hex4.exec(x))?{r:te(b[1]+""+b[1]),g:te(b[2]+""+b[2]),b:te(b[3]+""+b[3]),a:Re(b[4]+""+b[4]),format:M?"name":"hex8"}:(b=Ae.hex3.exec(x))?{r:te(b[1]+""+b[1]),g:te(b[2]+""+b[2]),b:te(b[3]+""+b[3]),format:M?"name":"hex"}:!1}function Le(x){var M,b;return x=x||{level:"AA",size:"small"},M=(x.level||"AA").toUpperCase(),b=(x.size||"small").toLowerCase(),M!=="AA"&&M!=="AAA"&&(M="AA"),b!=="small"&&b!=="large"&&(b="small"),{level:M,size:b}}i.exports?i.exports=l:window.tinycolor=l})(Math)})(Uc);var dn=Uc.exports,Kr={Linear:{None:function(i){return i}},Quadratic:{In:function(i){return i*i},Out:function(i){return i*(2-i)},InOut:function(i){return(i*=2)<1?.5*i*i:-.5*(--i*(i-2)-1)}},Cubic:{In:function(i){return i*i*i},Out:function(i){return--i*i*i+1},InOut:function(i){return(i*=2)<1?.5*i*i*i:.5*((i-=2)*i*i+2)}},Quartic:{In:function(i){return i*i*i*i},Out:function(i){return 1- --i*i*i*i},InOut:function(i){return(i*=2)<1?.5*i*i*i*i:-.5*((i-=2)*i*i*i-2)}},Quintic:{In:function(i){return i*i*i*i*i},Out:function(i){return--i*i*i*i*i+1},InOut:function(i){return(i*=2)<1?.5*i*i*i*i*i:.5*((i-=2)*i*i*i*i+2)}},Sinusoidal:{In:function(i){return 1-Math.cos(i*Math.PI/2)},Out:function(i){return Math.sin(i*Math.PI/2)},InOut:function(i){return .5*(1-Math.cos(Math.PI*i))}},Exponential:{In:function(i){return i===0?0:Math.pow(1024,i-1)},Out:function(i){return i===1?1:1-Math.pow(2,-10*i)},InOut:function(i){return i===0?0:i===1?1:(i*=2)<1?.5*Math.pow(1024,i-1):.5*(-Math.pow(2,-10*(i-1))+2)}},Circular:{In:function(i){return 1-Math.sqrt(1-i*i)},Out:function(i){return Math.sqrt(1- --i*i)},InOut:function(i){return(i*=2)<1?-.5*(Math.sqrt(1-i*i)-1):.5*(Math.sqrt(1-(i-=2)*i)+1)}},Elastic:{In:function(i){return i===0?0:i===1?1:-Math.pow(2,10*(i-1))*Math.sin((i-1.1)*5*Math.PI)},Out:function(i){return i===0?0:i===1?1:Math.pow(2,-10*i)*Math.sin((i-.1)*5*Math.PI)+1},InOut:function(i){return i===0?0:i===1?1:(i*=2,i<1?-.5*Math.pow(2,10*(i-1))*Math.sin((i-1.1)*5*Math.PI):.5*Math.pow(2,-10*(i-1))*Math.sin((i-1.1)*5*Math.PI)+1)}},Back:{In:function(i){var s=1.70158;return i*i*((s+1)*i-s)},Out:function(i){var s=1.70158;return--i*i*((s+1)*i+s)+1},InOut:function(i){var s=2.5949095;return(i*=2)<1?.5*(i*i*((s+1)*i-s)):.5*((i-=2)*i*((s+1)*i+s)+2)}},Bounce:{In:function(i){return 1-Kr.Bounce.Out(1-i)},Out:function(i){return i<1/2.75?7.5625*i*i:i<2/2.75?7.5625*(i-=1.5/2.75)*i+.75:i<2.5/2.75?7.5625*(i-=2.25/2.75)*i+.9375:7.5625*(i-=2.625/2.75)*i+.984375},InOut:function(i){return i<.5?Kr.Bounce.In(i*2)*.5:Kr.Bounce.Out(i*2-1)*.5+.5}}},ci;typeof self=="undefined"&&typeof process!="undefined"&&process.hrtime?ci=function(){var i=process.hrtime();return i[0]*1e3+i[1]/1e6}:typeof self!="undefined"&&self.performance!==void 0&&self.performance.now!==void 0?ci=self.performance.now.bind(self.performance):Date.now!==void 0?ci=Date.now:ci=function(){return new Date().getTime()};var kr=ci,Lf=function(){function i(){this._tweens={},this._tweensAddedDuringUpdate={}}return i.prototype.getAll=function(){var s=this;return Object.keys(this._tweens).map(function(a){return s._tweens[a]})},i.prototype.removeAll=function(){this._tweens={}},i.prototype.add=function(s){this._tweens[s.getId()]=s,this._tweensAddedDuringUpdate[s.getId()]=s},i.prototype.remove=function(s){delete this._tweens[s.getId()],delete this._tweensAddedDuringUpdate[s.getId()]},i.prototype.update=function(s,a){s===void 0&&(s=kr()),a===void 0&&(a=!1);var t=Object.keys(this._tweens);if(t.length===0)return!1;for(;t.length>0;){this._tweensAddedDuringUpdate={};for(var e=0;e<t.length;e++){var r=this._tweens[t[e]],n=!a;r&&r.update(s,n)===!1&&!a&&delete this._tweens[t[e]]}t=Object.keys(this._tweensAddedDuringUpdate)}return!0},i}(),li={Linear:function(i,s){var a=i.length-1,t=a*s,e=Math.floor(t),r=li.Utils.Linear;return s<0?r(i[0],i[1],t):s>1?r(i[a],i[a-1],a-t):r(i[e],i[e+1>a?a:e+1],t-e)},Bezier:function(i,s){for(var a=0,t=i.length-1,e=Math.pow,r=li.Utils.Bernstein,n=0;n<=t;n++)a+=e(1-s,t-n)*e(s,n)*i[n]*r(t,n);return a},CatmullRom:function(i,s){var a=i.length-1,t=a*s,e=Math.floor(t),r=li.Utils.CatmullRom;return i[0]===i[a]?(s<0&&(e=Math.floor(t=a*(1+s))),r(i[(e-1+a)%a],i[e],i[(e+1)%a],i[(e+2)%a],t-e)):s<0?i[0]-(r(i[0],i[0],i[1],i[1],-t)-i[0]):s>1?i[a]-(r(i[a],i[a],i[a-1],i[a-1],t-a)-i[a]):r(i[e?e-1:0],i[e],i[a<e+1?a:e+1],i[a<e+2?a:e+2],t-e)},Utils:{Linear:function(i,s,a){return(s-i)*a+i},Bernstein:function(i,s){var a=li.Utils.Factorial;return a(i)/a(s)/a(i-s)},Factorial:function(){var i=[1];return function(s){var a=1;if(i[s])return i[s];for(var t=s;t>1;t--)a*=t;return i[s]=a,a}}(),CatmullRom:function(i,s,a,t,e){var r=(a-i)*.5,n=(t-s)*.5,o=e*e,c=e*o;return(2*s-2*a+r+n)*c+(-3*s+3*a-2*r-n)*o+r*e+s}}},Uf=function(){function i(){}return i.nextId=function(){return i._nextId++},i._nextId=0,i}(),Nc=new Lf,Zs=function(){function i(s,a){a===void 0&&(a=Nc),this._object=s,this._group=a,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Kr.Linear.None,this._interpolationFunction=li.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._id=Uf.nextId(),this._isChainStopped=!1,this._goToEnd=!1}return i.prototype.getId=function(){return this._id},i.prototype.isPlaying=function(){return this._isPlaying},i.prototype.isPaused=function(){return this._isPaused},i.prototype.to=function(s,a){return this._valuesEnd=Object.create(s),a!==void 0&&(this._duration=a),this},i.prototype.duration=function(s){return this._duration=s,this},i.prototype.start=function(s){if(this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed){this._reversed=!1;for(var a in this._valuesStartRepeat)this._swapEndStartRepeatValues(a),this._valuesStart[a]=this._valuesStartRepeat[a]}return this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=s!==void 0?typeof s=="string"?kr()+parseFloat(s):s:kr(),this._startTime+=this._delayTime,this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat),this},i.prototype._setupProperties=function(s,a,t,e){for(var r in t){var n=s[r],o=Array.isArray(n),c=o?"array":typeof n,l=!o&&Array.isArray(t[r]);if(!(c==="undefined"||c==="function")){if(l){var u=t[r];if(u.length===0)continue;u=u.map(this._handleRelativeValue.bind(this,n)),t[r]=[n].concat(u)}if((c==="object"||o)&&n&&!l){a[r]=o?[]:{};for(var h in n)a[r][h]=n[h];e[r]=o?[]:{},this._setupProperties(n,a[r],t[r],e[r])}else typeof a[r]=="undefined"&&(a[r]=n),o||(a[r]*=1),l?e[r]=t[r].slice().reverse():e[r]=a[r]||0}}},i.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},i.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},i.prototype.pause=function(s){return s===void 0&&(s=kr()),this._isPaused||!this._isPlaying?this:(this._isPaused=!0,this._pauseStart=s,this._group&&this._group.remove(this),this)},i.prototype.resume=function(s){return s===void 0&&(s=kr()),!this._isPaused||!this._isPlaying?this:(this._isPaused=!1,this._startTime+=s-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this)},i.prototype.stopChainedTweens=function(){for(var s=0,a=this._chainedTweens.length;s<a;s++)this._chainedTweens[s].stop();return this},i.prototype.group=function(s){return this._group=s,this},i.prototype.delay=function(s){return this._delayTime=s,this},i.prototype.repeat=function(s){return this._initialRepeat=s,this._repeat=s,this},i.prototype.repeatDelay=function(s){return this._repeatDelayTime=s,this},i.prototype.yoyo=function(s){return this._yoyo=s,this},i.prototype.easing=function(s){return this._easingFunction=s,this},i.prototype.interpolation=function(s){return this._interpolationFunction=s,this},i.prototype.chain=function(){for(var s=[],a=0;a<arguments.length;a++)s[a]=arguments[a];return this._chainedTweens=s,this},i.prototype.onStart=function(s){return this._onStartCallback=s,this},i.prototype.onUpdate=function(s){return this._onUpdateCallback=s,this},i.prototype.onRepeat=function(s){return this._onRepeatCallback=s,this},i.prototype.onComplete=function(s){return this._onCompleteCallback=s,this},i.prototype.onStop=function(s){return this._onStopCallback=s,this},i.prototype.update=function(s,a){if(s===void 0&&(s=kr()),a===void 0&&(a=!0),this._isPaused)return!0;var t,e,r=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(s>r)return!1;a&&this.start(s)}if(this._goToEnd=!1,s<this._startTime)return!0;this._onStartCallbackFired===!1&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),e=(s-this._startTime)/this._duration,e=this._duration===0||e>1?1:e;var n=this._easingFunction(e);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,n),this._onUpdateCallback&&this._onUpdateCallback(this._object,e),e===1)if(this._repeat>0){isFinite(this._repeat)&&this._repeat--;for(t in this._valuesStartRepeat)!this._yoyo&&typeof this._valuesEnd[t]=="string"&&(this._valuesStartRepeat[t]=this._valuesStartRepeat[t]+parseFloat(this._valuesEnd[t])),this._yoyo&&this._swapEndStartRepeatValues(t),this._valuesStart[t]=this._valuesStartRepeat[t];return this._yoyo&&(this._reversed=!this._reversed),this._repeatDelayTime!==void 0?this._startTime=s+this._repeatDelayTime:this._startTime=s+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),!0}else{this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var o=0,c=this._chainedTweens.length;o<c;o++)this._chainedTweens[o].start(this._startTime+this._duration);return this._isPlaying=!1,!1}return!0},i.prototype._updateProperties=function(s,a,t,e){for(var r in t)if(a[r]!==void 0){var n=a[r]||0,o=t[r],c=Array.isArray(s[r]),l=Array.isArray(o),u=!c&&l;u?s[r]=this._interpolationFunction(o,e):typeof o=="object"&&o?this._updateProperties(s[r],n,o,e):(o=this._handleRelativeValue(n,o),typeof o=="number"&&(s[r]=n+(o-n)*e))}},i.prototype._handleRelativeValue=function(s,a){return typeof a!="string"?a:a.charAt(0)==="+"||a.charAt(0)==="-"?s+parseFloat(a):parseFloat(a)},i.prototype._swapEndStartRepeatValues=function(s){var a=this._valuesStartRepeat[s],t=this._valuesEnd[s];typeof t=="string"?this._valuesStartRepeat[s]=this._valuesStartRepeat[s]+parseFloat(t):this._valuesStartRepeat[s]=this._valuesEnd[s],this._valuesEnd[s]=a},i}(),Nt=Nc;Nt.getAll.bind(Nt);Nt.removeAll.bind(Nt);Nt.add.bind(Nt);Nt.remove.bind(Nt);var Nf=Nt.update.bind(Nt);function Js(i,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Vf(i,s,a){return s&&Js(i.prototype,s),a&&Js(i,a),i}function On(i,s){i.prototype=Object.create(s.prototype),i.prototype.constructor=i,Pn(i,s)}function Pn(i,s){return Pn=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Pn(i,s)}var kf=`#define GLSLIFY 1
#include <common>
#include <common_frag>
uniform vec3 u_colorId;void main(){gl_FragColor=vec4(u_colorId,1.0);}`,Gf=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`;z.create("framebuffer-picker-color",Gf,kf);var Hf=function(i){On(s,i);function s(t){var e;return e=i.call(this,t,z.find("framebuffer-picker-color"))||this,e._currentId=0,e._primitivesMap=[],e}var a=s.prototype;return a.reset=function(){this._currentId=0,this._primitivesMap=[]},a.id2Color=function(e){if(e>=16777215)return new w(0,0,0);var r=new w((e&255)/255,((e&65280)>>8)/255,((e&16711680)>>16)/255);return r},a.color2Id=function(e){return e[0]|e[1]<<8|e[2]<<16},a.getObjectByColor=function(e){return this._primitivesMap[this.color2Id(e)]},a._preRender=function(e){var r=e.component,n=e.mesh;this._currentId+=1,this._primitivesMap[this._currentId]={component:r,mesh:n},r.shaderData.setVector3("u_colorId",this.id2Color(this._currentId))},s}(Qt),Wf=function(i){On(s,i);function s(t,e,r,n,o){var c;return c=i.call(this,t,e,r,new Hf(o),n)||this,c._needPick=void 0,c.onPick=void 0,c._pickPos=void 0,c._needPick=!1,c.onPick=function(l){return console.log(l)},c}var a=s.prototype;return a.preRender=function(){this._needPick?(this.enabled=!0,this.replaceMaterial.reset()):this.enabled=!1},a.postRender=function(e){if(this._needPick){var r=this.readColorFromRenderTarget(e),n=this.replaceMaterial.getObjectByColor(r);this._needPick=!1,this.onPick&&this.onPick(n)}},a.pick=function(e,r){this._pickPos=[e,r],this._needPick=!0},a.readColorFromRenderTarget=function(e){var r=e.engine._hardwareRenderer.gl,n=this._pickPos,o=r.canvas,c=o.clientWidth,l=o.clientHeight,u=r.drawingBufferWidth,h=r.drawingBufferHeight,f=n[0]/c*u,d=n[1]/l*h,_=e.viewport,p=(_.z-_.x)*u,v=(_.w-_.y)*h,g=(f-_.x)/p,m=(d-_.y)/v,y=Math.floor(g*(this.renderTarget.width-1)),A=Math.floor((1-m)*(this.renderTarget.height-1)),S=new Uint8Array(4);return this.renderTarget.getColorTexture().getPixelBuffer(null,y,A,1,1,0,S),S},s}(wr),Xf=function(i){On(s,i);function s(t){var e;e=i.call(this,t)||this,e.colorRenderTarget=void 0,e.colorRenderPass=void 0,e._camera=void 0,e._needPick=void 0,e._pickPos=void 0;var r=1024,n=1024;return e.colorRenderTarget=new fc(e.engine,r,n,new dc(e.engine,r,n)),e.colorRenderPass=new Wf("ColorRenderTarget_FBP",-1,e.colorRenderTarget,0,e.engine),e}var a=s.prototype;return a.pick=function(e,r){this.enabled&&(this._needPick=!0,this._pickPos=[e,r])},a.onUpdate=function(e){i.prototype.onUpdate.call(this,e),this.enabled&&this._needPick&&(this.colorRenderPass.pick(this._pickPos[0],this._pickPos[1]),this._needPick=!1)},a.onDestroy=function(){this.camera.destroyed||this.camera._renderPipeline.removeRenderPass(this.colorRenderPass)},Vf(s,[{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this.camera._renderPipeline.addRenderPass(this.colorRenderPass))}},{key:"onPick",set:function(e){typeof e=="function"&&(this.colorRenderPass.onPick=e)}}]),s}(Jr);function jf(i,s){i.prototype=Object.create(s.prototype),i.prototype.constructor=i,Mn(i,s)}function Mn(i,s){return Mn=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},Mn(i,s)}function Ht(i){if(i===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return i}var ec=N.zeroTolerance,_n=function(){function i(a,t,e){this.radius=void 0,this.phi=void 0,this.theta=void 0,this.radius=a!==void 0?a:1,this.phi=t!==void 0?t:0,this.theta=e!==void 0?e:0}var s=i.prototype;return s.set=function(t,e,r){return this.radius=t,this.phi=e,this.theta=r,this},s.makeSafe=function(){return this.phi=N.clamp(this.phi,ec,Math.PI-ec),this},s.setFromVec3=function(t){return this.radius=t.length(),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t.x,t.z),this.phi=Math.acos(N.clamp(t.y/this.radius,-1,1))),this},s.setToVec3=function(t){var e=Math.sin(this.phi)*this.radius;return t.x=e*Math.sin(this.theta),t.y=Math.cos(this.phi)*this.radius,t.z=e*Math.cos(this.theta),this},i}(),tc=function(i){jf(s,i);function s(t){var e;return e=i.call(this,t)||this,e.camera=void 0,e.domElement=void 0,e.mainElement=void 0,e.fov=void 0,e.target=void 0,e.up=void 0,e.minDistance=void 0,e.maxDistance=void 0,e.minZoom=void 0,e.maxZoom=void 0,e.enableDamping=void 0,e.zoomFactor=void 0,e.enableRotate=void 0,e.keyPanSpeed=void 0,e.minPolarAngle=void 0,e.maxPolarAngle=void 0,e.minAzimuthAngle=void 0,e.maxAzimuthAngle=void 0,e.enableZoom=void 0,e.dampingFactor=void 0,e.zoomSpeed=void 0,e.enablePan=void 0,e.autoRotate=void 0,e.autoRotateSpeed=Math.PI,e.rotateSpeed=void 0,e.enableKeys=void 0,e.keys=void 0,e.mouseButtons=void 0,e.touchFingers=void 0,e.STATE=void 0,e.mouseUpEvents=void 0,e.constEvents=void 0,e._position=void 0,e._offset=void 0,e._spherical=void 0,e._sphericalDelta=void 0,e._sphericalDump=void 0,e._zoomFrag=void 0,e._scale=void 0,e._panOffset=void 0,e._isMouseUp=void 0,e._vPan=void 0,e._state=void 0,e._rotateStart=void 0,e._rotateEnd=void 0,e._rotateDelta=void 0,e._panStart=void 0,e._panEnd=void 0,e._panDelta=void 0,e._zoomStart=void 0,e._zoomEnd=void 0,e._zoomDelta=void 0,e.camera=t,e.mainElement=e.engine.canvas._webCanvas,e.domElement=document,e.fov=45,e.target=new w,e.up=new w(0,1,0),e.minDistance=.1,e.maxDistance=1/0,e.minZoom=0,e.maxZoom=1/0,e.minPolarAngle=0,e.maxPolarAngle=Math.PI,e.minAzimuthAngle=-1/0,e.maxAzimuthAngle=1/0,e.enableDamping=!0,e.dampingFactor=.1,e.zoomFactor=.2,e.enableZoom=!0,e.zoomSpeed=1,e.enableRotate=!0,e.rotateSpeed=1,e.enablePan=!0,e.keyPanSpeed=7,e.autoRotate=!1,e.enableKeys=!1,e.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},e.mouseButtons={ORBIT:0,ZOOM:1,PAN:2},e.touchFingers={ORBIT:1,ZOOM:2,PAN:3},e._position=new w,e._offset=new w,e._spherical=new _n,e._sphericalDelta=new _n,e._sphericalDump=new _n,e._zoomFrag=0,e._scale=1,e._panOffset=new w,e._isMouseUp=!0,e._vPan=new w,e._rotateStart=new H,e._rotateEnd=new H,e._rotateDelta=new H,e._panStart=new H,e._panEnd=new H,e._panDelta=new H,e._zoomStart=new H,e._zoomEnd=new H,e._zoomDelta=new H,e.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5},e._state=e.STATE.NONE,e.constEvents=[{type:"mousedown",listener:e.onMouseDown.bind(Ht(e))},{type:"wheel",listener:e.onMouseWheel.bind(Ht(e))},{type:"keydown",listener:e.onKeyDown.bind(Ht(e)),element:window},{type:"touchstart",listener:e.onTouchStart.bind(Ht(e))},{type:"touchmove",listener:e.onTouchMove.bind(Ht(e))},{type:"touchend",listener:e.onTouchEnd.bind(Ht(e))},{type:"contextmenu",listener:e.onContextMenu.bind(Ht(e))}],e.mouseUpEvents=[{type:"mousemove",listener:e.onMouseMove.bind(Ht(e))},{type:"mouseup",listener:e.onMouseUp.bind(Ht(e))}],e.constEvents.forEach(function(r){r.element?r.element.addEventListener(r.type,r.listener,!1):e.mainElement.addEventListener(r.type,r.listener,!1)}),e}var a=s.prototype;return a.onDisable=function(){var e=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.removeEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),e.removeEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)},a.onDestroy=function(){var e=this;this.constEvents.forEach(function(n){n.element?n.element.removeEventListener(n.type,n.listener,!1):e.mainElement.removeEventListener(n.type,n.listener,!1)});var r=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.removeEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),r.removeEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)},a.onUpdate=function(e){if(!!this.enabled){var r=this.camera.transform.position;r.cloneTo(this._offset),this._offset.subtract(this.target),this._spherical.setFromVec3(this._offset),this.autoRotate&&this._state===this.STATE.NONE&&this.rotateLeft(this.getAutoRotationAngle(e)),this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi,this._spherical.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this._scale!==1&&(this._zoomFrag=this._spherical.radius*(this._scale-1)),this._spherical.radius+=this._zoomFrag,this._spherical.radius=Math.max(this.minDistance,Math.min(this.maxDistance,this._spherical.radius)),this.target.add(this._panOffset),this._spherical.setToVec3(this._offset),this.target.cloneTo(this._position),this._position.add(this._offset),this.camera.transform.position=this._position,this.camera.transform.lookAt(this.target,this.up),this.enableDamping===!0?(this._sphericalDump.theta*=1-this.dampingFactor,this._sphericalDump.phi*=1-this.dampingFactor,this._zoomFrag*=1-this.zoomFactor,this._isMouseUp?(this._sphericalDelta.theta=this._sphericalDump.theta,this._sphericalDelta.phi=this._sphericalDump.phi):this._sphericalDelta.set(0,0,0)):(this._sphericalDelta.set(0,0,0),this._zoomFrag=0),this._scale=1,this._panOffset.setValue(0,0,0)}},a.getAutoRotationAngle=function(e){return this.autoRotateSpeed/1e3*e},a.getZoomScale=function(){return Math.pow(.95,this.zoomSpeed)},a.rotateLeft=function(e){this._sphericalDelta.theta-=e,this.enableDamping&&(this._sphericalDump.theta=-e)},a.rotateUp=function(e){this._sphericalDelta.phi-=e,this.enableDamping&&(this._sphericalDump.phi=-e)},a.panLeft=function(e,r){var n=r.elements;this._vPan.setValue(n[0],n[1],n[2]),this._vPan.scale(e),this._panOffset.add(this._vPan)},a.panUp=function(e,r){var n=r.elements;this._vPan.setValue(n[4],n[5],n[6]),this._vPan.scale(e),this._panOffset.add(this._vPan)},a.pan=function(e,r){var n=this.camera.position;n.cloneTo(this._vPan),this._vPan.subtract(this.target);var o=this._vPan.length();o*=this.fov/2*(Math.PI/180),this.panLeft(-2*e*(o/this.mainElement.clientHeight),this.camera.transform.worldMatrix),this.panUp(2*r*(o/this.mainElement.clientHeight),this.camera.transform.worldMatrix)},a.zoomIn=function(e){this._scale*=e},a.zoomOut=function(e){this._scale/=e},a.handleMouseDownRotate=function(e){this._rotateStart.setValue(e.clientX,e.clientY)},a.handleMouseDownZoom=function(e){this._zoomStart.setValue(e.clientX,e.clientY)},a.handleMouseDownPan=function(e){this._panStart.setValue(e.clientX,e.clientY)},a.handleMouseMoveRotate=function(e){this._rotateEnd.setValue(e.clientX,e.clientY),H.subtract(this._rotateEnd,this._rotateStart,this._rotateDelta),this.rotateLeft(2*Math.PI*(this._rotateDelta.x/this.mainElement.clientWidth)*this.rotateSpeed),this.rotateUp(2*Math.PI*(this._rotateDelta.y/this.mainElement.clientHeight)*this.rotateSpeed),this._rotateEnd.cloneTo(this._rotateStart)},a.handleMouseMoveZoom=function(e){this._zoomEnd.setValue(e.clientX,e.clientY),H.subtract(this._zoomEnd,this._zoomStart,this._zoomDelta),this._zoomDelta.y>0?this.zoomOut(this.getZoomScale()):this._zoomDelta.y<0&&this.zoomIn(this.getZoomScale()),this._zoomEnd.cloneTo(this._zoomStart)},a.handleMouseMovePan=function(e){this._panEnd.setValue(e.clientX,e.clientY),H.subtract(this._panEnd,this._panStart,this._panDelta),this.pan(this._panDelta.x,this._panDelta.y),this._panEnd.cloneTo(this._panStart)},a.handleMouseWheel=function(e){e.deltaY<0?this.zoomIn(this.getZoomScale()):e.deltaY>0&&this.zoomOut(this.getZoomScale())},a.handleKeyDown=function(e){switch(e.keyCode){case this.keys.UP:this.pan(0,this.keyPanSpeed);break;case this.keys.BOTTOM:this.pan(0,-this.keyPanSpeed);break;case this.keys.LEFT:this.pan(this.keyPanSpeed,0);break;case this.keys.RIGHT:this.pan(-this.keyPanSpeed,0);break}},a.handleTouchStartRotate=function(e){this._rotateStart.setValue(e.touches[0].pageX,e.touches[0].pageY)},a.handleTouchStartZoom=function(e){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);this._zoomStart.setValue(0,o)},a.handleTouchStartPan=function(e){this._panStart.setValue(e.touches[0].pageX,e.touches[0].pageY)},a.handleTouchMoveRotate=function(e){this._rotateEnd.setValue(e.touches[0].pageX,e.touches[0].pageY),H.subtract(this._rotateEnd,this._rotateStart,this._rotateDelta),this.rotateLeft(2*Math.PI*this._rotateDelta.x/this.mainElement.clientWidth*this.rotateSpeed),this.rotateUp(2*Math.PI*this._rotateDelta.y/this.mainElement.clientHeight*this.rotateSpeed),this._rotateEnd.cloneTo(this._rotateStart)},a.handleTouchMoveZoom=function(e){var r=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,o=Math.sqrt(r*r+n*n);this._zoomEnd.setValue(0,o),H.subtract(this._zoomEnd,this._zoomStart,this._zoomDelta),this._zoomDelta.y>0?this.zoomIn(this.getZoomScale()):this._zoomDelta.y<0&&this.zoomOut(this.getZoomScale()),this._zoomEnd.cloneTo(this._zoomStart)},a.handleTouchMovePan=function(e){this._panEnd.setValue(e.touches[0].pageX,e.touches[0].pageY),H.subtract(this._panEnd,this._panStart,this._panDelta),this.pan(this._panDelta.x,this._panDelta.y),this._panEnd.cloneTo(this._panStart)},a.onMouseDown=function(e){if(this.enabled!==!1){switch(e.preventDefault(),this._isMouseUp=!1,e.button){case this.mouseButtons.ORBIT:if(this.enableRotate===!1)return;this.handleMouseDownRotate(e),this._state=this.STATE.ROTATE;break;case this.mouseButtons.ZOOM:if(this.enableZoom===!1)return;this.handleMouseDownZoom(e),this._state=this.STATE.ZOOM;break;case this.mouseButtons.PAN:if(this.enablePan===!1)return;this.handleMouseDownPan(e),this._state=this.STATE.PAN;break}if(this._state!==this.STATE.NONE){var r=this.domElement===document?this.domElement.body:this.domElement;this.mainElement.addEventListener(this.mouseUpEvents[0].type,this.mouseUpEvents[0].listener,!1),r.addEventListener(this.mouseUpEvents[1].type,this.mouseUpEvents[1].listener,!1)}}},a.onMouseMove=function(e){if(this.enabled!==!1)switch(e.preventDefault(),this._state){case this.STATE.ROTATE:if(this.enableRotate===!1)return;this.handleMouseMoveRotate(e);break;case this.STATE.ZOOM:if(this.enableZoom===!1)return;this.handleMouseMoveZoom(e);break;case this.STATE.PAN:if(this.enablePan===!1)return;this.handleMouseMovePan(e);break}},a.onMouseUp=function(){var e=this;this.enabled!==!1&&(this._isMouseUp=!0,this.mouseUpEvents.forEach(function(r){var n=e.domElement===document?e.domElement.body:e.domElement;n.removeEventListener(r.type,r.listener,!1),e.mainElement.removeEventListener(r.type,r.listener,!1)}),this._state=this.STATE.NONE)},a.onMouseWheel=function(e){this.enabled===!1||this.enableZoom===!1||this._state!==this.STATE.NONE&&this._state!==this.STATE.ROTATE||(e.preventDefault(),e.stopPropagation(),this.handleMouseWheel(e))},a.onKeyDown=function(e){this.enabled===!1||this.enableKeys===!1||this.enablePan===!1||this.handleKeyDown(e)},a.onTouchStart=function(e){if(this.enabled!==!1)switch(this._isMouseUp=!1,e.touches.length){case this.touchFingers.ORBIT:if(this.enableRotate===!1)return;this.handleTouchStartRotate(e),this._state=this.STATE.TOUCH_ROTATE;break;case this.touchFingers.ZOOM:if(this.enableZoom===!1)return;this.handleTouchStartZoom(e),this._state=this.STATE.TOUCH_ZOOM;break;case this.touchFingers.PAN:if(this.enablePan===!1)return;this.handleTouchStartPan(e),this._state=this.STATE.TOUCH_PAN;break;default:this._state=this.STATE.NONE}},a.onTouchMove=function(e){if(this.enabled!==!1)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case this.touchFingers.ORBIT:if(this.enableRotate===!1||this._state!==this.STATE.TOUCH_ROTATE)return;this.handleTouchMoveRotate(e);break;case this.touchFingers.ZOOM:if(this.enableZoom===!1||this._state!==this.STATE.TOUCH_ZOOM)return;this.handleTouchMoveZoom(e);break;case this.touchFingers.PAN:if(this.enablePan===!1||this._state!==this.STATE.TOUCH_PAN)return;this.handleTouchMovePan(e);break;default:this._state=this.STATE.NONE}},a.onTouchEnd=function(){this.enabled!==!1&&(this._isMouseUp=!0,this._state=this.STATE.NONE)},a.onContextMenu=function(e){this.enabled!==!1&&e.preventDefault()},s}(Jr);let Ze;class Vc{constructor(){this.renderers_in_modelGltf=[],this.initCameraPoi=new w(2,3,10),this.modelUrl="models/list/3.glb",this.materialsConfig=[],this.onPickOnePart=s=>{if(s){const{component:a,mesh:t}=s;let e=a.entity;(!this.mouseHoverEntity||this.mouseHoverEntity.instanceId!=e.instanceId)&&e.name!="beiban"&&(this.mouseHoverEntity=e,(e.getComponent(Vi)||e.addComponent(Vi)).start())}else this.mouseHoverEntity&&((this.mouseHoverEntity.getComponent(Vi)||this.mouseHoverEntity.addComponent(Vi)).startReverse(),this.mouseHoverEntity=null)}}static get ins(){return this._ins||(this._ins=new Vc),this._ins}async createEngine(s,a){a&&this.resolveAllConfigData(a),this.engine=new Kh(s,null,{alpha:!0,premultipliedAlpha:!1}),this.engine.canvas.resizeByClientSize(),this.resize();const t=this.engine.sceneManager.activeScene,{background:e}=t;if(e.solidColor.setValue(.45,.45,.45,0),this.rootEntity=t.createRootEntity(),this.initCamera(),this.initLight(t),await this.changeModel(this.modelUrl),this.applyMaterialsConfig(),this.defaultAction&&this.setAction(this.defaultAction),this.modelUrl.includes("\u56FE\u68072")||this.modelUrl.includes("\u56FE\u68073")){const r=this.rootEntity.addComponent(Xf);r.camera=this.camera,r.onPick=this.onPickOnePart,this.engine.canvas._webCanvas.addEventListener("mousemove",n=>r.pick(n.offsetX,n.offsetY))}return this.engine.run(),this.engine}initCamera(){var t,e,r,n;const s=this.rootEntity.createChild("camera");this.camera=s.addComponent(En);const a=s.transform.position;if(a.setValue(this.initCameraPoi.x,this.initCameraPoi.y,this.initCameraPoi.z),s.transform.position=a,this.controler=s.addComponent(tc),this.sceneConfig=(t=this.allData)==null?void 0:t.sceneConfig,(n=(r=(e=this.allData)==null?void 0:e.sceneConfig)==null?void 0:r.cameraConfig)!=null&&n.controlerTarget){let{x:o,y:c,z:l}=this.allData.sceneConfig.cameraConfig.controlerTarget;this.controler.target.setValue(o,c,l)}}initLight(s){var o,c,l,u,h,f;s.ambientLight.diffuseSolidColor.setValue(0,0,0,0),s.ambientLight.diffuseIntensity=0;const a=this.rootEntity.createChild("light"),t=a.addComponent(Ut);if((o=this.sceneConfig)!=null&&o.light.direct){let d=dn((c=this.sceneConfig)==null?void 0:c.light.direct.color).toRgb();t.color.setValue(d.r/255,d.g/255,d.b/255,d.a)}else t.color.setValue(1,1,1,1);t.intensity=((l=this.sceneConfig)==null?void 0:l.light.direct.intensity)||0,a.transform.setRotation(-30,-30,0);const e=s.background,r=e.sky,n=new xc(this.engine);e.mode=(h=(u=this.sceneConfig)==null?void 0:u.background)!=null&&h.show?Cr.Sky:Cr.SolidColor,r.material=n,r.mesh=Hr.createCuboid(this.engine,1,1,1),this.setIBL(((f=this.sceneConfig)==null?void 0:f.light.IBLUrl)||"https://uufefile.uupt.com/eic/cdn/glb/env/leadenhall_market_2k.hdr.env")}resize(){let s;new ResizeObserver(t=>{s&&clearTimeout(s),s=setTimeout(()=>{this.engine.canvas.resizeByClientSize()},10)}).observe(this.engine.canvas._webCanvas)}resolveAllConfigData(s){if(this.allData=s,this.modelUrl=s.model.url,this.materialsConfig=s.materialsConfig,this.sceneConfig=s.sceneConfig,this.defaultAction=s.action,s.sceneConfig.cameraConfig&&s.sceneConfig.cameraConfig.position){const{x:a,y:t,z:e}=s.sceneConfig.cameraConfig.position;this.initCameraPoi.setValue(a,t,e)}}async changeModel(s){Ze&&this.rootEntity.removeChild(Ze.defaultSceneRoot),Ze=await this.engine.resourceManager.load(s),this.renderers_in_modelGltf=new Array,Ze.defaultSceneRoot.getComponentsIncludeChildren(Zr,this.renderers_in_modelGltf),this.checkMaterials(),this.playAnimation(),this.modelEntity=this.rootEntity.findByName("model")||this.rootEntity.createChild("model"),this.modelEntity.addChild(Ze.defaultSceneRoot)}checkMaterials(){this.renderers_in_modelGltf.forEach(s=>{if(s.getMaterial()instanceof et){let a=new fr(this.engine);a.roughness=0,a.metallic=0,s.setMaterial(a)}})}playAnimation(){let{animations:s}=Ze;if(s&&s.length>0){const a=Ze==null?void 0:Ze.defaultSceneRoot.getComponent(Dr),t=new Bn;s==null||s.forEach((e,r)=>{const n=new Qi("layer"+r),o=new $i;t.addLayer(n),n.stateMachine=o,r>0&&(n.blendingMode=xi.Additive);const c=o.addState(e.name);c.clip=e,r>0&&(c.clipStartTime=1)}),a.animatorController=t,a.speed=1,s==null||s.forEach((e,r)=>{r==0&&a.play(e.name,r)})}}applyMaterialsConfig(){this.materialsConfig.forEach(s=>{let a=this.renderers_in_modelGltf.find(n=>n.entity.name==s.name),t=(a==null?void 0:a.getMaterial()).clone();t.name=s.material.name,t.metallic=s.material.metallic,t.roughness=s.material.roughness,t.isTransparent=s.material.isTransparent;let e=dn(s.material.baseColor).toRgb();e.a=s.material.opacity,t.baseColor=new ne(e.r/255,e.g/255,e.b/255,e.a);let r=dn(s.material.emissiveColor).toRgb();t.emissiveColor=new ne(r.r/255,r.g/255,r.b/255,r.a),a==null||a.setMaterial(t)})}async setIBL(s){const a=this.engine.sceneManager.activeScene;let t=await this.engine.resourceManager.load({type:Te.Env,url:s});a.ambientLight=t,t.diffuseIntensity=1;const e=a.background.sky.material;e.textureCubeMap=t.specularTexture,e.textureDecodeRGBM=!0}setAction(s){let a=this.rootEntity.findByName("action");a&&(a.destroy(),a.clearChildren()),a=this.rootEntity.createChild("action"),this.camera.entity.clearChildren();let t=this.camera.entity.getComponent(tc);switch(t.enableZoom=t.enablePan=t.enableRotate=!1,s){case 1:t.enableZoom=t.enablePan=t.enableRotate=!0;break;case 2:a.addComponent(Kf);break;case 3:a.addComponent(kc).init(this.engine.canvas._webCanvas);break;case 4:let{animations:e}=Ze;if(e&&(e==null?void 0:e.length)>0){const r=Ze.defaultSceneRoot.getComponent(Dr);e==null||e.forEach((n,o)=>{r.speed=0}),a.addComponent(qf).init(this.engine.canvas._webCanvas)}break}}}class Kf extends Jr{constructor(){super(...arguments),this._totalTime=0}onUpdate(s){this._totalTime+=s;const a=this._totalTime*.1;this.entity.parent.findByName("model").transform.setRotation(0,a,0)}}const Tn=class extends Jr{constructor(i){super(i),this.oringeRot=this.entity.parent.findByName("model").transform.rotation.clone(),this.mouseX=0,this.mouseY=0,this.isOut=!0,this.modelEntity=this.entity.parent.findByName("model"),this.enterX=0,this.enterY=0,this.onDocumentMouseEnter=s=>{this.enterX=s.offsetX,this.enterY=s.offsetY},this.limit=300,this.onDocumentMouseMove=s=>{this.isOut=!1,this.mouseX=s.offsetX-this.enterX,this.mouseY=s.offsetY-this.enterY,this.mouseX<this.limit*-1?this.mouseX=this.limit*-1:this.mouseX>this.limit&&(this.mouseX=this.limit),this.mouseY<this.limit*-1?this.mouseY=this.limit*-1:this.mouseY>this.limit&&(this.mouseY=this.limit),this.targetRot=new w(this.oringeRot.x+this.mouseY*Tn.a,this.oringeRot.y+this.mouseX*Tn.a,0)},this.onDocumentMouseout=s=>{this.isOut=!0,this.targetRot=this.oringeRot},this.speed=1,this.targetRot=this.entity.parent.findByName("model").transform.rotation}init(i){i.addEventListener("mouseenter",this.onDocumentMouseEnter),i.addEventListener("mousemove",this.onDocumentMouseMove),i.addEventListener("mouseout",this.onDocumentMouseout)}onUpdate(i){let{x:s,y:a,z:t}=this.entity.parent.findByName("model").transform.rotation;if(this.isOut){let e=this.targetRot.x-s>0?Math.min(s+this.speed,this.targetRot.x):Math.max(s+this.speed*-1,this.targetRot.x),r=this.targetRot.y-a>0?Math.min(a+this.speed,this.targetRot.y):Math.max(a+this.speed*-1,this.targetRot.y);this.modelEntity.transform.setRotation(e,r,t)}else this.modelEntity.transform.setRotation(s,this.targetRot.y,t)}};let kc=Tn;kc.a=.1;class qf extends Jr{constructor(s){super(s)}init(s){s.addEventListener("mouseover",this.onmouseover),s.addEventListener("mouseout",this.onmouseout),this.webCanvas=s}onmouseover(){let{animations:s}=Ze;const a=Ze.defaultSceneRoot.getComponent(Dr);s&&(s==null?void 0:s.length)>0&&a&&(s==null||s.forEach((t,e)=>{a.speed=1}))}onmouseout(){let{animations:s}=Ze;const a=Ze.defaultSceneRoot.getComponent(Dr);s==null||s.forEach((t,e)=>{a.speed=0})}onDestroy(){var s,a;(s=this.webCanvas)==null||s.removeEventListener("mouseover",this.onmouseover),(a=this.webCanvas)==null||a.removeEventListener("mouseout",this.onmouseout),this.onmouseover()}}class Vi extends Jr{constructor(){super(...arguments),this.isRotating=!1,this.originRot=this.entity.transform.rotation.clone()}start(){if(this.isRotating)return;let{x:s,y:a,z:t}=this.originRot;this.isRotating=!0,new Zs({y:a}).to({y:a+360},500).onUpdate(({y:e})=>{this.entity.transform.setRotation(s,e,t)}).onComplete(()=>{this.isRotating=!1}).easing(Kr.Sinusoidal.InOut).start()}startReverse(){if(this.isRotating)return;let{x:s,y:a,z:t}=this.originRot;this.isRotating=!0,new Zs({y:a+360}).to({y:a},500).onUpdate(({y:e})=>{this.entity.transform.setRotation(s,e,t)}).onComplete(()=>{this.isRotating=!1}).easing(Kr.Sinusoidal.InOut).start()}onUpdate(s){Nf()}}export{Dr as A,ur as B,En as C,Ut as D,Kr as E,Xf as F,Zr as M,tc as O,fr as P,dc as R,Jr as S,Zs as T,w as V,Kh as W,yi as a,Cr as b,fc as c,xc as d,Hr as e,ne as f,et as g,xi as h,Te as i,Bn as j,Qi as k,$i as l,Vc as m,dn as t,Nf as u};
